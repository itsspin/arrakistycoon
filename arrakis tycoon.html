<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrakis Tycoon - A Dune Idle Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'arrakis-tycoon-default';
        let userId = auth.currentUser?.uid || `anon-${crypto.randomUUID()}`; // Initial fallback

        // --- Game Data Structure ---
        let gameData = {
            character: {
                house: null, 
                background: null, 
                name: "Survivor",
                health: 100,
                maxHealth: 100,
            },
            resources: {
                spice: 0,
                water: 10, 
                solari: 200,
                plasteel: 0,
            },
            harvesters: {
                spice_harvester_manual_level: 1, 
                spice_harvester_auto_level: 0,
                spice_harvester_auto_count: 0,
                water_collector_auto_level: 0,
                water_collector_auto_count: 0,
            },
            upgrades: {
                spice_auto_cost: 100, 
                water_auto_cost: 150, 
                spice_manual_upgrade_cost: 20, 
            },
            inventory: [], 
            craftingRecipes: [
                { id: 'basic_stillsuit_patch', name: 'Stillsuit Patch', cost: { water: 5, plasteel: 2 }, output: { id: 'stillsuit_patch_item', name: 'Stillsuit Patch', quantity: 1, type: 'consumable'}, description: "A basic patch for your stillsuit. Restores a bit of health by preventing dehydration."},
                { id: 'purified_water', name: 'Purified Water', cost: { water: 10 }, output: { id: 'purified_water_item', name: 'Purified Water', quantity: 1, type: 'consumable'}, description: "Critical for survival. Restores health."},
            ],
            settings: {
                gameSpeed: 1000, 
            },
            stats: {
                totalSpiceHarvested: 0,
                totalSolariEarned: 0,
                enemiesDefeated: 0,
            },
            lastUpdated: null,
            gameInitialized: false,
            currentTab: 'game'
        };

        const gameDocRef = () => doc(db, "artifacts", appId, "users", userId, "playerGameSaves", "mainSave");

        // --- Game Logic Functions ---
        async function saveGame() {
            if (!userId.startsWith('anon-') && gameData.gameInitialized) { 
                try {
                    gameData.lastUpdated = serverTimestamp();
                    await setDoc(gameDocRef(), gameData, { merge: true });
                    addLog("Game Saved to Cloud.", "success");
                } catch (error) {
                    console.error("Error saving game state to Firestore:", error);
                    addLog("Error saving game. Check console.", "error");
                }
            } else if (gameData.gameInitialized) {
                localStorage.setItem("arrakisTycoonData_local", JSON.stringify(gameData));
                addLog("Game Saved Locally (Anonymous User).", "info");
            }
        }

        async function loadGame() {
            if (!userId.startsWith('anon-')) {
                try {
                    const docSnap = await getDoc(gameDocRef());
                    if (docSnap.exists()) {
                        const loaded = docSnap.data();
                        Object.assign(gameData, loaded); 
                        gameData.character = { ...getDefaultCharacterState(), ...loaded.character };
                        gameData.resources = { ...getDefaultResourcesState(), ...loaded.resources };
                        gameData.harvesters = { ...getDefaultHarvestersState(), ...loaded.harvesters };
                        gameData.upgrades = { ...getDefaultUpgradesState(), ...loaded.upgrades };
                        
                        addLog("Game Loaded from Cloud.", "success");
                        if (!gameData.gameInitialized) { 
                           showCharacterCreator();
                        } else {
                           startGameLoop();
                           updateUI();
                        }
                    } else {
                        addLog("No cloud save found. Starting new game.", "info");
                        showCharacterCreator(); 
                    }
                } catch (error) {
                    console.error("Error loading game state from Firestore:", error);
                    addLog("Error loading cloud save. Trying local.", "error");
                    loadGameLocalFallback();
                }
            } else {
                loadGameLocalFallback();
            }
        }
        
        function loadGameLocalFallback() {
            const localSave = localStorage.getItem("arrakisTycoonData_local");
            if (localSave) {
                Object.assign(gameData, JSON.parse(localSave));
                 gameData.character = { ...getDefaultCharacterState(), ...gameData.character };
                 gameData.resources = { ...getDefaultResourcesState(), ...gameData.resources };
                 gameData.harvesters = { ...getDefaultHarvestersState(), ...gameData.harvesters };
                 gameData.upgrades = { ...getDefaultUpgradesState(), ...gameData.upgrades };
                addLog("Game Loaded from Local Storage.", "info");
                 if (!gameData.gameInitialized) {
                    showCharacterCreator();
                 } else {
                    startGameLoop();
                    updateUI();
                 }
            } else {
                addLog("No local save found. Starting new game.", "info");
                showCharacterCreator();
            }
        }

        function getDefaultCharacterState() {
            return { house: null, background: null, name: "Survivor", health: 100, maxHealth: 100 };
        }
        function getDefaultResourcesState() {
            return { spice: 0, water: 10, solari: 200, plasteel: 0 };
        }
        function getDefaultHarvestersState() {
            return { spice_harvester_manual_level: 1, spice_harvester_auto_level: 0, spice_harvester_auto_count: 0, water_collector_auto_level: 0, water_collector_auto_count: 0 };
        }
        function getDefaultUpgradesState() {
            return { spice_auto_cost: 100, water_auto_cost: 150, spice_manual_upgrade_cost: 20 };
        }


        function showCharacterCreator() {
            document.getElementById('characterCreatorScreen').classList.remove('hidden');
            document.getElementById('mainGameScreen').classList.add('hidden');
            // Ensure other main screens are also hidden if character creator is shown
            document.getElementById('loreScreen').classList.add('hidden');
            document.getElementById('chroniclerScreen').classList.add('hidden');
        }

        function finalizeCharacterCreation() {
            const house = document.querySelector('input[name="house"]:checked');
            const background = document.querySelector('input[name="background"]:checked');
            const charName = document.getElementById('characterNameInput').value;

            if (!house || !background) {
                addLog("Please select a House and Background.", "error");
                return;
            }
            if (!charName.trim()) {
                 addLog("Please enter a character name.", "error");
                 return;
            }

            gameData.character.house = house.value;
            gameData.character.background = background.value;
            gameData.character.name = charName.trim();

            if (gameData.character.house === 'Fremen') gameData.resources.water += 20;
            if (gameData.character.background === 'Merchant') gameData.resources.solari += 150;
            if (gameData.character.background === 'Technician') gameData.resources.plasteel += 5;

            gameData.gameInitialized = true;
            document.getElementById('characterCreatorScreen').classList.add('hidden');
            document.getElementById('mainGameScreen').classList.remove('hidden');
            switchTab('game'); // Default to game tab after creation
            addLog(`Welcome, ${gameData.character.name} of House ${gameData.character.house}! Your journey on Arrakis begins.`, "event");
            startGameLoop();
            updateUI();
            saveGame(); 
        }
        window.finalizeCharacterCreation = finalizeCharacterCreation;


        function gameTick() {
            if (!gameData.gameInitialized) return;

            const autoSpicePerTick = gameData.harvesters.spice_harvester_auto_count * (1 + gameData.harvesters.spice_harvester_auto_level * 0.5);
            gameData.resources.spice += autoSpicePerTick;
            gameData.stats.totalSpiceHarvested += autoSpicePerTick;

            const autoWaterPerTick = gameData.harvesters.water_collector_auto_count * (1 + gameData.harvesters.water_collector_auto_level * 0.2);
            gameData.resources.water += autoWaterPerTick;
            
            if (Math.random() < 0.01) { 
                const events = [
                    { msg: "A small tremor reveals a pocket of Spice!", spice: 10 + (5 * gameData.harvesters.spice_harvester_auto_level), type: "event" },
                    { msg: "A minor sandstorm kicks up. Visibility low.", type: "lore" },
                    { msg: "You find a discarded water flask!", water: 5, type: "event" }
                ];
                const randomEvent = events[Math.floor(Math.random() * events.length)];
                addLog(randomEvent.msg, randomEvent.type);
                if(randomEvent.spice) gameData.resources.spice += randomEvent.spice;
                if(randomEvent.water) gameData.resources.water += randomEvent.water;
            }
            updateUI();
        }

        let gameLoopInterval = null;
        function startGameLoop() {
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameTick, gameData.settings.gameSpeed);
            setInterval(saveGame, 30000); 
        }

        function manualHarvestSpice() {
            if (!gameData.gameInitialized) return;
            const amount = 1 * gameData.harvesters.spice_harvester_manual_level;
            gameData.resources.spice += amount;
            gameData.stats.totalSpiceHarvested += amount;
            addLog(`Manually harvested ${amount} Spice.`, "action");
            updateUI();
        }
        window.manualHarvestSpice = manualHarvestSpice;

        function buyAutoHarvester(type) {
            if (type === 'spice') {
                if (gameData.resources.solari >= gameData.upgrades.spice_auto_cost) {
                    gameData.resources.solari -= gameData.upgrades.spice_auto_cost;
                    gameData.harvesters.spice_harvester_auto_count++;
                    gameData.upgrades.spice_auto_cost = Math.ceil(gameData.upgrades.spice_auto_cost * 1.15);
                    addLog("Purchased Spice Auto-Harvester.", "success");
                } else { addLog("Not enough Solari for Spice Auto-Harvester.", "error"); }
            } else if (type === 'water') {
                 if (gameData.resources.solari >= gameData.upgrades.water_auto_cost) {
                    gameData.resources.solari -= gameData.upgrades.water_auto_cost;
                    gameData.harvesters.water_collector_auto_count++;
                    gameData.upgrades.water_auto_cost = Math.ceil(gameData.upgrades.water_auto_cost * 1.20);
                    addLog("Purchased Water Auto-Collector.", "success");
                } else { addLog("Not enough Solari for Water Auto-Collector.", "error"); }
            }
            updateUI();
            saveGame();
        }
        window.buyAutoHarvester = buyAutoHarvester;
        
        function upgradeManualSpiceHarvester() {
            if (gameData.resources.solari >= gameData.upgrades.spice_manual_upgrade_cost) {
                gameData.resources.solari -= gameData.upgrades.spice_manual_upgrade_cost;
                gameData.harvesters.spice_harvester_manual_level++;
                gameData.upgrades.spice_manual_upgrade_cost = Math.ceil(gameData.upgrades.spice_manual_upgrade_cost * 1.5);
                 addLog("Manual Spice Harvesting upgraded!", "success");
            } else {
                 addLog("Not enough Solari to upgrade manual Spice harvesting.", "error");
            }
            updateUI();
            saveGame();
        }
        window.upgradeManualSpiceHarvester = upgradeManualSpiceHarvester;

        function upgradeAutoHarvester(type) {
            let cost = 0;
            if (type === 'spice') {
                cost = 50 * Math.pow(1.5, gameData.harvesters.spice_harvester_auto_level);
                if (gameData.harvesters.spice_harvester_auto_count > 0 && gameData.resources.solari >= cost) {
                    gameData.resources.solari -= cost;
                    gameData.harvesters.spice_harvester_auto_level++;
                    addLog("Spice Auto-Harvester efficiency upgraded!", "success");
                } else if (gameData.harvesters.spice_harvester_auto_count === 0) {
                    addLog("Buy a Spice Auto-Harvester first!", "warn");
                } else {
                    addLog("Not enough Solari for Spice Auto-Harvester upgrade.", "error");
                }
            } else if (type === 'water') {
                cost = 75 * Math.pow(1.6, gameData.harvesters.water_collector_auto_level);
                 if (gameData.harvesters.water_collector_auto_count > 0 && gameData.resources.solari >= cost) {
                    gameData.resources.solari -= cost;
                    gameData.harvesters.water_collector_auto_level++;
                    addLog("Water Auto-Collector efficiency upgraded!", "success");
                } else if (gameData.harvesters.water_collector_auto_count === 0) {
                    addLog("Buy a Water Auto-Collector first!", "warn");
                } else {
                    addLog("Not enough Solari for Water Auto-Collector upgrade.", "error");
                }
            }
            updateUI();
            saveGame();
        }
        window.upgradeAutoHarvester = upgradeAutoHarvester;


        function craftItem(recipeId) {
            const recipe = gameData.craftingRecipes.find(r => r.id === recipeId);
            if (!recipe) {
                addLog("Invalid recipe.", "error");
                return;
            }

            for (const resource in recipe.cost) {
                if (gameData.resources[resource] < recipe.cost[resource]) {
                    addLog(`Not enough ${resource.charAt(0).toUpperCase() + resource.slice(1)} to craft ${recipe.name}.`, "error");
                    return;
                }
            }

            for (const resource in recipe.cost) {
                gameData.resources[resource] -= recipe.cost[resource];
            }

            const existingItem = gameData.inventory.find(item => item.id === recipe.output.id);
            if (existingItem) {
                existingItem.quantity += recipe.output.quantity;
            } else {
                gameData.inventory.push({ ...recipe.output });
            }
            addLog(`Crafted ${recipe.output.quantity}x ${recipe.name}.`, "success");
            updateUI();
            saveGame();
        }
        window.craftItem = craftItem;

        function useItem(itemId) {
            const itemIndex = gameData.inventory.findIndex(item => item.id === itemId);
            if (itemIndex === -1 || gameData.inventory[itemIndex].quantity <= 0) {
                addLog("No such item in inventory.", "error");
                return;
            }
            
            const item = gameData.inventory[itemIndex];
            let itemUsed = false;

            if (item.id === 'stillsuit_patch_item' || item.id === 'purified_water_item') {
                const healAmount = item.id === 'stillsuit_patch_item' ? 10 : 25;
                if (gameData.character.health < gameData.character.maxHealth) {
                    gameData.character.health = Math.min(gameData.character.maxHealth, gameData.character.health + healAmount);
                    addLog(`Used ${item.name}. Restored ${healAmount} health.`, "action");
                    itemUsed = true;
                } else {
                    addLog("Health is already full.", "info");
                }
            }

            if (itemUsed) {
                item.quantity--;
                if (item.quantity <= 0) {
                    gameData.inventory.splice(itemIndex, 1);
                }
            }
            updateUI();
            saveGame();
        }
        window.useItem = useItem;

        // --- Gemini API Integration for Holo-Chronicler ---
        async function askChronicler() {
            const questionInput = document.getElementById('chroniclerQuestion');
            const answerDisplay = document.getElementById('chroniclerAnswer');
            const askButton = document.getElementById('askChroniclerBtn');

            if (!questionInput || !answerDisplay || !askButton) {
                console.error("Chronicler UI elements not found.");
                return;
            }

            const question = questionInput.value.trim();
            if (!question) {
                answerDisplay.innerHTML = `<p class="text-amber-300">The Chronicler awaits your query.</p>`;
                return;
            }

            answerDisplay.innerHTML = `<p class="text-sky-300 animate-pulse">The Holo-Chronicler is processing your query...</p>`;
            askButton.disabled = true;
            questionInput.disabled = true;

            const prompt = `You are an ancient Holo-Chronicler from the planet Arrakis, possessing vast knowledge of the Dune universe by Frank Herbert. Provide a concise, lore-accurate, and engaging answer to the following question. If the question is outside of Dune lore, politely state that your archives do not contain such information. Question: "${question}"`;
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; // Provided by Canvas environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    throw new Error(`API request failed with status ${response.status}: ${errorData?.error?.message || response.statusText}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // Sanitize basic HTML, or use a more robust sanitizer if needed
                    const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
                    answerDisplay.innerHTML = `<p class="text-amber-100">${sanitizedText}</p>`;
                } else {
                    answerDisplay.innerHTML = `<p class="text-red-400">The Chronicler's connection is unstable. No coherent data received.</p>`;
                    console.warn("Unexpected response structure from Gemini API:", result);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                answerDisplay.innerHTML = `<p class="text-red-500">Error: The Holo-Chronicler's circuits are damaged. ${error.message}</p>`;
            } finally {
                askButton.disabled = false;
                questionInput.disabled = false;
                questionInput.value = ""; // Clear input after asking
            }
        }
        window.askChronicler = askChronicler;
        // --- End Gemini API Integration ---


        function addLog(message, type = "info") { 
            const logScreen = document.getElementById('logScreen');
            if (!logScreen) return; 
            const newLog = document.createElement('p');
            const time = new Date().toLocaleTimeString();
            let typeColor = "text-stone-400"; 
            if (type === "success") typeColor = "text-green-400";
            else if (type === "error") typeColor = "text-red-400";
            else if (type === "warn") typeColor = "text-yellow-400";
            else if (type === "event") typeColor = "text-purple-400";
            else if (type === "lore") typeColor = "text-sky-400";
            else if (type === "action") typeColor = "text-amber-400";
            
            newLog.className = `text-sm ${typeColor} mb-1`;
            newLog.innerHTML = `<span class="text-xs text-stone-500">[${time}]</span> ${message}`;
            logScreen.appendChild(newLog);
            logScreen.scrollTop = logScreen.scrollHeight; 
            if (logScreen.children.length > 100) { 
                logScreen.removeChild(logScreen.firstChild);
            }
        }

        function updateUI() {
            if (!gameData.gameInitialized && !document.getElementById('characterCreatorScreen').classList.contains('hidden')) {
                return;
            }
            const elementsToUpdate = [
                'spiceDisplay', 'waterDisplay', 'solariDisplay', 'plasteelDisplay',
                'characterNameDisplay', 'characterHouseDisplay', 'characterBackgroundDisplay',
                'healthDisplay', 'healthBarFill', 'manualSpiceLevel', 'manualSpiceUpgradeCost',
                'autoSpiceCount', 'autoSpiceLevel', 'autoSpiceCost', 'autoSpiceUpgradeEffCost',
                'autoWaterCount', 'autoWaterLevel', 'autoWaterCost', 'autoWaterUpgradeEffCost',
                'craftingRecipesList', 'inventoryList'
            ];
            for (const id of elementsToUpdate) {
                if (!document.getElementById(id)) {
                    if (['spiceDisplay', 'characterNameDisplay'].includes(id) && gameData.gameInitialized) { 
                         console.error(`Critical UI element '${id}' not found. UI update aborted.`);
                         return;
                    }
                }
            }

            document.getElementById('spiceDisplay').textContent = Math.floor(gameData.resources.spice);
            document.getElementById('waterDisplay').textContent = Math.floor(gameData.resources.water);
            document.getElementById('solariDisplay').textContent = Math.floor(gameData.resources.solari);
            document.getElementById('plasteelDisplay').textContent = Math.floor(gameData.resources.plasteel);

            document.getElementById('characterNameDisplay').textContent = gameData.character.name;
            document.getElementById('characterHouseDisplay').textContent = gameData.character.house || "N/A";
            document.getElementById('characterBackgroundDisplay').textContent = gameData.character.background || "N/A";
            document.getElementById('healthDisplay').textContent = `${Math.floor(gameData.character.health)} / ${gameData.character.maxHealth}`;
            const healthPercentage = (gameData.character.health / gameData.character.maxHealth) * 100;
            document.getElementById('healthBarFill').style.width = `${healthPercentage}%`;

            document.getElementById('manualSpiceLevel').textContent = gameData.harvesters.spice_harvester_manual_level;
            document.getElementById('manualSpiceUpgradeCost').textContent = gameData.upgrades.spice_manual_upgrade_cost;

            document.getElementById('autoSpiceCount').textContent = gameData.harvesters.spice_harvester_auto_count;
            document.getElementById('autoSpiceLevel').textContent = gameData.harvesters.spice_harvester_auto_level;
            document.getElementById('autoSpiceCost').textContent = gameData.upgrades.spice_auto_cost;
            document.getElementById('autoSpiceUpgradeEffCost').textContent = (50 * Math.pow(1.5, gameData.harvesters.spice_harvester_auto_level)).toFixed(0);

            document.getElementById('autoWaterCount').textContent = gameData.harvesters.water_collector_auto_count;
            document.getElementById('autoWaterLevel').textContent = gameData.harvesters.water_collector_auto_level;
            document.getElementById('autoWaterCost').textContent = gameData.upgrades.water_auto_cost;
            document.getElementById('autoWaterUpgradeEffCost').textContent = (75 * Math.pow(1.6, gameData.harvesters.water_collector_auto_level)).toFixed(0);

            const craftingList = document.getElementById('craftingRecipesList');
            craftingList.innerHTML = ''; 
            gameData.craftingRecipes.forEach(recipe => {
                let costString = Object.entries(recipe.cost).map(([key, value]) => `${value} ${key.charAt(0).toUpperCase() + key.slice(1)}`).join(', ');
                const canCraft = Object.entries(recipe.cost).every(([key,value]) => gameData.resources[key] >= value);
                const buttonClass = canCraft ? 'bg-green-600 hover:bg-green-700' : 'bg-stone-500 cursor-not-allowed';

                craftingList.innerHTML += `
                    <div class="bg-stone-700 p-3 rounded-md shadow">
                        <h4 class="text-lg font-semibold text-amber-400">${recipe.name}</h4>
                        <p class="text-xs text-stone-300 mb-1">Creates: ${recipe.output.quantity}x ${recipe.output.name}</p>
                        <p class="text-xs text-stone-300 mb-1">Cost: ${costString}</p>
                        <p class="text-xs text-stone-400 italic mb-2">${recipe.description || ''}</p>
                        <button onclick="craftItem('${recipe.id}')" class="w-full text-white font-semibold py-2 px-3 rounded-md text-sm ${buttonClass} transition-colors" ${!canCraft ? 'disabled' : ''}>Craft</button>
                    </div>
                `;
            });
            
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';
            if (gameData.inventory.length === 0) {
                inventoryList.innerHTML = '<p class="text-stone-400">Your inventory is empty.</p>';
            } else {
                gameData.inventory.forEach(item => {
                    inventoryList.innerHTML += `
                        <div class="bg-stone-700 p-3 rounded-md shadow flex justify-between items-center">
                            <div>
                                <h4 class="text-md font-semibold text-amber-300">${item.name} (x${item.quantity})</h4>
                                <p class="text-xs text-stone-400">${item.type}</p>
                            </div>
                            ${item.type === 'consumable' ? `<button onclick="useItem('${item.id}')" class="bg-sky-600 hover:bg-sky-700 text-white text-xs py-1 px-2 rounded-md">Use</button>` : ''}
                        </div>
                    `;
                });
            }
        }

        function switchTab(tabName) {
            gameData.currentTab = tabName;
            document.querySelectorAll('.main-tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-amber-600', 'text-white', 'font-semibold');
                button.classList.add('bg-stone-700', 'text-amber-300');
            });

            const tabElement = document.getElementById(`${tabName}Screen`);
            const buttonElement = document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`);

            if (tabElement) {
                 tabElement.classList.remove('hidden');
            } else {
                console.error(`Tab content for '${tabName}Screen' not found.`);
            }

            if (buttonElement) {
                buttonElement.classList.add('bg-amber-600', 'text-white', 'font-semibold');
                buttonElement.classList.remove('bg-stone-700', 'text-amber-300');
            } else {
                 console.error(`Tab button for '${tabName}' not found.`);
            }

            if (['crafting', 'inventory', 'upgrades', 'character', 'chronicler'].includes(tabName)) {
                 updateUI(); 
            }
        }
        window.switchTab = switchTab;

        onAuthStateChanged(auth, async (user) => {
            const authStatusElement = document.getElementById('authStatus');
            if (user) {
                userId = user.uid;
                console.log("User is signed in with UID:", userId);
                if(authStatusElement) authStatusElement.textContent = `User ID: ${userId.substring(0,12)}...`;
                await loadGame(); 
            } else {
                console.log("User is signed out or not yet authenticated. Trying anonymous sign-in.");
                userId = `anon-${crypto.randomUUID()}`; 
                if(authStatusElement) authStatusElement.textContent = "User: Anonymous (Cloud Save Disabled)";
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during anonymous sign-in:", error);
                    if(authStatusElement) authStatusElement.textContent = "Sign-in Error. Using Local Save.";
                    loadGameLocalFallback(); 
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Ensure character creator is shown if game not initialized, otherwise default to game tab.
            if (!gameData.gameInitialized) {
                showCharacterCreator();
            } else {
                switchTab('game'); 
            }
            const appIdDisplayElement = document.getElementById('appIdDisplay');
            if (appIdDisplayElement) appIdDisplayElement.textContent = appId;
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #2B2018; }
        h1, h2, h3, h4, .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .tab-button { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .progress-bar-bg { background-color: #573B20; }
        .progress-bar-fill { background-color: #D97706; transition: width 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #403126; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #854d0e; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #a16207; }
    </style>
</head>
<body class="bg-stone-900 text-amber-50 antialiased">

    <div id="characterCreatorScreen" class="fixed inset-0 bg-stone-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="bg-stone-800 p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full">
            <h2 class="text-3xl font-orbitron text-amber-500 mb-6 text-center">Create Your Survivor</h2>
            <div class="space-y-4">
                <div>
                    <label for="characterNameInput" class="block text-sm font-medium text-amber-200 mb-1">Character Name:</label>
                    <input type="text" id="characterNameInput" value="Survivor" class="w-full bg-stone-700 text-white p-2 rounded-md border border-stone-600 focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div>
                    <p class="text-sm font-medium text-amber-200 mb-1">Choose your House Affiliation:</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div><input type="radio" name="house" value="Atreides" id="houseAtreides" class="sr-only peer"><label for="houseAtreides" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-green-600 peer-checked:text-white hover:bg-stone-600">Atreides</label></div>
                        <div><input type="radio" name="house" value="Harkonnen" id="houseHarkonnen" class="sr-only peer"><label for="houseHarkonnen" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-red-600 peer-checked:text-white hover:bg-stone-600">Harkonnen</label></div>
                        <div><input type="radio" name="house" value="Corrino" id="houseCorrino" class="sr-only peer"><label for="houseCorrino" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-yellow-500 peer-checked:text-black hover:bg-stone-600">Corrino</label></div>
                        <div><input type="radio" name="house" value="Fremen" id="houseFremen" class="sr-only peer"><label for="houseFremen" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-sky-600 peer-checked:text-white hover:bg-stone-600">Fremen</label></div>
                    </div>
                </div>
                <div>
                    <p class="text-sm font-medium text-amber-200 mb-1">Choose your Background:</p>
                     <div class="grid grid-cols-2 gap-3">
                        <div><input type="radio" name="background" value="Scout" id="bgScout" class="sr-only peer"><label for="bgScout" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-teal-600 peer-checked:text-white hover:bg-stone-600">Scout</label></div>
                        <div><input type="radio" name="background" value="Technician" id="bgTechnician" class="sr-only peer"><label for="bgTechnician" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white hover:bg-stone-600">Technician</label></div>
                        <div><input type="radio" name="background" value="Warrior" id="bgWarrior" class="sr-only peer"><label for="bgWarrior" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-rose-600 peer-checked:text-white hover:bg-stone-600">Warrior</label></div>
                        <div><input type="radio" name="background" value="Merchant" id="bgMerchant" class="sr-only peer"><label for="bgMerchant" class="block bg-stone-700 p-3 rounded-md text-center cursor-pointer peer-checked:bg-lime-600 peer-checked:text-white hover:bg-stone-600">Merchant</label></div>
                    </div>
                </div>
                <button onclick="finalizeCharacterCreation()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors mt-6">Begin Your Journey on Arrakis</button>
            </div>
        </div>
    </div>

    <div id="mainGameScreen" class="container mx-auto p-2 sm:p-4 max-w-7xl hidden">
        <header class="bg-stone-800 p-4 rounded-lg shadow-xl mb-4">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl sm:text-4xl font-orbitron text-amber-500 mb-2 sm:mb-0">Arrakis Tycoon</h1>
                <div id="authStatus" class="text-xs text-stone-400">Initializing...</div>
            </div>
             <nav class="mt-4 flex flex-wrap justify-center sm:justify-start space-x-1 sm:space-x-2">
                <button onclick="switchTab('game')" class="tab-button py-2 px-3 sm:px-4 rounded-t-md text-sm font-medium">Game</button>
                <button onclick="switchTab('character')" class="tab-button py-2 px-3 sm:px-4 rounded-t-md text-sm font-medium">Character</button>
                <button onclick="switchTab('upgrades')" class="tab-button py-2 px-3 sm:px-4 rounded-t-md text-sm font-medium">Upgrades</button>
                <button onclick="switchTab('crafting')" class="tab-button py-2 px-3 sm:px-4 rounded-t-md text-sm font-medium">Crafting</button>
                <button onclick="switchTab('inventory')" class="tab-button py-2 px-3 sm:px-4 rounded-t-md text-sm font-medium">Inventory</button>
                <button onclick="switchTab('lore')" class="tab-button py-2 px-3 sm:px-4 rounded-t-md text-sm font-medium">Lore</button>
                <button onclick="switchTab('chronicler')" class="tab-button py-2 px-3 sm:px-4 rounded-t-md text-sm font-medium">✨ Holo-Chronicler</button>
            </nav>
        </header>

        <div id="gameScreen" class="main-tab-content bg-stone-800 p-4 rounded-lg shadow-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1 space-y-4">
                    <div class="bg-stone-700 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-amber-400 mb-2">Resources</h3>
                        <p>Spice: <span id="spiceDisplay" class="font-bold text-amber-300">0</span></p>
                        <p>Water: <span id="waterDisplay" class="font-bold text-sky-300">0</span></p>
                        <p>Solari: <span id="solariDisplay" class="font-bold text-yellow-300">0</span></p>
                        <p>Plasteel: <span id="plasteelDisplay" class="font-bold text-slate-300">0</span></p>
                    </div>
                    <div class="bg-stone-700 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-amber-400 mb-2">Manual Actions</h3>
                        <button onclick="manualHarvestSpice()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-4 rounded-md mb-2">Harvest Spice</button>
                        </div>
                </div>
                <div class="md:col-span-2 bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-amber-400 mb-2">Event Log</h3>
                    <div id="logScreen" class="h-64 sm:h-96 overflow-y-auto bg-stone-800 p-3 rounded-md border border-stone-600 text-sm">
                        </div>
                </div>
            </div>
        </div>
        
        <div id="characterScreen" class="main-tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-4">Character Status</h2>
            <div class="bg-stone-700 p-4 rounded-lg shadow space-y-2">
                <p>Name: <span id="characterNameDisplay" class="font-semibold text-amber-300"></span></p>
                <p>House: <span id="characterHouseDisplay" class="font-semibold text-amber-300"></span></p>
                <p>Background: <span id="characterBackgroundDisplay" class="font-semibold text-amber-300"></span></p>
                <div>
                    <p>Health: <span id="healthDisplay" class="font-semibold text-green-400"></span></p>
                    <div class="w-full progress-bar-bg rounded-full h-4 mt-1">
                        <div id="healthBarFill" class="progress-bar-fill h-4 rounded-full"></div>
                    </div>
                </div>
                </div>
        </div>

        <div id="upgradesScreen" class="main-tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-4">Upgrades</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-amber-400 mb-2">Manual Spice Harvesting</h3>
                    <p class="text-sm text-stone-300">Level: <span id="manualSpiceLevel">1</span></p>
                    <p class="text-sm text-stone-300 mb-2">Cost: <span id="manualSpiceUpgradeCost">20</span> Solari</p>
                    <button onclick="upgradeManualSpiceHarvester()" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-md text-sm">Upgrade</button>
                </div>
                <div class="bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-amber-400 mb-2">Spice Auto-Harvesters</h3>
                    <p class="text-sm text-stone-300">Count: <span id="autoSpiceCount">0</span> | Level: <span id="autoSpiceLevel">0</span></p>
                    <p class="text-sm text-stone-300 mb-1">Buy New: <span id="autoSpiceCost">100</span> Solari</p>
                    <button onclick="buyAutoHarvester('spice')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-md text-sm mb-2">Buy Harvester</button>
                    <p class="text-sm text-stone-300 mb-1">Upgrade Efficiency: <span id="autoSpiceUpgradeEffCost">N/A</span> Solari</p>
                    <button onclick="upgradeAutoHarvester('spice')" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-md text-sm">Upgrade Efficiency</button>
                </div>
                <div class="bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-amber-400 mb-2">Water Auto-Collectors</h3>
                    <p class="text-sm text-stone-300">Count: <span id="autoWaterCount">0</span> | Level: <span id="autoWaterLevel">0</span></p>
                    <p class="text-sm text-stone-300 mb-1">Buy New: <span id="autoWaterCost">150</span> Solari</p>
                    <button onclick="buyAutoHarvester('water')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-md text-sm mb-2">Buy Collector</button>
                    <p class="text-sm text-stone-300 mb-1">Upgrade Efficiency: <span id="autoWaterUpgradeEffCost">N/A</span> Solari</p>
                    <button onclick="upgradeAutoHarvester('water')" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-md text-sm">Upgrade Efficiency</button>
                </div>
                </div>
        </div>
        
        <div id="craftingScreen" class="main-tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-4">Crafting Station</h2>
            <div id="craftingRecipesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </div>
        
        <div id="inventoryScreen" class="main-tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-4">Inventory</h2>
            <div id="inventoryList" class="space-y-3">
                </div>
        </div>

        <div id="loreScreen" class="main-tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-4">Whispers of Arrakis (Lore)</h2>
            <div id="loreContent" class="prose prose-sm sm:prose prose-invert max-w-none bg-stone-700 p-4 rounded-md shadow h-96 overflow-y-auto">
                <h3 class="text-amber-400">The Spice Melange</h3>
                <p>Melange, colloquially known as "the spice," is a psychoactive chemical substance found only on the desert planet Arrakis. It is the most valuable and rarest commodity in the Imperium.</p>
                <p>The spice extends life, enhances sensory perception and awareness, and for a select few, unlocks prescience—the ability to see limited pathways of the future. This prescience is essential for Navigators of the Spacing Guild, who use it to guide starships through foldspace, making interstellar travel possible.</p>
                <h3 class="text-amber-400">Shai-Hulud (The Sandworms)</h3>
                <p>The great sandworms of Arrakis, also known by the Fremen as Shai-Hulud or "Old Man of the Desert," are colossal creatures that dominate the deep desert. They are inextricably linked to the spice cycle...</p>
                <h3 class="text-amber-400">The Fremen</h3>
                <p>The Fremen are the native human inhabitants of Arrakis...</p>
                <h3 class="text-amber-400">The Stillsuit</h3>
                <p>A stillsuit is a full-body suit worn in the open desert of Arrakis...</p>
            </div>
        </div>

        <div id="chroniclerScreen" class="main-tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-4">✨ Holo-Chronicler Archives</h2>
            <p class="text-amber-200 mb-4">Pose your questions about the vast Dune universe to the ancient Holo-Chronicler. Its knowledge is immense, drawn from centuries of data.</p>
            <div class="bg-stone-700 p-4 rounded-lg shadow">
                <textarea id="chroniclerQuestion" rows="3" class="w-full bg-stone-600 text-amber-50 p-2 rounded-md border border-stone-500 focus:ring-amber-500 focus:border-amber-500 placeholder-stone-400" placeholder="Ask about Houses, planets, technology, creatures, history..."></textarea>
                <button id="askChroniclerBtn" onclick="askChronicler()" class="mt-3 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md transition-colors">Query the Chronicler ✨</button>
                <div id="chroniclerAnswer" class="mt-4 prose prose-sm sm:prose prose-invert max-w-none bg-stone-800 p-3 rounded-md border border-stone-600 min-h-[100px]">
                    <p class="text-stone-400">The Chronicler awaits your query.</p>
                </div>
            </div>
        </div>


        <footer class="text-center mt-8 py-4 border-t border-stone-700">
            <p class="text-xs text-stone-400">Arrakis Tycoon v0.1.1 - A fan-made idle game. All Dune IP &copy; Herbert Properties LLC. Game &copy; Funcom.</p>
            <p class="text-xs text-stone-500 mt-1">App ID: <span id="appIdDisplay"></span></p>
        </footer>
    </div>

</body>
</html>
