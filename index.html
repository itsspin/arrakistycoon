<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrakis Tycoon - Dune MMO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1c1917; }
        h1, h2, h3, h4, .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { border-bottom-color: #f59e0b; color: #f59e0b; }
        .progress-bar-bg { background-color: #57534e; }
        .progress-bar-fill { background-color: #f59e0b; transition: width 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #44403c; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #d6d3d1; }
        .map-grid { display: grid; gap: 1px; background-color: #292524; border: 1px solid #44403c; }
        .map-cell { 
            width: 2rem; height: 2rem; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.75rem; font-weight: bold; border-radius: 0.125rem; 
            cursor: pointer; transition: all 0.1s; position: relative;
        }
        .map-cell:hover { transform: scale(1.1); z-index: 10; }
        .map-scroll-container { max-width: 100%; overflow: auto; max-height: 70vh; }
        .resource-indicator { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; border-radius: 50%; }
        .player-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-stone-900 text-amber-50 antialiased">

    <script type="module">
        // ===== CORE GAME STATE MANAGEMENT =====
        class GameState {
            constructor() {
                this.initialized = false;
                this.loading = true;
                this.currentTab = 'game';
                this.lastUpdate = Date.now();
                this.gameSpeed = 1000; // ms per tick
                
                // Player data
                this.player = {
                    id: null,
                    name: 'Survivor',
                    house: null,
                    background: null,
                    level: 1,
                    experience: 0,
                    experienceToNext: 100,
                    health: 100,
                    maxHealth: 100,
                    attack: 10,
                    defense: 5,
                    position: { x: 25, y: 25 },
                    equipment: { weapon: null, armor: null, accessory: null },
                    online: false
                };
                
                // Resources
                this.resources = {
                    spice: 0,
                    water: 50,
                    solari: 200,
                    plasteel: 0,
                    food: 20
                };
                
                // Production systems
                this.production = {
                    manual: {
                        spice: { level: 1, efficiency: 1 }
                    },
                    auto: {
                        spice: { count: 0, level: 0, efficiency: 1 },
                        water: { count: 0, level: 0, efficiency: 1 }
                    }
                };
                
                // Upgrade costs
                this.upgrades = {
                    manualSpice: 20,
                    autoSpice: 100,
                    autoWater: 150
                };
                
                // Inventory and crafting
                this.inventory = [];
                this.buildings = [];
                this.units = [];
                
                // Map and exploration
                this.map = {
                    width: 50,
                    height: 50,
                    explored: new Set(),
                    visibleRadius: 3,
                    resources: new Map(),
                    enemies: new Map(),
                    locations: new Map()
                };
                
                // Combat system
                this.combat = {
                    active: false,
                    enemy: null,
                    playerTurn: true,
                    messages: []
                };
                
                // Quest system
                this.quests = new Map();
                
                // Statistics
                this.stats = {
                    spiceHarvested: 0,
                    solariEarned: 0,
                    enemiesDefeated: 0,
                    areasExplored: 0,
                    questsCompleted: 0
                };
                
                this.initializeStaticData();
            }
            
            initializeStaticData() {
                // Initialize static locations
                this.map.locations.set('25,25', {
                    type: 'settlement',
                    name: 'Starting Outpost',
                    description: 'Your humble beginning on Arrakis',
                    friendly: true
                });
                
                this.map.locations.set('40,40', {
                    type: 'settlement',
                    name: 'Arrakeen',
                    description: 'The planetary capital',
                    friendly: true,
                    market: true
                });
                
                this.map.locations.set('10,10', {
                    type: 'ruins',
                    name: 'Ancient Outpost',
                    description: 'Ruins holding secrets',
                    loot: true
                });
                
                // Initialize starting quest
                this.quests.set('q1', {
                    id: 'q1',
                    title: 'First Steps on Arrakis',
                    description: 'Learn the basics of survival',
                    objectives: [
                        { id: 'harvest_spice', description: 'Harvest 50 Spice', target: 'spice', amount: 50, progress: 0, completed: false },
                        { id: 'explore_areas', description: 'Explore 5 areas', target: 'explore', amount: 5, progress: 0, completed: false }
                    ],
                    rewards: { solari: 100, experience: 50 },
                    active: true,
                    completed: false
                });
            }
            
            // Save/Load functionality
            save() {
                const saveData = {
                    player: this.player,
                    resources: this.resources,
                    production: this.production,
                    upgrades: this.upgrades,
                    inventory: this.inventory,
                    buildings: this.buildings,
                    units: this.units,
                    map: {
                        explored: Array.from(this.map.explored),
                        resources: Array.from(this.map.resources.entries()),
                        enemies: Array.from(this.map.enemies.entries())
                    },
                    quests: Array.from(this.quests.entries()),
                    stats: this.stats,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('arrakisTycoonSave', JSON.stringify(saveData));
                this.log('Game saved successfully', 'success');
            }
            
            load() {
                const saveData = localStorage.getItem('arrakisTycoonSave');
                if (!saveData) return false;
                
                try {
                    const data = JSON.parse(saveData);
                    
                    // Restore data
                    Object.assign(this.player, data.player);
                    Object.assign(this.resources, data.resources);
                    Object.assign(this.production, data.production);
                    Object.assign(this.upgrades, data.upgrades);
                    this.inventory = data.inventory || [];
                    this.buildings = data.buildings || [];
                    this.units = data.units || [];
                    
                    // Restore map data
                    this.map.explored = new Set(data.map.explored || []);
                    this.map.resources = new Map(data.map.resources || []);
                    this.map.enemies = new Map(data.map.enemies || []);
                    
                    // Restore quests
                    this.quests = new Map(data.quests || []);
                    
                    Object.assign(this.stats, data.stats);
                    
                    this.log('Game loaded successfully', 'success');
                    return true;
                } catch (error) {
                    console.error('Failed to load save data:', error);
                    return false;
                }
            }
            
            // Logging system
            log(message, type = 'info') {
                const logContainer = document.getElementById('gameLog');
                if (!logContainer) return;
                
                const logEntry = document.createElement('div');
                logEntry.className = `text-sm mb-1 ${this.getLogColor(type)}`;
                
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                logEntry.innerHTML = `<span class="text-xs text-stone-500">[${timestamp}]</span> ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 100 messages
                while (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
            
            getLogColor(type) {
                const colors = {
                    info: 'text-stone-300',
                    success: 'text-green-400',
                    error: 'text-red-400',
                    warning: 'text-yellow-400',
                    event: 'text-purple-400',
                    combat: 'text-rose-400',
                    action: 'text-amber-400'
                };
                return colors[type] || colors.info;
            }
        }

        // ===== RESOURCE MANAGEMENT SYSTEM =====
        class ResourceManager {
            constructor(gameState) {
                this.gameState = gameState;
            }
            
            // Manual resource gathering
            harvestSpice() {
                const amount = this.gameState.production.manual.spice.level * this.gameState.production.manual.spice.efficiency;
                this.gameState.resources.spice += amount;
                this.gameState.stats.spiceHarvested += amount;
                
                this.gameState.log(`Harvested ${amount} Spice manually`, 'action');
                this.updateQuestProgress('spice', amount);
                
                return amount;
            }
            
            // Automatic resource production (called each game tick)
            processAutoProduction() {
                // Spice auto-harvesters
                const spiceProduction = this.gameState.production.auto.spice;
                if (spiceProduction.count > 0) {
                    const amount = spiceProduction.count * spiceProduction.level * spiceProduction.efficiency;
                    this.gameState.resources.spice += amount;
                    this.gameState.stats.spiceHarvested += amount;
                }
                
                // Water auto-collectors
                const waterProduction = this.gameState.production.auto.water;
                if (waterProduction.count > 0) {
                    const amount = waterProduction.count * waterProduction.level * waterProduction.efficiency;
                    this.gameState.resources.water += amount;
                }
                
                // Building production
                this.gameState.buildings.forEach(building => {
                    if (building.level > 0 && building.production) {
                        Object.entries(building.production).forEach(([resource, amount]) => {
                            this.gameState.resources[resource] += amount * building.level;
                        });
                    }
                });
                
                // Unit upkeep
                this.gameState.units.forEach(unit => {
                    if (unit.count > 0 && unit.upkeep) {
                        Object.entries(unit.upkeep).forEach(([resource, amount]) => {
                            this.gameState.resources[resource] -= amount * unit.count;
                            if (this.gameState.resources[resource] < 0) {
                                this.gameState.resources[resource] = 0;
                            }
                        });
                    }
                });
            }
            
            // Resource spending
            canAfford(costs) {
                return Object.entries(costs).every(([resource, amount]) => 
                    this.gameState.resources[resource] >= amount
                );
            }
            
            spend(costs) {
                if (!this.canAfford(costs)) return false;
                
                Object.entries(costs).forEach(([resource, amount]) => {
                    this.gameState.resources[resource] -= amount;
                });
                
                return true;
            }
            
            // Upgrade systems
            upgradeManualSpice() {
                const cost = this.gameState.upgrades.manualSpice;
                if (!this.canAfford({ solari: cost })) {
                    this.gameState.log('Not enough Solari for upgrade', 'error');
                    return false;
                }
                
                this.spend({ solari: cost });
                this.gameState.production.manual.spice.level++;
                this.gameState.upgrades.manualSpice = Math.floor(cost * 1.5);
                
                this.gameState.log('Manual spice harvesting upgraded!', 'success');
                return true;
            }
            
            buyAutoHarvester(type) {
                const cost = this.gameState.upgrades[`auto${type.charAt(0).toUpperCase() + type.slice(1)}`];
                if (!this.canAfford({ solari: cost })) {
                    this.gameState.log('Not enough Solari for auto-harvester', 'error');
                    return false;
                }
                
                this.spend({ solari: cost });
                this.gameState.production.auto[type].count++;
                this.gameState.upgrades[`auto${type.charAt(0).toUpperCase() + type.slice(1)}`] = Math.floor(cost * 1.25);
                
                this.gameState.log(`Purchased ${type} auto-harvester!`, 'success');
                return true;
            }
            
            upgradeAutoHarvester(type) {
                const production = this.gameState.production.auto[type];
                if (production.count === 0) {
                    this.gameState.log(`No ${type} harvesters to upgrade`, 'warning');
                    return false;
                }
                
                const cost = Math.floor(100 * Math.pow(1.8, production.level) * production.count);
                if (!this.canAfford({ solari: cost })) {
                    this.gameState.log('Not enough Solari for upgrade', 'error');
                    return false;
                }
                
                this.spend({ solari: cost });
                production.level++;
                production.efficiency = 1 + (production.level * 0.5);
                
                this.gameState.log(`${type} auto-harvester efficiency upgraded!`, 'success');
                return true;
            }
            
            updateQuestProgress(type, amount) {
                this.gameState.quests.forEach(quest => {
                    if (!quest.active || quest.completed) return;
                    
                    quest.objectives.forEach(objective => {
                        if (objective.completed || objective.target !== type) return;
                        
                        objective.progress += amount;
                        if (objective.progress >= objective.amount) {
                            objective.completed = true;
                            this.gameState.log(`Objective completed: ${objective.description}`, 'event');
                            this.checkQuestCompletion(quest);
                        }
                    });
                });
            }
            
            checkQuestCompletion(quest) {
                if (quest.objectives.every(obj => obj.completed)) {
                    quest.completed = true;
                    quest.active = false;
                    
                    // Apply rewards
                    Object.entries(quest.rewards).forEach(([resource, amount]) => {
                        if (resource === 'experience') {
                            this.gameState.player.experience += amount;
                            this.checkLevelUp();
                        } else {
                            this.gameState.resources[resource] += amount;
                        }
                    });
                    
                    this.gameState.stats.questsCompleted++;
                    this.gameState.log(`Quest completed: ${quest.title}!`, 'success');
                }
            }
            
            checkLevelUp() {
                while (this.gameState.player.experience >= this.gameState.player.experienceToNext) {
                    this.gameState.player.level++;
                    this.gameState.player.experience -= this.gameState.player.experienceToNext;
                    this.gameState.player.experienceToNext = Math.floor(this.gameState.player.experienceToNext * 1.5);
                    
                    // Increase stats
                    this.gameState.player.maxHealth += 15;
                    this.gameState.player.health = this.gameState.player.maxHealth;
                    this.gameState.player.attack += 2;
                    this.gameState.player.defense += 1;
                    
                    this.gameState.log(`Level up! You are now level ${this.gameState.player.level}`, 'success');
                }
            }
        }

        // ===== MOVEMENT AND EXPLORATION SYSTEM =====
        class MovementSystem {
            constructor(gameState) {
                this.gameState = gameState;
                this.movementCost = 1; // Water cost per move
            }
            
            canMoveTo(x, y) {
                // Check bounds
                if (x < 0 || x >= this.gameState.map.width || y < 0 || y >= this.gameState.map.height) {
                    return { valid: false, reason: 'Out of bounds' };
                }
                
                // Check water cost
                if (this.gameState.resources.water < this.movementCost) {
                    return { valid: false, reason: 'Not enough water' };
                }
                
                // Check if in combat
                if (this.gameState.combat.active) {
                    return { valid: false, reason: 'Cannot move during combat' };
                }
                
                return { valid: true };
            }
            
            movePlayer(x, y) {
                const currentPos = this.gameState.player.position;
                
                // Validate movement (only adjacent cells or direct coordinate input)
                const dx = Math.abs(x - currentPos.x);
                const dy = Math.abs(y - currentPos.y);
                
                if (dx > 1 || dy > 1 || (dx === 0 && dy === 0)) {
                    this.gameState.log('Can only move to adjacent cells', 'warning');
                    return false;
                }
                
                const moveCheck = this.canMoveTo(x, y);
                if (!moveCheck.valid) {
                    this.gameState.log(moveCheck.reason, 'error');
                    return false;
                }
                
                // Execute movement
                this.gameState.resources.water -= this.movementCost;
                this.gameState.player.position = { x, y };
                
                // Explore new area
                this.exploreArea(x, y);
                
                // Check for encounters
                this.checkEncounters(x, y);
                
                this.gameState.log(`Moved to (${x}, ${y})`, 'action');
                return true;
            }
            
            moveDirection(direction) {
                const pos = this.gameState.player.position;
                let newX = pos.x;
                let newY = pos.y;
                
                switch (direction) {
                    case 'north': newY = pos.y - 1; break;
                    case 'south': newY = pos.y + 1; break;
                    case 'west': newX = pos.x - 1; break;
                    case 'east': newX = pos.x + 1; break;
                    default: return false;
                }
                
                return this.movePlayer(newX, newY);
            }
            
            exploreArea(x, y) {
                const key = `${x},${y}`;
                
                // Mark current position as explored
                if (!this.gameState.map.explored.has(key)) {
                    this.gameState.map.explored.add(key);
                    this.gameState.stats.areasExplored++;
                    
                    // Update quest progress
                    this.updateExploreQuests();
                }
                
                // Explore visible radius
                for (let dx = -this.gameState.map.visibleRadius; dx <= this.gameState.map.visibleRadius; dx++) {
                    for (let dy = -this.gameState.map.visibleRadius; dy <= this.gameState.map.visibleRadius; dy++) {
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance <= this.gameState.map.visibleRadius) {
                            const exploreKey = `${x + dx},${y + dy}`;
                            if (!this.gameState.map.explored.has(exploreKey)) {
                                this.gameState.map.explored.add(exploreKey);
                                this.gameState.stats.areasExplored++;
                            }
                        }
                    }
                }
            }
            
            updateExploreQuests() {
                this.gameState.quests.forEach(quest => {
                    if (!quest.active || quest.completed) return;
                    
                    quest.objectives.forEach(objective => {
                        if (objective.completed || objective.target !== 'explore') return;
                        
                        objective.progress = this.gameState.stats.areasExplored;
                        if (objective.progress >= objective.amount) {
                            objective.completed = true;
                            this.gameState.log(`Objective completed: ${objective.description}`, 'event');
                        }
                    });
                });
            }
            
            checkEncounters(x, y) {
                const key = `${x},${y}`;
                
                // Check for locations
                const location = this.gameState.map.locations.get(key);
                if (location) {
                    this.gameState.log(`Discovered ${location.name}: ${location.description}`, 'event');
                    
                    if (location.loot) {
                        this.generateLoot();
                    }
                }
                
                // Check for resource nodes
                const resource = this.gameState.map.resources.get(key);
                if (resource && resource.amount > 0) {
                    this.gameState.log(`Found ${resource.type} deposit (${resource.amount} remaining)`, 'event');
                }
                
                // Check for enemies
                const enemy = this.gameState.map.enemies.get(key);
                if (enemy && enemy.health > 0) {
                    this.gameState.log(`Encountered ${enemy.name}!`, 'combat');
                    this.initiateCombat(enemy);
                }
                
                // Random encounters
                if (Math.random() < 0.1) {
                    this.randomEncounter();
                }
            }
            
            generateLoot() {
                const lootTable = [
                    { resource: 'solari', amount: () => Math.floor(Math.random() * 50) + 25 },
                    { resource: 'spice', amount: () => Math.floor(Math.random() * 20) + 10 },
                    { resource: 'water', amount: () => Math.floor(Math.random() * 15) + 5 },
                    { resource: 'plasteel', amount: () => Math.floor(Math.random() * 10) + 3 }
                ];
                
                const loot = lootTable[Math.floor(Math.random() * lootTable.length)];
                const amount = loot.amount();
                
                this.gameState.resources[loot.resource] += amount;
                this.gameState.log(`Found ${amount} ${loot.resource}!`, 'success');
            }
            
            randomEncounter() {
                const encounters = [
                    { message: 'A desert wind reveals a small spice cache', reward: { spice: 5 } },
                    { message: 'You find a abandoned water container', reward: { water: 3 } },
                    { message: 'Scavenged materials from old equipment', reward: { plasteel: 2 } },
                    { message: 'A Fremen trader offers a small gift', reward: { solari: 15 } }
                ];
                
                const encounter = encounters[Math.floor(Math.random() * encounters.length)];
                this.gameState.log(encounter.message, 'event');
                
                Object.entries(encounter.reward).forEach(([resource, amount]) => {
                    this.gameState.resources[resource] += amount;
                });
            }
            
            initiateCombat(enemy) {
                this.gameState.combat.active = true;
                this.gameState.combat.enemy = { ...enemy };
                this.gameState.combat.playerTurn = true;
                this.gameState.combat.messages = [`Combat initiated with ${enemy.name}!`];
                
                // Show combat UI
                document.getElementById('combatModal').classList.remove('hidden');
                this.updateCombatUI();
            }
            
            updateCombatUI() {
                if (!this.gameState.combat.active) return;
                
                const enemy = this.gameState.combat.enemy;
                const player = this.gameState.player;
                
                document.getElementById('combatEnemyName').textContent = enemy.name;
                document.getElementById('combatEnemyHealth').textContent = `${enemy.health} / ${enemy.maxHealth || enemy.health}`;
                document.getElementById('combatPlayerHealth').textContent = `${Math.floor(player.health)} / ${player.maxHealth}`;
                
                // Update health bars
                const enemyHealthPercent = (enemy.health / (enemy.maxHealth || enemy.health)) * 100;
                const playerHealthPercent = (player.health / player.maxHealth) * 100;
                
                document.getElementById('combatEnemyHealthBar').style.width = `${enemyHealthPercent}%`;
                document.getElementById('combatPlayerHealthBar').style.width = `${playerHealthPercent}%`;
                
                // Update combat log
                const logContainer = document.getElementById('combatLog');
                logContainer.innerHTML = this.gameState.combat.messages.map(msg => `<p class="text-sm">${msg}</p>`).join('');
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Update button states
                document.getElementById('combatAttackBtn').disabled = !this.gameState.combat.playerTurn;
                document.getElementById('combatFleeBtn').disabled = !this.gameState.combat.playerTurn;
            }
        }

        // ===== MAP RENDERING SYSTEM =====
        class MapRenderer {
            constructor(gameState) {
                this.gameState = gameState;
                this.cellSize = 32; // pixels
            }
            
            render() {
                const container = document.getElementById('mapContainer');
                if (!container) return;
                
                container.innerHTML = '';
                container.style.gridTemplateColumns = `repeat(${this.gameState.map.width}, 1fr)`;
                container.className = 'map-grid';
                
                const playerPos = this.gameState.player.position;
                
                for (let y = 0; y < this.gameState.map.height; y++) {
                    for (let x = 0; x < this.gameState.map.width; x++) {
                        const cell = this.createMapCell(x, y, playerPos);
                        container.appendChild(cell);
                    }
                }
                
                // Center view on player
                this.centerOnPlayer();
            }
            
            createMapCell(x, y, playerPos) {
                const cell = document.createElement('div');
                cell.className = 'map-cell';
                cell.dataset.x = x;
                cell.dataset.y = y;
                
                const key = `${x},${y}`;
                const isExplored = this.gameState.map.explored.has(key);
                const isPlayerCell = playerPos.x === x && playerPos.y === y;
                const distanceToPlayer = Math.sqrt(Math.pow(playerPos.x - x, 2) + Math.pow(playerPos.y - y, 2));
                
                // Determine cell appearance
                if (!isExplored && distanceToPlayer > this.gameState.map.visibleRadius + 1) {
                    // Unexplored and far
                    cell.classList.add('bg-stone-900', 'text-stone-700');
                    cell.textContent = '';
                } else if (!isExplored) {
                    // Unexplored but visible
                    cell.classList.add('bg-stone-800', 'text-stone-600');
                    cell.textContent = '?';
                } else {
                    // Explored
                    cell.classList.add('bg-amber-800', 'hover:bg-amber-700', 'text-amber-200');
                    
                    // Check for special features
                    this.addCellFeatures(cell, x, y, key);
                }
                
                // Player position
                if (isPlayerCell) {
                    cell.innerHTML = '🤠';
                    cell.classList.add('bg-yellow-500', 'text-black', 'player-indicator');
                    cell.title = `${this.gameState.player.name} (You)`;
                }
                
                // Add click handler for movement
                if (!isPlayerCell && isExplored) {
                    cell.addEventListener('click', () => this.handleCellClick(x, y));
                }
                
                return cell;
            }
            
            addCellFeatures(cell, x, y, key) {
                // Locations
                const location = this.gameState.map.locations.get(key);
                if (location) {
                    const icons = {
                        settlement: '🏠',
                        ruins: '🏛️',
                        oasis: '💧',
                        outpost: '🏭'
                    };
                    
                    cell.innerHTML = icons[location.type] || '📍';
                    cell.classList.add(location.friendly ? 'bg-green-700' : 'bg-red-700', 'text-white');
                    cell.title = location.name;
                    return;
                }
                
                // Resource nodes
                const resource = this.gameState.map.resources.get(key);
                if (resource && resource.amount > 0) {
                    const icons = {
                        spice: '✨',
                        water: '💧',
                        plasteel: '🔩'
                    };
                    
                    cell.innerHTML = icons[resource.type] || '💎';
                    cell.classList.add('bg-orange-600', 'text-white');
                    cell.title = `${resource.type} (${resource.amount})`;
                    
                    // Add resource indicator
                    const indicator = document.createElement('div');
                    indicator.className = 'resource-indicator bg-orange-400';
                    cell.appendChild(indicator);
                    
                    cell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.harvestResource(x, y);
                    });
                    return;
                }
                
                // Enemies
                const enemy = this.gameState.map.enemies.get(key);
                if (enemy && enemy.health > 0) {
                    cell.innerHTML = '💀';
                    cell.classList.add('bg-red-600', 'text-white');
                    cell.title = enemy.name;
                    return;
                }
            }
            
            handleCellClick(x, y) {
                const movementSystem = new MovementSystem(this.gameState);
                if (movementSystem.movePlayer(x, y)) {
                    this.render();
                    uiManager.updateAll();
                }
            }
            
            harvestResource(x, y) {
                const key = `${x},${y}`;
                const resource = this.gameState.map.resources.get(key);
                
                if (!resource || resource.amount <= 0) {
                    this.gameState.log('No resources to harvest here', 'warning');
                    return;
                }
                
                // Check if player is adjacent
                const playerPos = this.gameState.player.position;
                const distance = Math.abs(playerPos.x - x) + Math.abs(playerPos.y - y);
                
                if (distance > 1) {
                    this.gameState.log('Must be adjacent to harvest resources', 'warning');
                    return;
                }
                
                // Harvest resource
                const harvestAmount = Math.min(resource.amount, Math.floor(Math.random() * 10) + 5);
                resource.amount -= harvestAmount;
                this.gameState.resources[resource.type] += harvestAmount;
                
                this.gameState.log(`Harvested ${harvestAmount} ${resource.type}`, 'success');
                
                // Remove depleted resource
                if (resource.amount <= 0) {
                    this.gameState.map.resources.delete(key);
                    this.gameState.log(`${resource.type} deposit depleted`, 'info');
                }
                
                this.render();
                uiManager.updateAll();
            }
            
            centerOnPlayer() {
                const container = document.getElementById('mapContainer');
                const scrollContainer = container.parentElement;
                
                if (!scrollContainer || !scrollContainer.scrollTo) return;
                
                const playerPos = this.gameState.player.position;
                const cellElement = container.querySelector(`[data-x="${playerPos.x}"][data-y="${playerPos.y}"]`);
                
                if (cellElement) {
                    const scrollLeft = cellElement.offsetLeft - scrollContainer.offsetWidth / 2 + this.cellSize / 2;
                    const scrollTop = cellElement.offsetTop - scrollContainer.offsetHeight / 2 + cellElement.offsetHeight / 2;
                    
                    scrollContainer.scrollTo({
                        left: Math.max(0, scrollLeft),
                        top: Math.max(0, scrollTop),
                        behavior: 'smooth'
                    });
                }
            }
        }

        // ===== UI MANAGEMENT SYSTEM =====
        class UIManager {
            constructor(gameState) {
                this.gameState = gameState;
            }
            
            updateAll() {
                this.updateResources();
                this.updateCharacterInfo();
                this.updateProduction();
                this.updateQuests();
                this.updatePosition();
            }
            
            updateResources() {
                const resources = ['spice', 'water', 'solari', 'plasteel', 'food'];
                resources.forEach(resource => {
                    const element = document.getElementById(`${resource}Display`);
                    if (element) {
                        element.textContent = Math.floor(this.gameState.resources[resource]);
                    }
                });
            }
            
            updateCharacterInfo() {
                const player = this.gameState.player;
                
                // Basic info
                this.updateElement('characterName', player.name);
                this.updateElement('characterHouse', player.house || 'None');
                this.updateElement('characterBackground', player.background || 'None');
                this.updateElement('characterLevel', player.level);
                this.updateElement('characterExp', `${player.experience} / ${player.experienceToNext}`);
                this.updateElement('characterAttack', player.attack);
                this.updateElement('characterDefense', player.defense);
                
                // Health bar
                this.updateElement('healthDisplay', `${Math.floor(player.health)} / ${player.maxHealth}`);
                this.updateElement('healthDisplayMain', `${Math.floor(player.health)} / ${player.maxHealth}`);
                
                const healthPercent = (player.health / player.maxHealth) * 100;
                this.updateElement('healthBar', null, (el) => el.style.width = `${healthPercent}%`);
                this.updateElement('healthBarMain', null, (el) => el.style.width = `${healthPercent}%`);
            }
            
            updateProduction() {
                // Manual spice
                this.updateElement('manualSpiceLevel', this.gameState.production.manual.spice.level);
                this.updateElement('manualSpiceUpgradeCost', this.gameState.upgrades.manualSpice);
                
                // Auto spice
                const autoSpice = this.gameState.production.auto.spice;
                this.updateElement('autoSpiceCount', autoSpice.count);
                this.updateElement('autoSpiceLevel', autoSpice.level);
                this.updateElement('autoSpiceCost', this.gameState.upgrades.autoSpice);
                
                const spiceUpgradeCost = autoSpice.count > 0 ? 
                    Math.floor(100 * Math.pow(1.8, autoSpice.level) * autoSpice.count) : 'N/A';
                this.updateElement('autoSpiceUpgradeCost', spiceUpgradeCost);
                
                // Auto water
                const autoWater = this.gameState.production.auto.water;
                this.updateElement('autoWaterCount', autoWater.count);
                this.updateElement('autoWaterLevel', autoWater.level);
                this.updateElement('autoWaterCost', this.gameState.upgrades.autoWater);
                
                const waterUpgradeCost = autoWater.count > 0 ? 
                    Math.floor(100 * Math.pow(1.8, autoWater.level) * autoWater.count) : 'N/A';
                this.updateElement('autoWaterUpgradeCost', waterUpgradeCost);
            }
            
            updateQuests() {
                const container = document.getElementById('questsList');
                if (!container) return;
                
                container.innerHTML = '';
                
                const activeQuests = Array.from(this.gameState.quests.values()).filter(q => q.active && !q.completed);
                
                if (activeQuests.length === 0) {
                    container.innerHTML = '<p class="text-stone-400">No active quests</p>';
                    return;
                }
                
                activeQuests.forEach(quest => {
                    const questElement = document.createElement('div');
                    questElement.className = 'bg-stone-700 p-3 rounded-lg shadow';
                    
                    let objectivesHtml = quest.objectives.map(obj => {
                        const status = obj.completed ? 'text-green-400 line-through' : 'text-stone-300';
                        const progress = obj.amount > 1 ? ` (${obj.progress}/${obj.amount})` : '';
                        return `<li class="${status}">${obj.description}${progress}</li>`;
                    }).join('');
                    
                    questElement.innerHTML = `
                        <h3 class="text-lg font-semibold text-amber-400 mb-2">${quest.title}</h3>
                        <p class="text-sm text-stone-300 mb-2">${quest.description}</p>
                        <ul class="list-disc list-inside text-sm space-y-1">${objectivesHtml}</ul>
                    `;
                    
                    container.appendChild(questElement);
                });
            }
            
            updatePosition() {
                const pos = this.gameState.player.position;
                this.updateElement('playerX', pos.x);
                this.updateElement('playerY', pos.y);
            }
            
            updateElement(id, value, customUpdate = null) {
                const element = document.getElementById(id);
                if (!element) return;
                
                if (customUpdate) {
                    customUpdate(element);
                } else if (value !== null && value !== undefined) {
                    element.textContent = value;
                }
            }
            
            switchTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                // Remove active class from all buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active', 'border-amber-500', 'text-amber-500');
                    button.classList.add('text-stone-400', 'border-transparent');
                });
                
                // Show selected tab
                const tabContent = document.getElementById(`${tabName}Tab`);
                if (tabContent) {
                    tabContent.classList.remove('hidden');
                }
                
                // Activate button
                const button = document.querySelector(`[data-tab="${tabName}"]`);
                if (button) {
                    button.classList.add('active', 'border-amber-500', 'text-amber-500');
                    button.classList.remove('text-stone-400', 'border-transparent');
                }
                
                this.gameState.currentTab = tabName;
                
                // Special handling for map tab
                if (tabName === 'map') {
                    setTimeout(() => mapRenderer.render(), 100);
                }
            }
        }

        // ===== COMBAT SYSTEM =====
        class CombatSystem {
            constructor(gameState) {
                this.gameState = gameState;
            }
            
            performAction(action) {
                if (!this.gameState.combat.active || !this.gameState.combat.playerTurn) return;
                
                const enemy = this.gameState.combat.enemy;
                const player = this.gameState.player;
                
                if (action === 'attack') {
                    // Player attacks
                    const damage = Math.max(1, player.attack - (enemy.defense || 0));
                    enemy.health -= damage;
                    
                    this.gameState.combat.messages.push(`You attack ${enemy.name} for ${damage} damage!`);
                    
                    if (enemy.health <= 0) {
                        this.endCombat(true);
                        return;
                    }
                } else if (action === 'flee') {
                    if (Math.random() < 0.6) {
                        this.gameState.combat.messages.push('You successfully fled!');
                        this.endCombat(false, true);
                        return;
                    } else {
                        this.gameState.combat.messages.push('Failed to flee!');
                    }
                }
                
                // Enemy turn
                this.gameState.combat.playerTurn = false;
                
                setTimeout(() => {
                    if (!this.gameState.combat.active) return;
                    
                    const enemyDamage = Math.max(1, (enemy.attack || 5) - player.defense);
                    player.health -= enemyDamage;
                    
                    this.gameState.combat.messages.push(`${enemy.name} attacks you for ${enemyDamage} damage!`);
                    
                    if (player.health <= 0) {
                        this.endCombat(false);
                        return;
                    }
                    
                    this.gameState.combat.playerTurn = true;
                    movementSystem.updateCombatUI();
                }, 1000);
                
                movementSystem.updateCombatUI();
            }
            
            endCombat(victory, fled = false) {
                const enemy = this.gameState.combat.enemy;
                
                if (victory) {
                    this.gameState.log(`Defeated ${enemy.name}!`, 'success');
                    this.gameState.stats.enemiesDefeated++;
                    
                    // Experience gain
                    const expGain = Math.floor((enemy.maxHealth || enemy.health) / 4) + 10;
                    this.gameState.player.experience += expGain;
                    this.gameState.log(`Gained ${expGain} experience`, 'success');
                    
                    // Loot
                    if (enemy.loot) {
                        Object.entries(enemy.loot).forEach(([resource, amount]) => {
                            this.gameState.resources[resource] += amount;
                            this.gameState.log(`Looted ${amount} ${resource}`, 'success');
                        });
                    }
                    
                    // Remove enemy from map
                    const pos = this.gameState.player.position;
                    this.gameState.map.enemies.delete(`${pos.x},${pos.y}`);
                    
                    resourceManager.checkLevelUp();
                } else if (fled) {
                    this.gameState.log(`Fled from ${enemy.name}`, 'action');
                } else {
                    this.gameState.log('You were defeated!', 'error');
                    
                    // Death penalty
                    this.gameState.player.health = Math.floor(this.gameState.player.maxHealth * 0.5);
                    this.gameState.resources.solari = Math.floor(this.gameState.resources.solari * 0.8);
                    
                    // Move to safe location
                    this.gameState.player.position = { x: 25, y: 25 };
                    this.gameState.log('You wake up at the starting outpost...', 'info');
                }
                
                // Clean up combat state
                this.gameState.combat.active = false;
                this.gameState.combat.enemy = null;
                this.gameState.combat.messages = [];
                
                document.getElementById('combatModal').classList.add('hidden');
                
                uiManager.updateAll();
                mapRenderer.render();
            }
        }

        // ===== GAME INITIALIZATION =====
        class GameInitializer {
            constructor() {
                this.gameState = new GameState();
            }
            
            async initialize() {
                // Show loading screen
                this.showLoading();
                
                // Try to load existing save
                const loaded = this.gameState.load();
                
                if (loaded && this.gameState.player.house) {
                    // Existing save found
                    this.gameState.initialized = true;
                    this.gameState.loading = false;
                    this.startGame();
                } else {
                    // New game - show character creator
                    this.gameState.loading = false;
                    this.showCharacterCreator();
                }
            }
            
            showLoading() {
                document.getElementById('loadingScreen').classList.remove('hidden');
                document.getElementById('characterCreator').classList.add('hidden');
                document.getElementById('gameInterface').classList.add('hidden');
            }
            
            showCharacterCreator() {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('characterCreator').classList.remove('hidden');
                document.getElementById('gameInterface').classList.add('hidden');
            }
            
            createCharacter() {
                const name = document.getElementById('characterName').value.trim();
                const house = document.querySelector('input[name="house"]:checked')?.value;
                const background = document.querySelector('input[name="background"]:checked')?.value;
                
                if (!name || !house || !background) {
                    this.gameState.log('Please fill in all character details', 'error');
                    return;
                }
                
                // Set character data
                this.gameState.player.name = name;
                this.gameState.player.house = house;
                this.gameState.player.background = background;
                
                // Apply house bonuses
                this.applyHouseBonuses(house);
                this.applyBackgroundBonuses(background);
                
                // Initialize map
                this.initializeMap();
                
                this.gameState.initialized = true;
                this.gameState.log(`Welcome to Arrakis, ${name} of House ${house}!`, 'event');
                
                this.startGame();
            }
            
            applyHouseBonuses(house) {
                switch (house) {
                    case 'Atreides':
                        this.gameState.player.maxHealth += 30;
                        this.gameState.player.health = this.gameState.player.maxHealth;
                        this.gameState.resources.food += 10;
                        break;
                    case 'Harkonnen':
                        this.gameState.player.attack += 3;
                        this.gameState.resources.solari += 150;
                        break;
                    case 'Fremen':
                        this.gameState.player.defense += 3;
                        this.gameState.resources.water += 30;
                        this.gameState.map.visibleRadius += 1;
                        break;
                    case 'Corrino':
                        this.gameState.player.defense += 1;
                        this.gameState.resources.solari += 75;
                        this.gameState.resources.plasteel += 15;
                        break;
                }
            }
            
            applyBackgroundBonuses(background) {
                switch (background) {
                    case 'Warrior':
                        this.gameState.player.attack += 5;
                        this.gameState.player.defense += 3;
                        this.gameState.player.maxHealth += 20;
                        this.gameState.player.health = this.gameState.player.maxHealth;
                        break;
                    case 'Scout':
                        this.gameState.resources.water += 15;
                        this.gameState.resources.food += 5;
                        this.gameState.map.visibleRadius += 1;
                        break;
                    case 'Technician':
                        this.gameState.resources.plasteel += 10;
                        this.gameState.production.manual.spice.efficiency += 0.5;
                        break;
                    case 'Merchant':
                        this.gameState.resources.solari += 200;
                        break;
                }
            }
            
            initializeMap() {
                // Mark starting area as explored
                const startX = this.gameState.player.position.x;
                const startY = this.gameState.player.position.y;
                
                for (let dx = -this.gameState.map.visibleRadius; dx <= this.gameState.map.visibleRadius; dx++) {
                    for (let dy = -this.gameState.map.visibleRadius; dy <= this.gameState.map.visibleRadius; dy++) {
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance <= this.gameState.map.visibleRadius) {
                            this.gameState.map.explored.add(`${startX + dx},${startY + dy}`);
                        }
                    }
                }
                
                // Generate initial resources
                this.generateResources();
                this.generateEnemies();
            }
            
            generateResources() {
                const resourceTypes = ['spice', 'water', 'plasteel'];
                const numResources = 20;
                
                for (let i = 0; i < numResources; i++) {
                    let x, y;
                    do {
                        x = Math.floor(Math.random() * this.gameState.map.width);
                        y = Math.floor(Math.random() * this.gameState.map.height);
                    } while (this.gameState.map.locations.has(`${x},${y}`) || 
                             (x === this.gameState.player.position.x && y === this.gameState.player.position.y));
                    
                    const type = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
                    const amount = Math.floor(Math.random() * 50) + 25;
                    
                    this.gameState.map.resources.set(`${x},${y}`, { type, amount });
                }
            }
            
            generateEnemies() {
                const enemyTypes = [
                    { name: 'Desert Bandit', health: 30, attack: 8, defense: 2, loot: { solari: 15, water: 3 } },
                    { name: 'Harkonnen Scout', health: 40, attack: 12, defense: 4, loot: { solari: 25, plasteel: 2 } },
                    { name: 'Sand Creature', health: 60, attack: 15, defense: 6, loot: { spice: 20, solari: 30 } }
                ];
                
                const numEnemies = 10;
                
                for (let i = 0; i < numEnemies; i++) {
                    let x, y;
                    do {
                        x = Math.floor(Math.random() * this.gameState.map.width);
                        y = Math.floor(Math.random() * this.gameState.map.height);
                    } while (this.gameState.map.locations.has(`${x},${y}`) || 
                             this.gameState.map.resources.has(`${x},${y}`) ||
                             (Math.abs(x - this.gameState.player.position.x) < 5 && 
                              Math.abs(y - this.gameState.player.position.y) < 5));
                    
                    const enemyTemplate = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                    const enemy = { ...enemyTemplate, maxHealth: enemyTemplate.health };
                    
                    this.gameState.map.enemies.set(`${x},${y}`, enemy);
                }
            }
            
            startGame() {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('characterCreator').classList.add('hidden');
                document.getElementById('gameInterface').classList.remove('hidden');
                
                // Initialize game systems
                window.resourceManager = new ResourceManager(this.gameState);
                window.movementSystem = new MovementSystem(this.gameState);
                window.mapRenderer = new MapRenderer(this.gameState);
                window.uiManager = new UIManager(this.gameState);
                window.combatSystem = new CombatSystem(this.gameState);
                
                // Initial UI update
                uiManager.updateAll();
                uiManager.switchTab('game');
                mapRenderer.render();
                
                // Start game loop
                this.startGameLoop();
                
                // Auto-save every 30 seconds
                setInterval(() => this.gameState.save(), 30000);
            }
            
            startGameLoop() {
                setInterval(() => {
                    if (this.gameState.initialized && !this.gameState.loading) {
                        resourceManager.processAutoProduction();
                        uiManager.updateResources();
                        
                        // Random events
                        if (Math.random() < 0.01) {
                            this.randomEvent();
                        }
                    }
                }, this.gameState.gameSpeed);
            }
            
            randomEvent() {
                const events = [
                    { message: 'A sandstorm reveals hidden spice deposits', reward: { spice: 10 } },
                    { message: 'You find an abandoned water cache', reward: { water: 8 } },
                    { message: 'Scavenged materials from wreckage', reward: { plasteel: 5 } },
                    { message: 'A passing trader drops some coins', reward: { solari: 20 } }
                ];
                
                const event = events[Math.floor(Math.random() * events.length)];
                this.gameState.log(event.message, 'event');
                
                Object.entries(event.reward).forEach(([resource, amount]) => {
                    this.gameState.resources[resource] += amount;
                });
                
                uiManager.updateResources();
            }
        }

        // ===== GLOBAL FUNCTIONS =====
        window.harvestSpice = () => {
            resourceManager.harvestSpice();
            uiManager.updateAll();
        };
        
        window.upgradeManualSpice = () => {
            resourceManager.upgradeManualSpice();
            uiManager.updateAll();
        };
        
        window.buyAutoHarvester = (type) => {
            resourceManager.buyAutoHarvester(type);
            uiManager.updateAll();
        };
        
        window.upgradeAutoHarvester = (type) => {
            resourceManager.upgradeAutoHarvester(type);
            uiManager.updateAll();
        };
        
        window.moveDirection = (direction) => {
            if (movementSystem.moveDirection(direction)) {
                mapRenderer.render();
                uiManager.updateAll();
            }
        };
        
        window.switchTab = (tabName) => {
            uiManager.switchTab(tabName);
        };
        
        window.createCharacter = () => {
            gameInitializer.createCharacter();
        };
        
        window.performCombatAction = (action) => {
            combatSystem.performAction(action);
        };

        // ===== GAME STARTUP =====
        let gameInitializer;
        
        document.addEventListener('DOMContentLoaded', () => {
            gameInitializer = new GameInitializer();
            gameInitializer.initialize();
        });
    </script>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-stone-900 flex flex-col items-center justify-center z-50">
        <div class="font-orbitron text-amber-500 text-4xl mb-8">Arrakis Tycoon</div>
        <div class="w-16 h-16 border-4 border-amber-400 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div class="text-stone-300">Loading the desert planet...</div>
    </div>

    <!-- Character Creator -->
    <div id="characterCreator" class="fixed inset-0 bg-stone-900 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-stone-800 p-8 rounded-xl shadow-2xl max-w-lg w-full">
            <h2 class="text-3xl font-orbitron text-amber-500 mb-6 text-center">Create Your Survivor</h2>
            
            <div class="space-y-6">
                <div>
                    <label for="characterName" class="block text-sm font-medium text-amber-200 mb-2">Character Name:</label>
                    <input type="text" id="characterName" value="Desert Walker" 
                           class="w-full bg-stone-700 text-white p-3 rounded-md border border-stone-600 focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-amber-200 mb-3">Choose your House:</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="block">
                            <input type="radio" name="house" value="Atreides" class="sr-only peer" checked>
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-green-600 peer-checked:text-white hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Atreides</div>
                                <div class="text-xs mt-1">+30 Health, +10 Food</div>
                            </div>
                        </label>
                        <label class="block">
                            <input type="radio" name="house" value="Harkonnen" class="sr-only peer">
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-red-600 peer-checked:text-white hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Harkonnen</div>
                                <div class="text-xs mt-1">+3 Attack, +150 Solari</div>
                            </div>
                        </label>
                        <label class="block">
                            <input type="radio" name="house" value="Fremen" class="sr-only peer">
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-sky-600 peer-checked:text-white hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Fremen</div>
                                <div class="text-xs mt-1">+3 Defense, +30 Water</div>
                            </div>
                        </label>
                        <label class="block">
                            <input type="radio" name="house" value="Corrino" class="sr-only peer">
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-yellow-500 peer-checked:text-black hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Corrino</div>
                                <div class="text-xs mt-1">+75 Solari, +15 Plasteel</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-amber-200 mb-3">Choose your Background:</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="block">
                            <input type="radio" name="background" value="Warrior" class="sr-only peer" checked>
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-rose-600 peer-checked:text-white hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Warrior</div>
                                <div class="text-xs mt-1">+5 Attack, +3 Defense</div>
                            </div>
                        </label>
                        <label class="block">
                            <input type="radio" name="background" value="Scout" class="sr-only peer">
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-teal-600 peer-checked:text-white hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Scout</div>
                                <div class="text-xs mt-1">+15 Water, +1 Vision</div>
                            </div>
                        </label>
                        <label class="block">
                            <input type="radio" name="background" value="Technician" class="sr-only peer">
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Technician</div>
                                <div class="text-xs mt-1">+10 Plasteel, Better Efficiency</div>
                            </div>
                        </label>
                        <label class="block">
                            <input type="radio" name="background" value="Merchant" class="sr-only peer">
                            <div class="bg-stone-700 p-4 rounded-md text-center cursor-pointer peer-checked:bg-lime-600 peer-checked:text-white hover:bg-stone-600 transition-all">
                                <div class="font-semibold">Merchant</div>
                                <div class="text-xs mt-1">+200 Solari</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <button onclick="createCharacter()" 
                        class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors">
                    Begin Your Journey on Arrakis
                </button>
            </div>
        </div>
    </div>

    <!-- Main Game Interface -->
    <div id="gameInterface" class="container mx-auto p-4 max-w-7xl hidden">
        <!-- Header -->
        <header class="bg-stone-800 p-4 rounded-lg shadow-xl mb-4">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h1 class="text-4xl font-orbitron text-amber-500">Arrakis Tycoon</h1>
                <div class="text-sm text-stone-400">The spice must flow...</div>
            </div>
            
            <!-- Navigation Tabs -->
            <nav class="flex flex-wrap gap-2 border-b border-stone-700 pb-2">
                <button data-tab="game" onclick="switchTab('game')" 
                        class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-all">
                    Game
                </button>
                <button data-tab="character" onclick="switchTab('character')" 
                        class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-all">
                    Character
                </button>
                <button data-tab="upgrades" onclick="switchTab('upgrades')" 
                        class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-all">
                    Upgrades
                </button>
                <button data-tab="map" onclick="switchTab('map')" 
                        class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-all">
                    Map
                </button>
                <button data-tab="quests" onclick="switchTab('quests')" 
                        class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-all">
                    Quests
                </button>
            </nav>
        </header>

        <!-- Game Tab -->
        <div id="gameTab" class="tab-content bg-stone-800 p-4 rounded-lg shadow-xl">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Resources Panel -->
                <div class="space-y-4">
                    <div class="bg-stone-700 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-amber-400 mb-3">Resources</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>🏜️ Spice:</span>
                                <span id="spiceDisplay" class="font-bold text-amber-300">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>💧 Water:</span>
                                <span id="waterDisplay" class="font-bold text-sky-300">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>💰 Solari:</span>
                                <span id="solariDisplay" class="font-bold text-yellow-300">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🔩 Plasteel:</span>
                                <span id="plasteelDisplay" class="font-bold text-slate-300">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🍖 Food:</span>
                                <span id="foodDisplay" class="font-bold text-orange-300">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-stone-700 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-amber-400 mb-3">Health</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>❤️ Health:</span>
                                <span id="healthDisplayMain" class="font-bold text-green-300">100 / 100</span>
                            </div>
                            <div class="w-full progress-bar-bg rounded-full h-3">
                                <div id="healthBarMain" class="progress-bar-fill h-3 rounded-full" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-stone-700 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-amber-400 mb-3">Actions</h3>
                        <button onclick="harvestSpice()" 
                                class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-4 rounded-md transition-colors">
                            🏜️ Harvest Spice
                        </button>
                        <p class="text-xs text-stone-300 text-center mt-2">Click to manually gather spice</p>
                    </div>
                </div>
                
                <!-- Game Log -->
                <div class="lg:col-span-2 bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-amber-400 mb-3">📜 Game Log</h3>
                    <div id="gameLog" class="h-96 overflow-y-auto bg-stone-800 p-3 rounded-md border border-stone-600 space-y-1">
                        <div class="text-stone-400 text-center">Welcome to Arrakis. Your survival begins now...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Character Tab -->
        <div id="characterTab" class="tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-6">👤 Character Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-stone-700 p-4 rounded-lg shadow space-y-3">
                    <h3 class="text-lg font-semibold text-amber-400">Basic Information</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Name:</span>
                            <span id="characterName" class="font-semibold text-amber-300">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>House:</span>
                            <span id="characterHouse" class="font-semibold text-amber-300">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Background:</span>
                            <span id="characterBackground" class="font-semibold text-amber-300">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Level:</span>
                            <span id="characterLevel" class="font-semibold text-amber-300">1</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Experience:</span>
                            <span id="characterExp" class="font-semibold text-amber-300">0 / 100</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-stone-700 p-4 rounded-lg shadow space-y-3">
                    <h3 class="text-lg font-semibold text-amber-400">Combat Stats</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Attack:</span>
                            <span id="characterAttack" class="font-semibold text-red-300">10</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Defense:</span>
                            <span id="characterDefense" class="font-semibold text-blue-300">5</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Health:</span>
                            <span id="healthDisplay" class="font-semibold text-green-300">100 / 100</span>
                        </div>
                        <div class="w-full progress-bar-bg rounded-full h-3 mt-2">
                            <div id="healthBar" class="progress-bar-fill h-3 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upgrades Tab -->
        <div id="upgradesTab" class="tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-6">⚙️ Upgrades</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Manual Spice Harvesting -->
                <div class="bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-amber-400 mb-3">🏜️ Manual Spice Harvesting</h3>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span>Level:</span>
                            <span id="manualSpiceLevel" class="font-bold">1</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Upgrade Cost:</span>
                            <span id="manualSpiceUpgradeCost" class="font-bold">20</span> Solari
                        </div>
                    </div>
                    <button onclick="upgradeManualSpice()" 
                            class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">
                        Upgrade
                    </button>
                </div>
                
                <!-- Auto Spice Harvesters -->
                <div class="bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-amber-400 mb-3">🤖 Auto Spice Harvesters</h3>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span>Count:</span>
                            <span id="autoSpiceCount" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Level:</span>
                            <span id="autoSpiceLevel" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Buy Cost:</span>
                            <span id="autoSpiceCost" class="font-bold">100</span> Solari
                        </div>
                        <div class="flex justify-between">
                            <span>Upgrade Cost:</span>
                            <span id="autoSpiceUpgradeCost" class="font-bold">N/A</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <button onclick="buyAutoHarvester('spice')" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">
                            Buy Harvester
                        </button>
                        <button onclick="upgradeAutoHarvester('spice')" 
                                class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">
                            Upgrade Efficiency
                        </button>
                    </div>
                </div>
                
                <!-- Auto Water Collectors -->
                <div class="bg-stone-700 p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-amber-400 mb-3">💧 Auto Water Collectors</h3>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span>Count:</span>
                            <span id="autoWaterCount" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Level:</span>
                            <span id="autoWaterLevel" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Buy Cost:</span>
                            <span id="autoWaterCost" class="font-bold">150</span> Solari
                        </div>
                        <div class="flex justify-between">
                            <span>Upgrade Cost:</span>
                            <span id="autoWaterUpgradeCost" class="font-bold">N/A</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <button onclick="buyAutoHarvester('water')" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">
                            Buy Collector
                        </button>
                        <button onclick="upgradeAutoHarvester('water')" 
                                class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">
                            Upgrade Efficiency
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Tab -->
        <div id="mapTab" class="tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <div class="flex flex-col xl:flex-row gap-6">
                <!-- Map Container -->
                <div class="flex-grow">
                    <h2 class="text-2xl font-orbitron text-amber-500 mb-4">🗺️ Arrakis Map</h2>
                    <div class="map-scroll-container bg-stone-900 p-2 rounded-md shadow-inner">
                        <div id="mapContainer" class="inline-block">
                            <!-- Map cells will be generated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Map Controls -->
                <div class="xl:w-80 space-y-4">
                    <div class="bg-stone-700 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-amber-400 mb-3">Navigation</h3>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div></div>
                            <button onclick="moveDirection('north')" 
                                    class="bg-stone-600 hover:bg-stone-500 text-white py-2 px-3 rounded-md transition-colors">
                                ↑ North
                            </button>
                            <div></div>
                            <button onclick="moveDirection('west')" 
                                    class="bg-stone-600 hover:bg-stone-500 text-white py-2 px-3 rounded-md transition-colors">
                                ← West
                            </button>
                            <div class="flex items-center justify-center text-stone-400 text-sm">
                                (<span id="playerX">25</span>, <span id="playerY">25</span>)
                            </div>
                            <button onclick="moveDirection('east')" 
                                    class="bg-stone-600 hover:bg-stone-500 text-white py-2 px-3 rounded-md transition-colors">
                                East →
                            </button>
                            <div></div>
                            <button onclick="moveDirection('south')" 
                                    class="bg-stone-600 hover:bg-stone-500 text-white py-2 px-3 rounded-md transition-colors">
                                ↓ South
                            </button>
                            <div></div>
                        </div>
                        <div class="text-xs text-stone-400">
                            <p>💧 Water cost per move: 1</p>
                            <p>Click on adjacent map cells to move</p>
                        </div>
                    </div>
                    
                    <div class="bg-stone-700 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-amber-400 mb-3">Legend</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 bg-yellow-500 rounded flex items-center justify-center">🤠</span>
                                <span>Your Position</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 bg-green-700 rounded flex items-center justify-center">🏠</span>
                                <span>Settlements</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 bg-orange-600 rounded flex items-center justify-center">✨</span>
                                <span>Resource Deposits</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 bg-red-600 rounded flex items-center justify-center">💀</span>
                                <span>Enemies</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 bg-stone-800 rounded flex items-center justify-center text-stone-600">?</span>
                                <span>Unexplored</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quests Tab -->
        <div id="questsTab" class="tab-content hidden bg-stone-800 p-4 rounded-lg shadow-xl">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-6">📜 Quest Log</h2>
            <div id="questsList" class="space-y-4">
                <!-- Quests will be populated here -->
            </div>
        </div>
    </div>

    <!-- Combat Modal -->
    <div id="combatModal" class="fixed inset-0 bg-stone-900 bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-stone-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-orbitron text-amber-500 mb-4 text-center">⚔️ Combat!</h2>
            
            <!-- Combat Status -->
            <div class="flex justify-between mb-6">
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-green-400">You</h3>
                    <p class="text-sm" id="combatPlayerHealth">100 / 100</p>
                    <div class="w-32 h-3 progress-bar-bg rounded-full mx-auto mt-1">
                        <div id="combatPlayerHealthBar" class="progress-bar-fill h-3 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                <div class="text-center">
                    <h3 id="combatEnemyName" class="text-lg font-semibold text-red-400">Enemy</h3>
                    <p class="text-sm" id="combatEnemyHealth">50 / 50</p>
                    <div class="w-32 h-3 progress-bar-bg rounded-full mx-auto mt-1">
                        <div id="combatEnemyHealthBar" class="progress-bar-fill h-3 rounded-full bg-red-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Combat Log -->
            <div id="combatLog" class="h-24 overflow-y-auto bg-stone-700 p-3 rounded-md text-sm mb-4 border border-stone-600">
                <!-- Combat messages will appear here -->
            </div>
            
            <!-- Combat Actions -->
            <div class="flex justify-center gap-4">
                <button id="combatAttackBtn" onclick="performCombatAction('attack')" 
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition-colors">
                    Attack
                </button>
                <button id="combatFleeBtn" onclick="performCombatAction('flee')" 
                        class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-md transition-colors">
                    Flee
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-8 py-4 border-t border-stone-700">
        <p class="text-xs text-stone-400">Arrakis Tycoon v2.0 - A Dune-inspired survival game</p>
        <p class="text-xs text-stone-500 mt-1">Fan project - All Dune IP belongs to the Herbert Estate</p>
    </footer>

</body>
</html>
