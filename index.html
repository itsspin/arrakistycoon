<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrakis: Spice Empire - Multiplayer MMO Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #1c1917 0%, #292524 50%, #1c1917 100%);
            color: #e5e7eb; 
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { border-bottom-color: #f59e0b; color: #f59e0b; background-color: #292524; }
        .progress-bar-bg { background-color: #3f3f46; }
        .progress-bar-fill { background-color: #f59e0b; transition: width 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #292524; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #71717a; }

        .map-grid { 
            display: grid; 
            grid-template-columns: repeat(15, 28px);
            gap: 1px;
            background: linear-gradient(45deg, #451a03, #1c1917);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 8px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        .map-cell { 
            width: 28px; height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; 
            font-weight: bold;
            border: 1px solid rgba(245, 158, 11, 0.1);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: linear-gradient(135deg, #78350f, #451a03);
        }
        .map-cell:hover {
            transform: scale(1.2);
            z-index: 10;
            border-color: #f59e0b !important;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
        }
        .map-cell-player { 
            background: radial-gradient(circle, #facc15, #eab308) !important; 
            color: #1c1917 !important; 
            box-shadow: 0 0 12px #facc15; 
            animation: pulse-player 2s infinite; 
            border: 2px solid #fff !important;
            font-size: 0.9rem;
        }
        .map-cell-other-player { 
            box-shadow: 0 0 10px currentColor; 
            animation: pulse-other-player 3s infinite; 
            border: 2px solid currentColor !important;
            font-size: 0.8rem;
        }
        .map-cell-enemy { background: linear-gradient(135deg, #dc2626, #b91c1c) !important; color: white !important; }
        .map-cell-boss { background: linear-gradient(135deg, #7e22ce, #6b21a8) !important; color: white !important; animation: pulse-boss 2s infinite alternate; }
        .map-cell-special-enemy { background: linear-gradient(135deg, #f97316, #ea580c) !important; color: white !important; animation: shimmer 3s infinite; }
        .map-cell-resource { background: linear-gradient(135deg, #059669, #047857) !important; color: #d1fae5 !important; }
        .map-cell-settlement { background: linear-gradient(135deg, #16a34a, #15803d) !important; color: white !important; }
        .map-cell-territory { border: 2px solid currentColor !important; }
        .map-cell-world-event { 
            background: linear-gradient(45deg, #8b5cf6, #a855f7) !important; 
            color: white !important; 
            animation: world-event-pulse 2s infinite;
        }
        .map-cell-hidden { opacity: 0.6; }

        @keyframes pulse-player { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes pulse-other-player { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes pulse-boss { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }
        @keyframes shimmer { 0%, 100% { filter: hue-rotate(0deg) brightness(1); } 50% { filter: hue-rotate(30deg) brightness(1.2); } }
        @keyframes world-event-pulse { 0%, 100% { box-shadow: 0 0 0 rgba(139, 92, 246, 0.7); } 50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.9); } }

        .notification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10000;
            padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500;
            opacity: 0; transform: translateX(-50%) translateY(100%);
            transition: all 0.4s ease-out;
            min-width: 300px; max-width: 500px; text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 2px solid currentColor;
        }
        .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: #1c1917; }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .notification.legendary { background: linear-gradient(45deg, #f59e0b, #ef4444, #8b5cf6); animation: shimmer 2s infinite; }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .modal-content { 
            background: linear-gradient(135deg, #1c1917, #292524); 
            border: 2px solid #f59e0b; 
            border-radius: 12px; 
            padding: 25px; 
            max-width: 600px; 
            width: 90%; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            max-height: 80vh;
            overflow-y: auto;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        .color-preview:hover { transform: scale(1.1); }
        .color-preview.selected { border-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; }

        .building-card {
            background: linear-gradient(135deg, #374151, #4b5563);
            border: 2px solid #6b7280;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .building-card:hover {
            border-color: #f59e0b;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.3);
        }
        .building-card.owned {
            border-color: #10b981;
            background: linear-gradient(135deg, #065f46, #047857);
        }

        .ranking-card {
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .ranking-card.rank-1 { border-left-color: #ffd700; background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent); }
        .ranking-card.rank-2 { border-left-color: #c0c0c0; background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), transparent); }
        .ranking-card.rank-3 { border-left-color: #cd7f32; background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), transparent); }

        .leaderboard-entry {
            transition: all 0.2s;
        }
        .leaderboard-entry:hover {
            background-color: rgba(245, 158, 11, 0.1);
            transform: translateX(5px);
        }

        .prestige-glow {
            animation: prestige-pulse 3s infinite;
            text-shadow: 0 0 10px currentColor;
        }
        @keyframes prestige-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .inventory-slot {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #374151, #4b5563);
            border: 2px solid #6b7280;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.5rem;
        }
        .inventory-slot:hover {
            border-color: #f59e0b;
            transform: scale(1.05);
        }

        .upgrade-button {
            background: linear-gradient(135deg, #7c2d12, #92400e);
            border: 2px solid #f59e0b;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.2s;
            cursor: pointer;
        }
        .upgrade-button:hover {
            background: linear-gradient(135deg, #92400e, #a16207);
            transform: scale(1.05);
        }
        .upgrade-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-300 antialiased">

    <script type="module">
        // === FIREBASE CONFIGURATION ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, limit, updateDoc, increment, arrayUnion, serverTimestamp, addDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyB7Zz3fxQtfSuk3tuc2UimeVNoX7M_5sIk",
            authDomain: "arrakis-spice-empire.firebaseapp.com",
            projectId: "arrakis-spice-empire",
            storageBucket: "arrakis-spice-empire.firebasestorage.app",
            messagingSenderId: "685304270859",
            appId: "1:685304270859:web:2d20f753db72a2de61f70e"
        };

        // Firebase variables
        let app, auth, db, userId;
        let firebaseInitialized = false;
        let initializationTimeout;
        let currentNotification = null;

        // === GAME CONSTANTS ===
        const CONFIG = {
            MAP_SIZE: 500,
            VIEW_RADIUS: 7,
            MAX_INVENTORY: 40,
            ENERGY_REGEN_RATE: 3,
            ENERGY_REGEN_INTERVAL: 2000,
            SAVE_INTERVAL: 10000,
            CHAT_UPDATE_INTERVAL: 3000,
            PLAYER_UPDATE_INTERVAL: 5000,
            WORLD_EVENT_INTERVAL: 120000,
            XP_BASE: 100,
            XP_FACTOR: 1.4,
            TERRITORY_BASE_COST: 1000,
            TERRITORY_COST_MULTIPLIER: 1.5,
            ENERGY_PRODUCTION_UNLOCK_LEVEL: 10,
            MAP_SEED: 12345
        };

        const PLAYER_COLORS = [
            { id: 'red', name: 'Crimson', hex: '#ef4444' },
            { id: 'blue', name: 'Azure', hex: '#3b82f6' },
            { id: 'green', name: 'Emerald', hex: '#10b981' },
            { id: 'purple', name: 'Violet', hex: '#8b5cf6' },
            { id: 'orange', name: 'Amber', hex: '#f97316' },
            { id: 'pink', name: 'Rose', hex: '#ec4899' },
            { id: 'yellow', name: 'Gold', hex: '#eab308' },
            { id: 'cyan', name: 'Aqua', hex: '#06b6d4' }
        ];

        const DUNE_QUOTES = [
            "Fear is the mind-killer.",
            "He who controls the spice, controls the universe.",
            "The spice must flow.",
            "I must not fear. Fear is the mind-killer.",
            "The mystery of life isn't a problem to solve, but a reality to experience.",
            "The beginning is a very delicate time.",
            "Dreams are messages from the deep.",
            "Without change, something sleeps inside us, and seldom awakens.",
            "The future remains uncertain and so it should, for it is the canvas upon which we paint our desires.",
            "Bless the Maker and His water. Bless the coming and going of Him."
        ];

        const STATIC_DATA = {
            HOUSES: {
                atreides: { 
                    name: "House Atreides", 
                    color: "house-atreides", 
                    bonus: "leadership", 
                    description: "+25% XP gain, +15% unit effectiveness, +10% territory income",
                    startingBonus: { solari: 1000, xp: 300 }
                },
                harkonnen: { 
                    name: "House Harkonnen", 
                    color: "house-harkonnen", 
                    bonus: "brutality", 
                    description: "+30% attack damage, +20% resource extraction, +15% enemy defeat rewards",
                    startingBonus: { plasteel: 200, attack: 8 }
                },
                fremen: { 
                    name: "Fremen", 
                    color: "house-fremen", 
                    bonus: "desert", 
                    description: "-60% water consumption, +40% spice finding, immune to sandworms, +20% territory defense",
                    startingBonus: { water: 300, spice: 100 }
                }
            },
            ENEMIES: {
                sandRaider: { 
                    name: "Desert Bandit", icon: "üèπ", health: 40, attack: 8, defense: 4, 
                    xp: 25, loot: { solari: 20, spice: 5, water: 3 }, level: 1, spawnChance: 0.15,
                    description: "Desert nomad seeking easy prey."
                },
                smuggler: {
                    name: "Spice Smuggler", icon: "üë§", health: 60, attack: 12, defense: 6,
                    xp: 40, loot: { solari: 35, melange: 1, spice: 8 }, level: 2, spawnChance: 0.12,
                    description: "Black market dealer in illegal spice."
                },
                harkonnenGuard: { 
                    name: "Harkonnen Guard", icon: "‚öîÔ∏è", health: 80, attack: 16, defense: 8, 
                    xp: 60, loot: { solari: 50, plasteel: 6, rareMaterials: 1 }, level: 3, spawnChance: 0.1,
                    description: "Brutal enforcer of Baron Harkonnen."
                },
                sardaukar: { 
                    name: "Sardaukar Elite", icon: "üëë", health: 120, attack: 24, defense: 12, 
                    xp: 120, loot: { solari: 100, rareMaterials: 4, melange: 2 }, level: 5, spawnChance: 0.06,
                    description: "Imperial super-soldier. Extremely dangerous."
                },
                guildNavigator: {
                    name: "Guild Navigator", icon: "üëÅÔ∏è", health: 150, attack: 20, defense: 15,
                    xp: 150, loot: { melange: 6, rareMaterials: 6, solari: 150 }, level: 7, spawnChance: 0.03,
                    special: true, description: "Mutated spice addict with prescient abilities."
                },
                mentat: {
                    name: "Corrupted Mentat", icon: "üß†", health: 140, attack: 28, defense: 10,
                    xp: 140, loot: { solari: 120, melange: 4, rareMaterials: 5 }, level: 6, spawnChance: 0.04,
                    special: true, description: "Human computer driven mad by forbidden calculations."
                },
                beastRabban: { 
                    name: "Beast Rabban", icon: "üëπ", health: 300, attack: 40, defense: 20, 
                    xp: 300, loot: { solari: 800, spice: 120, rareMaterials: 12, melange: 6 }, 
                    boss: true, level: 10, spawnChance: 0.008, description: "Harkonnen na-Baron. Ruthless and brutal."
                },
                baronHarkonnen: {
                    name: "Baron Vladimir Harkonnen", icon: "ü¶π", health: 600, attack: 60, defense: 30,
                    xp: 600, loot: { solari: 2000, spice: 250, rareMaterials: 25, melange: 15 },
                    boss: true, level: 20, spawnChance: 0.003, description: "The Baron himself. Master of schemes."
                },
                sandworm: {
                    name: "Shai-Hulud", icon: "üêõ", health: 1200, attack: 100, defense: 40,
                    xp: 1200, loot: { spice: 600, melange: 60, rareMaterials: 50 },
                    boss: true, level: 25, legendary: true, spawnChance: 0.001, description: "The Great Sandworm. Maker of spice."
                }
            },
            ITEMS: {
                crysknife: { name: "Crysknife", icon: "üó°Ô∏è", type: "weapon", attack: 30, rarity: "legendary", description: "Sacred Fremen blade made from sandworm tooth.", dropChance: 0.15 },
                maula: { name: "Maula Pistol", icon: "üî´", type: "weapon", attack: 22, rarity: "rare", description: "Spring-loaded dart gun used in shield combat.", dropChance: 0.25 },
                lasguns: { name: "Lasgun", icon: "‚ö°", type: "weapon", attack: 28, rarity: "epic", description: "Directed energy weapon.", dropChance: 0.1 },
                stillsuit: { name: "Stillsuit", icon: "ü•Ω", type: "armor", defense: 18, rarity: "uncommon", description: "Desert survival suit that recycles body moisture.", dropChance: 0.3 },
                shieldBelt: { name: "Shield Belt", icon: "üîò", type: "accessory", defense: 25, rarity: "epic", description: "Personal force field generator.", dropChance: 0.12 },
                fremkit: { name: "Fremen Survival Kit", icon: "üéí", type: "accessory", special: "desert", rarity: "rare", description: "Essential tools for desert survival.", dropChance: 0.2 },
                spiceLens: { name: "Spice Lens", icon: "üîç", type: "accessory", special: "detection", rarity: "epic", description: "Reveals hidden spice deposits.", dropChance: 0.08 },
                choamRing: { name: "CHOAM Signet", icon: "üíç", type: "accessory", special: "trading", rarity: "legendary", description: "Grants access to exclusive markets.", dropChance: 0.05 },
                powerArmor: { name: "Sardaukar Armor", icon: "üõ°Ô∏è", type: "armor", defense: 35, attack: 10, rarity: "legendary", description: "Imperial military armor.", dropChance: 0.06 },
                guildArtifact: { name: "Guild Artifact", icon: "üëÅÔ∏è", type: "accessory", special: "prescience", rarity: "legendary", description: "Navigator technology.", dropChance: 0.04 }
            },
            BUILDINGS: {
                spiceExtractor: {
                    name: "Spice Extractor",
                    icon: "‚õèÔ∏è",
                    description: "Automatically harvests spice from the desert",
                    baseCost: { solari: 500, plasteel: 20 },
                    baseProduction: { spice: 5 },
                    costMultiplier: 1.5,
                    maxLevel: 20,
                    unlockLevel: 1
                },
                waterRecycler: {
                    name: "Water Recycler",
                    icon: "üíß",
                    description: "Recycles and purifies water from moisture",
                    baseCost: { solari: 800, plasteel: 30, rareMaterials: 2 },
                    baseProduction: { water: 3 },
                    costMultiplier: 1.6,
                    maxLevel: 15,
                    unlockLevel: 3
                },
                plasticFactory: {
                    name: "Plasteel Factory",
                    icon: "üè≠",
                    description: "Manufactures plasteel from raw materials",
                    baseCost: { solari: 1200, water: 50, rareMaterials: 5 },
                    baseProduction: { plasteel: 2 },
                    costMultiplier: 1.7,
                    maxLevel: 12,
                    unlockLevel: 5
                },
                refineryComplex: {
                    name: "Melange Refinery",
                    icon: "üß™",
                    description: "Refines raw spice into pure melange",
                    baseCost: { solari: 2000, plasteel: 50, rareMaterials: 10 },
                    baseProduction: { melange: 1 },
                    costMultiplier: 2.0,
                    maxLevel: 10,
                    unlockLevel: 8
                },
                tradingPost: {
                    name: "Trading Post",
                    icon: "üè™",
                    description: "Generates passive income from trade",
                    baseCost: { solari: 1500, plasteel: 25, water: 30 },
                    baseProduction: { solari: 50 },
                    costMultiplier: 1.8,
                    maxLevel: 15,
                    unlockLevel: 4
                },
                researchCenter: {
                    name: "Research Center",
                    icon: "üî¨",
                    description: "Discovers rare materials through research",
                    baseCost: { solari: 3000, plasteel: 80, melange: 5 },
                    baseProduction: { rareMaterials: 1 },
                    costMultiplier: 2.2,
                    maxLevel: 8,
                    unlockLevel: 12
                }
            },
            WORLD_EVENTS: [
                {
                    name: "Spice Bloom",
                    description: "A massive spice deposit has been discovered!",
                    icon: "‚ú®",
                    rewards: { spice: 500, melange: 25 },
                    duration: 300000
                },
                {
                    name: "Sandstorm",
                    description: "A great sandstorm sweeps across the desert!",
                    icon: "üå™Ô∏è",
                    effect: "energy_drain",
                    duration: 180000
                },
                {
                    name: "Guild Heighliner",
                    description: "A Guild ship has crashed, scattering rare materials!",
                    icon: "üöÄ",
                    rewards: { rareMaterials: 50, melange: 15 },
                    duration: 600000
                },
                {
                    name: "Fremen Gathering",
                    description: "The Fremen offer knowledge and resources to worthy allies!",
                    icon: "üèîÔ∏è",
                    rewards: { water: 200, xp: 500 },
                    duration: 240000
                },
                {
                    name: "Imperial Raid",
                    description: "Sardaukar forces are searching the area! High risk, high reward!",
                    icon: "‚öîÔ∏è",
                    effect: "combat_boost",
                    rewards: { solari: 1000, rareMaterials: 20 },
                    duration: 420000
                }
            ]
        };

        // === GAME STATE ===
        let gameState = {
            player: {
                id: null, name: "", color: "red", level: 1, experience: 0, experienceToNext: 100,
                health: 120, maxHealth: 120, energy: 150, maxEnergy: 150,
                attack: 15, defense: 10, critChance: 8, dodgeChance: 15,
                position: { x: 250, y: 250 }, basePosition: { x: 250, y: 250 },
                house: null, rank: 'Desert Rat', power: 0, prestigeLevel: 0,
                territories: [], lifetimeSpice: 0, totalEnemiesDefeated: 0,
                energyProductionRate: CONFIG.ENERGY_REGEN_RATE,
                created: Date.now(), lastActive: Date.now()
            },
            resources: { spice: 0, water: 200, solari: 2000, plasteel: 150, rareMaterials: 0, melange: 0 },
            equipment: { weapon: null, armor: null, accessory: null },
            inventory: new Array(CONFIG.MAX_INVENTORY).fill(null),
            buildings: {},
            combat: { active: false, enemy: null, turn: 'player', log: [] },
            currentTab: 'game',
            gameInitialized: false,
            lastSaveTime: 0,
            lastEnergyRegen: Date.now(),
            lastBuildingProduction: Date.now(),
            onlinePlayers: {},
            worldEvents: [],
            tradeOffers: [],
            rankings: [],
            mapData: null
        };

        // === UTILITY FUNCTIONS ===
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function generateMapSeed(x, y) {
            return CONFIG.MAP_SEED + x * 1000 + y;
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                console.log("üéØ Hiding loading screen");
                loadingScreen.style.display = 'none';
            }
        }

        // === FIREBASE FUNCTIONS ===
        async function initializeFirebase() {
            console.log("üöÄ Starting Firebase initialization...");
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                console.log("‚úÖ Firebase app initialized");
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("‚úÖ User authenticated:", user.uid);
                        
                        if (initializationTimeout) {
                            clearTimeout(initializationTimeout);
                        }
                        
                        userId = user.uid;
                        gameState.player.id = userId;
                        firebaseInitialized = true;
                        loadGame();
                        startMultiplayerSync();
                    } else {
                        console.log("üîë No user, signing in anonymously...");
                        signInAnonymously(auth).catch((error) => {
                            console.error("‚ùå Anonymous sign in failed:", error);
                            if (initializationTimeout) {
                                clearTimeout(initializationTimeout);
                            }
                            startOfflineMode();
                        });
                    }
                });
                
            } catch (error) {
                console.error("‚ùå Firebase initialization failed:", error);
                if (initializationTimeout) {
                    clearTimeout(initializationTimeout);
                }
                startOfflineMode();
            }
        }

        function startOfflineMode() {
            console.log("üì¥ Starting offline mode...");
            firebaseInitialized = false;
            
            if (initializationTimeout) {
                clearTimeout(initializationTimeout);
            }
            
            try {
                const savedData = localStorage.getItem('arrakis_gamestate');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    Object.assign(gameState.player, data.player);
                    gameState.resources = data.resources || gameState.resources;
                    gameState.equipment = data.equipment || gameState.equipment;
                    gameState.inventory = data.inventory || gameState.inventory;
                    gameState.buildings = data.buildings || gameState.buildings;
                }
            } catch (error) {
                console.error("Failed to load local data:", error);
            }
            
            const savedName = localStorage.getItem('arrakis_player_name');
            const savedColor = localStorage.getItem('arrakis_player_color');
            const savedHouse = localStorage.getItem('arrakis_player_house');
            
            if (savedName && savedColor && savedHouse) {
                gameState.player.name = savedName;
                gameState.player.color = savedColor;
                gameState.player.house = savedHouse;
                completeGameInitialization();
            } else {
                showNameSelectionModal();
            }
        }

        async function saveGame() {
            try {
                localStorage.setItem('arrakis_gamestate', JSON.stringify({
                    player: gameState.player,
                    resources: gameState.resources,
                    equipment: gameState.equipment,
                    inventory: gameState.inventory,
                    buildings: gameState.buildings
                }));
                
                if (gameState.player.name) {
                    localStorage.setItem('arrakis_player_name', gameState.player.name);
                    localStorage.setItem('arrakis_player_color', gameState.player.color);
                    if (gameState.player.house) {
                        localStorage.setItem('arrakis_player_house', gameState.player.house);
                    }
                }
            } catch (error) {
                console.error('Local save failed:', error);
            }
            
            if (!db || !userId || !firebaseInitialized) return;
            
            try {
                const playerData = {
                    ...gameState.player,
                    resources: gameState.resources,
                    equipment: gameState.equipment,
                    inventory: gameState.inventory,
                    buildings: gameState.buildings,
                    lastSave: serverTimestamp(),
                    lastActive: serverTimestamp()
                };
                
                await setDoc(doc(db, 'players', userId), playerData);
                
                await setDoc(doc(db, 'playerPositions', userId), {
                    position: gameState.player.position,
                    name: gameState.player.name,
                    color: gameState.player.color,
                    level: gameState.player.level,
                    prestigeLevel: gameState.player.prestigeLevel,
                    house: gameState.player.house,
                    lifetimeSpice: gameState.player.lifetimeSpice,
                    territories: gameState.player.territories?.length || 0,
                    totalEnemiesDefeated: gameState.player.totalEnemiesDefeated,
                    power: calculatePlayerPower(),
                    lastUpdate: serverTimestamp()
                });
                
                gameState.lastSaveTime = Date.now();
            } catch (error) {
                console.error('Cloud save failed:', error);
            }
        }

        async function loadGame() {
            console.log("üì• Loading game data...");
            
            if (!db || !userId) {
                console.log("No database or user ID, showing name selection");
                showNameSelectionModal();
                return;
            }
            
            try {
                const docRef = doc(db, 'players', userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    console.log("‚úÖ Player data found, loading...");
                    const data = docSnap.data();
                    Object.assign(gameState.player, data);
                    gameState.resources = data.resources || gameState.resources;
                    gameState.equipment = data.equipment || gameState.equipment;
                    gameState.inventory = data.inventory || gameState.inventory;
                    gameState.buildings = data.buildings || gameState.buildings;
                    
                    if (!gameState.player.name) {
                        console.log("Player data exists but no name, showing name selection");
                        showNameSelectionModal();
                    } else {
                        console.log("Player data loaded successfully, starting game");
                        completeGameInitialization();
                    }
                } else {
                    console.log("No existing player data, showing name selection");
                    showNameSelectionModal();
                }
            } catch (error) {
                console.error('Load failed:', error);
                showNotification('Failed to load game data. Starting fresh.', 'warning');
                showNameSelectionModal();
            }
        }

        async function startMultiplayerSync() {
            if (!db) return;
            
            try {
                const playersQuery = query(collection(db, 'playerPositions'), orderBy('lastUpdate', 'desc'), limit(100));
                onSnapshot(playersQuery, (snapshot) => {
                    gameState.onlinePlayers = {};
                    const playerList = [];
                    snapshot.forEach((doc) => {
                        const playerData = doc.data();
                        if (doc.id !== userId) {
                            gameState.onlinePlayers[doc.id] = playerData;
                        }
                        playerList.push({ id: doc.id, ...playerData });
                    });
                    
                    // Update rankings
                    gameState.rankings = playerList.sort((a, b) => b.power - a.power).slice(0, 50);
                    
                    updateOnlinePlayersDisplay();
                    updateRankingsDisplay();
                    renderMap();
                });

                const chatQuery = query(collection(db, 'worldChat'), orderBy('timestamp', 'desc'), limit(50));
                onSnapshot(chatQuery, (snapshot) => {
                    const messages = [];
                    snapshot.forEach((doc) => {
                        messages.unshift(doc.data());
                    });
                    updateWorldChat(messages);
                });

                const eventsQuery = query(collection(db, 'worldEvents'), where('endTime', '>', new Date()));
                onSnapshot(eventsQuery, (snapshot) => {
                    gameState.worldEvents = [];
                    snapshot.forEach((doc) => {
                        gameState.worldEvents.push({ id: doc.id, ...doc.data() });
                    });
                    updateWorldEventsDisplay();
                    renderMap();
                });

            } catch (error) {
                console.error('Failed to start multiplayer sync:', error);
            }
        }

        // === NAME SELECTION ===
        function showNameSelectionModal() {
            console.log("üé≠ Showing name selection modal");
            
            hideLoadingScreen();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content max-w-md">
                    <h3 class="text-3xl font-orbitron text-amber-400 mb-6 text-center">Welcome to Arrakis</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Choose Your Name:</label>
                        <input type="text" id="playerNameInput" class="w-full px-3 py-2 bg-stone-700 border border-stone-600 rounded text-white" 
                               placeholder="Enter your name" maxlength="20">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Choose Your Color:</label>
                        <div class="grid grid-cols-4 gap-3">
                            ${PLAYER_COLORS.map(color => `
                                <div class="text-center">
                                    <div class="color-preview mx-auto mb-1" 
                                         data-color="${color.id}" 
                                         style="background-color: ${color.hex}"></div>
                                    <span class="text-xs">${color.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button id="confirmNameBtn" class="w-full py-3 bg-amber-600 hover:bg-amber-700 rounded font-bold text-lg" disabled>
                        Begin Your Journey
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            let selectedColor = 'red';
            const nameInput = modal.querySelector('#playerNameInput');
            const confirmBtn = modal.querySelector('#confirmNameBtn');
            
            modal.querySelectorAll('.color-preview').forEach(preview => {
                preview.addEventListener('click', () => {
                    modal.querySelectorAll('.color-preview').forEach(p => p.classList.remove('selected'));
                    preview.classList.add('selected');
                    selectedColor = preview.dataset.color;
                    checkFormValid();
                });
            });
            
            modal.querySelector('.color-preview').click();
            
            nameInput.addEventListener('input', checkFormValid);
            
            function checkFormValid() {
                const name = nameInput.value.trim();
                confirmBtn.disabled = name.length < 2;
            }
            
            confirmBtn.addEventListener('click', async () => {
                const name = nameInput.value.trim();
                if (name.length >= 2) {
                    gameState.player.name = name;
                    gameState.player.color = selectedColor;
                    
                    localStorage.setItem('arrakis_player_name', name);
                    localStorage.setItem('arrakis_player_color', selectedColor);
                    
                    document.body.removeChild(modal);
                    showHouseSelection();
                }
            });
        }

        function showHouseSelection() {
            console.log("üè† Showing house selection modal");
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content max-w-4xl">
                    <h3 class="text-3xl font-orbitron text-amber-400 mb-6 text-center">Choose Your Great House</h3>
                    <p class="text-center text-stone-300 mb-8">Your allegiance will shape your destiny on Arrakis...</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${Object.entries(STATIC_DATA.HOUSES).map(([houseId, house]) => `
                            <button class="house-btn p-6 border-2 border-stone-600 rounded-lg hover:bg-stone-700 transition-all text-left" data-house="${houseId}">
                                <h4 class="text-xl font-bold mb-3">${house.name}</h4>
                                <p class="text-sm text-stone-300 mb-4">${house.description}</p>
                                <div class="text-xs text-amber-300">
                                    Starting Bonus: ${Object.entries(house.startingBonus).map(([key, val]) => `${val} ${key}`).join(', ')}
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <p class="text-center text-xs text-stone-400 mt-6">This choice is permanent and affects your entire journey.</p>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelectorAll('.house-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const houseId = btn.dataset.house;
                    selectHouse(houseId);
                    document.body.removeChild(modal);
                    completeGameInitialization();
                });
            });
        }

        function selectHouse(houseId) {
            console.log("üèõÔ∏è Selected house:", houseId);
            
            const house = STATIC_DATA.HOUSES[houseId];
            gameState.player.house = houseId;
            
            localStorage.setItem('arrakis_player_house', houseId);
            
            if (house.startingBonus.solari) {
                gameState.resources.solari += house.startingBonus.solari;
            }
            if (house.startingBonus.plasteel) {
                gameState.resources.plasteel += house.startingBonus.plasteel;
            }
            if (house.startingBonus.water) {
                gameState.resources.water += house.startingBonus.water;
            }
            if (house.startingBonus.spice) {
                gameState.resources.spice += house.startingBonus.spice;
            }
            if (house.startingBonus.xp) {
                addExperience(house.startingBonus.xp);
            }
            if (house.startingBonus.attack) {
                gameState.player.attack += house.startingBonus.attack;
            }
            
            showNotification(`Joined ${house.name}! ${house.description}`, 'legendary', 8000);
            showQuotePopup(`"Welcome to ${house.name}, ${gameState.player.name}. May your enemies know fear."`);
        }

        function completeGameInitialization() {
            console.log("üéÆ Completing game initialization...");
            
            gameState.gameInitialized = true;
            
            hideLoadingScreen();
            
            startGameLoop();
            
            updateUI();
            renderMap();
            
            saveGame();
            
            showNotification(`Welcome to Arrakis, ${gameState.player.name}!`, 'success', 6000);
            showQuotePopup('"The beginning is a very delicate time..."');
            
            console.log("‚úÖ Game initialization complete!");
        }

        // === MAP SYSTEM ===
        function getMapCellContent(x, y) {
            const seed = generateMapSeed(x, y);
            const rand = seededRandom(seed);
            
            // Enemies
            const enemyTypes = Object.entries(STATIC_DATA.ENEMIES);
            for (const [enemyType, enemy] of enemyTypes) {
                if (rand < enemy.spawnChance) {
                    return {
                        type: 'enemy',
                        subtype: enemyType,
                        data: {
                            ...enemy,
                            currentHealth: enemy.health,
                            position: { x, y },
                            id: `${x}-${y}-${enemyType}`
                        }
                    };
                }
            }
            
            // Resources
            if (seededRandom(seed + 1000) < 0.08) {
                const resourceTypes = ['spice', 'water', 'plasteel', 'rareMaterials'];
                const resourceWeights = [0.5, 0.25, 0.15, 0.1];
                const resourceRand = seededRandom(seed + 2000);
                
                let resourceType = 'spice';
                let cumulative = 0;
                for (let i = 0; i < resourceTypes.length; i++) {
                    cumulative += resourceWeights[i];
                    if (resourceRand < cumulative) {
                        resourceType = resourceTypes[i];
                        break;
                    }
                }
                
                return {
                    type: 'resource',
                    subtype: resourceType,
                    data: {
                        type: resourceType,
                        amount: 20 + Math.floor(seededRandom(seed + 3000) * 50),
                        position: { x, y },
                        id: `${x}-${y}-resource`
                    }
                };
            }
            
            // Hidden fights
            if (seededRandom(seed + 4000) < 0.02) {
                return {
                    type: 'hidden',
                    data: {
                        type: 'hidden_combat',
                        position: { x, y }
                    }
                };
            }
            
            return null;
        }

        function renderMap() {
            const mapGrid = document.getElementById('uiMapGrid');
            if (!mapGrid) return;
            
            mapGrid.innerHTML = '';
            
            const playerX = gameState.player.position.x;
            const playerY = gameState.player.position.y;
            const radius = CONFIG.VIEW_RADIUS;
            
            const coordsElement = document.getElementById('mapPlayerCoords');
            if (coordsElement) {
                coordsElement.textContent = `${playerX},${playerY}`;
            }
            
            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    const x = playerX + dx;
                    const y = playerY + dy;
                    
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    let hasContent = false;
                    
                    // Player position
                    if (x === playerX && y === playerY) {
                        cell.className += ' map-cell-player';
                        cell.textContent = '‚òÖ';
                        cell.title = `${gameState.player.name} (P${gameState.player.prestigeLevel})`;
                        hasContent = true;
                    }
                    // Other players
                    else if (gameState.onlinePlayers) {
                        for (const [playerId, player] of Object.entries(gameState.onlinePlayers)) {
                            if (player.position && player.position.x === x && player.position.y === y) {
                                cell.className += ` map-cell-other-player player-color-${player.color}`;
                                cell.textContent = '‚óÜ';
                                cell.title = `${player.name} (P${player.prestigeLevel || 0}) - ${STATIC_DATA.HOUSES[player.house]?.name || 'No House'}`;
                                hasContent = true;
                                break;
                            }
                        }
                    }
                    // World events
                    if (!hasContent && gameState.worldEvents) {
                        for (const event of gameState.worldEvents) {
                            if (event.position && event.position.x === x && event.position.y === y) {
                                cell.className += ' map-cell-world-event';
                                cell.textContent = event.icon;
                                cell.title = `${event.name}: ${event.description}`;
                                hasContent = true;
                                break;
                            }
                        }
                    }
                    
                    if (!hasContent) {
                        const content = getMapCellContent(x, y);
                        if (content) {
                            switch (content.type) {
                                case 'enemy':
                                    const enemy = content.data;
                                    if (enemy.special) {
                                        cell.className += ' map-cell-special-enemy';
                                    } else if (enemy.boss) {
                                        cell.className += ' map-cell-boss';
                                    } else {
                                        cell.className += ' map-cell-enemy';
                                    }
                                    cell.textContent = enemy.icon;
                                    cell.title = `${enemy.name} (Lv.${enemy.level})`;
                                    break;
                                case 'resource':
                                    cell.className += ' map-cell-resource';
                                    const resourceIcons = { spice: '‚óà', water: '‚óã', plasteel: '‚óä', rareMaterials: '‚óä' };
                                    cell.textContent = resourceIcons[content.data.type] || '‚óà';
                                    cell.title = `${content.data.type} (${content.data.amount})`;
                                    break;
                                case 'hidden':
                                    cell.className += ' map-cell-hidden';
                                    cell.textContent = '?';
                                    cell.title = 'Something is hidden here...';
                                    break;
                            }
                            hasContent = true;
                        }
                    }
                    
                    if (!hasContent) {
                        cell.textContent = '¬∑';
                        cell.title = 'Empty desert';
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(parseInt(x), parseInt(y)));
                    mapGrid.appendChild(cell);
                }
            }
        }

        function handleCellClick(x, y) {
            const dx = x - gameState.player.position.x;
            const dy = y - gameState.player.position.y;
            
            if (Math.abs(dx) <= 1 && Math.abs(dy) <= 1 && (dx !== 0 || dy !== 0)) {
                movePlayer(dx, dy);
            } else if (dx === 0 && dy === 0) {
                const content = getMapCellContent(x, y);
                if (content) {
                    switch (content.type) {
                        case 'enemy':
                            startCombat(content.data);
                            break;
                        case 'resource':
                            harvestResource(content.data);
                            break;
                        case 'hidden':
                            discoverHidden(x, y);
                            break;
                    }
                }
            }
        }

        function movePlayer(dx, dy) {
            if (gameState.combat.active) {
                showNotification('Cannot move during combat!', 'error');
                return;
            }
            
            const waterCost = gameState.player.house === 'fremen' ? 1 : 2;
            
            if (gameState.resources.water < waterCost) {
                showNotification('Not enough water to travel!', 'error');
                return;
            }
            
            const newX = Math.max(0, Math.min(CONFIG.MAP_SIZE - 1, gameState.player.position.x + dx));
            const newY = Math.max(0, Math.min(CONFIG.MAP_SIZE - 1, gameState.player.position.y + dy));
            
            gameState.player.position.x = newX;
            gameState.player.position.y = newY;
            updateResources({ water: -waterCost });
            
            const content = getMapCellContent(newX, newY);
            if (content && content.type === 'enemy') {
                setTimeout(() => startCombat(content.data), 500);
            }
            
            renderMap();
            saveGame();
        }

        function harvestResource(resource) {
            if (gameState.player.energy < 20) {
                showNotification('Not enough energy!', 'error');
                return;
            }
            
            gameState.player.energy -= 20;
            let amount = Math.min(15, resource.amount);
            
            if (gameState.player.house === 'harkonnen') {
                amount = Math.floor(amount * 1.2);
            } else if (gameState.player.house === 'fremen' && resource.type === 'spice') {
                amount = Math.floor(amount * 1.4);
            }
            
            updateResources({ [resource.type]: amount });
            showNotification(`Harvested ${amount} ${resource.type}!`, 'success');
            
            renderMap();
        }

        function discoverHidden(x, y) {
            const enemies = Object.values(STATIC_DATA.ENEMIES);
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            const hiddenEnemy = {
                ...enemy,
                currentHealth: enemy.health,
                position: { x, y },
                id: `hidden-${x}-${y}`
            };
            
            showNotification('You discovered a hidden enemy!', 'warning');
            setTimeout(() => startCombat(hiddenEnemy), 1000);
        }

        // === COMBAT SYSTEM ===
        function startCombat(enemy) {
            gameState.combat = {
                active: true,
                enemy: { ...enemy, currentHealth: enemy.currentHealth || enemy.health },
                turn: 'player',
                log: []
            };
            
            addCombatLog(`‚öîÔ∏è Combat begins with ${enemy.name}!`);
            showCombatModal();
        }

        function showCombatModal() {
            const modal = document.getElementById('modalCombat');
            if (modal) {
                modal.classList.remove('hidden');
                updateCombatDisplay();
            }
        }

        function updateCombatDisplay() {
            if (!gameState.combat.active) return;
            
            const enemy = gameState.combat.enemy;
            
            document.getElementById('modalCombatPlayerName').textContent = `${gameState.player.name} (P${gameState.player.prestigeLevel})`;
            document.getElementById('modalCombatPlayerLevel').textContent = `Lv.${gameState.player.level}`;
            document.getElementById('modalCombatPlayerHealth').textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('modalCombatEnemyName').textContent = enemy.name;
            document.getElementById('modalCombatEnemyLevel').textContent = `Lv.${enemy.level}`;
            document.getElementById('modalCombatEnemyHealth').textContent = `${enemy.currentHealth}/${enemy.health}`;
            
            const playerHealthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const enemyHealthPercent = (enemy.currentHealth / enemy.health) * 100;
            
            document.getElementById('modalCombatPlayerHealthBar').style.width = `${playerHealthPercent}%`;
            document.getElementById('modalCombatEnemyHealthBar').style.width = `${enemyHealthPercent}%`;
            
            const logElement = document.getElementById('modalCombatLog');
            if (logElement) {
                logElement.innerHTML = gameState.combat.log.join('<br>');
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function addCombatLog(message) {
            gameState.combat.log.push(message);
            if (gameState.combat.log.length > 20) gameState.combat.log.shift();
        }

        function combatAction(action) {
            if (gameState.combat.turn !== 'player') return;
            
            const enemy = gameState.combat.enemy;
            
            switch (action) {
                case 'attack':
                    let damage = gameState.player.attack + Math.floor(Math.random() * 20);
                    
                    if (gameState.equipment.weapon) {
                        damage += gameState.equipment.weapon.attack || 0;
                    }
                    
                    if (gameState.player.house === 'harkonnen') {
                        damage = Math.floor(damage * 1.3);
                    }
                    
                    if (Math.random() * 100 < gameState.player.critChance) {
                        damage *= 2;
                        addCombatLog(`üí• CRITICAL HIT! You deal ${damage} damage!`);
                    } else {
                        addCombatLog(`‚öîÔ∏è You attack for ${damage} damage!`);
                    }
                    
                    enemy.currentHealth -= damage;
                    break;
                    
                case 'defend':
                    const healing = Math.floor(gameState.player.maxHealth * 0.2);
                    gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healing);
                    addCombatLog(`üõ°Ô∏è You defend and recover ${healing} health!`);
                    break;
                    
                case 'flee':
                    let fleeChance = 0.7;
                    if (enemy.boss) fleeChance = 0.4;
                    
                    if (Math.random() < fleeChance) {
                        addCombatLog(`üí® You successfully flee from combat!`);
                        endCombat(false, true);
                        return;
                    } else {
                        addCombatLog(`‚ùå Failed to flee!`);
                    }
                    break;
            }
            
            if (enemy.currentHealth <= 0) {
                endCombat(true);
                return;
            }
            
            gameState.combat.turn = 'enemy';
            setTimeout(() => enemyTurn(), 1500);
        }

        function enemyTurn() {
            const enemy = gameState.combat.enemy;
            let damage = enemy.attack + Math.floor(Math.random() * 15);
            
            let defense = gameState.player.defense;
            if (gameState.equipment.armor) defense += gameState.equipment.armor.defense || 0;
            if (gameState.equipment.accessory?.defense) defense += gameState.equipment.accessory.defense;
            
            if (Math.random() * 100 < gameState.player.dodgeChance) {
                addCombatLog(`üí® You dodge ${enemy.name}'s attack!`);
            } else {
                const actualDamage = Math.max(1, damage - defense);
                gameState.player.health -= actualDamage;
                addCombatLog(`üíÄ ${enemy.name} attacks for ${actualDamage} damage!`);
                
                if (gameState.player.health <= 0) {
                    endCombat(false);
                    return;
                }
            }
            
            gameState.combat.turn = 'player';
            updateCombatDisplay();
        }

        function endCombat(victory, fled = false) {
            const enemy = gameState.combat.enemy;
            
            if (victory) {
                addCombatLog(`üéâ Victory! ${enemy.name} has been defeated!`);
                
                let xpGain = enemy.xp || 50;
                let lootMultiplier = 1;
                
                if (gameState.player.house === 'harkonnen') {
                    lootMultiplier = 1.15;
                }
                
                addExperience(xpGain);
                
                if (enemy.loot) {
                    const rewards = {};
                    Object.entries(enemy.loot).forEach(([resource, amount]) => {
                        rewards[resource] = Math.floor(amount * lootMultiplier);
                    });
                    updateResources(rewards);
                }
                
                const dropChance = enemy.boss ? 0.8 : enemy.special ? 0.4 : 0.2;
                if (Math.random() < dropChance) {
                    const items = Object.values(STATIC_DATA.ITEMS);
                    const droppableItems = items.filter(item => Math.random() < item.dropChance);
                    if (droppableItems.length > 0) {
                        const item = droppableItems[Math.floor(Math.random() * droppableItems.length)];
                        addToInventory(item);
                        showNotification(`Found: ${item.name}!`, item.rarity === 'legendary' ? 'legendary' : 'success');
                    }
                }
                
                gameState.player.totalEnemiesDefeated++;
                
                if (enemy.boss) {
                    showNotification(`üèÜ BOSS DEFEATED: ${enemy.name}!`, 'legendary', 8000);
                    sendWorldMessage(`${gameState.player.name} has defeated ${enemy.name}!`, 'boss');
                }
            } else if (fled) {
                addCombatLog(`üí® You escaped from ${enemy.name}!`);
            } else {
                addCombatLog(`üíÄ Defeat! You have been defeated!`);
                
                gameState.player.health = Math.floor(gameState.player.maxHealth * 0.1);
                const solariLoss = Math.floor(gameState.resources.solari * 0.15);
                updateResources({ solari: -solariLoss });
                
                gameState.player.position = { ...gameState.player.basePosition };
            }
            
            gameState.combat.active = false;
            
            setTimeout(() => {
                document.getElementById('modalCombat')?.classList.add('hidden');
                renderMap();
                updateUI();
                saveGame();
            }, 3000);
        }

        // === EMPIRE MANAGEMENT SYSTEM ===
        function canAffordBuilding(buildingType, level = 1) {
            const building = STATIC_DATA.BUILDINGS[buildingType];
            if (!building) return false;
            
            const costs = {};
            Object.entries(building.baseCost).forEach(([resource, amount]) => {
                costs[resource] = Math.floor(amount * Math.pow(building.costMultiplier, level - 1));
            });
            
            return Object.entries(costs).every(([resource, cost]) => 
                gameState.resources[resource] >= cost
            );
        }

        function purchaseBuilding(buildingType) {
            const building = STATIC_DATA.BUILDINGS[buildingType];
            if (!building) return false;
            
            if (gameState.player.level < building.unlockLevel) {
                showNotification(`Requires level ${building.unlockLevel}!`, 'error');
                return false;
            }
            
            const currentLevel = gameState.buildings[buildingType] || 0;
            const nextLevel = currentLevel + 1;
            
            if (nextLevel > building.maxLevel) {
                showNotification(`${building.name} is already at max level!`, 'warning');
                return false;
            }
            
            if (!canAffordBuilding(buildingType, nextLevel)) {
                showNotification(`Cannot afford ${building.name} upgrade!`, 'error');
                return false;
            }
            
            const costs = {};
            Object.entries(building.baseCost).forEach(([resource, amount]) => {
                costs[resource] = -Math.floor(amount * Math.pow(building.costMultiplier, nextLevel - 1));
            });
            
            updateResources(costs);
            gameState.buildings[buildingType] = nextLevel;
            
            showNotification(`${building.name} upgraded to level ${nextLevel}!`, 'success');
            updateEmpireDisplay();
            saveGame();
            
            return true;
        }

        function processBuildingProduction() {
            const now = Date.now();
            const timeDiff = Math.min(now - gameState.lastBuildingProduction, 60000); // Max 1 minute
            
            if (timeDiff < 1000) return; // At least 1 second
            
            const productionMultiplier = timeDiff / 60000; // Per minute
            const totalProduction = {};
            
            Object.entries(gameState.buildings).forEach(([buildingType, level]) => {
                if (level <= 0) return;
                
                const building = STATIC_DATA.BUILDINGS[buildingType];
                if (!building) return;
                
                Object.entries(building.baseProduction).forEach(([resource, amount]) => {
                    const production = amount * level * productionMultiplier;
                    totalProduction[resource] = (totalProduction[resource] || 0) + production;
                });
            });
            
            if (Object.keys(totalProduction).length > 0) {
                updateResources(totalProduction);
                
                // Show production notification every 30 seconds
                if (timeDiff >= 30000) {
                    const productionText = Object.entries(totalProduction)
                        .map(([resource, amount]) => `+${Math.floor(amount)} ${resource}`)
                        .join(', ');
                    showNotification(`Production: ${productionText}`, 'info', 3000);
                }
            }
            
            gameState.lastBuildingProduction = now;
        }

        function updateEmpireDisplay() {
            const empireContainer = document.getElementById('empireBuildings');
            if (!empireContainer) return;
            
            empireContainer.innerHTML = Object.entries(STATIC_DATA.BUILDINGS).map(([buildingType, building]) => {
                const currentLevel = gameState.buildings[buildingType] || 0;
                const nextLevel = currentLevel + 1;
                const canAfford = canAffordBuilding(buildingType, nextLevel);
                const isUnlocked = gameState.player.level >= building.unlockLevel;
                const atMaxLevel = currentLevel >= building.maxLevel;
                
                const costs = {};
                Object.entries(building.baseCost).forEach(([resource, amount]) => {
                    costs[resource] = Math.floor(amount * Math.pow(building.costMultiplier, nextLevel - 1));
                });
                
                const production = Object.entries(building.baseProduction)
                    .map(([resource, amount]) => `+${amount * currentLevel}/min ${resource}`)
                    .join(', ');
                
                return `
                    <div class="building-card ${currentLevel > 0 ? 'owned' : ''} ${!isUnlocked ? 'opacity-50' : ''}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${building.icon}</span>
                                <div>
                                    <h4 class="font-bold">${building.name}</h4>
                                    <span class="text-sm text-stone-400">Level ${currentLevel}/${building.maxLevel}</span>
                                </div>
                            </div>
                            ${!isUnlocked ? `<span class="text-xs text-red-400">Requires Lv.${building.unlockLevel}</span>` : ''}
                        </div>
                        <p class="text-sm text-stone-300 mb-3">${building.description}</p>
                        ${currentLevel > 0 ? `<p class="text-xs text-green-400 mb-3">Production: ${production}</p>` : ''}
                        ${!atMaxLevel && isUnlocked ? `
                            <div class="mb-3">
                                <p class="text-xs text-stone-400 mb-2">Upgrade Cost:</p>
                                <div class="text-xs space-x-2">
                                    ${Object.entries(costs).map(([resource, cost]) => 
                                        `<span class="${gameState.resources[resource] >= cost ? 'text-green-400' : 'text-red-400'}">${cost} ${resource}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <button onclick="purchaseBuilding('${buildingType}')" 
                                    class="upgrade-button w-full" ${!canAfford ? 'disabled' : ''}>
                                ${currentLevel === 0 ? 'Build' : 'Upgrade'}
                            </button>
                        ` : atMaxLevel ? `<div class="text-center text-amber-400 font-bold">MAX LEVEL</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // === RANKING SYSTEM ===
        function calculatePlayerPower() {
            let power = gameState.player.level * 100;
            power += gameState.player.prestigeLevel * 5000;
            power += (gameState.player.territories?.length || 0) * 50;
            power += Math.floor(gameState.player.lifetimeSpice / 10);
            power += gameState.player.totalEnemiesDefeated * 25;
            power += Object.values(gameState.resources).reduce((sum, val) => sum + val, 0);
            
            return power;
        }

        function updateRankingsDisplay() {
            const rankingsContainer = document.getElementById('rankingsContainer');
            const topRankingsContainer = document.getElementById('topRankings');
            
            if (!gameState.rankings.length) {
                if (rankingsContainer) {
                    rankingsContainer.innerHTML = '<p class="text-stone-400 text-center">No rankings available</p>';
                }
                if (topRankingsContainer) {
                    topRankingsContainer.innerHTML = '<p class="text-stone-400 text-center text-sm">Loading rankings...</p>';
                }
                return;
            }
            
            // Top 5 for sidebar
            if (topRankingsContainer) {
                topRankingsContainer.innerHTML = gameState.rankings.slice(0, 5).map((player, index) => `
                    <div class="ranking-card rank-${index + 1} flex items-center justify-between p-2 rounded">
                        <div class="flex items-center">
                            <span class="text-lg mr-2">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}</span>
                            <div>
                                <span class="player-color-${player.color} font-semibold text-sm">${player.name || 'Unknown'}</span>
                                <div class="text-xs text-stone-400">P${player.prestigeLevel || 0} ‚Ä¢ Lv.${player.level}</div>
                            </div>
                        </div>
                        <div class="text-right text-xs">
                            <div class="text-amber-400 font-bold">${(player.power || 0).toLocaleString()}</div>
                            <div class="text-stone-400">${player.territories || 0} territories</div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Full rankings for multiplayer tab
            if (rankingsContainer) {
                rankingsContainer.innerHTML = gameState.rankings.slice(0, 20).map((player, index) => `
                    <div class="leaderboard-entry ranking-card rank-${index + 1} p-3 bg-stone-700 rounded border-l-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-xl mr-3">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}</span>
                                <div>
                                    <div class="player-color-${player.color} font-bold">${player.name || 'Unknown'}</div>
                                    <div class="text-sm text-stone-400">
                                        P${player.prestigeLevel || 0} ‚Ä¢ Lv.${player.level} ‚Ä¢ ${STATIC_DATA.HOUSES[player.house]?.name || 'No House'}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-amber-400 font-bold text-lg">${(player.power || 0).toLocaleString()}</div>
                                <div class="text-xs text-stone-400">
                                    ${player.territories || 0} territories ‚Ä¢ ${player.totalEnemiesDefeated || 0} defeats
                                </div>
                                <div class="text-xs text-stone-400">
                                    ${(player.lifetimeSpice || 0).toLocaleString()} spice collected
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // === WORLD CHAT ===
        async function sendWorldMessage(message, type = 'chat') {
            if (!db || !message.trim()) return;
            
            try {
                await addDoc(collection(db, 'worldChat'), {
                    playerId: userId,
                    playerName: gameState.player.name,
                    playerColor: gameState.player.color,
                    message: message.trim(),
                    type: type,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }

        function updateWorldChat(messages) {
            const chatContainer = document.getElementById('worldChatMessages');
            if (!chatContainer) return;
            
            chatContainer.innerHTML = messages.slice(-30).map(msg => {
                const time = msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString() : new Date().toLocaleTimeString();
                const colorClass = `player-color-${msg.playerColor || 'white'}`;
                
                if (msg.type === 'boss') {
                    return `<div class="text-red-400 font-bold">[${time}] üèÜ ${msg.message}</div>`;
                } else if (msg.type === 'event') {
                    return `<div class="text-purple-400 font-bold">[${time}] üåü ${msg.message}</div>`;
                } else {
                    return `<div>[${time}] <span class="${colorClass} font-semibold">${msg.playerName}:</span> ${msg.message}</div>`;
                }
            }).join('');
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // === UTILITY FUNCTIONS ===
        function generateId() {
            return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function addExperience(amount) {
            const houseBonus = gameState.player.house === 'atreides' ? 1.25 : 1;
            const finalAmount = Math.floor(amount * houseBonus);
            
            gameState.player.experience += finalAmount;
            
            while (gameState.player.experience >= gameState.player.experienceToNext) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.player.level++;
            gameState.player.experience -= gameState.player.experienceToNext;
            gameState.player.experienceToNext = Math.floor(CONFIG.XP_BASE * Math.pow(CONFIG.XP_FACTOR, gameState.player.level - 1));
            
            gameState.player.maxHealth += 15;
            gameState.player.health = gameState.player.maxHealth;
            gameState.player.maxEnergy += 8;
            gameState.player.energy = gameState.player.maxEnergy;
            gameState.player.attack += 4;
            gameState.player.defense += 3;
            
            showNotification(`üåü LEVEL UP! Now level ${gameState.player.level}!`, 'legendary');
            
            if (gameState.player.level === CONFIG.ENERGY_PRODUCTION_UNLOCK_LEVEL) {
                showNotification('üîì Energy buildings unlocked!', 'info');
            }
        }

        function updateResources(changes) {
            Object.entries(changes).forEach(([resource, amount]) => {
                if (gameState.resources[resource] !== undefined) {
                    gameState.resources[resource] = Math.max(0, gameState.resources[resource] + amount);
                    
                    if (resource === 'spice' && amount > 0) {
                        gameState.player.lifetimeSpice += amount;
                    }
                }
            });
            updateResourceDisplay();
        }

        function addToInventory(item) {
            const emptySlot = gameState.inventory.findIndex(slot => slot === null);
            if (emptySlot === -1) {
                showNotification('Inventory full!', 'warning');
                return false;
            }
            
            gameState.inventory[emptySlot] = { ...item, id: generateId() };
            updateInventoryDisplay();
            return true;
        }

        // === NOTIFICATIONS & POPUPS ===
        function showNotification(message, type = 'info', duration = 4000) {
            // Remove existing notification to prevent duplicates
            if (currentNotification) {
                currentNotification.remove();
                currentNotification = null;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            currentNotification = notification;
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                        if (currentNotification === notification) {
                            currentNotification = null;
                        }
                    }
                }, 400);
            }, duration);
        }

        function showQuotePopup(quote) {
            const popup = document.createElement('div');
            popup.className = 'quote-popup';
            popup.textContent = quote;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    document.body.removeChild(popup);
                }
            }, 6000);
        }

        // === UI UPDATES ===
        function updateResourceDisplay() {
            Object.entries(gameState.resources).forEach(([resource, amount]) => {
                const element = document.getElementById(`resource${resource.charAt(0).toUpperCase() + resource.slice(1)}`);
                if (element) {
                    element.textContent = amount.toLocaleString();
                }
            });
        }

        function updatePlayerStats() {
            document.getElementById('statHealth').textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('statEnergy').textContent = `${gameState.player.energy}/${gameState.player.maxEnergy}`;
            document.getElementById('statLevel').textContent = gameState.player.level;
            document.getElementById('statExp').textContent = `${gameState.player.experience}/${gameState.player.experienceToNext}`;
            
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const energyPercent = (gameState.player.energy / gameState.player.maxEnergy) * 100;
            const expPercent = (gameState.player.experience / gameState.player.experienceToNext) * 100;
            
            document.getElementById('barHealth').style.width = `${healthPercent}%`;
            document.getElementById('barEnergy').style.width = `${energyPercent}%`;
            document.getElementById('barExp').style.width = `${expPercent}%`;
            
            document.getElementById('playerName').textContent = gameState.player.name || 'Loading...';
            document.getElementById('playerPrestige').textContent = gameState.player.prestigeLevel;
            if (gameState.player.house) {
                const house = STATIC_DATA.HOUSES[gameState.player.house];
                document.getElementById('playerHouse').textContent = house.name;
            }
        }

        function updateInventoryDisplay() {
            const inventoryGrid = document.getElementById('uiInventoryGrid');
            if (!inventoryGrid) return;
            
            inventoryGrid.innerHTML = '';
            
            for (let i = 0; i < CONFIG.MAX_INVENTORY; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.dataset.index = i;
                
                const item = gameState.inventory[i];
                if (item) {
                    slot.textContent = item.icon || 'üì¶';
                    slot.title = `${item.name}\n${item.description || ''}`;
                    
                    slot.addEventListener('click', () => {
                        if (item.type && ['weapon', 'armor', 'accessory'].includes(item.type)) {
                            equipItem(item, i);
                        }
                    });
                }
                
                inventoryGrid.appendChild(slot);
            }
        }

        function equipItem(item, inventoryIndex) {
            const equipSlot = item.type;
            const currentEquipped = gameState.equipment[equipSlot];
            
            if (currentEquipped) {
                gameState.inventory[inventoryIndex] = currentEquipped;
            } else {
                gameState.inventory[inventoryIndex] = null;
            }
            
            gameState.equipment[equipSlot] = item;
            
            showNotification(`Equipped ${item.name}`, 'success');
            updateInventoryDisplay();
            updateEquipmentDisplay();
        }

        function updateEquipmentDisplay() {
            ['weapon', 'armor', 'accessory'].forEach(type => {
                const element = document.getElementById(`equip${type.charAt(0).toUpperCase() + type.slice(1)}`);
                if (element) {
                    const item = gameState.equipment[type];
                    if (item) {
                        element.textContent = item.icon || 'üì¶';
                        element.title = `${item.name}\n${item.description || ''}`;
                    } else {
                        element.textContent = '';
                        element.title = 'Empty';
                    }
                }
            });
        }

        function updateOnlinePlayersDisplay() {
            const playersList = document.getElementById('onlinePlayersList');
            if (!playersList) return;
            
            const players = Object.values(gameState.onlinePlayers).slice(0, 20);
            playersList.innerHTML = players.map(player => `
                <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                    <span class="player-color-${player.color} font-semibold">${player.name}</span>
                    <span class="text-xs text-stone-400">P${player.prestigeLevel || 0} Lv.${player.level}</span>
                </div>
            `).join('');
        }

        function updateWorldEventsDisplay() {
            const eventsContainer = document.getElementById('worldEventsContainer');
            if (!eventsContainer) return;
            
            if (!gameState.worldEvents.length) {
                eventsContainer.innerHTML = '<p class="text-stone-400 text-center">No active events</p>';
                return;
            }
            
            eventsContainer.innerHTML = gameState.worldEvents.map(event => {
                const timeLeft = Math.max(0, Math.floor((new Date(event.endTime.seconds * 1000) - Date.now()) / 1000));
                return `
                    <div class="bg-purple-800 p-3 rounded-lg border border-purple-600">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold">${event.icon} ${event.name}</span>
                            <span class="text-xs">${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}</span>
                        </div>
                        <p class="text-sm text-stone-300">${event.description}</p>
                        <p class="text-xs text-amber-400">Location: ${event.position.x},${event.position.y}</p>
                    </div>
                `;
            }).join('');
        }

        function updateUI() {
            updateResourceDisplay();
            updatePlayerStats();
            updateInventoryDisplay();
            updateEquipmentDisplay();
            updateOnlinePlayersDisplay();
            updateWorldEventsDisplay();
            updateEmpireDisplay();
            updateRankingsDisplay();
        }

        // === GAME LOOP ===
        function startGameLoop() {
            console.log("üîÑ Starting game loop...");
            
            setInterval(() => {
                // Energy regeneration
                if (Date.now() - gameState.lastEnergyRegen >= CONFIG.ENERGY_REGEN_INTERVAL) {
                    const regenRate = gameState.player.energyProductionRate;
                    gameState.player.energy = Math.min(gameState.player.maxEnergy, gameState.player.energy + regenRate);
                    gameState.lastEnergyRegen = Date.now();
                }
                
                // Building production
                processBuildingProduction();
                
                // Auto-save
                if (Date.now() - gameState.lastSaveTime >= CONFIG.SAVE_INTERVAL) {
                    saveGame();
                }
                
                updatePlayerStats();
            }, 1000);
            
            // Longer intervals
            setInterval(() => {
                if (Math.random() < 0.05) {
                    const quote = DUNE_QUOTES[Math.floor(Math.random() * DUNE_QUOTES.length)];
                    showQuotePopup(`"${quote}"`);
                }
            }, 60000);
        }

        // === GLOBAL FUNCTIONS ===
        window.combatAction = combatAction;
        window.movePlayer = movePlayer;
        window.purchaseBuilding = purchaseBuilding;

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üì± DOM loaded, starting initialization...");
            
            initializationTimeout = setTimeout(() => {
                if (!gameState.gameInitialized && !firebaseInitialized) {
                    console.log("‚è∞ Timeout reached, starting offline mode");
                    startOfflineMode();
                }
            }, 8000);
            
            await initializeFirebase();
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    const tabId = button.dataset.tab + 'Tab';
                    document.getElementById(tabId)?.classList.remove('hidden');
                    
                    gameState.currentTab = button.dataset.tab;
                    
                    if (button.dataset.tab === 'game') {
                        renderMap();
                    } else if (button.dataset.tab === 'empire') {
                        updateEmpireDisplay();
                    }
                });
            });
            
            // Combat actions
            document.getElementById('combatActionAttack')?.addEventListener('click', () => combatAction('attack'));
            document.getElementById('combatActionDefend')?.addEventListener('click', () => combatAction('defend'));
            document.getElementById('combatActionFlee')?.addEventListener('click', () => combatAction('flee'));
            
            // Movement keys
            document.addEventListener('keydown', (e) => {
                if (gameState.combat.active) return;
                
                switch (e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        movePlayer(0, 1);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        movePlayer(1, 0);
                        break;
                    case ' ':
                        e.preventDefault();
                        const content = getMapCellContent(gameState.player.position.x, gameState.player.position.y);
                        if (content && content.type === 'resource') {
                            harvestResource(content.data);
                        }
                        break;
                }
            });
            
            // Chat functionality
            const chatInput = document.getElementById('worldChatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            
            if (chatInput && sendChatBtn) {
                const sendMessage = () => {
                    const message = chatInput.value.trim();
                    if (message) {
                        sendWorldMessage(message);
                        chatInput.value = '';
                    }
                };
                
                sendChatBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });
    </script>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-stone-950 text-white flex items-center justify-center z-[10000]">
        <div class="text-center">
            <div class="text-6xl font-orbitron text-amber-400 mb-6 prestige-glow">üèúÔ∏è ARRAKIS</div>
            <div class="text-3xl mb-4">Multiplayer Spice Empire</div>
            <div class="text-lg text-amber-300 mb-6">Connecting to the desert world...</div>
            <div class="flex items-center justify-center space-x-2">
                <div class="w-4 h-4 bg-amber-400 rounded-full animate-bounce"></div>
                <div class="w-4 h-4 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-4 h-4 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <div class="mt-8 text-stone-400 italic text-lg">"The spice must flow..."</div>
            <div class="mt-4 text-stone-500 text-sm">Join hundreds of players in the ultimate desert survival experience</div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="bg-gradient-to-r from-stone-800 to-stone-700 border-b-2 border-amber-500 px-6 py-4 fixed top-0 left-0 right-0 z-100 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <h1 class="text-4xl font-orbitron font-bold text-amber-400 prestige-glow">üèúÔ∏è Arrakis: Spice Empire</h1>
                <span class="text-lg text-amber-200 italic">"The Spice Must Flow"</span>
            </div>
            <div class="flex items-center space-x-8">
                <div class="text-sm">
                    <span class="text-stone-400">Player:</span>
                    <span id="playerName" class="font-bold text-amber-300">Loading...</span>
                </div>
                <div class="text-sm">
                    <span class="text-stone-400">House:</span>
                    <span id="playerHouse" class="font-semibold">None</span>
                </div>
                <div class="text-sm">
                    <span class="text-stone-400">Prestige:</span>
                    <span id="playerPrestige" class="font-bold text-purple-400 prestige-glow">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-stone-800 border-b border-stone-600 px-6 fixed top-[88px] left-0 right-0 z-100">
        <div class="flex space-x-2">
            <button class="tab-button active px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="game">üèúÔ∏è Desert World</button>
            <button class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="character">üë§ Character</button>
            <button class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="empire">üèóÔ∏è Spice Empire</button>
            <button class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="multiplayer">üåç Multiplayer</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex pt-[140px] h-screen">
        <!-- Left Sidebar -->
        <aside class="w-80 bg-gradient-to-b from-stone-800 to-stone-900 border-r-2 border-amber-600 flex flex-col p-4 space-y-4 overflow-y-auto shadow-lg">
            <!-- Resources -->
            <div class="bg-stone-700 p-4 rounded-lg border border-amber-500">
                <h3 class="text-lg font-semibold text-amber-400 mb-3 font-orbitron">üì¶ Empire Resources</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-amber-400 mr-2">‚ú®</span>Spice:</span>
                        <span id="resourceSpice" class="font-mono text-amber-300 font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-orange-400 mr-2">üî•</span>Melange:</span>
                        <span id="resourceMelange" class="font-mono text-orange-300 font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-blue-400 mr-2">üíß</span>Water:</span>
                        <span id="resourceWater" class="font-mono text-blue-300 font-bold">200</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-yellow-400 mr-2">üí∞</span>Solari:</span>
                        <span id="resourceSolari" class="font-mono text-yellow-300 font-bold">2000</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-gray-400 mr-2">üîß</span>Plasteel:</span>
                        <span id="resourcePlasteel" class="font-mono text-gray-300 font-bold">150</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-purple-400 mr-2">üíé</span>Rare Materials:</span>
                        <span id="resourceRareMaterials" class="font-mono text-purple-300 font-bold">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Character Stats -->
            <div class="bg-stone-700 p-4 rounded-lg border border-blue-500">
                <h3 class="text-lg font-semibold text-blue-400 mb-3 font-orbitron">‚ö° Vital Stats</h3>
                <div class="space-y-3 text-sm">
                    <div class="p-2 bg-stone-600 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Health:</span>
                            <span id="statHealth" class="font-mono">120/120</span>
                        </div>
                        <div class="progress-bar-bg rounded h-3">
                            <div id="barHealth" class="progress-bar-fill h-full rounded" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="p-2 bg-stone-600 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Energy:</span>
                            <span id="statEnergy" class="font-mono">150/150</span>
                        </div>
                        <div class="progress-bar-bg rounded h-3">
                            <div id="barEnergy" class="bg-blue-500 h-full rounded" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="p-2 bg-stone-600 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Level <span id="statLevel" class="font-bold">1</span>:</span>
                            <span id="statExp" class="font-mono text-xs">0/100</span>
                        </div>
                        <div class="progress-bar-bg rounded h-3">
                            <div id="barExp" class="bg-purple-500 h-full rounded" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Rankings -->
            <div class="bg-gradient-to-br from-amber-900 to-stone-800 p-4 rounded-lg border border-amber-500">
                <h3 class="text-lg font-semibold text-amber-300 mb-3 font-orbitron">üèÜ Top Players</h3>
                <div id="topRankings" class="space-y-1 text-sm">
                    <p class="text-stone-400 text-center">Loading rankings...</p>
                </div>
            </div>
            
            <!-- World Events -->
            <div class="bg-purple-800 p-4 rounded-lg border border-purple-500">
                <h3 class="text-lg font-semibold text-purple-300 mb-3 font-orbitron">üåü World Events</h3>
                <div id="worldEventsContainer" class="space-y-2 text-sm max-h-32 overflow-y-auto">
                    <p class="text-stone-400 text-center">No active events</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Game Tab -->
            <div id="gameTab" class="tab-content flex-1 p-6 overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-orbitron text-amber-400">üèúÔ∏è The Great Desert of Arrakis</h2>
                    <div class="text-lg text-stone-300">
                        Position: <span id="mapPlayerCoords" class="text-amber-300 font-bold">250,250</span>
                    </div>
                </div>
                
                <div class="mb-8 text-center">
                    <div class="text-sm text-stone-400 mb-4 p-3 bg-stone-800 rounded-lg border border-stone-600">
                        <span class="font-semibold text-amber-400">Controls:</span> 
                        WASD/Arrow Keys to move ‚Ä¢ Space to harvest ‚Ä¢ Click cells to interact ‚Ä¢ Auto-combat when moving onto enemies
                    </div>
                    <div id="uiMapGrid" class="map-grid mx-auto"></div>
                    <div class="mt-4 text-sm text-stone-400 flex flex-wrap justify-center gap-4">
                        <span class="flex items-center"><span class="text-amber-400 mr-1">‚òÖ</span> You</span>
                        <span class="flex items-center"><span class="text-purple-400 mr-1">‚óÜ</span> Other Players</span>
                        <span class="flex items-center"><span class="text-red-400 mr-1">üëπ</span> Enemies</span>
                        <span class="flex items-center"><span class="text-green-400 mr-1">‚óà</span> Resources</span>
                        <span class="flex items-center"><span class="text-gray-400 mr-1">?</span> Hidden</span>
                    </div>
                </div>
            </div>
            
            <!-- Character Tab -->
            <div id="characterTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-3xl font-orbitron text-amber-400 mb-6">üë§ Character Profile</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">Equipment</h3>
                        <div class="grid grid-cols-3 gap-4 text-center mb-6">
                            <div>
                                <div id="equipWeapon" class="inventory-slot mx-auto mb-2 w-16 h-16"></div>
                                <span class="text-sm font-semibold">Weapon</span>
                            </div>
                            <div>
                                <div id="equipArmor" class="inventory-slot mx-auto mb-2 w-16 h-16"></div>
                                <span class="text-sm font-semibold">Armor</span>
                            </div>
                            <div>
                                <div id="equipAccessory" class="inventory-slot mx-auto mb-2 w-16 h-16"></div>
                                <span class="text-sm font-semibold">Accessory</span>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">Inventory</h3>
                        <div id="uiInventoryGrid" class="grid grid-cols-8 gap-2"></div>
                        <p class="text-xs text-stone-400 mt-3">Click equipment items to equip them</p>
                    </div>
                    
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">Character Statistics</h3>
                        <div class="space-y-3 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <p class="flex justify-between">
                                    <span>Attack Power:</span>
                                    <span class="text-red-400 font-bold">15</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Defense Rating:</span>
                                    <span class="text-blue-400 font-bold">10</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Critical Chance:</span>
                                    <span class="text-yellow-400 font-bold">8%</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Dodge Chance:</span>
                                    <span class="text-green-400 font-bold">15%</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Empire Tab -->
            <div id="empireTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-3xl font-orbitron text-amber-400 mb-6">üèóÔ∏è Spice Empire Management</h2>
                <p class="text-center text-stone-300 mb-8">Build and upgrade your spice empire to generate passive income!</p>
                
                <div id="empireBuildings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Buildings will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Multiplayer Tab -->
            <div id="multiplayerTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-3xl font-orbitron text-amber-400 mb-6">üåç Multiplayer Hub</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- World Chat -->
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">üí¨ World Chat</h3>
                        <div id="worldChatMessages" class="chat-container p-3 mb-4 text-sm"></div>
                        <div class="flex space-x-2">
                            <input type="text" id="worldChatInput" placeholder="Type your message..." 
                                   class="flex-1 px-3 py-2 bg-stone-700 border border-stone-600 rounded text-white">
                            <button id="sendChatBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">Send</button>
                        </div>
                    </div>
                    
                    <!-- Online Players -->
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">üë• Online Players</h3>
                        <div id="onlinePlayersList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                    
                    <!-- Rankings -->
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600 lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">üèÜ Global Rankings</h3>
                        <div id="rankingsContainer" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-stone-400 text-center">Loading rankings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Combat Modal -->
    <div id="modalCombat" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-3xl">
            <h3 class="text-3xl font-orbitron text-red-500 mb-6 text-center">‚öîÔ∏è DESERT COMBAT ‚öîÔ∏è</h3>
            
            <div class="grid grid-cols-2 gap-8 mb-6">
                <div class="bg-stone-700 p-4 rounded-lg">
                    <div class="flex justify-between items-baseline mb-3">
                        <span id="modalCombatPlayerName" class="font-bold text-green-400 text-lg">Player</span>
                        <span id="modalCombatPlayerLevel" class="text-sm text-stone-400">Lv.1</span>
                    </div>
                    <div class="text-sm mb-2">Health: <span id="modalCombatPlayerHealth">120/120</span></div>
                    <div class="progress-bar-bg rounded h-4 mb-3">
                        <div id="modalCombatPlayerHealthBar" class="progress-bar-fill h-full rounded" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="bg-stone-700 p-4 rounded-lg">
                    <div class="flex justify-between items-baseline mb-3">
                        <span id="modalCombatEnemyName" class="font-bold text-red-400 text-lg">Enemy</span>
                        <span id="modalCombatEnemyLevel" class="text-sm text-stone-400">Lv.1</span>
                    </div>
                    <div class="text-sm mb-2">Health: <span id="modalCombatEnemyHealth">50/50</span></div>
                    <div class="progress-bar-bg rounded h-4">
                        <div id="modalCombatEnemyHealthBar" class="bg-red-600 h-full rounded" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            
            <div id="modalCombatLog" class="bg-stone-900 rounded p-4 h-48 overflow-y-auto text-sm mb-6 border border-stone-600"></div>
            
            <div class="grid grid-cols-3 gap-4">
                <button id="combatActionAttack" class="py-4 bg-red-600 hover:bg-red-700 rounded font-bold text-lg">‚öîÔ∏è Attack</button>
                <button id="combatActionDefend" class="py-4 bg-blue-600 hover:bg-blue-700 rounded font-bold text-lg">üõ°Ô∏è Defend</button>
                <button id="combatActionFlee" class="py-4 bg-stone-600 hover:bg-stone-700 rounded font-bold text-lg">üí® Flee</button>
            </div>
        </div>
    </div>

</body>
</html>
