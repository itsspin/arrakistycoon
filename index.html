<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrakis Tycoon - Dune MMO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1c1917; }
        h1, h2, h3, h4, .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { border-bottom-color: #f59e0b; color: #f59e0b; }
        .progress-bar-bg { background-color: #57534e; }
        .progress-bar-fill { background-color: #f59e0b; transition: width 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #44403c; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #d6d3d1; }
        .map-grid { 
            display: grid; 
            gap: 1px; 
            background-color: #292524; 
            border: 2px solid #44403c;
            padding: 2px;
        }
        .map-cell { 
            position: relative;
            transition: all 0.1s;
            border: 1px solid #44403c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .map-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            border-color: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .map-cell.near-player {
            border-color: #78716c;
            background-color: #44403c;
        }
        .map-cell.at-player {
            border-color: #f59e0b;
            background-color: #451a03;
            box-shadow: inset 0 0 10px rgba(245, 158, 11, 0.3);
        }
        .minimap-container {
            position: relative;
            width: 120px;
            height: 120px;
            background: #1c1917;
            border: 1px solid #44403c;
            overflow: hidden;
        }
        .minimap-cell {
            position: absolute;
            width: 2px;
            height: 2px;
        }
        .player-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background-color: #059669; }
        .notification.error { background-color: #dc2626; }
        .notification.warning { background-color: #d97706; }
        .notification.info { background-color: #2563eb; }
        .notification.epic { background-color: #7c3aed; }
        .notification.legendary { background-color: #f59e0b; color: black; }
        .inventory-slot {
            width: 40px;
            height: 40px;
            border: 2px solid #44403c;
            background: #292524;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
        }
        .inventory-slot:hover {
            border-color: #f59e0b;
            transform: scale(1.05);
        }
        .item-rarity-common { border-color: #6b7280 !important; }
        .item-rarity-uncommon { border-color: #059669 !important; }
        .item-rarity-rare { border-color: #2563eb !important; }
        .item-rarity-epic { border-color: #7c3aed !important; }
        .item-rarity-legendary { 
            border-color: #f59e0b !important; 
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .rank-novice { color: #9ca3af; }
        .rank-apprentice { color: #10b981; }
        .rank-trader { color: #3b82f6; }
        .rank-merchant { color: #8b5cf6; }
        .rank-baron { color: #f59e0b; }
        .rank-duke { color: #ef4444; }
        .rank-emperor { 
            color: #f59e0b; 
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.8);
            font-weight: bold;
        }
        .combat-turn-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: #f59e0b;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        .loot-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1c1917;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        .event-log-container {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-stone-900 text-amber-50 antialiased">

    <!-- Header -->
    <header class="bg-stone-800 border-b border-stone-700 px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-orbitron font-bold text-amber-400">Arrakis Tycoon</h1>
                <span class="text-xs text-amber-200 italic">The spice must flow...</span>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-sm">
                    <span class="text-stone-400">Players:</span>
                    <span id="playersOnline" class="text-amber-400 font-semibold">12</span>
                </div>
                <div class="text-sm">
                    <span class="text-stone-400">Rank:</span>
                    <span id="playerRankDisplay" class="font-semibold rank-novice">Novice</span>
                </div>
                <button id="saveBtn" class="px-3 py-1 bg-green-700 hover:bg-green-600 rounded text-sm">üíæ</button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-stone-800 border-b border-stone-700 px-4">
        <div class="flex space-x-1">
            <button class="tab-button active px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="game">Game</button>
            <button class="tab-button px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="character">Character</button>
            <button class="tab-button px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="multiplayer">Rankings</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex h-[calc(100vh-112px)]">
        <!-- Left Sidebar -->
        <aside class="w-72 bg-stone-800 border-r border-stone-700 flex flex-col">
            <!-- Resources Panel -->
            <div class="p-3 border-b border-stone-700">
                <h3 class="text-base font-semibold text-amber-400 mb-2">üì¶ Resources</h3>
                <div class="space-y-1 text-sm">
                    <div class="flex items-center justify-between">
                        <span>‚ú® Spice:</span>
                        <span id="spiceCount" class="font-mono text-amber-300">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>üíß Water:</span>
                        <span id="waterCount" class="font-mono text-blue-300">100</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>üí∞ Solari:</span>
                        <span id="solariCount" class="font-mono text-yellow-300">500</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>üîß Plasteel:</span>
                        <span id="plasteelCount" class="font-mono text-gray-300">50</span>
                    </div>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs mb-1">
                            <span>‚ù§Ô∏è Health:</span>
                            <span id="healthText">100/100</span>
                        </div>
                        <div class="progress-bar-bg rounded-full h-2">
                            <div id="healthBar" class="progress-bar-fill h-full rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Panel -->
            <div class="p-3 border-b border-stone-700">
                <h3 class="text-base font-semibold text-amber-400 mb-2">‚ö° Actions</h3>
                <div class="space-y-2">
                    <button id="harvestSpiceBtn" class="w-full px-3 py-1.5 bg-amber-600 hover:bg-amber-700 rounded text-sm font-medium">
                        ‚ú® Harvest (<span id="harvestAmount">1</span>)
                    </button>
                    <button id="sellSpiceBtn" class="w-full px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-sm font-medium">
                        üí∞ Sell Spice (<span id="spicePrice">5</span> each)
                    </button>
                    <div class="grid grid-cols-2 gap-1">
                        <button class="move-btn px-2 py-1 bg-stone-700 hover:bg-stone-600 rounded text-xs" data-dir="north">‚¨ÜÔ∏è N</button>
                        <button class="move-btn px-2 py-1 bg-stone-700 hover:bg-stone-600 rounded text-xs" data-dir="south">‚¨áÔ∏è S</button>
                        <button class="move-btn px-2 py-1 bg-stone-700 hover:bg-stone-600 rounded text-xs" data-dir="west">‚¨ÖÔ∏è W</button>
                        <button class="move-btn px-2 py-1 bg-stone-700 hover:bg-stone-600 rounded text-xs" data-dir="east">‚û°Ô∏è E</button>
                    </div>
                </div>
            </div>

            <!-- Minimap -->
            <div class="p-3 border-b border-stone-700">
                <h3 class="text-base font-semibold text-amber-400 mb-2">üó∫Ô∏è Minimap</h3>
                <div id="minimapContainer" class="minimap-container mx-auto"></div>
                <div class="mt-1 text-xs text-stone-400 text-center">
                    Pos: <span id="playerPosition" class="font-mono text-amber-300">(25,25)</span>
                </div>
            </div>

            <!-- Event Log -->
            <div class="flex-1 flex flex-col p-3">
                <h3 class="text-base font-semibold text-amber-400 mb-2">üìú Events</h3>
                <div id="gameLog" class="event-log-container flex-1 bg-stone-900 rounded p-2 text-xs"></div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- Game Tab -->
            <div id="gameTab" class="tab-content flex-1 flex">
                <div class="flex-1 flex flex-col p-4">
                    <!-- Top Section - Map & Tycoon -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Map -->
                        <div class="bg-stone-800 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-base font-semibold text-amber-400">üèúÔ∏è Desert Map</h3>
                                <span class="text-xs text-stone-400">Danger: <span id="dangerLevel" class="text-red-400">High</span></span>
                            </div>
                            <div id="mapContainer" class="map-grid" style="grid-template-columns: repeat(11, 35px); grid-template-rows: repeat(11, 35px);"></div>
                        </div>

                        <!-- Tycoon Management -->
                        <div class="bg-stone-800 rounded-lg p-3 overflow-y-auto" style="max-height: 420px;">
                            <h3 class="text-base font-semibold text-amber-400 mb-3">üè≠ Tycoon Empire</h3>
                            
                            <!-- Production -->
                            <div class="mb-4">
                                <h4 class="font-semibold text-sm mb-2">‚öôÔ∏è Production</h4>
                                <div class="space-y-2">
                                    <div class="bg-stone-700 rounded p-2">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs">Manual Harvest</span>
                                            <span class="text-xs bg-amber-600 px-2 rounded">Lv.<span id="harvestLevel">1</span></span>
                                        </div>
                                        <button id="upgradeHarvest" class="w-full px-2 py-1 bg-amber-600 hover:bg-amber-700 rounded text-xs">
                                            Upgrade (<span id="harvestCost">100</span> Solari)
                                        </button>
                                    </div>
                                    
                                    <div class="bg-stone-700 rounded p-2">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs">ü§ñ Auto-Harvesters</span>
                                            <span class="text-xs bg-blue-600 px-2 rounded"><span id="autoCount">0</span></span>
                                        </div>
                                        <div class="text-xs text-stone-400 mb-1">+<span id="autoProduction">0</span>/sec</div>
                                        <button id="buyAuto" class="w-full px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                                            Buy (<span id="autoCost">250</span> Solari)
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Buildings -->
                            <div class="mb-4">
                                <h4 class="font-semibold text-sm mb-2">üèóÔ∏è Buildings</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-stone-700 rounded p-2">
                                        <div class="text-center mb-1">
                                            <div class="text-lg">üè≠</div>
                                            <div class="text-xs font-semibold">Refinery</div>
                                            <div class="text-xs text-stone-400">Lv.<span id="refineryLevel">0</span></div>
                                        </div>
                                        <button id="buildRefinery" class="w-full px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                            500üí∞ 50üîß
                                        </button>
                                    </div>
                                    
                                    <div class="bg-stone-700 rounded p-2">
                                        <div class="text-center mb-1">
                                            <div class="text-lg">üõ°Ô∏è</div>
                                            <div class="text-xs font-semibold">Defense</div>
                                            <div class="text-xs text-stone-400">Lv.<span id="defenseLevel">0</span></div>
                                        </div>
                                        <button id="buildDefense" class="w-full px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                            400üí∞ 40üîß
                                        </button>
                                    </div>
                                    
                                    <div class="bg-stone-700 rounded p-2">
                                        <div class="text-center mb-1">
                                            <div class="text-lg">üè™</div>
                                            <div class="text-xs font-semibold">Market</div>
                                            <div class="text-xs text-stone-400">Lv.<span id="marketLevel">0</span></div>
                                        </div>
                                        <button id="buildMarket" class="w-full px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                                            300üí∞ 30üîß
                                        </button>
                                    </div>
                                    
                                    <div class="bg-stone-700 rounded p-2">
                                        <div class="text-center mb-1">
                                            <div class="text-lg">üè¶</div>
                                            <div class="text-xs font-semibold">Bank</div>
                                            <div class="text-xs text-stone-400">Lv.<span id="bankLevel">0</span></div>
                                        </div>
                                        <button id="buildBank" class="w-full px-2 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-xs">
                                            600üí∞ 60üîß
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Units -->
                            <div>
                                <h4 class="font-semibold text-sm mb-2">‚öîÔ∏è Military</h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="bg-stone-700 rounded p-2 text-center">
                                        <div class="text-lg">üó°Ô∏è</div>
                                        <div class="text-xs">Infantry</div>
                                        <div class="text-xs text-stone-400"><span id="infantryCount">0</span></div>
                                        <button id="buyInfantry" class="mt-1 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                            100üí∞
                                        </button>
                                    </div>
                                    <div class="bg-stone-700 rounded p-2 text-center">
                                        <div class="text-lg">üèπ</div>
                                        <div class="text-xs">Archers</div>
                                        <div class="text-xs text-stone-400"><span id="archerCount">0</span></div>
                                        <button id="buyArcher" class="mt-1 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                            150üí∞
                                        </button>
                                    </div>
                                    <div class="bg-stone-700 rounded p-2 text-center">
                                        <div class="text-lg">üõ∏</div>
                                        <div class="text-xs">Thopter</div>
                                        <div class="text-xs text-stone-400"><span id="thopterCount">0</span></div>
                                        <button id="buyThopter" class="mt-1 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                            300üí∞
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Section - Quests & Inventory -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Active Quests -->
                        <div class="bg-stone-800 rounded-lg p-3" style="max-height: 200px; overflow-y: auto;">
                            <h3 class="text-base font-semibold text-amber-400 mb-2">üìã Active Quests</h3>
                            <div id="questList" class="space-y-2"></div>
                        </div>

                        <!-- Quick Inventory -->
                        <div class="bg-stone-800 rounded-lg p-3">
                            <h3 class="text-base font-semibold text-amber-400 mb-2">üéí Quick Inventory</h3>
                            <div class="grid grid-cols-8 gap-1">
                                <div id="quickSlots"></div>
                            </div>
                            <div id="lastLoot" class="mt-2 text-xs text-stone-400"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - Chat & Players -->
                <div class="w-72 bg-stone-800 border-l border-stone-700 flex flex-col">
                    <!-- Online Players -->
                    <div class="p-3 border-b border-stone-700">
                        <h3 class="text-base font-semibold text-amber-400 mb-2">üë• Nearby Players</h3>
                        <div id="playerList" class="space-y-1 max-h-32 overflow-y-auto text-sm"></div>
                    </div>

                    <!-- Top Ranks -->
                    <div class="p-3 border-b border-stone-700">
                        <h3 class="text-base font-semibold text-amber-400 mb-2">üèÜ Top Ranks</h3>
                        <div id="topRanks" class="space-y-1 text-sm"></div>
                    </div>

                    <!-- Global Chat -->
                    <div class="flex-1 flex flex-col p-3">
                        <h3 class="text-base font-semibold text-amber-400 mb-2">üí¨ Global Chat</h3>
                        <div id="chatMessages" class="flex-1 bg-stone-900 rounded p-2 text-xs overflow-y-auto mb-2"></div>
                        <div class="flex">
                            <input id="chatInput" type="text" placeholder="Type message..." class="flex-1 px-2 py-1 bg-stone-700 rounded-l text-xs" maxlength="80">
                            <button id="chatSend" class="px-3 py-1 bg-amber-600 hover:bg-amber-700 rounded-r text-xs">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Character Tab -->
            <div id="characterTab" class="tab-content hidden flex-1 p-4">
                <div class="max-w-4xl mx-auto grid grid-cols-2 gap-6">
                    <!-- Character Stats -->
                    <div>
                        <h2 class="text-xl font-bold text-amber-400 mb-4">üë§ Character Profile</h2>
                        
                        <div class="bg-stone-800 rounded-lg p-4 mb-4">
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">Name</label>
                                <input id="playerName" type="text" class="w-full px-3 py-2 bg-stone-700 rounded text-sm" value="Survivor">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="block text-sm font-medium mb-1">Level</span>
                                    <span id="playerLevel" class="text-2xl font-bold text-amber-400">1</span>
                                </div>
                                <div>
                                    <span class="block text-sm font-medium mb-1">Experience</span>
                                    <div class="progress-bar-bg rounded-full h-2 mt-2">
                                        <div id="expBar" class="progress-bar-fill h-full rounded-full" style="width: 0%"></div>
                                    </div>
                                    <span id="expText" class="text-xs text-stone-400">0/100</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-stone-800 rounded-lg p-4">
                            <h3 class="font-semibold mb-3">Combat Stats</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>‚öîÔ∏è Attack</span>
                                    <span id="playerAttack" class="font-semibold text-red-400">10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üõ°Ô∏è Defense</span>
                                    <span id="playerDefense" class="font-semibold text-blue-400">5</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üéØ Critical</span>
                                    <span id="playerCrit" class="font-semibold text-yellow-400">5%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üí® Dodge</span>
                                    <span id="playerDodge" class="font-semibold text-green-400">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Equipment & Inventory -->
                    <div>
                        <h2 class="text-xl font-bold text-amber-400 mb-4">üéí Equipment & Inventory</h2>
                        
                        <div class="bg-stone-800 rounded-lg p-4 mb-4">
                            <h3 class="font-semibold mb-3">Equipped Items</h3>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="text-center">
                                    <div id="weaponSlot" class="inventory-slot mx-auto mb-1">
                                        <span class="text-xl">‚öîÔ∏è</span>
                                    </div>
                                    <div class="text-xs">Weapon</div>
                                </div>
                                <div class="text-center">
                                    <div id="armorSlot" class="inventory-slot mx-auto mb-1">
                                        <span class="text-xl">üõ°Ô∏è</span>
                                    </div>
                                    <div class="text-xs">Armor</div>
                                </div>
                                <div class="text-center">
                                    <div id="accessorySlot" class="inventory-slot mx-auto mb-1">
                                        <span class="text-xl">üíç</span>
                                    </div>
                                    <div class="text-xs">Accessory</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-stone-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-semibold">Inventory</h3>
                                <span class="text-xs text-stone-400"><span id="invCount">0</span>/40</span>
                            </div>
                            <div id="inventoryGrid" class="grid grid-cols-8 gap-1">
                                <!-- Inventory slots will be generated -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Multiplayer Tab -->
            <div id="multiplayerTab" class="tab-content hidden flex-1 p-4">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-xl font-bold text-amber-400 mb-4">üèÜ Global Rankings</h2>
                    
                    <div class="bg-stone-800 rounded-lg p-4">
                        <div class="grid grid-cols-7 gap-2 mb-3 text-sm font-semibold text-stone-400 border-b border-stone-600 pb-2">
                            <div>Rank</div>
                            <div class="col-span-2">Player</div>
                            <div>Title</div>
                            <div>Spice</div>
                            <div>Level</div>
                            <div>Power</div>
                        </div>
                        <div id="fullRankings" class="space-y-2">
                            <!-- Rankings will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Combat Modal -->
    <div id="combatModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-stone-800 rounded-lg p-4 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold text-red-400 mb-3">‚öîÔ∏è Combat</h3>
            
            <div class="grid grid-cols-2 gap-4 mb-3">
                <!-- Enemy -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span id="enemyName" class="font-semibold text-sm">Enemy</span>
                        <span id="enemyLevel" class="text-xs text-stone-400">Lv.1</span>
                    </div>
                    <div class="text-xs mb-1">
                        HP: <span id="enemyHealth">50/50</span>
                    </div>
                    <div class="progress-bar-bg rounded-full h-2">
                        <div id="enemyHealthBar" class="bg-red-500 h-full rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                
                <!-- Player -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-sm">You</span>
                        <span class="text-xs text-stone-400">Lv.<span id="combatPlayerLevel">1</span></span>
                    </div>
                    <div class="text-xs mb-1">
                        HP: <span id="combatPlayerHealth">100/100</span>
                    </div>
                    <div class="progress-bar-bg rounded-full h-2">
                        <div id="playerHealthBar" class="progress-bar-fill h-full rounded-full" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div id="combatLog" class="bg-stone-900 rounded p-2 h-24 overflow-y-auto text-xs mb-3"></div>

            <div class="grid grid-cols-3 gap-2">
                <button id="attackBtn" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded text-sm">
                    ‚öîÔ∏è Attack
                </button>
                <button id="defendBtn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                    üõ°Ô∏è Defend
                </button>
                <button id="fleeBtn" class="px-3 py-1.5 bg-stone-600 hover:bg-stone-700 rounded text-sm">
                    üí® Flee
                </button>
            </div>
            
            <div id="combatTurnIndicator" class="text-center text-xs text-amber-400 mt-2"></div>
        </div>
    </div>

    <!-- Loot Modal -->
    <div id="lootModal" class="loot-popup hidden">
        <h3 class="text-lg font-bold text-amber-400 mb-3">üíé Loot Found!</h3>
        <div id="lootContents" class="space-y-2 mb-3">
            <!-- Loot items will be displayed here -->
        </div>
        <button id="collectLootBtn" class="w-full px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded">
            Collect All
        </button>
    </div>

    <!-- Duel Request Modal -->
    <div id="duelModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-stone-800 rounded-lg p-4 max-w-sm w-full mx-4">
            <h3 class="text-lg font-bold text-red-400 mb-3">‚öîÔ∏è Duel Challenge!</h3>
            <p class="text-sm mb-3">
                <span id="duelChallenger" class="text-amber-400 font-semibold">Player</span> challenges you to a duel!
            </p>
            <div class="grid grid-cols-2 gap-2">
                <button id="acceptDuelBtn" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded">
                    Accept
                </button>
                <button id="declineDuelBtn" class="px-3 py-1.5 bg-stone-600 hover:bg-stone-700 rounded">
                    Decline
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Game State
        const gameState = {
            // Resources
            resources: {
                spice: 0,
                water: 100,
                solari: 500,
                plasteel: 50
            },
            
            // Player
            player: {
                id: 'player_' + Math.random().toString(36).substr(2, 9),
                name: 'Survivor',
                level: 1,
                experience: 0,
                experienceToNext: 100,
                health: 100,
                maxHealth: 100,
                attack: 10,
                defense: 5,
                critChance: 5,
                dodgeChance: 10,
                position: { x: 25, y: 25 },
                totalSpiceCollected: 0,
                enemiesDefeated: 0,
                playersDefeated: 0,
                rank: 'Novice',
                power: 100
            },
            
            // Equipment
            equipment: {
                weapon: null,
                armor: null,
                accessory: null
            },
            
            // Inventory
            inventory: new Array(40).fill(null),
            
            // Production
            production: {
                manual: { level: 1, cost: 100 },
                auto: { count: 0, production: 2, cost: 250 }
            },
            
            // Buildings
            buildings: {
                refinery: { level: 0, bonus: 1.2 },
                defense: { level: 0, protection: 50 },
                market: { level: 0, priceBonus: 1.1 },
                bank: { level: 0, interest: 0.01 }
            },
            
            // Units
            units: {
                infantry: { count: 0, attack: 5, cost: 100 },
                archer: { count: 0, attack: 8, cost: 150 },
                thopter: { count: 0, attack: 15, cost: 300 }
            },
            
            // Map
            map: {
                size: 50,
                viewRadius: 5,
                currentView: { x: 25, y: 25 },
                explored: new Set(['25,25']),
                locations: new Map()
            },
            
            // Quests
            quests: [],
            
            // Market
            spicePrice: 5,
            
            // Other players
            otherPlayers: new Map(),
            
            // Combat
            inCombat: false,
            currentEnemy: null,
            isPlayerTurn: true,
            defendBonus: 0
        };

        // Rank thresholds
        const RANKS = [
            { name: 'Novice', minSpice: 0, color: 'rank-novice' },
            { name: 'Apprentice', minSpice: 100, color: 'rank-apprentice' },
            { name: 'Trader', minSpice: 500, color: 'rank-trader' },
            { name: 'Merchant', minSpice: 2000, color: 'rank-merchant' },
            { name: 'Baron', minSpice: 10000, color: 'rank-baron' },
            { name: 'Duke', minSpice: 50000, color: 'rank-duke' },
            { name: 'Emperor', minSpice: 100000, color: 'rank-emperor' }
        ];

        // Loot tables
        const LOOT_TABLES = {
            common: [
                { type: 'resource', resource: 'solari', amount: [10, 50], chance: 40 },
                { type: 'resource', resource: 'water', amount: [5, 20], chance: 30 },
                { type: 'resource', resource: 'plasteel', amount: [2, 10], chance: 20 },
                { type: 'item', itemType: 'weapon', rarity: 'common', chance: 5 },
                { type: 'item', itemType: 'armor', rarity: 'common', chance: 5 }
            ],
            rare: [
                { type: 'resource', resource: 'solari', amount: [50, 200], chance: 30 },
                { type: 'resource', resource: 'spice', amount: [10, 50], chance: 25 },
                { type: 'resource', resource: 'plasteel', amount: [10, 30], chance: 20 },
                { type: 'item', itemType: 'weapon', rarity: 'uncommon', chance: 15 },
                { type: 'item', itemType: 'armor', rarity: 'uncommon', chance: 10 }
            ],
            epic: [
                { type: 'resource', resource: 'solari', amount: [200, 500], chance: 25 },
                { type: 'resource', resource: 'spice', amount: [50, 150], chance: 25 },
                { type: 'item', itemType: 'weapon', rarity: 'rare', chance: 20 },
                { type: 'item', itemType: 'armor', rarity: 'rare', chance: 15 },
                { type: 'item', itemType: 'accessory', rarity: 'uncommon', chance: 15 }
            ]
        };

        // Item templates
        const ITEMS = {
            weapon: {
                common: [
                    { name: 'Rusty Blade', attack: 3, icon: 'üó°Ô∏è' },
                    { name: 'Worn Dagger', attack: 2, critChance: 2, icon: 'üî™' }
                ],
                uncommon: [
                    { name: 'Steel Sword', attack: 5, icon: '‚öîÔ∏è' },
                    { name: 'Hunter\'s Bow', attack: 4, critChance: 5, icon: 'üèπ' }
                ],
                rare: [
                    { name: 'Crysknife', attack: 10, critChance: 10, icon: 'üó°Ô∏è' },
                    { name: 'Lasgun', attack: 12, icon: 'üî´' }
                ],
                epic: [
                    { name: 'Maker Hook', attack: 15, critChance: 15, icon: 'ü™ù' },
                    { name: 'Sardukar Blade', attack: 18, defense: 5, icon: '‚öîÔ∏è' }
                ],
                legendary: [
                    { name: 'Shai-Hulud\'s Tooth', attack: 25, critChance: 20, icon: 'ü¶∑' }
                ]
            },
            armor: {
                common: [
                    { name: 'Desert Robes', defense: 3, icon: 'üëò' },
                    { name: 'Leather Vest', defense: 4, icon: 'ü¶∫' }
                ],
                uncommon: [
                    { name: 'Stillsuit', defense: 6, water: 10, icon: 'ü•ã' },
                    { name: 'Combat Armor', defense: 8, icon: 'üõ°Ô∏è' }
                ],
                rare: [
                    { name: 'Shield Belt', defense: 10, dodgeChance: 5, icon: 'üõ°Ô∏è' },
                    { name: 'Fremen Suit', defense: 12, water: 20, icon: 'ü•ã' }
                ],
                epic: [
                    { name: 'Sardukar Armor', defense: 20, health: 50, icon: 'üõ°Ô∏è' }
                ],
                legendary: [
                    { name: 'Emperor\'s Armor', defense: 30, health: 100, icon: 'üëë' }
                ]
            },
            accessory: {
                common: [
                    { name: 'Water Ring', water: 5, icon: 'üíç' },
                    { name: 'Spice Pouch', spiceBonus: 0.1, icon: 'üëù' }
                ],
                uncommon: [
                    { name: 'Gom Jabbar', critChance: 10, icon: 'üìå' },
                    { name: 'Hunter Seeker', attack: 5, icon: 'üéØ' }
                ],
                rare: [
                    { name: 'Prescience Crystal', dodgeChance: 15, icon: 'üîÆ' },
                    { name: 'Melange Infusion', all: 5, icon: '‚ú®' }
                ],
                epic: [
                    { name: 'Kwisatz Ring', all: 10, icon: 'üíç' }
                ],
                legendary: [
                    { name: 'Golden Path Amulet', all: 20, prescience: true, icon: 'üî±' }
                ]
            }
        };

        // Initialize map with more content
        function initializeMap() {
            // Player base
            gameState.map.locations.set('25,25', { 
                type: 'home', 
                name: 'Your Settlement',
                safe: true 
            });
            
            // Generate random content
            for (let i = 0; i < 200; i++) {
                const x = Math.floor(Math.random() * gameState.map.size);
                const y = Math.floor(Math.random() * gameState.map.size);
                const key = `${x},${y}`;
                
                if (gameState.map.locations.has(key)) continue;
                
                const rand = Math.random();
                if (rand < 0.3) {
                    // Enemies (30%)
                    const enemyTypes = [
                        { name: 'Sand Raider', health: 30, attack: 8, level: 1, loot: 'common' },
                        { name: 'Desert Bandit', health: 50, attack: 12, level: 2, loot: 'common' },
                        { name: 'Harkonnen Scout', health: 80, attack: 15, level: 3, loot: 'rare' },
                        { name: 'Sandworm Larva', health: 100, attack: 20, level: 4, loot: 'rare' },
                        { name: 'Sardaukar Patrol', health: 150, attack: 25, level: 5, loot: 'epic' }
                    ];
                    const enemy = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                    gameState.map.locations.set(key, { 
                        type: 'enemy', 
                        enemy: { ...enemy, maxHealth: enemy.health }
                    });
                } else if (rand < 0.45) {
                    // Resources (15%)
                    const resources = [
                        { type: 'spice', amount: [20, 100] },
                        { type: 'water', amount: [10, 50] },
                        { type: 'plasteel', amount: [5, 25] }
                    ];
                    const resource = resources[Math.floor(Math.random() * resources.length)];
                    const amount = Math.floor(Math.random() * (resource.amount[1] - resource.amount[0] + 1)) + resource.amount[0];
                    gameState.map.locations.set(key, { 
                        type: 'resource', 
                        resource: resource.type, 
                        amount: amount 
                    });
                } else if (rand < 0.5) {
                    // Special locations (5%)
                    const specials = [
                        { type: 'ruins', name: 'Ancient Ruins', loot: 'rare' },
                        { type: 'oasis', name: 'Hidden Oasis', water: 100 },
                        { type: 'cache', name: 'Smuggler Cache', loot: 'epic' }
                    ];
                    gameState.map.locations.set(key, specials[Math.floor(Math.random() * specials.length)]);
                }
            }
            
            // Add some other players
            const playerNames = ['SpiceLord', 'DesertWalker', 'FremenScout', 'DuneTrader', 'SandMaster'];
            playerNames.forEach((name, i) => {
                const player = {
                    id: 'bot_' + i,
                    name: name,
                    position: { 
                        x: Math.floor(Math.random() * gameState.map.size), 
                        y: Math.floor(Math.random() * gameState.map.size) 
                    },
                    level: Math.floor(Math.random() * 10) + 1,
                    spice: Math.floor(Math.random() * 5000),
                    rank: RANKS[Math.floor(Math.random() * 4)].name,
                    online: true
                };
                gameState.otherPlayers.set(player.id, player);
            });
            
            // Initialize quests
            gameState.quests = [
                {
                    id: 1,
                    title: "Spice Harvester",
                    description: "Collect 100 spice",
                    target: 100,
                    progress: 0,
                    type: 'spice',
                    reward: { solari: 200, experience: 50 }
                },
                {
                    id: 2,
                    title: "Desert Explorer",
                    description: "Explore 50 map tiles",
                    target: 50,
                    progress: 1,
                    type: 'explore',
                    reward: { plasteel: 50, experience: 100 }
                },
                {
                    id: 3,
                    title: "Combat Training",
                    description: "Defeat 10 enemies",
                    target: 10,
                    progress: 0,
                    type: 'combat',
                    reward: { solari: 500, experience: 200 }
                }
            ];
        }

        // Render map with improved visibility
        function renderMap() {
            const container = document.getElementById('mapContainer');
            container.innerHTML = '';
            
            const playerPos = gameState.player.position;
            const viewRadius = gameState.map.viewRadius;
            
            for (let dy = -viewRadius; dy <= viewRadius; dy++) {
                for (let dx = -viewRadius; dx <= viewRadius; dx++) {
                    const x = playerPos.x + dx;
                    const y = playerPos.y + dy;
                    const key = `${x},${y}`;
                    
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // Check distance from player for visibility
                    const distance = Math.abs(dx) + Math.abs(dy);
                    if (distance <= 1) {
                        cell.classList.add('near-player');
                    }
                    if (dx === 0 && dy === 0) {
                        cell.classList.add('at-player');
                    }
                    
                    // Check if in bounds
                    if (x < 0 || x >= gameState.map.size || y < 0 || y >= gameState.map.size) {
                        cell.classList.add('bg-black');
                        cell.innerHTML = '';
                    } else if (!gameState.map.explored.has(key) && distance > 2) {
                        cell.classList.add('bg-stone-900');
                        cell.innerHTML = '?';
                        cell.style.opacity = '0.5';
                    } else {
                        // Mark as explored
                        if (distance <= 2) {
                            gameState.map.explored.add(key);
                        }
                        
                        cell.classList.add('bg-amber-900');
                        
                        // Check for locations
                        const location = gameState.map.locations.get(key);
                        if (location) {
                            switch (location.type) {
                                case 'home':
                                    cell.innerHTML = 'üè†';
                                    cell.classList.add('bg-green-700');
                                    break;
                                case 'enemy':
                                    if (location.enemy) {
                                        cell.innerHTML = 'üíÄ';
                                        cell.classList.add('bg-red-700');
                                        cell.title = `${location.enemy.name} (Lv.${location.enemy.level})`;
                                    }
                                    break;
                                case 'resource':
                                    const icons = { spice: '‚ú®', water: 'üíß', plasteel: 'üîß' };
                                    cell.innerHTML = icons[location.resource] || 'üíé';
                                    cell.classList.add('bg-orange-700');
                                    cell.title = `${location.resource} (${location.amount})`;
                                    break;
                                case 'ruins':
                                    cell.innerHTML = 'üèõÔ∏è';
                                    cell.classList.add('bg-purple-700');
                                    break;
                                case 'oasis':
                                    cell.innerHTML = 'üå¥';
                                    cell.classList.add('bg-blue-700');
                                    break;
                                case 'cache':
                                    cell.innerHTML = 'üì¶';
                                    cell.classList.add('bg-yellow-700');
                                    break;
                            }
                        }
                        
                        // Player position
                        if (x === playerPos.x && y === playerPos.y) {
                            cell.innerHTML = 'ü§†';
                            cell.classList.add('bg-yellow-500', 'player-indicator');
                        }
                        
                        // Other players
                        gameState.otherPlayers.forEach(player => {
                            if (player.position.x === x && player.position.y === y && player.online) {
                                cell.innerHTML = 'üë§';
                                cell.classList.add('bg-blue-600');
                                cell.title = `${player.name} (${player.rank})`;
                            }
                        });
                    }
                    
                    // Click to move (only adjacent cells)
                    if (Math.abs(x - playerPos.x) <= 1 && Math.abs(y - playerPos.y) <= 1) {
                        cell.style.cursor = 'pointer';
                        cell.addEventListener('click', () => {
                            if (x !== playerPos.x || y !== playerPos.y) {
                                movePlayer(x, y);
                            }
                        });
                    }
                    
                    container.appendChild(cell);
                }
            }
            
            renderMinimap();
        }

        // Render minimap
        function renderMinimap() {
            const container = document.getElementById('minimapContainer');
            container.innerHTML = '';
            
            const scale = container.clientWidth / gameState.map.size;
            
            // Render explored areas
            gameState.map.explored.forEach(key => {
                const [x, y] = key.split(',').map(Number);
                const cell = document.createElement('div');
                cell.className = 'minimap-cell bg-amber-800';
                cell.style.width = Math.max(1, scale) + 'px';
                cell.style.height = Math.max(1, scale) + 'px';
                cell.style.left = (x * scale) + 'px';
                cell.style.top = (y * scale) + 'px';
                container.appendChild(cell);
            });
            
            // Player position
            const playerCell = document.createElement('div');
            playerCell.className = 'minimap-cell bg-yellow-500';
            playerCell.style.width = '3px';
            playerCell.style.height = '3px';
            playerCell.style.left = (gameState.player.position.x * scale - 1) + 'px';
            playerCell.style.top = (gameState.player.position.y * scale - 1) + 'px';
            playerCell.style.zIndex = '10';
            container.appendChild(playerCell);
        }

        // Move player
        function movePlayer(x, y) {
            if (gameState.inCombat) {
                showNotification('Cannot move during combat!', 'error');
                return;
            }
            
            const waterCost = 1;
            if (gameState.resources.water < waterCost) {
                showNotification('Not enough water!', 'error');
                return;
            }
            
            gameState.resources.water -= waterCost;
            gameState.player.position = { x, y };
            
            // Check for other players
            const otherPlayer = Array.from(gameState.otherPlayers.values()).find(
                p => p.position.x === x && p.position.y === y && p.online
            );
            
            if (otherPlayer) {
                // Initiate duel
                showDuelRequest(otherPlayer);
                return;
            }
            
            // Check location
            const key = `${x},${y}`;
            const location = gameState.map.locations.get(key);
            
            if (location) {
                handleLocationEncounter(location, key);
            }
            
            updateQuestProgress('explore', gameState.map.explored.size);
            updateUI();
            renderMap();
            log(`Moved to (${x}, ${y})`);
        }

        // Handle location encounters
        function handleLocationEncounter(location, key) {
            switch (location.type) {
                case 'enemy':
                    if (location.enemy) {
                        startCombat(location.enemy, key);
                    }
                    break;
                    
                case 'resource':
                    if (location.amount > 0) {
                        const harvest = Math.min(location.amount, 20);
                        gameState.resources[location.resource] += harvest;
                        location.amount -= harvest;
                        
                        log(`Found ${harvest} ${location.resource}!`, 'success');
                        
                        if (location.resource === 'spice') {
                            gameState.player.totalSpiceCollected += harvest;
                            updateQuestProgress('spice', gameState.player.totalSpiceCollected);
                        }
                        
                        if (location.amount <= 0) {
                            gameState.map.locations.delete(key);
                        }
                    }
                    break;
                    
                case 'ruins':
                case 'cache':
                    generateLoot(location.loot || 'rare');
                    gameState.map.locations.delete(key);
                    break;
                    
                case 'oasis':
                    if (location.water) {
                        gameState.resources.water += location.water;
                        log(`Found an oasis! +${location.water} water`, 'success');
                        gameState.map.locations.delete(key);
                    }
                    break;
            }
        }

        // Combat system
        function startCombat(enemy, locationKey) {
            gameState.inCombat = true;
            gameState.currentEnemy = { ...enemy, locationKey };
            gameState.isPlayerTurn = true;
            gameState.defendBonus = 0;
            
            document.getElementById('combatModal').classList.remove('hidden');
            document.getElementById('combatModal').classList.add('flex');
            
            document.getElementById('enemyName').textContent = enemy.name;
            document.getElementById('enemyLevel').textContent = `Lv.${enemy.level}`;
            document.getElementById('enemyHealth').textContent = `${enemy.health}/${enemy.maxHealth}`;
            document.getElementById('combatPlayerLevel').textContent = gameState.player.level;
            
            document.getElementById('combatLog').innerHTML = `<p>Encountered ${enemy.name}!</p>`;
            
            updateCombatUI();
            updateCombatTurn();
        }

        function updateCombatUI() {
            if (!gameState.currentEnemy) return;
            
            const enemy = gameState.currentEnemy;
            const enemyHealthPercent = (enemy.health / enemy.maxHealth) * 100;
            const playerHealthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            
            document.getElementById('enemyHealthBar').style.width = enemyHealthPercent + '%';
            document.getElementById('playerHealthBar').style.width = playerHealthPercent + '%';
            document.getElementById('combatPlayerHealth').textContent = `${Math.floor(gameState.player.health)}/${gameState.player.maxHealth}`;
            document.getElementById('enemyHealth').textContent = `${Math.floor(enemy.health)}/${enemy.maxHealth}`;
        }

        function updateCombatTurn() {
            const indicator = document.getElementById('combatTurnIndicator');
            indicator.textContent = gameState.isPlayerTurn ? 'Your Turn' : 'Enemy Turn';
            
            document.getElementById('attackBtn').disabled = !gameState.isPlayerTurn;
            document.getElementById('defendBtn').disabled = !gameState.isPlayerTurn;
            document.getElementById('fleeBtn').disabled = !gameState.isPlayerTurn;
            
            if (!gameState.isPlayerTurn) {
                setTimeout(enemyTurn, 1000);
            }
        }

        function playerAttack() {
            if (!gameState.isPlayerTurn || !gameState.currentEnemy) return;
            
            const enemy = gameState.currentEnemy;
            const combatLog = document.getElementById('combatLog');
            
            // Calculate damage
            let damage = gameState.player.attack + getTotalEquipmentStat('attack') + getUnitDamage();
            
            // Critical hit
            if (Math.random() * 100 < (gameState.player.critChance + getTotalEquipmentStat('critChance'))) {
                damage *= 2;
                combatLog.innerHTML += `<p class="text-yellow-400">Critical hit!</p>`;
            }
            
            damage = Math.max(1, damage - Math.floor(enemy.defense || 0));
            enemy.health -= damage;
            
            combatLog.innerHTML += `<p class="text-green-400">You deal ${damage} damage!</p>`;
            
            if (enemy.health <= 0) {
                endCombat(true);
            } else {
                gameState.isPlayerTurn = false;
                updateCombatUI();
                updateCombatTurn();
            }
            
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function playerDefend() {
            if (!gameState.isPlayerTurn) return;
            
            gameState.defendBonus = 10;
            const combatLog = document.getElementById('combatLog');
            combatLog.innerHTML += `<p class="text-blue-400">You take a defensive stance!</p>`;
            
            // Restore some health
            const heal = Math.floor(gameState.player.maxHealth * 0.1);
            gameState.player.health = Math.min(gameState.player.health + heal, gameState.player.maxHealth);
            combatLog.innerHTML += `<p class="text-green-400">Recovered ${heal} health!</p>`;
            
            gameState.isPlayerTurn = false;
            updateCombatUI();
            updateCombatTurn();
            
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function playerFlee() {
            if (!gameState.isPlayerTurn) return;
            
            const fleeChance = 50 + (gameState.player.dodgeChance + getTotalEquipmentStat('dodgeChance'));
            const combatLog = document.getElementById('combatLog');
            
            if (Math.random() * 100 < fleeChance) {
                combatLog.innerHTML += `<p class="text-yellow-400">Fled successfully!</p>`;
                endCombat(false);
            } else {
                combatLog.innerHTML += `<p class="text-red-400">Failed to flee!</p>`;
                gameState.isPlayerTurn = false;
                updateCombatTurn();
            }
            
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function enemyTurn() {
            if (!gameState.currentEnemy || gameState.currentEnemy.health <= 0) return;
            
            const enemy = gameState.currentEnemy;
            const combatLog = document.getElementById('combatLog');
            
            // Enemy dodges sometimes
            if (Math.random() < 0.1) {
                combatLog.innerHTML += `<p class="text-stone-400">${enemy.name} dodges!</p>`;
            } else {
                // Calculate damage
                let damage = enemy.attack;
                damage = Math.max(1, damage - (gameState.player.defense + getTotalEquipmentStat('defense') + gameState.defendBonus));
                
                // Dodge chance
                if (Math.random() * 100 < (gameState.player.dodgeChance + getTotalEquipmentStat('dodgeChance'))) {
                    combatLog.innerHTML += `<p class="text-blue-400">You dodged the attack!</p>`;
                } else {
                    gameState.player.health -= damage;
                    combatLog.innerHTML += `<p class="text-red-400">${enemy.name} deals ${damage} damage!</p>`;
                }
            }
            
            gameState.defendBonus = 0;
            
            if (gameState.player.health <= 0) {
                endCombat(false);
            } else {
                gameState.isPlayerTurn = true;
                updateCombatUI();
                updateCombatTurn();
            }
            
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function endCombat(victory) {
            const combatLog = document.getElementById('combatLog');
            
            if (victory) {
                const enemy = gameState.currentEnemy;
                
                // Rewards
                const expGain = enemy.level * 20;
                const solariGain = enemy.level * 50;
                
                gameState.player.experience += expGain;
                gameState.resources.solari += solariGain;
                gameState.player.enemiesDefeated++;
                
                combatLog.innerHTML += `<p class="text-amber-400">Victory! +${expGain} exp, +${solariGain} solari</p>`;
                
                // Generate loot
                if (enemy.loot) {
                    setTimeout(() => {
                        generateLoot(enemy.loot);
                    }, 1000);
                }
                
                // Remove enemy from map
                if (enemy.locationKey) {
                    gameState.map.locations.delete(enemy.locationKey);
                }
                
                updateQuestProgress('combat', gameState.player.enemiesDefeated);
                checkLevelUp();
            } else {
                // Defeat penalty
                gameState.player.health = gameState.player.maxHealth * 0.5;
                gameState.resources.solari = Math.max(0, gameState.resources.solari - 100);
                combatLog.innerHTML += `<p class="text-red-600">Defeated! Lost 100 solari.</p>`;
            }
            
            setTimeout(() => {
                document.getElementById('combatModal').classList.add('hidden');
                gameState.inCombat = false;
                gameState.currentEnemy = null;
                updateUI();
                renderMap();
            }, 2000);
        }

        // Generate loot
        function generateLoot(lootTable) {
            const table = LOOT_TABLES[lootTable] || LOOT_TABLES.common;
            const loot = [];
            
            // Roll for each item in table
            table.forEach(entry => {
                if (Math.random() * 100 < entry.chance) {
                    if (entry.type === 'resource') {
                        const amount = Math.floor(Math.random() * (entry.amount[1] - entry.amount[0] + 1)) + entry.amount[0];
                        loot.push({ type: 'resource', resource: entry.resource, amount });
                    } else if (entry.type === 'item') {
                        const item = generateItem(entry.itemType, entry.rarity);
                        if (item) loot.push({ type: 'item', item });
                    }
                }
            });
            
            // Always give at least something
            if (loot.length === 0) {
                loot.push({ type: 'resource', resource: 'solari', amount: Math.floor(Math.random() * 20) + 10 });
            }
            
            showLoot(loot);
        }

        function generateItem(itemType, rarity) {
            const items = ITEMS[itemType][rarity];
            if (!items || items.length === 0) return null;
            
            const template = items[Math.floor(Math.random() * items.length)];
            return {
                ...template,
                type: itemType,
                rarity: rarity,
                id: 'item_' + Math.random().toString(36).substr(2, 9)
            };
        }

        function showLoot(loot) {
            const modal = document.getElementById('lootModal');
            const contents = document.getElementById('lootContents');
            contents.innerHTML = '';
            
            loot.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-stone-700 rounded';
                
                if (item.type === 'resource') {
                    const icons = { solari: 'üí∞', spice: '‚ú®', water: 'üíß', plasteel: 'üîß' };
                    div.innerHTML = `
                        <span>${icons[item.resource]} ${item.resource}</span>
                        <span class="font-semibold">+${item.amount}</span>
                    `;
                } else if (item.type === 'item') {
                    const rarityColors = {
                        common: 'text-gray-400',
                        uncommon: 'text-green-400',
                        rare: 'text-blue-400',
                        epic: 'text-purple-400',
                        legendary: 'text-amber-400'
                    };
                    div.innerHTML = `
                        <span class="${rarityColors[item.item.rarity]}">${item.item.icon} ${item.item.name}</span>
                        <span class="text-xs">${item.item.rarity}</span>
                    `;
                }
                
                contents.appendChild(div);
            });
            
            // Store loot temporarily
            modal.dataset.loot = JSON.stringify(loot);
            
            modal.classList.remove('hidden');
            
            // Show notifications for good loot
            loot.forEach(item => {
                if (item.type === 'item' && ['rare', 'epic', 'legendary'].includes(item.item.rarity)) {
                    showNotification(`Found ${item.item.rarity} ${item.item.name}!`, item.item.rarity);
                }
            });
        }

        function collectLoot() {
            const modal = document.getElementById('lootModal');
            const loot = JSON.parse(modal.dataset.loot || '[]');
            
            loot.forEach(item => {
                if (item.type === 'resource') {
                    gameState.resources[item.resource] += item.amount;
                    if (item.resource === 'spice') {
                        gameState.player.totalSpiceCollected += item.amount;
                        updateQuestProgress('spice', gameState.player.totalSpiceCollected);
                    }
                } else if (item.type === 'item') {
                    addToInventory(item.item);
                }
            });
            
            modal.classList.add('hidden');
            updateUI();
            log('Collected loot!', 'success');
        }

        // Inventory management
        function addToInventory(item) {
            const emptySlot = gameState.inventory.findIndex(slot => slot === null);
            if (emptySlot !== -1) {
                gameState.inventory[emptySlot] = item;
                return true;
            }
            showNotification('Inventory full!', 'error');
            return false;
        }

        function equipItem(item, slot) {
            if (item.type !== slot) return false;
            
            // Unequip current item
            if (gameState.equipment[slot]) {
                addToInventory(gameState.equipment[slot]);
            }
            
            gameState.equipment[slot] = item;
            updateUI();
            log(`Equipped ${item.name}`, 'success');
            return true;
        }

        function getTotalEquipmentStat(stat) {
            let total = 0;
            Object.values(gameState.equipment).forEach(item => {
                if (item && item[stat]) {
                    total += item[stat];
                }
                if (item && item.all) {
                    total += item.all;
                }
            });
            return total;
        }

        function getUnitDamage() {
            let damage = 0;
            damage += gameState.units.infantry.count * gameState.units.infantry.attack;
            damage += gameState.units.archer.count * gameState.units.archer.attack;
            damage += gameState.units.thopter.count * gameState.units.thopter.attack;
            return Math.floor(damage * 0.1); // Units contribute 10% of their attack
        }

        // Player duels
        function showDuelRequest(otherPlayer) {
            document.getElementById('duelChallenger').textContent = otherPlayer.name;
            document.getElementById('duelModal').classList.remove('hidden');
            document.getElementById('duelModal').classList.add('flex');
            
            // Store challenger info
            document.getElementById('duelModal').dataset.challenger = JSON.stringify(otherPlayer);
        }

        function acceptDuel() {
            const modal = document.getElementById('duelModal');
            const challenger = JSON.parse(modal.dataset.challenger || '{}');
            
            modal.classList.add('hidden');
            
            // Start PvP combat
            const pvpEnemy = {
                name: challenger.name,
                level: challenger.level,
                health: 100 + (challenger.level * 20),
                maxHealth: 100 + (challenger.level * 20),
                attack: 10 + (challenger.level * 2),
                defense: 5 + challenger.level,
                isPvP: true,
                playerId: challenger.id
            };
            
            startCombat(pvpEnemy);
        }

        function declineDuel() {
            document.getElementById('duelModal').classList.add('hidden');
            log('Duel declined', 'info');
        }

        // Production and economy
        function harvestSpice() {
            const amount = gameState.production.manual.level;
            gameState.resources.spice += amount;
            gameState.player.totalSpiceCollected += amount;
            updateQuestProgress('spice', gameState.player.totalSpiceCollected);
            updateUI();
            log(`Harvested ${amount} spice`);
        }

        function sellSpice() {
            if (gameState.resources.spice < 10) {
                showNotification('Need at least 10 spice to sell!', 'error');
                return;
            }
            
            const amount = Math.min(gameState.resources.spice, 100);
            const price = Math.floor(gameState.spicePrice * (gameState.buildings.market.level > 0 ? gameState.buildings.market.priceBonus : 1));
            const profit = amount * price;
            
            gameState.resources.spice -= amount;
            gameState.resources.solari += profit;
            
            updateUI();
            log(`Sold ${amount} spice for ${profit} solari (${price} each)`, 'success');
        }

        function autoProduction() {
            // Auto harvesters
            if (gameState.production.auto.count > 0) {
                const spiceProduction = gameState.production.auto.count * gameState.production.auto.production;
                const refineryBonus = gameState.buildings.refinery.level > 0 ? gameState.buildings.refinery.bonus : 1;
                const totalProduction = Math.floor(spiceProduction * refineryBonus);
                
                gameState.resources.spice += totalProduction;
                gameState.player.totalSpiceCollected += totalProduction;
            }
            
            // Bank interest
            if (gameState.buildings.bank.level > 0) {
                const interest = Math.floor(gameState.resources.solari * gameState.buildings.bank.interest * gameState.buildings.bank.level);
                gameState.resources.solari += interest;
            }
            
            // Health regeneration
            if (gameState.player.health < gameState.player.maxHealth && !gameState.inCombat) {
                gameState.player.health = Math.min(gameState.player.health + 2, gameState.player.maxHealth);
            }
            
            // Update spice price
            gameState.spicePrice = Math.floor(5 + Math.random() * 5);
            
            updateUI();
        }

        // Upgrades
        function upgradeHarvest() {
            const cost = gameState.production.manual.cost;
            if (gameState.resources.solari >= cost) {
                gameState.resources.solari -= cost;
                gameState.production.manual.level++;
                gameState.production.manual.cost = Math.floor(cost * 1.5);
                updateUI();
                log('Manual harvesting upgraded!', 'success');
            } else {
                showNotification('Not enough solari!', 'error');
            }
        }

        function buyAutoHarvester() {
            const cost = gameState.production.auto.cost;
            if (gameState.resources.solari >= cost) {
                gameState.resources.solari -= cost;
                gameState.production.auto.count++;
                gameState.production.auto.cost = Math.floor(cost * 1.3);
                updateUI();
                log('Auto-harvester purchased!', 'success');
            } else {
                showNotification('Not enough solari!', 'error');
            }
        }

        // Buildings
        function buildBuilding(type) {
            const costs = {
                refinery: { solari: 500, plasteel: 50 },
                defense: { solari: 400, plasteel: 40 },
                market: { solari: 300, plasteel: 30 },
                bank: { solari: 600, plasteel: 60 }
            };
            
            const cost = costs[type];
            if (gameState.resources.solari >= cost.solari && gameState.resources.plasteel >= cost.plasteel) {
                gameState.resources.solari -= cost.solari;
                gameState.resources.plasteel -= cost.plasteel;
                gameState.buildings[type].level++;
                
                // Update costs for next level
                cost.solari = Math.floor(cost.solari * 1.5);
                cost.plasteel = Math.floor(cost.plasteel * 1.5);
                
                updateUI();
                log(`${type.charAt(0).toUpperCase() + type.slice(1)} upgraded to level ${gameState.buildings[type].level}!`, 'success');
            } else {
                showNotification('Not enough resources!', 'error');
            }
        }

        // Units
        function buyUnit(type) {
            const unit = gameState.units[type];
            if (gameState.resources.solari >= unit.cost) {
                gameState.resources.solari -= unit.cost;
                unit.count++;
                
                // Calculate player power
                updatePlayerPower();
                
                updateUI();
                log(`${type.charAt(0).toUpperCase() + type.slice(1)} recruited!`, 'success');
            } else {
                showNotification('Not enough solari!', 'error');
            }
        }

        // Quest progress
        function updateQuestProgress(type, value) {
            gameState.quests.forEach(quest => {
                if (quest.type === type && !quest.completed) {
                    quest.progress = value;
                    if (quest.progress >= quest.target) {
                        completeQuest(quest);
                    }
                }
            });
            updateUI();
        }

        function completeQuest(quest) {
            quest.completed = true;
            
            // Give rewards
            Object.entries(quest.reward).forEach(([reward, amount]) => {
                if (reward === 'experience') {
                    gameState.player.experience += amount;
                } else {
                    gameState.resources[reward] += amount;
                }
            });
            
            showNotification(`Quest completed: ${quest.title}!`, 'success');
            log(`Quest completed: ${quest.title}!`, 'success');
            checkLevelUp();
        }

        // Level up
        function checkLevelUp() {
            while (gameState.player.experience >= gameState.player.experienceToNext) {
                gameState.player.level++;
                gameState.player.experience -= gameState.player.experienceToNext;
                gameState.player.experienceToNext = Math.floor(gameState.player.experienceToNext * 1.5);
                
                // Increase stats
                gameState.player.maxHealth += 20;
                gameState.player.health = gameState.player.maxHealth;
                gameState.player.attack += 3;
                gameState.player.defense += 2;
                gameState.player.critChance += 1;
                gameState.player.dodgeChance += 1;
                
                showNotification(`Level up! You are now level ${gameState.player.level}`, 'success');
            }
            updatePlayerPower();
        }

        // Calculate player rank and power
        function updatePlayerRank() {
            const spice = gameState.player.totalSpiceCollected;
            let currentRank = RANKS[0];
            
            for (let i = RANKS.length - 1; i >= 0; i--) {
                if (spice >= RANKS[i].minSpice) {
                    currentRank = RANKS[i];
                    break;
                }
            }
            
            gameState.player.rank = currentRank.name;
            
            const rankDisplay = document.getElementById('playerRankDisplay');
            rankDisplay.textContent = currentRank.name;
            rankDisplay.className = `font-semibold ${currentRank.color}`;
        }

        function updatePlayerPower() {
            // Calculate total power
            let power = 0;
            power += gameState.player.level * 100;
            power += gameState.player.totalSpiceCollected * 0.1;
            power += (gameState.player.attack + getTotalEquipmentStat('attack')) * 10;
            power += (gameState.player.defense + getTotalEquipmentStat('defense')) * 10;
            power += gameState.units.infantry.count * 50;
            power += gameState.units.archer.count * 75;
            power += gameState.units.thopter.count * 150;
            power += gameState.buildings.defense.level * 200;
            
            gameState.player.power = Math.floor(power);
        }

        // Chat system
        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'mb-1';
                
                const rankClass = RANKS.find(r => r.name === gameState.player.rank)?.color || 'rank-novice';
                messageDiv.innerHTML = `
                    <span class="${rankClass}">[${gameState.player.rank}]</span>
                    <span class="text-amber-400">${gameState.player.name}:</span>
                    <span class="text-stone-300">${message}</span>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                input.value = '';
                
                // Simulate other players chatting
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        const otherPlayer = Array.from(gameState.otherPlayers.values())[Math.floor(Math.random() * gameState.otherPlayers.size)];
                        if (otherPlayer) {
                            const responses = [
                                'Nice!', 'gg', 'Anyone want to trade?', 'Selling spice cheap!',
                                'LFG ruins', 'Watch out for sandworms', 'The spice must flow!'
                            ];
                            const response = responses[Math.floor(Math.random() * responses.length)];
                            
                            const botDiv = document.createElement('div');
                            botDiv.className = 'mb-1';
                            const botRankClass = RANKS.find(r => r.name === otherPlayer.rank)?.color || 'rank-novice';
                            botDiv.innerHTML = `
                                <span class="${botRankClass}">[${otherPlayer.rank}]</span>
                                <span class="text-blue-400">${otherPlayer.name}:</span>
                                <span class="text-stone-300">${response}</span>
                            `;
                            chatMessages.appendChild(botDiv);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }, 1000 + Math.random() * 3000);
                }
            }
        }

        // UI Updates
        function updateUI() {
            // Resources
            document.getElementById('spiceCount').textContent = gameState.resources.spice;
            document.getElementById('waterCount').textContent = gameState.resources.water;
            document.getElementById('solariCount').textContent = gameState.resources.solari;
            document.getElementById('plasteelCount').textContent = gameState.resources.plasteel;
            
            // Health
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            document.getElementById('healthBar').style.width = healthPercent + '%';
            document.getElementById('healthText').textContent = `${Math.floor(gameState.player.health)}/${gameState.player.maxHealth}`;
            
            // Production
            document.getElementById('harvestAmount').textContent = gameState.production.manual.level;
            document.getElementById('harvestLevel').textContent = gameState.production.manual.level;
            document.getElementById('harvestCost').textContent = gameState.production.manual.cost;
            
            document.getElementById('autoCount').textContent = gameState.production.auto.count;
            document.getElementById('autoProduction').textContent = gameState.production.auto.count * gameState.production.auto.production;
            document.getElementById('autoCost').textContent = gameState.production.auto.cost;
            
            // Buildings
            document.getElementById('refineryLevel').textContent = gameState.buildings.refinery.level;
            document.getElementById('defenseLevel').textContent = gameState.buildings.defense.level;
            document.getElementById('marketLevel').textContent = gameState.buildings.market.level;
            document.getElementById('bankLevel').textContent = gameState.buildings.bank.level;
            
            // Units
            document.getElementById('infantryCount').textContent = gameState.units.infantry.count;
            document.getElementById('archerCount').textContent = gameState.units.archer.count;
            document.getElementById('thopterCount').textContent = gameState.units.thopter.count;
            
            // Player info
            document.getElementById('playerPosition').textContent = `(${gameState.player.position.x},${gameState.player.position.y})`;
            document.getElementById('playerLevel').textContent = gameState.player.level;
            document.getElementById('playerAttack').textContent = gameState.player.attack + getTotalEquipmentStat('attack');
            document.getElementById('playerDefense').textContent = gameState.player.defense + getTotalEquipmentStat('defense');
            document.getElementById('playerCrit').textContent = (gameState.player.critChance + getTotalEquipmentStat('critChance')) + '%';
            document.getElementById('playerDodge').textContent = (gameState.player.dodgeChance + getTotalEquipmentStat('dodgeChance')) + '%';
            
            // Experience
            const expPercent = (gameState.player.experience / gameState.player.experienceToNext) * 100;
            document.getElementById('expBar').style.width = expPercent + '%';
            document.getElementById('expText').textContent = `${gameState.player.experience}/${gameState.player.experienceToNext}`;
            
            // Spice price
            document.getElementById('spicePrice').textContent = gameState.spicePrice;
            
            // Update rank
            updatePlayerRank();
            
            // Update quests
            updateQuests();
            
            // Update nearby players
            updateNearbyPlayers();
            
            // Update top ranks
            updateTopRanks();
            
            // Update inventory display
            updateInventoryDisplay();
            
            // Update danger level
            const dangerLevel = Math.min(5, Math.floor(Math.sqrt(Math.pow(gameState.player.position.x - 25, 2) + Math.pow(gameState.player.position.y - 25, 2)) / 10));
            const dangerText = ['Low', 'Medium', 'High', 'Very High', 'Extreme'][dangerLevel];
            const dangerElement = document.getElementById('dangerLevel');
            dangerElement.textContent = dangerText;
            dangerElement.className = dangerLevel >= 3 ? 'text-red-400' : dangerLevel >= 2 ? 'text-yellow-400' : 'text-green-400';
        }

        function updateQuests() {
            const container = document.getElementById('questList');
            container.innerHTML = '';
            
            gameState.quests.filter(q => !q.completed).forEach(quest => {
                const div = document.createElement('div');
                div.className = 'bg-stone-700 rounded p-2';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-xs">${quest.title}</span>
                        <span class="text-xs text-amber-400">${quest.progress}/${quest.target}</span>
                    </div>
                    <div class="text-xs text-stone-400 mb-1">${quest.description}</div>
                    <div class="progress-bar-bg rounded-full h-1">
                        <div class="progress-bar-fill h-full rounded-full" style="width: ${(quest.progress / quest.target) * 100}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateNearbyPlayers() {
            const container = document.getElementById('playerList');
            container.innerHTML = '';
            
            // Find players within 10 tiles
            const nearbyPlayers = Array.from(gameState.otherPlayers.values()).filter(player => {
                const distance = Math.abs(player.position.x - gameState.player.position.x) + 
                               Math.abs(player.position.y - gameState.player.position.y);
                return distance <= 10 && player.online;
            });
            
            if (nearbyPlayers.length === 0) {
                container.innerHTML = '<div class="text-xs text-stone-400">No players nearby</div>';
            } else {
                nearbyPlayers.forEach(player => {
                    const div = document.createElement('div');
                    const distance = Math.abs(player.position.x - gameState.player.position.x) + 
                                   Math.abs(player.position.y - gameState.player.position.y);
                    const rankClass = RANKS.find(r => r.name === player.rank)?.color || 'rank-novice';
                    
                    div.className = 'flex items-center justify-between p-1 hover:bg-stone-700 rounded cursor-pointer';
                    div.innerHTML = `
                        <span class="text-xs">
                            <span class="${rankClass}">${player.name}</span>
                            <span class="text-stone-500">(${distance} tiles)</span>
                        </span>
                        <span class="text-xs text-stone-400">Lv.${player.level}</span>
                    `;
                    
                    div.addEventListener('click', () => {
                        log(`${player.name} is at (${player.position.x}, ${player.position.y})`, 'info');
                    });
                    
                    container.appendChild(div);
                });
            }
        }

        function updateTopRanks() {
            const container = document.getElementById('topRanks');
            container.innerHTML = '';
            
            // Get all players including current player
            const allPlayers = [
                {
                    name: gameState.player.name,
                    spice: gameState.player.totalSpiceCollected,
                    rank: gameState.player.rank,
                    power: gameState.player.power,
                    isYou: true
                },
                ...Array.from(gameState.otherPlayers.values()).map(p => ({
                    name: p.name,
                    spice: p.spice,
                    rank: p.rank,
                    power: Math.floor(p.level * 100 + p.spice * 0.1),
                    isYou: false
                }))
            ];
            
            // Sort by power
            allPlayers.sort((a, b) => b.power - a.power);
            
            // Show top 5
            allPlayers.slice(0, 5).forEach((player, index) => {
                const div = document.createElement('div');
                const rankClass = RANKS.find(r => r.name === player.rank)?.color || 'rank-novice';
                const medal = index === 0 ? 'üëë' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
                
                div.className = `flex items-center justify-between p-1 rounded text-xs ${player.isYou ? 'bg-amber-900/30' : ''}`;
                div.innerHTML = `
                    <span>
                        <span class="mr-1">${medal}</span>
                        <span class="${rankClass}">${player.name}</span>
                        ${player.isYou ? '<span class="text-amber-400">(You)</span>' : ''}
                    </span>
                    <span class="text-stone-400">${player.power}</span>
                `;
                
                container.appendChild(div);
            });
        }

        function updateInventoryDisplay() {
            // Quick slots
            const quickSlots = document.getElementById('quickSlots');
            quickSlots.innerHTML = '';
            
            for (let i = 0; i < 8; i++) {
                const item = gameState.inventory[i];
                const slot = document.createElement('div');
                slot.className = `inventory-slot ${item ? `item-rarity-${item.rarity}` : ''}`;
                slot.dataset.slot = i;
                
                if (item) {
                    slot.innerHTML = `<span class="text-lg">${item.icon}</span>`;
                    slot.title = item.name;
                }
                
                quickSlots.appendChild(slot);
            }
            
            // Full inventory (character tab)
            const inventoryGrid = document.getElementById('inventoryGrid');
            if (inventoryGrid) {
                inventoryGrid.innerHTML = '';
                
                for (let i = 0; i < 40; i++) {
                    const item = gameState.inventory[i];
                    const slot = document.createElement('div');
                    slot.className = `inventory-slot ${item ? `item-rarity-${item.rarity}` : ''}`;
                    slot.dataset.slot = i;
                    
                    if (item) {
                        slot.innerHTML = `<span class="text-lg">${item.icon}</span>`;
                        slot.title = item.name;
                        
                        slot.addEventListener('click', () => {
                            if (item.type === 'weapon' || item.type === 'armor' || item.type === 'accessory') {
                                equipItem(item, item.type);
                                gameState.inventory[i] = null;
                                updateInventoryDisplay();
                            }
                        });
                    }
                    
                    inventoryGrid.appendChild(slot);
                }
                
                // Update equipped items
                ['weapon', 'armor', 'accessory'].forEach(slotType => {
                    const slotElement = document.getElementById(`${slotType}Slot`);
                    const equipped = gameState.equipment[slotType];
                    
                    if (equipped) {
                        slotElement.innerHTML = `<span class="text-xl">${equipped.icon}</span>`;
                        slotElement.className = `inventory-slot item-rarity-${equipped.rarity}`;
                        slotElement.title = equipped.name;
                    } else {
                        const defaultIcons = { weapon: '‚öîÔ∏è', armor: 'üõ°Ô∏è', accessory: 'üíç' };
                        slotElement.innerHTML = `<span class="text-xl">${defaultIcons[slotType]}</span>`;
                        slotElement.className = 'inventory-slot';
                        slotElement.title = 'Empty';
                    }
                });
                
                // Inventory count
                document.getElementById('invCount').textContent = gameState.inventory.filter(i => i !== null).length;
            }
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Game log
        function log(message, type = 'info') {
            const logContainer = document.getElementById('gameLog');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const colorClass = {
                info: 'text-stone-300',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            }[type] || 'text-stone-300';
            
            entry.className = `mb-1 ${colorClass}`;
            entry.innerHTML = `<span class="text-stone-500">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 50 messages
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update full rankings when switching to multiplayer tab
            if (tabName === 'multiplayer') {
                updateFullRankings();
            }
        }

        function updateFullRankings() {
            const container = document.getElementById('fullRankings');
            container.innerHTML = '';
            
            // Get all players
            const allPlayers = [
                {
                    name: gameState.player.name,
                    spice: gameState.player.totalSpiceCollected,
                    rank: gameState.player.rank,
                    level: gameState.player.level,
                    power: gameState.player.power,
                    isYou: true
                },
                ...Array.from(gameState.otherPlayers.values()).map(p => ({
                    name: p.name,
                    spice: p.spice,
                    rank: p.rank,
                    level: p.level,
                    power: Math.floor(p.level * 100 + p.spice * 0.1),
                    isYou: false
                }))
            ];
            
            // Sort by power
            allPlayers.sort((a, b) => b.power - a.power);
            
            // Display all players
            allPlayers.forEach((player, index) => {
                const div = document.createElement('div');
                const rankClass = RANKS.find(r => r.name === player.rank)?.color || 'rank-novice';
                
                div.className = `grid grid-cols-7 gap-2 p-2 rounded text-sm ${player.isYou ? 'bg-amber-900/30' : index % 2 === 0 ? 'bg-stone-700/50' : ''}`;
                div.innerHTML = `
                    <div>${index + 1}</div>
                    <div class="col-span-2 ${rankClass}">${player.name} ${player.isYou ? '(You)' : ''}</div>
                    <div class="${rankClass}">${player.rank}</div>
                    <div>${player.spice}</div>
                    <div>${player.level}</div>
                    <div class="font-semibold">${player.power}</div>
                `;
                
                container.appendChild(div);
            });
        }

        // Save/Load
        function saveGame() {
            const saveData = {
                gameState: gameState,
                timestamp: Date.now()
            };
            
            localStorage.setItem('arrakisTycoonSave', JSON.stringify(saveData));
            showNotification('Game saved!', 'success');
        }

        function loadGame() {
            const saveData = localStorage.getItem('arrakisTycoonSave');
            if (saveData) {
                try {
                    const data = JSON.parse(saveData);
                    Object.assign(gameState, data.gameState);
                    
                    // Rebuild Maps
                    gameState.map.explored = new Set(gameState.map.explored);
                    gameState.map.locations = new Map(gameState.map.locations);
                    gameState.otherPlayers = new Map(gameState.otherPlayers);
                    
                    showNotification('Game loaded!', 'success');
                    return true;
                } catch (e) {
                    console.error('Failed to load save:', e);
                }
            }
            return false;
        }

        // Initialize game
        function initGame() {
            // Try to load save
            if (!loadGame()) {
                initializeMap();
            }
            
            // Event listeners
            document.getElementById('harvestSpiceBtn').addEventListener('click', harvestSpice);
            document.getElementById('sellSpiceBtn').addEventListener('click', sellSpice);
            document.getElementById('upgradeHarvest').addEventListener('click', upgradeHarvest);
            document.getElementById('buyAuto').addEventListener('click', buyAutoHarvester);
            document.getElementById('buildRefinery').addEventListener('click', () => buildBuilding('refinery'));
            document.getElementById('buildDefense').addEventListener('click', () => buildBuilding('defense'));
            document.getElementById('buildMarket').addEventListener('click', () => buildBuilding('market'));
            document.getElementById('buildBank').addEventListener('click', () => buildBuilding('bank'));
            document.getElementById('buyInfantry').addEventListener('click', () => buyUnit('infantry'));
            document.getElementById('buyArcher').addEventListener('click', () => buyUnit('archer'));
            document.getElementById('buyThopter').addEventListener('click', () => buyUnit('thopter'));
            document.getElementById('saveBtn').addEventListener('click', saveGame);
            
            // Movement
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dir = btn.dataset.dir;
                    const pos = gameState.player.position;
                    let newX = pos.x, newY = pos.y;
                    
                    switch(dir) {
                        case 'north': newY--; break;
                        case 'south': newY++; break;
                        case 'west': newX--; break;
                        case 'east': newX++; break;
                    }
                    
                    if (newX >= 0 && newX < gameState.map.size && newY >= 0 && newY < gameState.map.size) {
                        movePlayer(newX, newY);
                    }
                });
            });
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            // Combat
            document.getElementById('attackBtn').addEventListener('click', playerAttack);
            document.getElementById('defendBtn').addEventListener('click', playerDefend);
            document.getElementById('fleeBtn').addEventListener('click', playerFlee);
            
            // Loot
            document.getElementById('collectLootBtn').addEventListener('click', collectLoot);
            
            // Duel
            document.getElementById('acceptDuelBtn').addEventListener('click', acceptDuel);
            document.getElementById('declineDuelBtn').addEventListener('click', declineDuel);
            
            // Chat
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            chatSend.addEventListener('click', sendChat);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChat();
            });
            
            // Player name
            document.getElementById('playerName').addEventListener('change', (e) => {
                gameState.player.name = e.target.value || 'Survivor';
                updateUI();
            });
            
            // Start game loops
            renderMap();
            updateUI();
            
            // Production loop
            setInterval(autoProduction, 1000);
            
            // Auto save
            setInterval(saveGame, 60000);
            
            // Simulate other player movements
            setInterval(() => {
                gameState.otherPlayers.forEach(player => {
                    if (Math.random() < 0.3) {
                        const dx = Math.floor(Math.random() * 3) - 1;
                        const dy = Math.floor(Math.random() * 3) - 1;
                        player.position.x = Math.max(0, Math.min(gameState.map.size - 1, player.position.x + dx));
                        player.position.y = Math.max(0, Math.min(gameState.map.size - 1, player.position.y + dy));
                        
                        // Randomly update their stats
                        if (Math.random() < 0.1) {
                            player.spice += Math.floor(Math.random() * 100);
                            player.level = Math.min(50, player.level + (Math.random() < 0.05 ? 1 : 0));
                            
                            // Update rank
                            for (let i = RANKS.length - 1; i >= 0; i--) {
                                if (player.spice >= RANKS[i].minSpice) {
                                    player.rank = RANKS[i].name;
                                    break;
                                }
                            }
                        }
                    }
                });
                renderMap();
                updateNearbyPlayers();
            }, 5000);
            
            log('Welcome to Arrakis Tycoon!', 'info');
            log('The spice must flow...', 'warning');
            showNotification('Game started! Click on adjacent tiles to move.', 'info');
        }

        // Start game
        initGame();
    </script>
</body>
</html>
