<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrakis: Spice Empire - Multiplayer MMO Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #1c1917 0%, #292524 50%, #1c1917 100%);
            color: #e5e7eb; 
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { border-bottom-color: #f59e0b; color: #f59e0b; background-color: #292524; }
        .progress-bar-bg { background-color: #3f3f46; }
        .progress-bar-fill { background-color: #f59e0b; transition: width 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #292524; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #71717a; }

        .map-grid { 
            display: grid; 
            grid-template-columns: repeat(15, 32px);
            gap: 1px;
            background: linear-gradient(45deg, #451a03, #1c1917);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 8px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        .map-cell { 
            width: 32px; height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem; 
            font-weight: bold;
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: linear-gradient(135deg, #78350f, #451a03);
        }
        .map-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            border-color: #f59e0b !important;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .map-cell-player { 
            background: radial-gradient(circle, #facc15, #eab308) !important; 
            color: black !important; 
            box-shadow: 0 0 15px #facc15; 
            animation: pulse-player 2s infinite; 
            border: 2px solid #fff !important;
        }
        .map-cell-other-player { 
            box-shadow: 0 0 12px currentColor; 
            animation: pulse-other-player 3s infinite; 
            border: 2px solid currentColor !important;
        }
        .map-cell-enemy { background: linear-gradient(135deg, #ef4444, #dc2626) !important; color: white !important; }
        .map-cell-boss { background: linear-gradient(135deg, #7e22ce, #6b21a8) !important; color: white !important; animation: pulse-boss 2s infinite alternate; }
        .map-cell-special-enemy { background: linear-gradient(135deg, #f97316, #ea580c) !important; color: white !important; animation: shimmer 3s infinite; }
        .map-cell-sandworm { background: linear-gradient(135deg, #451a03, #f59e0b) !important; color: #fed7aa !important; animation: sandworm-pulse 3s infinite; }
        .map-cell-resource-spice { background: linear-gradient(135deg, #ea580c, #f97316) !important; color: #fed7aa !important; }
        .map-cell-resource-water { background: linear-gradient(135deg, #0ea5e9, #0284c7) !important; color: white !important; }
        .map-cell-resource-plasteel { background: linear-gradient(135deg, #64748b, #475569) !important; color: white !important; }
        .map-cell-settlement { background: linear-gradient(135deg, #16a34a, #15803d) !important; color: white !important; }
        .map-cell-territory { border: 3px solid currentColor !important; }
        .map-cell-world-event { 
            background: linear-gradient(45deg, #8b5cf6, #a855f7) !important; 
            color: white !important; 
            animation: world-event-pulse 2s infinite;
        }

        @keyframes pulse-player { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes pulse-other-player { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes pulse-boss { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }
        @keyframes shimmer { 0%, 100% { filter: hue-rotate(0deg) brightness(1); } 50% { filter: hue-rotate(30deg) brightness(1.2); } }
        @keyframes sandworm-pulse { 0%, 100% { box-shadow: 0 0 0 rgba(245, 158, 11, 0.7); } 50% { box-shadow: 0 0 25px rgba(245, 158, 11, 0.9); } }
        @keyframes world-event-pulse { 0%, 100% { box-shadow: 0 0 0 rgba(139, 92, 246, 0.7); } 50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.9); } }

        .notification {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            padding: 12px 18px; border-radius: 8px; color: white; font-weight: 500;
            transform: translateX(120%); opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            min-width: 300px; max-width: 400px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            border-left: 4px solid currentColor;
        }
        .notification.show { transform: translateX(0); opacity: 1;}
        .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: #1c1917; }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .notification.legendary { background: linear-gradient(45deg, #f59e0b, #ef4444, #8b5cf6); animation: shimmer 2s infinite; }

        .defeat-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;
            padding: 15px 25px; border-radius: 10px; 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.5);
            opacity: 0; animation: defeat-popup 4s ease-in-out;
        }
        @keyframes defeat-popup { 0%, 100% { opacity: 0; transform: translateX(-50%) translateY(100%); } 20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); } }

        .quote-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;
            padding: 20px 30px; border-radius: 10px; 
            background: linear-gradient(135deg, rgba(28, 25, 23, 0.95), rgba(41, 37, 36, 0.95));
            color: #f59e0b; font-style: italic; font-size: 1.1rem;
            border: 2px solid #f59e0b;
            box-shadow: 0 5px 25px rgba(245, 158, 11, 0.3);
            max-width: 600px; text-align: center;
            opacity: 0; animation: quote-popup 6s ease-in-out;
        }
        @keyframes quote-popup { 0%, 100% { opacity: 0; transform: translateX(-50%) translateY(100%); } 15%, 85% { opacity: 1; transform: translateX(-50%) translateY(0); } }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .modal-content { 
            background: linear-gradient(135deg, #1c1917, #292524); 
            border: 2px solid #f59e0b; 
            border-radius: 12px; 
            padding: 25px; 
            max-width: 600px; 
            width: 90%; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            max-height: 80vh;
            overflow-y: auto;
        }

        .player-color-red { color: #ef4444 !important; }
        .player-color-blue { color: #3b82f6 !important; }
        .player-color-green { color: #10b981 !important; }
        .player-color-purple { color: #8b5cf6 !important; }
        .player-color-orange { color: #f97316 !important; }
        .player-color-pink { color: #ec4899 !important; }
        .player-color-yellow { color: #eab308 !important; }
        .player-color-cyan { color: #06b6d4 !important; }

        .chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #44403c;
            border-radius: 6px;
            background: rgba(28, 25, 23, 0.8);
        }

        .territory-owned {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1)) !important;
            border: 2px dashed #10b981 !important;
        }

        .world-event-marker {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .energy-production-building {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            border: 1px solid #3b82f6;
        }

        .trading-item {
            transition: all 0.2s;
            cursor: pointer;
        }
        .trading-item:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }
        .trading-item.selected {
            border-color: #f59e0b !important;
            background-color: rgba(245, 158, 11, 0.1) !important;
        }

        .tycoon-building {
            background: linear-gradient(135deg, #7c2d12, #92400e);
            border: 2px solid #f59e0b;
        }

        .leaderboard-entry {
            transition: all 0.2s;
        }
        .leaderboard-entry:hover {
            background-color: rgba(245, 158, 11, 0.1);
            transform: translateX(5px);
        }

        .prestige-glow {
            animation: prestige-pulse 3s infinite;
            text-shadow: 0 0 10px currentColor;
        }
        @keyframes prestige-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-stone-950 text-stone-300 antialiased">

    <script type="module">
        // === FIREBASE CONFIGURATION ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, limit, updateDoc, increment, arrayUnion, serverTimestamp, addDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // REPLACE THIS WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB7Zz3fxQtfSuk3tuc2UimeVNoX7M_5sIk",
            authDomain: "arrakis-spice-empire.firebaseapp.com",
            projectId: "arrakis-spice-empire",
            storageBucket: "arrakis-spice-empire.firebasestorage.app",
            messagingSenderId: "685304270859",
            appId: "1:685304270859:web:2d20f753db72a2de61f70e"
        };

        let app, auth, db, userId;

        // === GAME CONSTANTS ===
        const CONFIG = {
            MAP_SIZE: 200,
            VIEW_RADIUS: 7,
            MAX_INVENTORY: 40,
            ENERGY_REGEN_RATE: 3,
            ENERGY_REGEN_INTERVAL: 2000,
            SAVE_INTERVAL: 10000,
            CHAT_UPDATE_INTERVAL: 3000,
            PLAYER_UPDATE_INTERVAL: 5000,
            WORLD_EVENT_INTERVAL: 120000, // 2 minutes
            XP_BASE: 100,
            XP_FACTOR: 1.4,
            TERRITORY_BASE_COST: 1000,
            TERRITORY_COST_MULTIPLIER: 1.5,
            ENERGY_PRODUCTION_UNLOCK_LEVEL: 10
        };

        const PLAYER_COLORS = [
            'red', 'blue', 'green', 'purple', 'orange', 'pink', 'yellow', 'cyan'
        ];

        const DUNE_QUOTES = [
            "Fear is the mind-killer.",
            "He who controls the spice, controls the universe.",
            "The spice must flow.",
            "I must not fear. Fear is the mind-killer.",
            "The mystery of life isn't a problem to solve, but a reality to experience.",
            "The beginning is a very delicate time.",
            "Dreams are messages from the deep.",
            "Without change, something sleeps inside us, and seldom awakens.",
            "The future remains uncertain and so it should, for it is the canvas upon which we paint our desires.",
            "Bless the Maker and His water. Bless the coming and going of Him."
        ];

        const STATIC_DATA = {
            HOUSES: {
                atreides: { 
                    name: "House Atreides", 
                    color: "house-atreides", 
                    bonus: "leadership", 
                    description: "+25% XP gain, +15% unit effectiveness, +10% territory income",
                    startingBonus: { solari: 1000, xp: 300 }
                },
                harkonnen: { 
                    name: "House Harkonnen", 
                    color: "house-harkonnen", 
                    bonus: "brutality", 
                    description: "+30% attack damage, +20% resource extraction, +15% enemy defeat rewards",
                    startingBonus: { plasteel: 200, attack: 8 }
                },
                fremen: { 
                    name: "Fremen", 
                    color: "house-fremen", 
                    bonus: "desert", 
                    description: "-60% water consumption, +40% spice finding, immune to sandworms, +20% territory defense",
                    startingBonus: { water: 300, spice: 100 }
                }
            },
            ENEMIES: {
                sandRaider: { 
                    name: "Fremen Raider", icon: "🏹", health: 60, attack: 12, defense: 6, 
                    xp: 40, loot: { solari: 30, spice: 10, water: 8 }, level: 1, spawnChance: 0.4,
                    description: "Desert nomad seeking spice and water."
                },
                smuggler: {
                    name: "Spice Smuggler", icon: "🥷", health: 80, attack: 18, defense: 8,
                    xp: 60, loot: { solari: 50, melange: 2, rareMaterials: 1 }, level: 2, spawnChance: 0.25,
                    description: "Black market dealer in illegal spice."
                },
                harkonnenGuard: { 
                    name: "Harkonnen Guard", icon: "👤", health: 100, attack: 20, defense: 10, 
                    xp: 80, loot: { solari: 60, plasteel: 8, rareMaterials: 2 }, level: 3, spawnChance: 0.2,
                    description: "Brutal enforcer of Baron Harkonnen."
                },
                sardaukar: { 
                    name: "Sardaukar Elite", icon: "⚔️", health: 150, attack: 30, defense: 15, 
                    xp: 150, loot: { solari: 120, rareMaterials: 5, melange: 3 }, level: 5, spawnChance: 0.1,
                    description: "Imperial super-soldier. Extremely dangerous."
                },
                guildNavigator: {
                    name: "Guild Navigator", icon: "👁️", health: 200, attack: 25, defense: 20,
                    xp: 200, loot: { melange: 8, rareMaterials: 8, solari: 200 }, level: 7, spawnChance: 0.05,
                    special: true, description: "Mutated spice addict with prescient abilities."
                },
                mentat: {
                    name: "Corrupted Mentat", icon: "🧠", health: 180, attack: 35, defense: 12,
                    xp: 180, loot: { solari: 150, melange: 5, rareMaterials: 6 }, level: 6, spawnChance: 0.08,
                    special: true, description: "Human computer driven mad by forbidden calculations."
                },
                beastRabban: { 
                    name: "Beast Rabban", icon: "👹", health: 400, attack: 50, defense: 25, 
                    xp: 400, loot: { solari: 1000, spice: 150, rareMaterials: 15, melange: 8 }, 
                    boss: true, level: 10, spawnChance: 0.02, description: "Harkonnen na-Baron. Ruthless and brutal."
                },
                baronHarkonnen: {
                    name: "Baron Vladimir Harkonnen", icon: "🦹", health: 800, attack: 70, defense: 35,
                    xp: 800, loot: { solari: 2500, spice: 300, rareMaterials: 30, melange: 20 },
                    boss: true, level: 20, spawnChance: 0.01, description: "The Baron himself. Master of schemes."
                },
                sandworm: {
                    name: "Shai-Hulud", icon: "🐛", health: 1500, attack: 120, defense: 50,
                    xp: 1500, loot: { spice: 800, melange: 80, rareMaterials: 60 },
                    boss: true, level: 25, legendary: true, spawnChance: 0.005, description: "The Great Sandworm. Maker of spice."
                }
            },
            BUILDINGS: {
                spiceRefinery: { 
                    name: "Spice Refinery", icon: "🏭", maxLevel: 25, 
                    baseCost: { solari: 500, plasteel: 30 }, costFactor: 1.6,
                    production: { type: 'process', input: 'spice', output: 'melange', ratio: 0.15 },
                    description: "Converts raw spice into pure melange."
                },
                energyPlant: {
                    name: "Energy Plant", icon: "⚡", maxLevel: 20,
                    baseCost: { solari: 800, plasteel: 50, rareMaterials: 5 }, costFactor: 1.8,
                    production: { type: 'energy', rate: 1 },
                    description: "Increases energy regeneration rate.",
                    unlock: CONFIG.ENERGY_PRODUCTION_UNLOCK_LEVEL
                },
                harvestor: { 
                    name: "Spice Harvestor", icon: "⛏️", maxLevel: 30, 
                    baseCost: { solari: 1200, plasteel: 100 }, costFactor: 1.7,
                    production: { type: 'generate', output: 'spice', rate: 3 },
                    description: "Automated spice extraction."
                },
                waterReclamator: { 
                    name: "Water Reclamator", icon: "💧", maxLevel: 15, 
                    baseCost: { solari: 600, plasteel: 40 }, costFactor: 1.5,
                    production: { type: 'generate', output: 'water', rate: 0.8 },
                    description: "Recycles moisture from the atmosphere."
                },
                plasteelForge: {
                    name: "Plasteel Forge", icon: "🔨", maxLevel: 20,
                    baseCost: { solari: 1000, water: 100 }, costFactor: 1.6,
                    production: { type: 'generate', output: 'plasteel', rate: 1.5 },
                    description: "Produces high-grade plasteel."
                },
                bank: { 
                    name: "CHOAM Bank", icon: "🏦", maxLevel: 15, 
                    baseCost: { solari: 2000, plasteel: 80 }, costFactor: 2.0,
                    effect: 'interest', description: "Generates passive Solari income."
                },
                researchLab: { 
                    name: "Mentat School", icon: "🧠", maxLevel: 20, 
                    baseCost: { solari: 2500, plasteel: 200, melange: 15 }, costFactor: 2.2,
                    effect: 'research', description: "Unlocks advanced technologies."
                },
                marketplace: { 
                    name: "Spice Exchange", icon: "📈", maxLevel: 15, 
                    baseCost: { solari: 1500, plasteel: 60 }, costFactor: 1.9,
                    effect: 'trading', description: "Improves trade efficiency."
                },
                sietchTabr: {
                    name: "Sietch Tabr", icon: "🏔️", maxLevel: 10,
                    baseCost: { solari: 8000, water: 1500, melange: 50 }, costFactor: 3.0,
                    effect: 'prestige', description: "Sacred Fremen stronghold. Required for prestige."
                },
                // Tycoon Buildings (High-end power generation)
                spiceMegaRefinery: {
                    name: "Spice Mega-Refinery", icon: "🏭", maxLevel: 10,
                    baseCost: { solari: 50000, plasteel: 1000, melange: 100, rareMaterials: 50 }, costFactor: 2.5,
                    production: { type: 'generate', output: 'melange', rate: 15 },
                    tycoon: true, unlock: 15, description: "Massive industrial spice processing complex."
                },
                orbitalHarvester: {
                    name: "Orbital Harvester", icon: "🛰️", maxLevel: 5,
                    baseCost: { solari: 100000, plasteel: 2000, rareMaterials: 100 }, costFactor: 3.0,
                    production: { type: 'generate', output: 'rareMaterials', rate: 8 },
                    tycoon: true, unlock: 20, description: "Space-based resource extraction platform."
                },
                economicImperium: {
                    name: "Economic Imperium", icon: "👑", maxLevel: 3,
                    baseCost: { solari: 500000, melange: 500, rareMaterials: 200 }, costFactor: 4.0,
                    production: { type: 'generate', output: 'solari', rate: 1000 },
                    tycoon: true, unlock: 25, description: "Ultimate economic dominance structure."
                }
            },
            ITEMS: {
                crysknife: { name: "Crysknife", icon: "🗡️", type: "weapon", attack: 30, rarity: "legendary", description: "Sacred Fremen blade made from sandworm tooth.", dropChance: 0.15 },
                maula: { name: "Maula Pistol", icon: "🔫", type: "weapon", attack: 22, rarity: "rare", description: "Spring-loaded dart gun used in shield combat.", dropChance: 0.25 },
                lasguns: { name: "Lasgun", icon: "⚡", type: "weapon", attack: 28, rarity: "epic", description: "Directed energy weapon.", dropChance: 0.1 },
                stillsuit: { name: "Stillsuit", icon: "🥽", type: "armor", defense: 18, rarity: "uncommon", description: "Desert survival suit that recycles body moisture.", dropChance: 0.3 },
                shieldBelt: { name: "Shield Belt", icon: "🔘", type: "accessory", defense: 25, rarity: "epic", description: "Personal force field generator.", dropChance: 0.12 },
                fremkit: { name: "Fremen Survival Kit", icon: "🎒", type: "accessory", special: "desert", rarity: "rare", description: "Essential tools for desert survival.", dropChance: 0.2 },
                spiceLens: { name: "Spice Lens", icon: "🔍", type: "accessory", special: "detection", rarity: "epic", description: "Reveals hidden spice deposits.", dropChance: 0.08 },
                choamRing: { name: "CHOAM Signet", icon: "💍", type: "accessory", special: "trading", rarity: "legendary", description: "Grants access to exclusive markets.", dropChance: 0.05 },
                powerArmor: { name: "Sardaukar Armor", icon: "🛡️", type: "armor", defense: 35, attack: 10, rarity: "legendary", description: "Imperial military armor.", dropChance: 0.06 },
                guildArtifact: { name: "Guild Artifact", icon: "👁️", type: "accessory", special: "prescience", rarity: "legendary", description: "Navigator technology.", dropChance: 0.04 }
            },
            WORLD_EVENTS: [
                {
                    name: "Spice Bloom",
                    description: "A massive spice deposit has been discovered!",
                    icon: "✨",
                    rewards: { spice: 500, melange: 25 },
                    duration: 300000 // 5 minutes
                },
                {
                    name: "Sandstorm",
                    description: "A great sandstorm sweeps across the desert!",
                    icon: "🌪️",
                    effect: "energy_drain",
                    duration: 180000 // 3 minutes
                },
                {
                    name: "Guild Heighliner",
                    description: "A Guild ship has crashed, scattering rare materials!",
                    icon: "🚀",
                    rewards: { rareMaterials: 50, melange: 15 },
                    duration: 600000 // 10 minutes
                },
                {
                    name: "Fremen Gathering",
                    description: "The Fremen offer knowledge and resources to worthy allies!",
                    icon: "🏔️",
                    rewards: { water: 200, xp: 500 },
                    duration: 240000 // 4 minutes
                },
                {
                    name: "Imperial Raid",
                    description: "Sardaukar forces are searching the area! High risk, high reward!",
                    icon: "⚔️",
                    effect: "combat_boost",
                    rewards: { solari: 1000, rareMaterials: 20 },
                    duration: 420000 // 7 minutes
                }
            ]
        };

        // === GAME STATE ===
        let gameState = {
            player: {
                id: null, name: "", color: "red", level: 1, experience: 0, experienceToNext: 100,
                health: 120, maxHealth: 120, energy: 150, maxEnergy: 150,
                attack: 15, defense: 10, critChance: 8, dodgeChance: 15,
                position: { x: 100, y: 100 }, basePosition: { x: 100, y: 100 },
                house: null, rank: 'Desert Rat', power: 0, prestigeLevel: 0,
                territories: [], lifetimeSpice: 0, totalEnemiesDefeated: 0,
                energyProductionRate: CONFIG.ENERGY_REGEN_RATE,
                created: Date.now(), lastActive: Date.now()
            },
            resources: { spice: 0, water: 200, solari: 2000, plasteel: 150, rareMaterials: 0, melange: 0 },
            equipment: { weapon: null, armor: null, accessory: null },
            inventory: new Array(CONFIG.MAX_INVENTORY).fill(null),
            buildings: {},
            combat: { active: false, enemy: null, turn: 'player', log: [] },
            currentTab: 'game',
            gameInitialized: false,
            lastSaveTime: 0,
            lastEnergyRegen: Date.now(),
            onlinePlayers: {},
            worldEvents: [],
            tradeOffers: []
        };

        // === FIREBASE FUNCTIONS ===
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        gameState.player.id = userId;
                        loadGame();
                        startMultiplayerSync();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Failed to connect to game servers. Playing offline.", 'error');
            }
        }

        async function saveGame() {
            if (!db || !userId) return;
            
            try {
                const playerData = {
                    ...gameState.player,
                    resources: gameState.resources,
                    equipment: gameState.equipment,
                    inventory: gameState.inventory,
                    buildings: gameState.buildings,
                    lastSave: serverTimestamp(),
                    lastActive: serverTimestamp()
                };
                
                await setDoc(doc(db, 'players', userId), playerData);
                
                // Update player position for map display
                await setDoc(doc(db, 'playerPositions', userId), {
                    position: gameState.player.position,
                    name: gameState.player.name,
                    color: gameState.player.color,
                    level: gameState.player.level,
                    prestigeLevel: gameState.player.prestigeLevel,
                    house: gameState.player.house,
                    lastUpdate: serverTimestamp()
                });
                
                gameState.lastSaveTime = Date.now();
            } catch (error) {
                console.error('Save failed:', error);
            }
        }

        async function loadGame() {
            if (!db || !userId) return;
            
            try {
                const docRef = doc(db, 'players', userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    Object.assign(gameState.player, data);
                    gameState.resources = data.resources || gameState.resources;
                    gameState.equipment = data.equipment || gameState.equipment;
                    gameState.inventory = data.inventory || gameState.inventory;
                    gameState.buildings = data.buildings || gameState.buildings;
                    
                    if (!gameState.player.name) {
                        showNameSelectionModal();
                    } else {
                        completeGameInitialization();
                    }
                } else {
                    showNameSelectionModal();
                }
            } catch (error) {
                console.error('Load failed:', error);
                showNameSelectionModal();
            }
        }

        async function startMultiplayerSync() {
            // Listen for other players
            const playersQuery = query(collection(db, 'playerPositions'), orderBy('lastUpdate', 'desc'), limit(50));
            onSnapshot(playersQuery, (snapshot) => {
                gameState.onlinePlayers = {};
                snapshot.forEach((doc) => {
                    if (doc.id !== userId) {
                        gameState.onlinePlayers[doc.id] = doc.data();
                    }
                });
                updateOnlinePlayersDisplay();
                renderMap();
            });

            // Listen for world chat
            const chatQuery = query(collection(db, 'worldChat'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(chatQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.unshift(doc.data());
                });
                updateWorldChat(messages);
            });

            // Listen for world events
            const eventsQuery = query(collection(db, 'worldEvents'), where('endTime', '>', new Date()));
            onSnapshot(eventsQuery, (snapshot) => {
                gameState.worldEvents = [];
                snapshot.forEach((doc) => {
                    gameState.worldEvents.push({ id: doc.id, ...doc.data() });
                });
                updateWorldEventsDisplay();
                renderMap();
            });

            // Listen for trade offers
            const tradesQuery = query(collection(db, 'tradeOffers'), where('status', '==', 'open'));
            onSnapshot(tradesQuery, (snapshot) => {
                gameState.tradeOffers = [];
                snapshot.forEach((doc) => {
                    const trade = { id: doc.id, ...doc.data() };
                    if (trade.toPlayerId === userId || trade.fromPlayerId === userId) {
                        gameState.tradeOffers.push(trade);
                    }
                });
                updateTradeOffersDisplay();
            });
        }

        // === NAME SELECTION ===
        function showNameSelectionModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content max-w-md">
                    <h3 class="text-3xl font-orbitron text-amber-400 mb-6 text-center">Welcome to Arrakis</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Choose Your Name:</label>
                        <input type="text" id="playerNameInput" class="w-full px-3 py-2 bg-stone-700 border border-stone-600 rounded text-white" 
                               placeholder="Enter your name" maxlength="20">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Choose Your Color:</label>
                        <div class="grid grid-cols-4 gap-2">
                            ${PLAYER_COLORS.map(color => `
                                <button class="color-btn w-12 h-12 rounded-full border-2 border-stone-600 player-color-${color}" 
                                        data-color="${color}" style="background-color: var(--tw-color-${color}-500)"></button>
                            `).join('')}
                        </div>
                    </div>
                    <button id="confirmNameBtn" class="w-full py-3 bg-amber-600 hover:bg-amber-700 rounded font-bold text-lg" disabled>
                        Begin Your Journey
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            let selectedColor = 'red';
            const nameInput = modal.querySelector('#playerNameInput');
            const confirmBtn = modal.querySelector('#confirmNameBtn');
            
            // Color selection
            modal.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.querySelectorAll('.color-btn').forEach(b => b.classList.remove('ring-4', 'ring-amber-400'));
                    btn.classList.add('ring-4', 'ring-amber-400');
                    selectedColor = btn.dataset.color;
                    checkFormValid();
                });
            });
            
            // First color selected by default
            modal.querySelector('.color-btn').click();
            
            nameInput.addEventListener('input', checkFormValid);
            
            function checkFormValid() {
                const name = nameInput.value.trim();
                confirmBtn.disabled = name.length < 2;
            }
            
            confirmBtn.addEventListener('click', async () => {
                const name = nameInput.value.trim();
                if (name.length >= 2) {
                    gameState.player.name = name;
                    gameState.player.color = selectedColor;
                    document.body.removeChild(modal);
                    showHouseSelection();
                }
            });
        }

        function showHouseSelection() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content max-w-4xl">
                    <h3 class="text-3xl font-orbitron text-amber-400 mb-6 text-center">Choose Your Great House</h3>
                    <p class="text-center text-stone-300 mb-8">Your allegiance will shape your destiny on Arrakis...</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${Object.entries(STATIC_DATA.HOUSES).map(([houseId, house]) => `
                            <button class="house-btn p-6 border-2 rounded-lg ${house.color} hover:bg-stone-700 transition-all text-left" data-house="${houseId}">
                                <h4 class="text-xl font-bold mb-3">${house.name}</h4>
                                <p class="text-sm text-stone-300 mb-4">${house.description}</p>
                                <div class="text-xs text-amber-300">
                                    Starting Bonus: ${Object.entries(house.startingBonus).map(([key, val]) => `${val} ${key}`).join(', ')}
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <p class="text-center text-xs text-stone-400 mt-6">This choice is permanent and affects your entire journey.</p>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelectorAll('.house-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const houseId = btn.dataset.house;
                    selectHouse(houseId);
                    document.body.removeChild(modal);
                    completeGameInitialization();
                });
            });
        }

        function selectHouse(houseId) {
            const house = STATIC_DATA.HOUSES[houseId];
            gameState.player.house = houseId;
            
            // Apply starting bonuses
            if (house.startingBonus.solari) {
                gameState.resources.solari += house.startingBonus.solari;
            }
            if (house.startingBonus.plasteel) {
                gameState.resources.plasteel += house.startingBonus.plasteel;
            }
            if (house.startingBonus.water) {
                gameState.resources.water += house.startingBonus.water;
            }
            if (house.startingBonus.spice) {
                gameState.resources.spice += house.startingBonus.spice;
            }
            if (house.startingBonus.xp) {
                addExperience(house.startingBonus.xp);
            }
            if (house.startingBonus.attack) {
                gameState.player.attack += house.startingBonus.attack;
            }
            
            showNotification(`Joined ${house.name}! ${house.description}`, 'legendary', 8000);
            showQuotePopup(`"Welcome to ${house.name}, ${gameState.player.name}. May your enemies know fear."`);
        }

        function completeGameInitialization() {
            gameState.gameInitialized = true;
            
            // Hide loading screen
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            // Initialize map
            initializeMap();
            
            // Start game loop
            startGameLoop();
            
            // Initial UI update
            updateUI();
            renderMap();
            
            // Save initial state
            saveGame();
            
            showNotification(`Welcome to Arrakis, ${gameState.player.name}!`, 'success', 6000);
            showQuotePopup('"The beginning is a very delicate time..."');
        }

        // === MAP SYSTEM ===
        function initializeMap() {
            // Generate more enemies
            for (let i = 0; i < 400; i++) {
                const pos = getRandomPosition();
                const key = `${pos.x},${pos.y}`;
                
                // Check spawn chances
                const enemyTypes = Object.entries(STATIC_DATA.ENEMIES);
                for (const [enemyType, enemy] of enemyTypes) {
                    if (Math.random() < enemy.spawnChance) {
                        gameState.map = gameState.map || { enemies: {}, resources: {}, territories: {} };
                        gameState.map.enemies[key] = {
                            id: generateId(),
                            type: enemyType,
                            position: pos,
                            ...enemy,
                            currentHealth: enemy.health
                        };
                        break;
                    }
                }
            }
            
            // Generate resources
            for (let i = 0; i < 200; i++) {
                const pos = getRandomPosition();
                const key = `${pos.x},${pos.y}`;
                
                if (!gameState.map.enemies[key]) {
                    const resourceTypes = ['spice', 'water', 'plasteel', 'rareMaterials'];
                    const weights = [50, 25, 15, 10];
                    const resourceType = weightedRandom(resourceTypes, weights);
                    
                    gameState.map.resources = gameState.map.resources || {};
                    gameState.map.resources[key] = {
                        id: generateId(),
                        type: resourceType,
                        position: pos,
                        amount: 30 + Math.floor(Math.random() * 70)
                    };
                }
            }
        }

        function renderMap() {
            const mapGrid = document.getElementById('uiMapGrid');
            if (!mapGrid) return;
            
            mapGrid.innerHTML = '';
            
            const playerX = gameState.player.position.x;
            const playerY = gameState.player.position.y;
            const radius = CONFIG.VIEW_RADIUS;
            
            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    const x = playerX + dx;
                    const y = playerY + dy;
                    const key = `${x},${y}`;
                    
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // Check for content
                    let hasContent = false;
                    
                    // Player position
                    if (x === playerX && y === playerY) {
                        cell.className += ' map-cell-player';
                        cell.textContent = '👤';
                        cell.title = `${gameState.player.name} (P${gameState.player.prestigeLevel})`;
                        hasContent = true;
                    }
                    // Other players
                    else if (gameState.onlinePlayers) {
                        for (const [playerId, player] of Object.entries(gameState.onlinePlayers)) {
                            if (player.position && player.position.x === x && player.position.y === y) {
                                cell.className += ` map-cell-other-player player-color-${player.color}`;
                                cell.textContent = '👤';
                                cell.title = `${player.name} (P${player.prestigeLevel || 0}) - ${STATIC_DATA.HOUSES[player.house]?.name || 'No House'}`;
                                hasContent = true;
                                break;
                            }
                        }
                    }
                    // World events
                    if (!hasContent && gameState.worldEvents) {
                        for (const event of gameState.worldEvents) {
                            if (event.position && event.position.x === x && event.position.y === y) {
                                cell.className += ' map-cell-world-event';
                                cell.textContent = event.icon;
                                cell.title = `${event.name}: ${event.description}`;
                                hasContent = true;
                                break;
                            }
                        }
                    }
                    // Enemies
                    if (!hasContent && gameState.map?.enemies?.[key]) {
                        const enemy = gameState.map.enemies[key];
                        if (enemy.special) {
                            cell.className += ' map-cell-special-enemy';
                        } else if (enemy.boss) {
                            cell.className += ' map-cell-boss';
                        } else {
                            cell.className += ' map-cell-enemy';
                        }
                        cell.textContent = enemy.icon;
                        cell.title = `${enemy.name} (Lv.${enemy.level}) - ${enemy.description}`;
                        hasContent = true;
                    }
                    // Resources
                    else if (!hasContent && gameState.map?.resources?.[key]) {
                        const resource = gameState.map.resources[key];
                        cell.className += ` map-cell-resource-${resource.type}`;
                        const icons = { spice: '✨', water: '💧', plasteel: '🔧', rareMaterials: '💎' };
                        cell.textContent = icons[resource.type] || '📦';
                        cell.title = `${resource.type.charAt(0).toUpperCase() + resource.type.slice(1)} (${resource.amount})`;
                        hasContent = true;
                    }
                    // Territory
                    if (gameState.map?.territories?.[key]) {
                        const territory = gameState.map.territories[key];
                        cell.classList.add('map-cell-territory');
                        if (territory.ownerId === userId) {
                            cell.classList.add('territory-owned');
                        } else {
                            cell.style.borderColor = `var(--tw-color-${territory.ownerColor}-500)`;
                        }
                    }
                    
                    // Empty desert
                    if (!hasContent) {
                        const terrains = ['🏜️', '🌵', '🪨', '⛰️'];
                        cell.textContent = terrains[Math.floor(Math.random() * terrains.length)];
                        cell.title = 'Empty desert - Click to purchase territory';
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(parseInt(x), parseInt(y)));
                    mapGrid.appendChild(cell);
                }
            }
        }

        function handleCellClick(x, y) {
            const dx = x - gameState.player.position.x;
            const dy = y - gameState.player.position.y;
            const key = `${x},${y}`;
            
            // Movement to adjacent cells
            if (Math.abs(dx) <= 1 && Math.abs(dy) <= 1 && (dx !== 0 || dy !== 0)) {
                movePlayer(dx, dy);
            }
            // Current position interactions
            else if (dx === 0 && dy === 0) {
                if (gameState.map?.enemies?.[key]) {
                    startCombat(gameState.map.enemies[key]);
                } else if (gameState.map?.resources?.[key]) {
                    harvestResourceNode(gameState.map.resources[key]);
                } else {
                    // Try to purchase territory
                    purchaseTerritory(x, y);
                }
            }
            // Purchase territory at distance
            else {
                purchaseTerritory(x, y);
            }
        }

        function movePlayer(dx, dy) {
            if (gameState.combat.active) {
                showNotification('Cannot move during combat!', 'error');
                return;
            }
            
            const waterCost = gameState.player.house === 'fremen' ? 1 : 2;
            
            if (gameState.resources.water < waterCost) {
                showNotification('Not enough water to travel!', 'error');
                return;
            }
            
            const newX = Math.max(0, Math.min(CONFIG.MAP_SIZE - 1, gameState.player.position.x + dx));
            const newY = Math.max(0, Math.min(CONFIG.MAP_SIZE - 1, gameState.player.position.y + dy));
            const key = `${newX},${newY}`;
            
            gameState.player.position.x = newX;
            gameState.player.position.y = newY;
            updateResources({ water: -waterCost });
            
            // Auto-combat if moving onto enemy
            if (gameState.map?.enemies?.[key]) {
                setTimeout(() => startCombat(gameState.map.enemies[key]), 500);
            }
            
            renderMap();
            saveGame();
        }

        // === TERRITORY SYSTEM ===
        function purchaseTerritory(x, y) {
            const key = `${x},${y}`;
            const existingTerritory = gameState.map?.territories?.[key];
            
            let cost = CONFIG.TERRITORY_BASE_COST;
            
            if (existingTerritory) {
                if (existingTerritory.ownerId === userId) {
                    showNotification('You already own this territory!', 'warning');
                    return;
                }
                // Higher cost to buy from other player
                cost = Math.floor(existingTerritory.purchasePrice * CONFIG.TERRITORY_COST_MULTIPLIER);
            }
            
            // Count current territories for scaling cost
            const ownedCount = gameState.player.territories?.length || 0;
            cost = Math.floor(cost * Math.pow(1.2, ownedCount));
            
            if (gameState.resources.solari < cost) {
                showNotification(`Need ${cost.toLocaleString()} Solari to purchase this territory!`, 'error');
                return;
            }
            
            if (!confirm(`Purchase territory at ${x},${y} for ${cost.toLocaleString()} Solari?`)) {
                return;
            }
            
            updateResources({ solari: -cost });
            
            // Add to territories
            gameState.map.territories = gameState.map.territories || {};
            gameState.map.territories[key] = {
                ownerId: userId,
                ownerName: gameState.player.name,
                ownerColor: gameState.player.color,
                position: { x, y },
                purchasePrice: cost,
                purchaseTime: Date.now()
            };
            
            gameState.player.territories = gameState.player.territories || [];
            if (!gameState.player.territories.some(t => t.x === x && t.y === y)) {
                gameState.player.territories.push({ x, y, cost });
            }
            
            showNotification(`Territory purchased at ${x},${y}!`, 'success');
            
            // Compensate previous owner if applicable
            if (existingTerritory && existingTerritory.ownerId !== userId) {
                compensatePlayer(existingTerritory.ownerId, Math.floor(cost * 0.8));
            }
            
            renderMap();
            saveGame();
            saveTerritoryToFirebase(key, gameState.map.territories[key]);
        }

        async function saveTerritoryToFirebase(key, territory) {
            if (!db) return;
            try {
                await setDoc(doc(db, 'territories', key), territory);
            } catch (error) {
                console.error('Failed to save territory:', error);
            }
        }

        async function compensatePlayer(playerId, amount) {
            if (!db) return;
            try {
                await updateDoc(doc(db, 'players', playerId), {
                    'resources.solari': increment(amount)
                });
            } catch (error) {
                console.error('Failed to compensate player:', error);
            }
        }

        // === COMBAT SYSTEM ===
        function startCombat(enemy) {
            gameState.combat = {
                active: true,
                enemy: { ...enemy, currentHealth: enemy.currentHealth || enemy.health },
                turn: 'player',
                log: []
            };
            
            addCombatLog(`⚔️ Combat begins with ${enemy.name}!`);
            showCombatModal();
        }

        function showCombatModal() {
            const modal = document.getElementById('modalCombat');
            if (modal) {
                modal.classList.remove('hidden');
                updateCombatDisplay();
            }
        }

        function updateCombatDisplay() {
            if (!gameState.combat.active) return;
            
            const enemy = gameState.combat.enemy;
            
            // Update displays
            document.getElementById('modalCombatPlayerName').textContent = `${gameState.player.name} (P${gameState.player.prestigeLevel})`;
            document.getElementById('modalCombatPlayerLevel').textContent = `Lv.${gameState.player.level}`;
            document.getElementById('modalCombatPlayerHealth').textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('modalCombatEnemyName').textContent = enemy.name;
            document.getElementById('modalCombatEnemyLevel').textContent = `Lv.${enemy.level}`;
            document.getElementById('modalCombatEnemyHealth').textContent = `${enemy.currentHealth}/${enemy.health}`;
            
            // Update health bars
            const playerHealthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const enemyHealthPercent = (enemy.currentHealth / enemy.health) * 100;
            
            document.getElementById('modalCombatPlayerHealthBar').style.width = `${playerHealthPercent}%`;
            document.getElementById('modalCombatEnemyHealthBar').style.width = `${enemyHealthPercent}%`;
            
            // Update combat log
            const logElement = document.getElementById('modalCombatLog');
            if (logElement) {
                logElement.innerHTML = gameState.combat.log.join('<br>');
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function addCombatLog(message) {
            gameState.combat.log.push(message);
            if (gameState.combat.log.length > 20) gameState.combat.log.shift();
        }

        function combatAction(action) {
            if (gameState.combat.turn !== 'player') return;
            
            const enemy = gameState.combat.enemy;
            
            switch (action) {
                case 'attack':
                    let damage = gameState.player.attack + Math.floor(Math.random() * 20);
                    
                    // Equipment bonuses
                    if (gameState.equipment.weapon) {
                        damage += gameState.equipment.weapon.attack || 0;
                    }
                    
                    // House bonuses
                    if (gameState.player.house === 'harkonnen') {
                        damage = Math.floor(damage * 1.3);
                    }
                    
                    // Critical hit
                    if (Math.random() * 100 < gameState.player.critChance) {
                        damage *= 2;
                        addCombatLog(`💥 CRITICAL HIT! You deal ${damage} damage!`);
                    } else {
                        addCombatLog(`⚔️ You attack for ${damage} damage!`);
                    }
                    
                    enemy.currentHealth -= damage;
                    break;
                    
                case 'defend':
                    const healing = Math.floor(gameState.player.maxHealth * 0.2);
                    gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healing);
                    addCombatLog(`🛡️ You defend and recover ${healing} health!`);
                    break;
                    
                case 'flee':
                    let fleeChance = 0.7;
                    if (enemy.boss) fleeChance = 0.4;
                    
                    if (Math.random() < fleeChance) {
                        addCombatLog(`💨 You successfully flee from combat!`);
                        endCombat(false, true);
                        return;
                    } else {
                        addCombatLog(`❌ Failed to flee!`);
                    }
                    break;
            }
            
            if (enemy.currentHealth <= 0) {
                endCombat(true);
                return;
            }
            
            // Enemy turn
            gameState.combat.turn = 'enemy';
            setTimeout(() => enemyTurn(), 1500);
        }

        function enemyTurn() {
            const enemy = gameState.combat.enemy;
            let damage = enemy.attack + Math.floor(Math.random() * 15);
            
            // Apply defense
            let defense = gameState.player.defense;
            if (gameState.equipment.armor) defense += gameState.equipment.armor.defense || 0;
            if (gameState.equipment.accessory?.defense) defense += gameState.equipment.accessory.defense;
            
            // Dodge check
            if (Math.random() * 100 < gameState.player.dodgeChance) {
                addCombatLog(`💨 You dodge ${enemy.name}'s attack!`);
            } else {
                const actualDamage = Math.max(1, damage - defense);
                gameState.player.health -= actualDamage;
                addCombatLog(`💀 ${enemy.name} attacks for ${actualDamage} damage!`);
                
                if (gameState.player.health <= 0) {
                    endCombat(false);
                    return;
                }
            }
            
            gameState.combat.turn = 'player';
            updateCombatDisplay();
        }

        function endCombat(victory, fled = false) {
            const enemy = gameState.combat.enemy;
            
            if (victory) {
                addCombatLog(`🎉 Victory! ${enemy.name} has been defeated!`);
                
                // Rewards
                let xpGain = enemy.xp || 50;
                let lootMultiplier = 1;
                
                // House bonuses
                if (gameState.player.house === 'harkonnen') {
                    lootMultiplier = 1.15;
                }
                
                addExperience(xpGain);
                
                if (enemy.loot) {
                    const rewards = {};
                    Object.entries(enemy.loot).forEach(([resource, amount]) => {
                        rewards[resource] = Math.floor(amount * lootMultiplier);
                    });
                    updateResources(rewards);
                }
                
                // Item drops
                const dropChance = enemy.boss ? 0.8 : enemy.special ? 0.4 : 0.2;
                if (Math.random() < dropChance) {
                    const items = Object.values(STATIC_DATA.ITEMS);
                    const droppableItems = items.filter(item => Math.random() < item.dropChance);
                    if (droppableItems.length > 0) {
                        const item = droppableItems[Math.floor(Math.random() * droppableItems.length)];
                        addToInventory(item);
                        showNotification(`Found: ${item.name}!`, item.rarity === 'legendary' ? 'legendary' : 'success');
                    }
                }
                
                gameState.player.totalEnemiesDefeated++;
                
                // Remove enemy from map
                const key = `${enemy.position.x},${enemy.position.y}`;
                delete gameState.map.enemies[key];
                
                // Show defeat popup
                showDefeatPopup(`Defeated ${enemy.name}!`);
                
                if (enemy.boss) {
                    showNotification(`🏆 BOSS DEFEATED: ${enemy.name}!`, 'legendary', 8000);
                    sendWorldMessage(`${gameState.player.name} has defeated ${enemy.name}!`, 'boss');
                }
            } else if (fled) {
                addCombatLog(`💨 You escaped from ${enemy.name}!`);
            } else {
                addCombatLog(`💀 Defeat! You have been defeated!`);
                
                // Death penalties
                gameState.player.health = Math.floor(gameState.player.maxHealth * 0.1);
                const solariLoss = Math.floor(gameState.resources.solari * 0.15);
                updateResources({ solari: -solariLoss });
                
                showDefeatPopup(`Defeated by ${enemy.name}! Lost ${solariLoss} Solari`);
                
                // Teleport to base
                gameState.player.position = { ...gameState.player.basePosition };
            }
            
            gameState.combat.active = false;
            
            setTimeout(() => {
                document.getElementById('modalCombat')?.classList.add('hidden');
                renderMap();
                updateUI();
                saveGame();
            }, 3000);
        }

        // === TRADING SYSTEM ===
        function showTradingModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content max-w-4xl">
                    <h3 class="text-2xl font-orbitron text-amber-400 mb-4">🤝 Player Trading</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold mb-3">Create Trade Offer</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm mb-1">To Player:</label>
                                    <select id="tradeToPlayer" class="w-full px-3 py-2 bg-stone-700 border border-stone-600 rounded">
                                        <option value="">Select Player</option>
                                        ${Object.entries(gameState.onlinePlayers).map(([id, player]) => 
                                            `<option value="${id}">${player.name} (P${player.prestigeLevel || 0})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="font-medium mb-2">Your Offer:</h5>
                                        <div id="yourTradeItems" class="space-y-2 max-h-40 overflow-y-auto">
                                            <!-- Trade items will be populated here -->
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="font-medium mb-2">Request:</h5>
                                        <div class="space-y-2">
                                            <input type="number" id="requestSolari" placeholder="Solari" class="w-full px-2 py-1 bg-stone-700 rounded text-sm">
                                            <input type="number" id="requestSpice" placeholder="Spice" class="w-full px-2 py-1 bg-stone-700 rounded text-sm">
                                            <input type="number" id="requestMelange" placeholder="Melange" class="w-full px-2 py-1 bg-stone-700 rounded text-sm">
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="createTradeBtn" class="w-full py-2 bg-green-600 hover:bg-green-700 rounded">Create Trade Offer</button>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold mb-3">Active Trade Offers</h4>
                            <div id="activeTradeOffers" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Active trades will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <button class="mt-4 px-4 py-2 bg-stone-600 hover:bg-stone-700 rounded" onclick="closeTradingModal()">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateTradingModal(modal);
            
            window.closeTradingModal = () => {
                document.body.removeChild(modal);
                delete window.closeTradingModal;
            };
        }

        function updateTradingModal(modal) {
            // Populate your trade items
            const yourItems = modal.querySelector('#yourTradeItems');
            yourItems.innerHTML = '';
            
            // Add resources
            Object.entries(gameState.resources).forEach(([resource, amount]) => {
                if (amount > 0) {
                    const item = document.createElement('div');
                    item.className = 'trading-item p-2 bg-stone-700 rounded cursor-pointer';
                    item.innerHTML = `
                        <div class="flex justify-between">
                            <span>${resource}: ${amount}</span>
                            <input type="number" class="w-16 px-1 bg-stone-800 rounded text-xs" 
                                   max="${amount}" min="0" data-resource="${resource}">
                        </div>
                    `;
                    yourItems.appendChild(item);
                }
            });
            
            // Add inventory items
            gameState.inventory.forEach((item, index) => {
                if (item) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'trading-item p-2 bg-stone-700 rounded cursor-pointer';
                    itemDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span>${item.icon} ${item.name}</span>
                            <input type="checkbox" data-item-index="${index}">
                        </div>
                    `;
                    yourItems.appendChild(itemDiv);
                }
            });
        }

        async function createTradeOffer(toPlayerId, offerItems, requestItems) {
            if (!db) return;
            
            try {
                await addDoc(collection(db, 'tradeOffers'), {
                    fromPlayerId: userId,
                    fromPlayerName: gameState.player.name,
                    toPlayerId: toPlayerId,
                    offerItems: offerItems,
                    requestItems: requestItems,
                    status: 'open',
                    createdAt: serverTimestamp()
                });
                
                showNotification('Trade offer created!', 'success');
            } catch (error) {
                console.error('Failed to create trade offer:', error);
                showNotification('Failed to create trade offer', 'error');
            }
        }

        // === WORLD EVENTS ===
        async function createWorldEvent() {
            if (!db) return;
            
            const eventTemplate = STATIC_DATA.WORLD_EVENTS[Math.floor(Math.random() * STATIC_DATA.WORLD_EVENTS.length)];
            const position = getRandomPosition();
            
            const worldEvent = {
                ...eventTemplate,
                position: position,
                startTime: new Date(),
                endTime: new Date(Date.now() + eventTemplate.duration),
                participants: []
            };
            
            try {
                await addDoc(collection(db, 'worldEvents'), worldEvent);
                await sendWorldMessage(`World Event: ${eventTemplate.name} at ${position.x},${position.y}!`, 'event');
            } catch (error) {
                console.error('Failed to create world event:', error);
            }
        }

        // === WORLD CHAT ===
        async function sendWorldMessage(message, type = 'chat') {
            if (!db || !message.trim()) return;
            
            try {
                await addDoc(collection(db, 'worldChat'), {
                    playerId: userId,
                    playerName: gameState.player.name,
                    playerColor: gameState.player.color,
                    message: message.trim(),
                    type: type,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }

        function updateWorldChat(messages) {
            const chatContainer = document.getElementById('worldChatMessages');
            if (!chatContainer) return;
            
            chatContainer.innerHTML = messages.slice(-30).map(msg => {
                const time = msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString() : new Date().toLocaleTimeString();
                const colorClass = `player-color-${msg.playerColor || 'white'}`;
                
                if (msg.type === 'boss') {
                    return `<div class="text-red-400 font-bold">[${time}] 🏆 ${msg.message}</div>`;
                } else if (msg.type === 'event') {
                    return `<div class="text-purple-400 font-bold">[${time}] 🌟 ${msg.message}</div>`;
                } else {
                    return `<div>[${time}] <span class="${colorClass} font-semibold">${msg.playerName}:</span> ${msg.message}</div>`;
                }
            }).join('');
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // === NOTIFICATIONS & POPUPS ===
        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            }, duration);
        }

        function showDefeatPopup(message) {
            const popup = document.createElement('div');
            popup.className = 'defeat-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    document.body.removeChild(popup);
                }
            }, 4000);
        }

        function showQuotePopup(quote) {
            const popup = document.createElement('div');
            popup.className = 'quote-popup';
            popup.textContent = quote;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    document.body.removeChild(popup);
                }
            }, 6000);
        }

        // === UTILITY FUNCTIONS ===
        function generateId() {
            return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function getRandomPosition() {
            return {
                x: Math.floor(Math.random() * CONFIG.MAP_SIZE),
                y: Math.floor(Math.random() * CONFIG.MAP_SIZE)
            };
        }

        function weightedRandom(items, weights) {
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < items.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return items[i];
                }
            }
            return items[items.length - 1];
        }

        function addExperience(amount) {
            const houseBonus = gameState.player.house === 'atreides' ? 1.25 : 1;
            const finalAmount = Math.floor(amount * houseBonus);
            
            gameState.player.experience += finalAmount;
            
            while (gameState.player.experience >= gameState.player.experienceToNext) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.player.level++;
            gameState.player.experience -= gameState.player.experienceToNext;
            gameState.player.experienceToNext = Math.floor(CONFIG.XP_BASE * Math.pow(CONFIG.XP_FACTOR, gameState.player.level - 1));
            
            // Stat increases
            gameState.player.maxHealth += 15;
            gameState.player.health = gameState.player.maxHealth;
            gameState.player.maxEnergy += 8;
            gameState.player.energy = gameState.player.maxEnergy;
            gameState.player.attack += 4;
            gameState.player.defense += 3;
            
            showNotification(`🌟 LEVEL UP! Now level ${gameState.player.level}!`, 'legendary');
            
            // Check for building unlocks
            if (gameState.player.level === CONFIG.ENERGY_PRODUCTION_UNLOCK_LEVEL) {
                showNotification('🔓 Energy buildings unlocked!', 'info');
            }
        }

        function updateResources(changes) {
            Object.entries(changes).forEach(([resource, amount]) => {
                if (gameState.resources[resource] !== undefined) {
                    gameState.resources[resource] = Math.max(0, gameState.resources[resource] + amount);
                    
                    if (resource === 'spice' && amount > 0) {
                        gameState.player.lifetimeSpice += amount;
                    }
                }
            });
            updateResourceDisplay();
        }

        function addToInventory(item) {
            const emptySlot = gameState.inventory.findIndex(slot => slot === null);
            if (emptySlot === -1) {
                showNotification('Inventory full!', 'warning');
                return false;
            }
            
            gameState.inventory[emptySlot] = { ...item, id: generateId() };
            updateInventoryDisplay();
            return true;
        }

        function harvestResourceNode(resource) {
            if (gameState.player.energy < 20) {
                showNotification('Not enough energy!', 'error');
                return;
            }
            
            gameState.player.energy -= 20;
            const amount = Math.min(15, resource.amount);
            resource.amount -= amount;
            
            // House bonuses
            let finalAmount = amount;
            if (gameState.player.house === 'harkonnen') {
                finalAmount = Math.floor(amount * 1.2);
            } else if (gameState.player.house === 'fremen' && resource.type === 'spice') {
                finalAmount = Math.floor(amount * 1.4);
            }
            
            updateResources({ [resource.type]: finalAmount });
            
            if (resource.amount <= 0) {
                const key = `${resource.position.x},${resource.position.y}`;
                delete gameState.map.resources[key];
            }
            
            renderMap();
        }

        // === UI UPDATES ===
        function updateResourceDisplay() {
            Object.entries(gameState.resources).forEach(([resource, amount]) => {
                const element = document.getElementById(`resource${resource.charAt(0).toUpperCase() + resource.slice(1)}`);
                if (element) {
                    element.textContent = amount.toLocaleString();
                }
            });
        }

        function updatePlayerStats() {
            document.getElementById('statHealth').textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('statEnergy').textContent = `${gameState.player.energy}/${gameState.player.maxEnergy}`;
            document.getElementById('statLevel').textContent = gameState.player.level;
            document.getElementById('statExp').textContent = `${gameState.player.experience}/${gameState.player.experienceToNext}`;
            
            // Update progress bars
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const energyPercent = (gameState.player.energy / gameState.player.maxEnergy) * 100;
            const expPercent = (gameState.player.experience / gameState.player.experienceToNext) * 100;
            
            document.getElementById('barHealth').style.width = `${healthPercent}%`;
            document.getElementById('barEnergy').style.width = `${energyPercent}%`;
            document.getElementById('barExp').style.width = `${expPercent}%`;
            
            // Header displays
            document.getElementById('playerName').textContent = gameState.player.name;
            document.getElementById('playerPrestige').textContent = gameState.player.prestigeLevel;
            if (gameState.player.house) {
                const house = STATIC_DATA.HOUSES[gameState.player.house];
                document.getElementById('playerHouse').textContent = house.name;
            }
        }

        function updateInventoryDisplay() {
            const inventoryGrid = document.getElementById('uiInventoryGrid');
            if (!inventoryGrid) return;
            
            inventoryGrid.innerHTML = '';
            
            for (let i = 0; i < CONFIG.MAX_INVENTORY; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.dataset.index = i;
                
                const item = gameState.inventory[i];
                if (item) {
                    slot.textContent = item.icon || '📦';
                    slot.title = `${item.name}\n${item.description || ''}`;
                    
                    slot.addEventListener('click', () => {
                        if (item.type && ['weapon', 'armor', 'accessory'].includes(item.type)) {
                            equipItem(item, i);
                        }
                    });
                }
                
                inventoryGrid.appendChild(slot);
            }
        }

        function equipItem(item, inventoryIndex) {
            const equipSlot = item.type;
            const currentEquipped = gameState.equipment[equipSlot];
            
            if (currentEquipped) {
                gameState.inventory[inventoryIndex] = currentEquipped;
            } else {
                gameState.inventory[inventoryIndex] = null;
            }
            
            gameState.equipment[equipSlot] = item;
            
            showNotification(`Equipped ${item.name}`, 'success');
            updateInventoryDisplay();
            updateEquipmentDisplay();
        }

        function updateEquipmentDisplay() {
            ['weapon', 'armor', 'accessory'].forEach(type => {
                const element = document.getElementById(`equip${type.charAt(0).toUpperCase() + type.slice(1)}`);
                if (element) {
                    const item = gameState.equipment[type];
                    if (item) {
                        element.textContent = item.icon || '📦';
                        element.title = `${item.name}\n${item.description || ''}`;
                    } else {
                        element.textContent = '';
                        element.title = 'Empty';
                    }
                }
            });
        }

        function updateOnlinePlayersDisplay() {
            const playersList = document.getElementById('onlinePlayersList');
            if (!playersList) return;
            
            const players = Object.values(gameState.onlinePlayers).slice(0, 20);
            playersList.innerHTML = players.map(player => `
                <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                    <span class="player-color-${player.color} font-semibold">${player.name}</span>
                    <span class="text-xs text-stone-400">P${player.prestigeLevel || 0} Lv.${player.level}</span>
                </div>
            `).join('');
        }

        function updateWorldEventsDisplay() {
            const eventsContainer = document.getElementById('worldEventsContainer');
            if (!eventsContainer || !gameState.worldEvents.length) return;
            
            eventsContainer.innerHTML = gameState.worldEvents.map(event => {
                const timeLeft = Math.max(0, Math.floor((new Date(event.endTime.seconds * 1000) - Date.now()) / 1000));
                return `
                    <div class="bg-purple-800 p-3 rounded-lg border border-purple-600">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold">${event.icon} ${event.name}</span>
                            <span class="text-xs">${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}</span>
                        </div>
                        <p class="text-sm text-stone-300">${event.description}</p>
                        <p class="text-xs text-amber-400">Location: ${event.position.x},${event.position.y}</p>
                    </div>
                `;
            }).join('');
        }

        function updateTradeOffersDisplay() {
            const tradesContainer = document.getElementById('tradeOffersContainer');
            if (!tradesContainer) return;
            
            tradesContainer.innerHTML = gameState.tradeOffers.map(trade => `
                <div class="bg-stone-700 p-3 rounded border">
                    <div class="font-semibold">${trade.fromPlayerName} → You</div>
                    <div class="text-sm text-stone-300">Offering: ${JSON.stringify(trade.offerItems)}</div>
                    <div class="text-sm text-stone-300">Requesting: ${JSON.stringify(trade.requestItems)}</div>
                    <div class="mt-2 space-x-2">
                        <button class="px-3 py-1 bg-green-600 rounded text-xs" onclick="acceptTrade('${trade.id}')">Accept</button>
                        <button class="px-3 py-1 bg-red-600 rounded text-xs" onclick="rejectTrade('${trade.id}')">Reject</button>
                    </div>
                </div>
            `).join('');
        }

        function updateUI() {
            updateResourceDisplay();
            updatePlayerStats();
            updateInventoryDisplay();
            updateEquipmentDisplay();
            updateOnlinePlayersDisplay();
            updateWorldEventsDisplay();
            updateTradeOffersDisplay();
        }

        // === GAME LOOP ===
        function startGameLoop() {
            setInterval(() => {
                // Energy regeneration
                if (Date.now() - gameState.lastEnergyRegen >= CONFIG.ENERGY_REGEN_INTERVAL) {
                    const regenRate = gameState.player.energyProductionRate;
                    gameState.player.energy = Math.min(gameState.player.maxEnergy, gameState.player.energy + regenRate);
                    gameState.lastEnergyRegen = Date.now();
                }
                
                // Territory income
                if (gameState.player.territories?.length > 0) {
                    const income = gameState.player.territories.length * 5; // 5 solari per territory per loop
                    updateResources({ solari: income });
                }
                
                // Auto-save
                if (Date.now() - gameState.lastSaveTime >= CONFIG.SAVE_INTERVAL) {
                    saveGame();
                }
                
                updatePlayerStats();
            }, 1000);
            
            // Longer intervals
            setInterval(() => {
                // Create world events (only first player online to prevent spam)
                if (Math.random() < 0.1 && Object.keys(gameState.onlinePlayers).length < 5) {
                    createWorldEvent();
                }
                
                // Show random quote
                if (Math.random() < 0.05) {
                    const quote = DUNE_QUOTES[Math.floor(Math.random() * DUNE_QUOTES.length)];
                    showQuotePopup(`"${quote}"`);
                }
            }, 60000); // Every minute
        }

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    const tabId = button.dataset.tab + 'Tab';
                    document.getElementById(tabId)?.classList.remove('hidden');
                    
                    gameState.currentTab = button.dataset.tab;
                    
                    if (button.dataset.tab === 'game') {
                        renderMap();
                    }
                });
            });
            
            // Combat actions
            document.getElementById('combatActionAttack')?.addEventListener('click', () => combatAction('attack'));
            document.getElementById('combatActionDefend')?.addEventListener('click', () => combatAction('defend'));
            document.getElementById('combatActionFlee')?.addEventListener('click', () => combatAction('flee'));
            
            // Movement keys
            document.addEventListener('keydown', (e) => {
                if (gameState.combat.active) return;
                
                switch (e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        movePlayer(0, 1);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        movePlayer(1, 0);
                        break;
                    case ' ':
                        e.preventDefault();
                        // Harvest if on resource
                        const key = `${gameState.player.position.x},${gameState.player.position.y}`;
                        if (gameState.map?.resources?.[key]) {
                            harvestResourceNode(gameState.map.resources[key]);
                        }
                        break;
                }
            });
            
            // Chat functionality
            const chatInput = document.getElementById('worldChatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            
            if (chatInput && sendChatBtn) {
                const sendMessage = () => {
                    const message = chatInput.value.trim();
                    if (message) {
                        sendWorldMessage(message);
                        chatInput.value = '';
                    }
                };
                
                sendChatBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });

        // Global functions for onclick handlers
        window.combatAction = combatAction;
        window.movePlayer = movePlayer;
        window.showTradingModal = showTradingModal;
        window.purchaseTerritory = purchaseTerritory;
    </script>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-stone-950 text-white flex items-center justify-center z-[10000]">
        <div class="text-center">
            <div class="text-6xl font-orbitron text-amber-400 mb-6 prestige-glow">🏜️ ARRAKIS</div>
            <div class="text-3xl mb-4">Multiplayer Spice Empire</div>
            <div class="text-lg text-amber-300 mb-6">Connecting to the desert world...</div>
            <div class="flex items-center justify-center space-x-2">
                <div class="w-4 h-4 bg-amber-400 rounded-full animate-bounce"></div>
                <div class="w-4 h-4 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-4 h-4 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <div class="mt-8 text-stone-400 italic text-lg">"The spice must flow..."</div>
            <div class="mt-4 text-stone-500 text-sm">Join hundreds of players in the ultimate desert survival experience</div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="bg-gradient-to-r from-stone-800 to-stone-700 border-b-2 border-amber-500 px-6 py-4 fixed top-0 left-0 right-0 z-100 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <h1 class="text-4xl font-orbitron font-bold text-amber-400 prestige-glow">🏜️ Arrakis: Spice Empire</h1>
                <span class="text-lg text-amber-200 italic">"The Spice Must Flow"</span>
            </div>
            <div class="flex items-center space-x-8">
                <div class="text-sm">
                    <span class="text-stone-400">Player:</span>
                    <span id="playerName" class="font-bold text-amber-300">Loading...</span>
                </div>
                <div class="text-sm">
                    <span class="text-stone-400">House:</span>
                    <span id="playerHouse" class="font-semibold">None</span>
                </div>
                <div class="text-sm">
                    <span class="text-stone-400">Prestige:</span>
                    <span id="playerPrestige" class="font-bold text-purple-400 prestige-glow">0</span>
                </div>
                <button onclick="showTradingModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">🤝 Trade</button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-stone-800 border-b border-stone-600 px-6 fixed top-[88px] left-0 right-0 z-100">
        <div class="flex space-x-2">
            <button class="tab-button active px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="game">🏜️ Desert World</button>
            <button class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="character">👤 Character</button>
            <button class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="empire">🏗️ Empire</button>
            <button class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="multiplayer">🌍 Multiplayer</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex pt-[140px] h-screen">
        <!-- Left Sidebar -->
        <aside class="w-80 bg-gradient-to-b from-stone-800 to-stone-900 border-r-2 border-amber-600 flex flex-col p-4 space-y-4 overflow-y-auto shadow-lg">
            <!-- Resources -->
            <div class="bg-stone-700 p-4 rounded-lg border border-amber-500">
                <h3 class="text-lg font-semibold text-amber-400 mb-3 font-orbitron">📦 Empire Resources</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-amber-400 mr-2">✨</span>Spice:</span>
                        <span id="resourceSpice" class="font-mono text-amber-300 font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-orange-400 mr-2">🔥</span>Melange:</span>
                        <span id="resourceMelange" class="font-mono text-orange-300 font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-blue-400 mr-2">💧</span>Water:</span>
                        <span id="resourceWater" class="font-mono text-blue-300 font-bold">200</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-yellow-400 mr-2">💰</span>Solari:</span>
                        <span id="resourceSolari" class="font-mono text-yellow-300 font-bold">2000</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-gray-400 mr-2">🔧</span>Plasteel:</span>
                        <span id="resourcePlasteel" class="font-mono text-gray-300 font-bold">150</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-600 rounded">
                        <span class="flex items-center"><span class="text-purple-400 mr-2">💎</span>Rare Materials:</span>
                        <span id="resourceRareMaterials" class="font-mono text-purple-300 font-bold">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Character Stats -->
            <div class="bg-stone-700 p-4 rounded-lg border border-blue-500">
                <h3 class="text-lg font-semibold text-blue-400 mb-3 font-orbitron">⚡ Vital Stats</h3>
                <div class="space-y-3 text-sm">
                    <div class="p-2 bg-stone-600 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Health:</span>
                            <span id="statHealth" class="font-mono">120/120</span>
                        </div>
                        <div class="progress-bar-bg rounded h-3">
                            <div id="barHealth" class="progress-bar-fill h-full rounded" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="p-2 bg-stone-600 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Energy:</span>
                            <span id="statEnergy" class="font-mono">150/150</span>
                        </div>
                        <div class="progress-bar-bg rounded h-3">
                            <div id="barEnergy" class="bg-blue-500 h-full rounded" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="p-2 bg-stone-600 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Level <span id="statLevel" class="font-bold">1</span>:</span>
                            <span id="statExp" class="font-mono text-xs">0/100</span>
                        </div>
                        <div class="progress-bar-bg rounded h-3">
                            <div id="barExp" class="bg-purple-500 h-full rounded" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- World Events -->
            <div class="bg-purple-800 p-4 rounded-lg border border-purple-500">
                <h3 class="text-lg font-semibold text-purple-300 mb-3 font-orbitron">🌟 World Events</h3>
                <div id="worldEventsContainer" class="space-y-2 text-sm max-h-32 overflow-y-auto">
                    <p class="text-stone-400 text-center">No active events</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Game Tab -->
            <div id="gameTab" class="tab-content flex-1 p-6 overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-orbitron text-amber-400">🏜️ The Great Desert of Arrakis</h2>
                    <div class="text-lg text-stone-300">
                        Position: <span id="mapPlayerCoords" class="text-amber-300 font-bold">100,100</span>
                    </div>
                </div>
                
                <div class="mb-8 text-center">
                    <div class="text-sm text-stone-400 mb-4 p-3 bg-stone-800 rounded-lg border border-stone-600">
                        <span class="font-semibold text-amber-400">Controls:</span> 
                        WASD/Arrow Keys to move • Space to harvest • Click cells to interact/purchase territory • Auto-combat when moving onto enemies
                    </div>
                    <div id="uiMapGrid" class="map-grid mx-auto"></div>
                    <div class="mt-4 text-sm text-stone-400 flex flex-wrap justify-center gap-4">
                        <span class="flex items-center"><span class="text-amber-400 mr-1">👤</span> You</span>
                        <span class="flex items-center"><span class="text-purple-400 mr-1">👤</span> Other Players</span>
                        <span class="flex items-center"><span class="text-red-400 mr-1">👹</span> Enemies</span>
                        <span class="flex items-center"><span class="text-orange-400 mr-1">✨</span> Spice</span>
                        <span class="flex items-center"><span class="text-blue-400 mr-1">💧</span> Water</span>
                        <span class="flex items-center"><span class="text-purple-400 mr-1">🌟</span> World Events</span>
                        <span class="flex items-center"><span class="text-green-400 mr-1">⬜</span> Territory</span>
                    </div>
                </div>
            </div>
            
            <!-- Character Tab -->
            <div id="characterTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-3xl font-orbitron text-amber-400 mb-6">👤 Character Profile</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">Equipment</h3>
                        <div class="grid grid-cols-3 gap-4 text-center mb-6">
                            <div>
                                <div id="equipWeapon" class="inventory-slot mx-auto mb-2 w-16 h-16"></div>
                                <span class="text-sm font-semibold">Weapon</span>
                            </div>
                            <div>
                                <div id="equipArmor" class="inventory-slot mx-auto mb-2 w-16 h-16"></div>
                                <span class="text-sm font-semibold">Armor</span>
                            </div>
                            <div>
                                <div id="equipAccessory" class="inventory-slot mx-auto mb-2 w-16 h-16"></div>
                                <span class="text-sm font-semibold">Accessory</span>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">Inventory</h3>
                        <div id="uiInventoryGrid" class="grid grid-cols-8 gap-2"></div>
                        <p class="text-xs text-stone-400 mt-3">Click equipment items to equip them</p>
                    </div>
                    
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">Character Statistics</h3>
                        <div class="space-y-3 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <p class="flex justify-between">
                                    <span>Attack Power:</span>
                                    <span class="text-red-400 font-bold">15</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Defense Rating:</span>
                                    <span class="text-blue-400 font-bold">10</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Critical Chance:</span>
                                    <span class="text-yellow-400 font-bold">8%</span>
                                </p>
                                <p class="flex justify-between">
                                    <span>Dodge Chance:</span>
                                    <span class="text-green-400 font-bold">15%</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Empire Tab -->
            <div id="empireTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-3xl font-orbitron text-amber-400 mb-6">🏗️ Spice Empire Management</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Buildings will be populated here -->
                </div>
            </div>
            
            <!-- Multiplayer Tab -->
            <div id="multiplayerTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-3xl font-orbitron text-amber-400 mb-6">🌍 Multiplayer Hub</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- World Chat -->
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">💬 World Chat</h3>
                        <div id="worldChatMessages" class="chat-container p-3 mb-4 text-sm"></div>
                        <div class="flex space-x-2">
                            <input type="text" id="worldChatInput" placeholder="Type your message..." 
                                   class="flex-1 px-3 py-2 bg-stone-700 border border-stone-600 rounded text-white">
                            <button id="sendChatBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">Send</button>
                        </div>
                    </div>
                    
                    <!-- Online Players -->
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">👥 Online Players</h3>
                        <div id="onlinePlayersList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                    
                    <!-- Trade Offers -->
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">🤝 Trade Offers</h3>
                        <div id="tradeOffersContainer" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                    
                    <!-- Rankings -->
                    <div class="bg-stone-800 p-6 rounded-lg border border-stone-600">
                        <h3 class="text-xl font-semibold mb-4 text-amber-300">🏆 Rankings</h3>
                        <div id="rankingsContainer" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Combat Modal -->
    <div id="modalCombat" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-3xl">
            <h3 class="text-3xl font-orbitron text-red-500 mb-6 text-center">⚔️ DESERT COMBAT ⚔️</h3>
            
            <div class="grid grid-cols-2 gap-8 mb-6">
                <div class="bg-stone-700 p-4 rounded-lg">
                    <div class="flex justify-between items-baseline mb-3">
                        <span id="modalCombatPlayerName" class="font-bold text-green-400 text-lg">Player</span>
                        <span id="modalCombatPlayerLevel" class="text-sm text-stone-400">Lv.1</span>
                    </div>
                    <div class="text-sm mb-2">Health: <span id="modalCombatPlayerHealth">120/120</span></div>
                    <div class="progress-bar-bg rounded h-4 mb-3">
                        <div id="modalCombatPlayerHealthBar" class="progress-bar-fill h-full rounded" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="bg-stone-700 p-4 rounded-lg">
                    <div class="flex justify-between items-baseline mb-3">
                        <span id="modalCombatEnemyName" class="font-bold text-red-400 text-lg">Enemy</span>
                        <span id="modalCombatEnemyLevel" class="text-sm text-stone-400">Lv.1</span>
                    </div>
                    <div class="text-sm mb-2">Health: <span id="modalCombatEnemyHealth">50/50</span></div>
                    <div class="progress-bar-bg rounded h-4">
                        <div id="modalCombatEnemyHealthBar" class="bg-red-600 h-full rounded" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            
            <div id="modalCombatLog" class="bg-stone-900 rounded p-4 h-48 overflow-y-auto text-sm mb-6 border border-stone-600"></div>
            
            <div class="grid grid-cols-3 gap-4">
                <button id="combatActionAttack" class="py-4 bg-red-600 hover:bg-red-700 rounded font-bold text-lg">⚔️ Attack</button>
                <button id="combatActionDefend" class="py-4 bg-blue-600 hover:bg-blue-700 rounded font-bold text-lg">🛡️ Defend</button>
                <button id="combatActionFlee" class="py-4 bg-stone-600 hover:bg-stone-700 rounded font-bold text-lg">💨 Flee</button>
            </div>
        </div>
    </div>

</body>
</html>
