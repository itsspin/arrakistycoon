<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrakis: Spice Empire - Advanced MMO Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1c1917; color: #e5e7eb; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { border-bottom-color: #f59e0b; color: #f59e0b; background-color: #292524; }
        .progress-bar-bg { background-color: #3f3f46; }
        .progress-bar-fill { background-color: #f59e0b; transition: width 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #292524; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #71717a; }

        .map-grid { 
            display: grid; 
            grid-template-columns: repeat(15, 28px);
            gap: 0px;
            background-color: #0c0a09;
            border: 1px solid #44403c;
            margin: 0 auto;
        }
        .map-cell { 
            width: 28px; height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem; 
            font-weight: bold;
            border: 1px solid #292524;
            cursor: pointer;
            transition: background-color 0.1s, transform 0.1s;
            position: relative;
        }
        .map-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            border-color: #f59e0b !important;
        }
        .map-cell-unexplored { background-color: #0c0a09; color: #1c1917; }
        .map-cell-explored { background-color: #78350f; color: #eab308; }
        .map-cell-player { background-color: #facc15 !important; color: black !important; box-shadow: 0 0 8px #facc15; animation: pulse-player 2s infinite; }
        .map-cell-other-player { background-color: #8b5cf6 !important; color: white !important; }
        .map-cell-enemy { background-color: #ef4444 !important; color: white !important; }
        .map-cell-boss { background-color: #7e22ce !important; color: white !important; animation: pulse-boss 2s infinite alternate; }
        .map-cell-sandworm { background-color: #451a03 !important; color: #f59e0b !important; animation: sandworm-pulse 3s infinite; }
        .map-cell-resource-spice { background-color: #ea580c !important; color: #fed7aa !important; }
        .map-cell-resource-water { background-color: #0ea5e9 !important; color: white !important; }
        .map-cell-resource-plasteel { background-color: #64748b !important; color: white !important; }
        .map-cell-settlement { background-color: #16a34a !important; color: white !important; }
        .map-cell-ruins { background-color: #6b7280 !important; color: white !important; }
        .map-cell-sietch { background-color: #059669 !important; color: white !important; }
        .map-cell-player-base { border: 2px dashed #059669 !important; }

        @keyframes pulse-player { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes pulse-boss { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.5); } }
        @keyframes sandworm-pulse { 0%, 100% { box-shadow: 0 0 0 rgba(245, 158, 11, 0.7); } 50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.9); } }

        .notification {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            padding: 10px 15px; border-radius: 6px; color: white; font-weight: 500;
            transform: translateX(120%); opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            min-width: 250px; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .notification.show { transform: translateX(0); opacity: 1;}
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.warning { background-color: #f59e0b; color: #1c1917; }
        .notification.info { background-color: #3b82f6; }
        .notification.legendary { background: linear-gradient(45deg, #f59e0b, #ef4444); animation: shimmer 2s infinite; }
        .notification.sandworm { background: linear-gradient(45deg, #451a03, #f59e0b); animation: sandworm-notification 3s infinite; }

        @keyframes shimmer { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }
        @keyframes sandworm-notification { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.75); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #1c1917; border: 1px solid #44403c; border-radius: 8px; padding: 20px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .inventory-slot {
            width: 48px; height: 48px; border: 1px solid #44403c; background: #292524;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.1s; position: relative; border-radius: 4px;
            font-size: 1.2rem;
        }
        .inventory-slot:hover { border-color: #f59e0b; transform: scale(1.05); }

        .quest-item {
            background: linear-gradient(135deg, #292524, #1c1917);
            border-left: 4px solid #f59e0b;
            transition: all 0.2s;
        }
        .quest-item:hover { transform: translateX(5px); background: linear-gradient(135deg, #374151, #292524); }
        .quest-completed { border-left-color: #10b981; opacity: 0.7; }

        .achievement-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin: 1px;
        }
        .achievement-common { background-color: #6b7280; color: white; }
        .achievement-rare { background-color: #3b82f6; color: white; }
        .achievement-epic { background-color: #8b5cf6; color: white; }
        .achievement-legendary { background: linear-gradient(45deg, #f59e0b, #ef4444); color: white; }

        .house-atreides { border-color: #3b82f6; color: #3b82f6; }
        .house-harkonnen { border-color: #ef4444; color: #ef4444; }
        .house-fremen { border-color: #059669; color: #059669; }

        .prestige-glow {
            animation: prestige-pulse 3s infinite;
            text-shadow: 0 0 10px currentColor;
        }
        @keyframes prestige-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .spice-addiction-effect {
            animation: spice-vision 5s infinite;
        }
        @keyframes spice-vision { 0%, 100% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(30deg); } }

        .production-building {
            background: linear-gradient(135deg, #1f2937, #111827);
            border: 1px solid #374151;
            position: relative;
            overflow: hidden;
        }
        .production-building::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.1), transparent);
            transition: left 2s;
        }
        .production-building.producing::before {
            left: 100%;
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-300 antialiased">

    <script type="module">
        // === FIREBASE CONFIGURATION ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, limit, updateDoc, increment, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGX_Xu3WR6hd2bSrJFqC7Q9Y_example", // Replace with actual config
            authDomain: "arrakis-tycoon.firebaseapp.com",
            projectId: "arrakis-tycoon",
            storageBucket: "arrakis-tycoon.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        // For demo purposes, we'll use localStorage as backup
        const USE_FIREBASE = false; // Set to true when you have Firebase configured

        let app, auth, db, userId;

        // === GAME CONSTANTS ===
        const CONFIG = {
            MAP_SIZE: 200,
            VIEW_RADIUS: 7,
            MAX_INVENTORY: 30,
            ENERGY_REGEN_RATE: 2,
            ENERGY_REGEN_INTERVAL: 3000,
            SAVE_INTERVAL: 15000,
            XP_BASE: 100,
            XP_FACTOR: 1.4,
            SPICE_BASE_PRICE: 5,
            WATER_CONSUMPTION_MOVE: 1,
            INITIAL_RESOURCES: { spice: 0, water: 150, solari: 1000, plasteel: 100, rareMaterials: 0, melange: 0 },
            PRESTIGE_COST_BASE: 1000000, // 1 million spice for first prestige
            PRESTIGE_BONUS_PER_LEVEL: 0.1, // 10% bonus per prestige level
            SPICE_ADDICTION_THRESHOLD: 1000,
            SANDWORM_ENCOUNTER_CHANCE: 0.001,
            MAX_PRESTIGE_LEVEL: 50
        };

        const STATIC_DATA = {
            HOUSES: {
                atreides: { name: "House Atreides", color: "house-atreides", bonus: "leadership", description: "+20% XP gain, +10% unit effectiveness" },
                harkonnen: { name: "House Harkonnen", color: "house-harkonnen", bonus: "brutality", description: "+25% attack damage, +15% resource extraction" },
                fremen: { name: "Fremen", color: "house-fremen", bonus: "desert", description: "-50% water consumption, +30% spice finding, immune to sandworms" }
            },
            RANKS: [
                { name: 'Desert Rat', minPower: 0, color: 'text-stone-400' },
                { name: 'Spice Hunter', minPower: 1000, color: 'text-amber-400' },
                { name: 'Fremen Warrior', minPower: 5000, color: 'text-lime-400' },
                { name: 'House Guard', minPower: 15000, color: 'text-emerald-400' },
                { name: 'Mentat', minPower: 40000, color: 'text-teal-400' },
                { name: 'Swordmaster', minPower: 100000, color: 'text-cyan-400' },
                { name: 'Baron', minPower: 250000, color: 'text-sky-400' },
                { name: 'Duke', minPower: 500000, color: 'text-blue-400' },
                { name: 'Padishah Emperor', minPower: 1000000, color: 'text-indigo-400' },
                { name: 'Kwisatz Haderach', minPower: 2500000, color: 'text-violet-400 prestige-glow' },
                { name: 'God Emperor', minPower: 10000000, color: 'text-purple-400 prestige-glow font-bold' }
            ],
            BUILDINGS: {
                spiceRefinery: { 
                    name: "Spice Refinery", icon: "🏭", maxLevel: 20, 
                    baseCost: { solari: 500, plasteel: 30 }, costFactor: 1.6,
                    production: { type: 'process', input: 'spice', output: 'melange', ratio: 0.1 },
                    description: "Converts raw spice into pure melange. Higher levels increase efficiency."
                },
                shieldWall: { 
                    name: "Shield Wall", icon: "🛡️", maxLevel: 25, 
                    baseCost: { solari: 800, plasteel: 80 }, costFactor: 1.8,
                    effect: 'defense', description: "Protects your base from raids and sandworm attacks."
                },
                stillsuit: { 
                    name: "Stillsuit Factory", icon: "💧", maxLevel: 15, 
                    baseCost: { solari: 300, plasteel: 20 }, costFactor: 1.5,
                    production: { type: 'generate', output: 'water', rate: 0.5 },
                    description: "Produces water through moisture reclamation technology."
                },
                harvestor: { 
                    name: "Spice Harvestor", icon: "⛏️", maxLevel: 30, 
                    baseCost: { solari: 1200, plasteel: 100 }, costFactor: 1.7,
                    production: { type: 'generate', output: 'spice', rate: 2 },
                    description: "Automated spice extraction. The backbone of your empire."
                },
                bank: { 
                    name: "CHOAM Bank", icon: "🏦", maxLevel: 10, 
                    baseCost: { solari: 2000, plasteel: 50 }, costFactor: 2.0,
                    effect: 'interest', description: "Generates passive Solari income and protects wealth."
                },
                researchLab: { 
                    name: "Mentat School", icon: "🧠", maxLevel: 15, 
                    baseCost: { solari: 1500, plasteel: 200, melange: 10 }, costFactor: 2.2,
                    effect: 'research', description: "Unlocks advanced technologies and abilities."
                },
                market: { 
                    name: "Spice Exchange", icon: "📈", maxLevel: 12, 
                    baseCost: { solari: 800, plasteel: 40 }, costFactor: 1.9,
                    effect: 'trading', description: "Improves trade prices and unlocks new markets."
                },
                sietchTabr: {
                    name: "Sietch Tabr", icon: "🏔️", maxLevel: 5,
                    baseCost: { solari: 5000, water: 1000, melange: 50 }, costFactor: 3.0,
                    effect: 'prestige', description: "Sacred Fremen stronghold. Required for prestige."
                }
            },
            ABILITIES: {
                sandstorm: { 
                    name: "Sandstorm", icon: "🌪️", energyCost: 25, cooldown: 45000, 
                    damage: 40, type: 'aoe', unlock: 5,
                    description: "Call upon the desert winds to devastate enemies."
                },
                crysknife: { 
                    name: "Crysknife Strike", icon: "🗡️", energyCost: 20, cooldown: 30000, 
                    damage: 60, type: 'single', critBonus: 100, unlock: 3,
                    description: "Sacred blade of the Fremen. Deadly precision strike."
                },
                shield: { 
                    name: "Holtzman Shield", icon: "🔰", energyCost: 15, cooldown: 25000, 
                    defense: 50, type: 'defense', unlock: 7,
                    description: "Personal shield technology. Deflects fast attacks."
                },
                waterOfLife: { 
                    name: "Water of Life", icon: "💙", energyCost: 40, cooldown: 60000, 
                    heal: 80, type: 'heal', unlock: 10,
                    description: "Sacred spice essence. Grants visions and healing."
                },
                prescience: {
                    name: "Prescience", icon: "👁️", energyCost: 50, cooldown: 120000,
                    effect: 'foresight', type: 'utility', unlock: 15,
                    description: "See into possible futures. Reveals map and enemy locations."
                },
                voiceCommand: {
                    name: "Voice Command", icon: "🗣️", energyCost: 35, cooldown: 90000,
                    effect: 'control', type: 'utility', unlock: 12,
                    description: "Bene Gesserit voice. Forces enemies to flee."
                }
            },
            ENEMIES: {
                sandRaider: { 
                    name: "Fremen Raider", icon: "🏹", health: 80, attack: 15, defense: 8, 
                    xp: 35, loot: { solari: 25, spice: 8, water: 5 }, level: 1,
                    description: "Desert nomad seeking spice and water."
                },
                harkonnenGuard: { 
                    name: "Harkonnen Guard", icon: "👤", health: 120, attack: 22, defense: 12, 
                    xp: 60, loot: { solari: 45, plasteel: 5, rareMaterials: 1 }, level: 3,
                    description: "Brutal enforcer of Baron Harkonnen."
                },
                sardaukar: { 
                    name: "Sardaukar Elite", icon: "⚔️", health: 200, attack: 35, defense: 18, 
                    xp: 120, loot: { solari: 100, rareMaterials: 3, melange: 2 }, level: 6,
                    description: "Imperial super-soldier. Extremely dangerous."
                },
                beastRabban: { 
                    name: "Beast Rabban", icon: "👹", health: 500, attack: 60, defense: 30, 
                    xp: 300, loot: { solari: 800, spice: 100, rareMaterials: 10, melange: 5 }, 
                    boss: true, level: 10, description: "Harkonnen na-Baron. Ruthless and brutal."
                },
                baronHarkonnen: {
                    name: "Baron Vladimir Harkonnen", icon: "🦹", health: 1000, attack: 80, defense: 40,
                    xp: 600, loot: { solari: 2000, spice: 250, rareMaterials: 25, melange: 15 },
                    boss: true, level: 20, description: "The Baron himself. Master of schemes."
                },
                sandworm: {
                    name: "Shai-Hulud", icon: "🐛", health: 2000, attack: 150, defense: 60,
                    xp: 1000, loot: { spice: 500, melange: 50, rareMaterials: 50 },
                    boss: true, level: 30, legendary: true, description: "The Great Sandworm. Maker of spice."
                }
            },
            ITEMS: {
                crysknife: { name: "Crysknife", icon: "🗡️", type: "weapon", attack: 25, rarity: "legendary", description: "Sacred Fremen blade made from sandworm tooth." },
                maula: { name: "Maula Pistol", icon: "🔫", type: "weapon", attack: 18, rarity: "rare", description: "Spring-loaded dart gun used in shield combat." },
                stillsuit: { name: "Stillsuit", icon: "🥽", type: "armor", defense: 15, rarity: "uncommon", description: "Desert survival suit that recycles body moisture." },
                shieldBelt: { name: "Shield Belt", icon: "🔘", type: "accessory", defense: 20, rarity: "epic", description: "Personal force field generator." },
                fremkit: { name: "Fremen Survival Kit", icon: "🎒", type: "accessory", special: "desert", rarity: "rare", description: "Essential tools for desert survival." },
                spiceLens: { name: "Spice Lens", icon: "🔍", type: "accessory", special: "detection", rarity: "epic", description: "Reveals hidden spice deposits." },
                choamRing: { name: "CHOAM Signet", icon: "💍", type: "accessory", special: "trading", rarity: "legendary", description: "Grants access to exclusive markets." }
            },
            QUESTS: [
                {
                    id: 'first_harvest',
                    name: 'First Steps on Arrakis',
                    description: 'Harvest 50 spice to establish your presence on the desert planet.',
                    type: 'collection',
                    target: { spice: 50 },
                    rewards: { xp: 100, solari: 200, water: 50 },
                    chain: 'tutorial',
                    lore: "The spice melange is the most valuable substance in the universe. Your survival depends on it."
                },
                {
                    id: 'build_refinery',
                    name: 'The Spice Must Flow',
                    description: 'Build your first Spice Refinery to process raw spice into pure melange.',
                    type: 'building',
                    target: { spiceRefinery: 1 },
                    rewards: { xp: 200, solari: 500, melange: 10 },
                    chain: 'tutorial',
                    requires: 'first_harvest',
                    lore: "He who controls the spice, controls the universe. - Baron Harkonnen"
                },
                {
                    id: 'defeat_raiders',
                    name: 'Desert Conflict',
                    description: 'Defeat 10 Fremen Raiders to secure your territory.',
                    type: 'combat',
                    target: { sandRaider: 10 },
                    rewards: { xp: 300, solari: 300, crysknife: 1 },
                    chain: 'combat',
                    lore: "The desert makes men strong. Prove your strength against the Fremen."
                },
                {
                    id: 'water_wisdom',
                    name: 'Water Discipline',
                    description: 'Survive in the desert by managing your water consumption. Travel 100 tiles.',
                    type: 'exploration',
                    target: { movement: 100 },
                    rewards: { xp: 150, water: 200, stillsuit: 1 },
                    chain: 'survival',
                    lore: "Water is life. Every drop is precious on Arrakis."
                },
                {
                    id: 'choose_house',
                    name: 'Allegiance',
                    description: 'Choose your allegiance: Atreides, Harkonnen, or Fremen.',
                    type: 'choice',
                    rewards: { xp: 250, solari: 1000 },
                    chain: 'politics',
                    lore: "In the game of houses, you must choose a side to survive."
                },
                {
                    id: 'spice_addiction',
                    name: 'The Spice Agony',
                    description: 'Consume 1000 spice to unlock enhanced abilities.',
                    type: 'consumption',
                    target: { spice_consumed: 1000 },
                    rewards: { xp: 500, ability: 'prescience' },
                    chain: 'transcendence',
                    dangerous: true,
                    lore: "The spice extends life, expands consciousness... but at what cost?"
                },
                {
                    id: 'sandworm_encounter',
                    name: 'Shai-Hulud',
                    description: 'Survive an encounter with the great sandworm.',
                    type: 'survival',
                    target: { sandworm_survived: 1 },
                    rewards: { xp: 1000, melange: 100, prestige: 1 },
                    chain: 'legendary',
                    lore: "Bless the Maker and His water. Bless the coming and going of Him."
                },
                {
                    id: 'first_prestige',
                    name: 'Transcendence',
                    description: 'Accumulate enough power to transcend and begin anew with enhanced abilities.',
                    type: 'prestige',
                    target: { prestige_ready: true },
                    rewards: { prestige_level: 1 },
                    chain: 'ascension',
                    lore: "Some say the spice grants immortality. You are about to find out."
                }
            ]
        };

        // === GAME STATE ===
        let gameState = {
            player: {
                id: null, name: "Desert Walker", level: 1, experience: 0, experienceToNext: 100,
                health: 120, maxHealth: 120, energy: 150, maxEnergy: 150,
                attack: 12, defense: 8, critChance: 5, dodgeChance: 12,
                position: { x: 100, y: 100 }, basePosition: { x: 100, y: 100 },
                house: null, rank: 'Desert Rat', power: 0, prestigeLevel: 0,
                abilities: [], selectedAbilities: [null, null, null],
                spiceConsumed: 0, sandwormsSurvived: 0, movementCount: 0,
                totalSpiceCollected: 0, totalEnemiesDefeated: 0,
                lifetimeSpice: 0, lifetimeSolari: 0, lifetimeXP: 0
            },
            resources: { ...CONFIG.INITIAL_RESOURCES },
            equipment: { weapon: null, armor: null, accessory: null },
            inventory: new Array(CONFIG.MAX_INVENTORY).fill(null),
            buildings: {},
            productionRates: {},
            map: {
                viewRadius: CONFIG.VIEW_RADIUS,
                explored: {},
                enemies: {},
                resources: {},
                players: {},
                sandworms: {}
            },
            quests: {
                active: [],
                completed: [],
                available: [...STATIC_DATA.QUESTS]
            },
            achievements: [],
            combat: { active: false, enemy: null, turn: 'player', log: [] },
            isLoading: true,
            gameInitialized: false,
            currentTab: 'game',
            abilityCooldowns: {},
            lastSaveTime: 0,
            lastEnergyRegen: Date.now(),
            lastProduction: Date.now(),
            gameLog: [],
            settings: {
                autoSave: true,
                notifications: true,
                combatAnimations: true
            }
        };

        // === FIREBASE INTEGRATION ===
        async function initializeFirebase() {
            if (!USE_FIREBASE) {
                // Use localStorage for demo
                userId = localStorage.getItem('arrakis_user_id') || generateId();
                localStorage.setItem('arrakis_user_id', userId);
                gameState.player.id = userId;
                loadGameFromStorage();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        gameState.player.id = userId;
                        loadGameFromFirebase();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Fallback to localStorage
                userId = localStorage.getItem('arrakis_user_id') || generateId();
                localStorage.setItem('arrakis_user_id', userId);
                gameState.player.id = userId;
                loadGameFromStorage();
            }
        }

        async function saveGameToFirebase() {
            if (!USE_FIREBASE || !db || !userId) return;
            
            try {
                const saveData = {
                    player: gameState.player,
                    resources: gameState.resources,
                    equipment: gameState.equipment,
                    inventory: gameState.inventory,
                    buildings: gameState.buildings,
                    quests: gameState.quests,
                    achievements: gameState.achievements,
                    lastSave: serverTimestamp()
                };
                
                await setDoc(doc(db, 'players', userId), saveData);
                logEvent('Game saved to cloud');
            } catch (error) {
                console.error('Failed to save to Firebase:', error);
                saveGameToStorage(); // Fallback
            }
        }

        async function loadGameFromFirebase() {
            if (!USE_FIREBASE || !db || !userId) return;
            
            try {
                const docRef = doc(db, 'players', userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    Object.assign(gameState.player, data.player);
                    Object.assign(gameState.resources, data.resources);
                    Object.assign(gameState.equipment, data.equipment);
                    gameState.inventory = data.inventory || new Array(CONFIG.MAX_INVENTORY).fill(null);
                    gameState.buildings = data.buildings || {};
                    gameState.quests = data.quests || { active: [], completed: [], available: [...STATIC_DATA.QUESTS] };
                    gameState.achievements = data.achievements || [];
                    
                    logEvent('Game loaded from cloud');
                } else {
                    logEvent('New player - starting fresh');
                }
                
                initializeGameAfterLoad();
            } catch (error) {
                console.error('Failed to load from Firebase:', error);
                loadGameFromStorage(); // Fallback
            }
        }

        function saveGameToStorage() {
            const saveData = {
                player: gameState.player,
                resources: gameState.resources,
                equipment: gameState.equipment,
                inventory: gameState.inventory,
                buildings: gameState.buildings,
                quests: gameState.quests,
                achievements: gameState.achievements,
                lastSave: Date.now()
            };
            
            localStorage.setItem('arrakis_save_' + userId, JSON.stringify(saveData));
            logEvent('Game saved locally');
        }

        function loadGameFromStorage() {
            const saveData = localStorage.getItem('arrakis_save_' + userId);
            
            if (saveData) {
                try {
                    const data = JSON.parse(saveData);
                    Object.assign(gameState.player, data.player);
                    Object.assign(gameState.resources, data.resources);
                    Object.assign(gameState.equipment, data.equipment);
                    gameState.inventory = data.inventory || new Array(CONFIG.MAX_INVENTORY).fill(null);
                    gameState.buildings = data.buildings || {};
                    gameState.quests = data.quests || { active: [], completed: [], available: [...STATIC_DATA.QUESTS] };
                    gameState.achievements = data.achievements || [];
                    
                    logEvent('Game loaded from local storage');
                } catch (error) {
                    console.error('Failed to load save data:', error);
                    logEvent('Save data corrupted - starting fresh');
                }
            } else {
                logEvent('New player - welcome to Arrakis!');
            }
            
            initializeGameAfterLoad();
        }

        // === UTILITY FUNCTIONS ===
        function generateId() {
            return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function getRandomPosition() {
            return {
                x: Math.floor(Math.random() * CONFIG.MAP_SIZE),
                y: Math.floor(Math.random() * CONFIG.MAP_SIZE)
            };
        }

        function calculateDistance(pos1, pos2) {
            return Math.abs(pos1.x - pos2.x) + Math.abs(pos1.y - pos2.y);
        }

        function applyPrestigeBonus(baseValue, type = 'general') {
            const prestigeLevel = gameState.player.prestigeLevel || 0;
            let bonus = prestigeLevel * CONFIG.PRESTIGE_BONUS_PER_LEVEL;
            
            // House specific bonuses
            if (gameState.player.house === 'harkonnen' && type === 'extraction') {
                bonus += 0.15;
            } else if (gameState.player.house === 'atreides' && type === 'xp') {
                bonus += 0.20;
            } else if (gameState.player.house === 'fremen' && type === 'spice') {
                bonus += 0.30;
            }
            
            return Math.floor(baseValue * (1 + bonus));
        }

        function calculatePlayerPower() {
            let power = gameState.player.level * 50;
            power += gameState.player.attack * 10;
            power += gameState.player.defense * 8;
            power += gameState.player.prestigeLevel * 10000;
            
            // Equipment bonuses
            Object.values(gameState.equipment).forEach(item => {
                if (item) {
                    power += (item.attack || 0) * 15;
                    power += (item.defense || 0) * 12;
                    if (item.rarity === 'legendary') power += 1000;
                    else if (item.rarity === 'epic') power += 500;
                    else if (item.rarity === 'rare') power += 200;
                }
            });

            // Building bonuses
            Object.entries(gameState.buildings).forEach(([type, level]) => {
                power += level * 100;
                if (type === 'sietchTabr') power += level * 5000;
            });

            // Resource wealth
            power += Math.floor(gameState.resources.melange * 10);
            power += Math.floor(gameState.resources.solari / 100);
            power += Math.floor(gameState.resources.rareMaterials * 50);

            gameState.player.power = Math.floor(power);
            return power;
        }

        function updatePlayerRank() {
            const power = calculatePlayerPower();
            const ranks = STATIC_DATA.RANKS;
            
            for (let i = ranks.length - 1; i >= 0; i--) {
                if (power >= ranks[i].minPower) {
                    if (gameState.player.rank !== ranks[i].name) {
                        gameState.player.rank = ranks[i].name;
                        showNotification(`Rank Up! You are now ${ranks[i].name}!`, 'legendary');
                        logEvent(`🌟 Achieved rank: ${ranks[i].name}`);
                    }
                    break;
                }
            }
        }

        function calculateXPNeeded(level) {
            return Math.floor(CONFIG.XP_BASE * Math.pow(CONFIG.XP_FACTOR, level - 1));
        }

        function addExperience(amount) {
            const bonusAmount = applyPrestigeBonus(amount, 'xp');
            gameState.player.experience += bonusAmount;
            gameState.player.lifetimeXP += bonusAmount;
            
            if (bonusAmount > amount) {
                logEvent(`Gained ${bonusAmount} XP! (+${bonusAmount - amount} prestige bonus)`);
            } else {
                logEvent(`Gained ${bonusAmount} XP!`);
            }
            
            while (gameState.player.experience >= gameState.player.experienceToNext) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.player.level++;
            gameState.player.experience -= gameState.player.experienceToNext;
            gameState.player.experienceToNext = calculateXPNeeded(gameState.player.level + 1);
            
            // Stat increases with house bonuses
            const healthBonus = gameState.player.house === 'atreides' ? 15 : 12;
            const energyBonus = gameState.player.house === 'fremen' ? 8 : 6;
            
            gameState.player.maxHealth += healthBonus;
            gameState.player.health = gameState.player.maxHealth;
            gameState.player.maxEnergy += energyBonus;
            gameState.player.energy = gameState.player.maxEnergy;
            gameState.player.attack += 3;
            gameState.player.defense += 2;

            logEvent(`🌟 LEVEL UP! You are now level ${gameState.player.level}!`);
            showNotification(`Level Up! Now level ${gameState.player.level}`, 'legendary');
            
            // Check for ability unlocks
            checkAbilityUnlocks();
            updatePlayerRank();
            checkQuestProgress();
        }

        function checkAbilityUnlocks() {
            Object.entries(STATIC_DATA.ABILITIES).forEach(([abilityId, ability]) => {
                if (ability.unlock <= gameState.player.level && !gameState.player.abilities.includes(abilityId)) {
                    gameState.player.abilities.push(abilityId);
                    showNotification(`New Ability Unlocked: ${ability.name}!`, 'legendary');
                    logEvent(`🌟 Unlocked ability: ${ability.name}`);
                }
            });
        }

        function logEvent(message) {
            const timestamp = new Date().toLocaleTimeString();
            gameState.gameLog.unshift(`[${timestamp}] ${message}`);
            if (gameState.gameLog.length > 100) gameState.gameLog.pop();
            updateGameLog();
        }

        function showNotification(message, type = 'info', duration = 4000) {
            if (!gameState.settings.notifications) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            const container = document.getElementById('notificationContainer') || document.body;
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 400);
            }, duration);
        }

        // === RESOURCE MANAGEMENT ===
        function updateResources(changes) {
            Object.entries(changes).forEach(([resource, amount]) => {
                if (gameState.resources[resource] !== undefined) {
                    const oldAmount = gameState.resources[resource];
                    gameState.resources[resource] = Math.max(0, oldAmount + amount);
                    
                    // Track lifetime stats
                    if (amount > 0) {
                        if (resource === 'spice') {
                            gameState.player.totalSpiceCollected += amount;
                            gameState.player.lifetimeSpice += amount;
                        } else if (resource === 'solari') {
                            gameState.player.lifetimeSolari += amount;
                        }
                    }
                }
            });
            updateResourceDisplay();
            checkQuestProgress();
        }

        function canAfford(costs) {
            return Object.entries(costs).every(([resource, amount]) => 
                gameState.resources[resource] >= amount
            );
        }

        function spendResources(costs) {
            if (!canAfford(costs)) return false;
            Object.entries(costs).forEach(([resource, amount]) => {
                gameState.resources[resource] -= amount;
            });
            updateResourceDisplay();
            return true;
        }

        function processProduction() {
            const now = Date.now();
            const timeDiff = (now - gameState.lastProduction) / 1000; // seconds
            
            Object.entries(gameState.buildings).forEach(([buildingType, level]) => {
                if (level <= 0) return;
                
                const building = STATIC_DATA.BUILDINGS[buildingType];
                if (building.production) {
                    const production = building.production;
                    const rate = production.rate * level * timeDiff;
                    
                    if (production.type === 'generate') {
                        const bonusRate = applyPrestigeBonus(rate, 'extraction');
                        updateResources({ [production.output]: bonusRate });
                        
                        // Visual effect
                        const buildingElement = document.querySelector(`[data-building="${buildingType}"]`);
                        if (buildingElement) {
                            buildingElement.classList.add('producing');
                            setTimeout(() => buildingElement.classList.remove('producing'), 2000);
                        }
                    } else if (production.type === 'process') {
                        const inputAvailable = gameState.resources[production.input];
                        const canProcess = Math.min(inputAvailable, rate);
                        if (canProcess > 0) {
                            const output = canProcess * production.ratio;
                            updateResources({ 
                                [production.input]: -canProcess,
                                [production.output]: output 
                            });
                        }
                    }
                }
                
                // Bank interest
                if (buildingType === 'bank') {
                    const interest = Math.floor(gameState.resources.solari * 0.0001 * level * timeDiff);
                    if (interest > 0) {
                        updateResources({ solari: interest });
                    }
                }
            });
            
            gameState.lastProduction = now;
        }

        function harvestResource(type) {
            const energyCosts = { spice: 8, water: 12, plasteel: 15, rareMaterials: 25 };
            const baseAmounts = { spice: 5, water: 8, plasteel: 3, rareMaterials: 1 };
            
            const energyCost = energyCosts[type] || 8;
            let baseAmount = baseAmounts[type] || 1;
            
            if (gameState.player.energy < energyCost) {
                showNotification('Not enough energy!', 'error');
                return;
            }

            // House bonuses
            if (gameState.player.house === 'fremen' && type === 'spice') {
                baseAmount = Math.floor(baseAmount * 1.3);
            } else if (gameState.player.house === 'harkonnen') {
                baseAmount = Math.floor(baseAmount * 1.15);
            }

            gameState.player.energy -= energyCost;
            const amount = applyPrestigeBonus(baseAmount + Math.floor(gameState.player.level / 3), 'extraction');
            updateResources({ [type]: amount });
            
            logEvent(`Harvested ${amount} ${type}`);
            showNotification(`+${amount} ${type.charAt(0).toUpperCase() + type.slice(1)}`, 'success');
            
            // Spice addiction tracking
            if (type === 'spice') {
                gameState.player.spiceConsumed += Math.floor(amount * 0.1); // Passive consumption
                checkSpiceAddiction();
            }
            
            checkQuestProgress();
        }

        function checkSpiceAddiction() {
            if (gameState.player.spiceConsumed >= CONFIG.SPICE_ADDICTION_THRESHOLD) {
                document.body.classList.add('spice-addiction-effect');
                if (gameState.player.spiceConsumed === CONFIG.SPICE_ADDICTION_THRESHOLD) {
                    showNotification('The spice... you feel its power coursing through you...', 'warning', 6000);
                    logEvent('🔥 You have developed spice addiction - reality seems... different');
                    
                    // Unlock spice-related abilities earlier
                    if (!gameState.player.abilities.includes('prescience')) {
                        gameState.player.abilities.push('prescience');
                        showNotification('Spice Vision Unlocked: Prescience!', 'legendary');
                    }
                }
            } else {
                document.body.classList.remove('spice-addiction-effect');
            }
        }

        // === QUEST SYSTEM ===
        function checkQuestProgress() {
            gameState.quests.active.forEach(quest => {
                if (quest.completed) return;
                
                let completed = false;
                
                switch (quest.type) {
                    case 'collection':
                        completed = Object.entries(quest.target).every(([resource, amount]) => 
                            gameState.player.totalSpiceCollected >= amount || gameState.resources[resource] >= amount
                        );
                        break;
                    case 'building':
                        completed = Object.entries(quest.target).every(([building, level]) => 
                            (gameState.buildings[building] || 0) >= level
                        );
                        break;
                    case 'combat':
                        completed = Object.entries(quest.target).every(([enemy, count]) => 
                            gameState.player.totalEnemiesDefeated >= count
                        );
                        break;
                    case 'exploration':
                        completed = Object.entries(quest.target).every(([stat, amount]) => 
                            gameState.player.movementCount >= amount
                        );
                        break;
                    case 'consumption':
                        completed = gameState.player.spiceConsumed >= quest.target.spice_consumed;
                        break;
                    case 'survival':
                        completed = gameState.player.sandwormsSurvived >= (quest.target.sandworm_survived || 0);
                        break;
                    case 'prestige':
                        completed = canPrestige();
                        break;
                }
                
                if (completed && !quest.completed) {
                    completeQuest(quest);
                }
            });
            
            // Check for new available quests
            gameState.quests.available.forEach(quest => {
                if (quest.requires && !gameState.quests.completed.includes(quest.requires)) return;
                if (gameState.quests.active.includes(quest) || gameState.quests.completed.includes(quest.id)) return;
                
                gameState.quests.active.push(quest);
                gameState.quests.available = gameState.quests.available.filter(q => q.id !== quest.id);
                showNotification(`New Quest: ${quest.name}`, 'info');
                logEvent(`📜 New quest available: ${quest.name}`);
            });
        }

        function completeQuest(quest) {
            quest.completed = true;
            gameState.quests.completed.push(quest.id);
            
            // Give rewards
            if (quest.rewards) {
                Object.entries(quest.rewards).forEach(([reward, amount]) => {
                    if (reward === 'xp') {
                        addExperience(amount);
                    } else if (gameState.resources[reward] !== undefined) {
                        updateResources({ [reward]: amount });
                    } else if (reward === 'ability') {
                        if (!gameState.player.abilities.includes(amount)) {
                            gameState.player.abilities.push(amount);
                            showNotification(`Ability Unlocked: ${STATIC_DATA.ABILITIES[amount].name}!`, 'legendary');
                        }
                    } else if (STATIC_DATA.ITEMS[reward]) {
                        addToInventory(STATIC_DATA.ITEMS[reward]);
                    } else if (reward === 'prestige_level') {
                        gameState.player.prestigeLevel += amount;
                    }
                });
            }
            
            showNotification(`Quest Completed: ${quest.name}!`, 'legendary', 6000);
            logEvent(`🎉 Quest completed: ${quest.name}`);
            
            if (quest.lore) {
                setTimeout(() => {
                    showNotification(`"${quest.lore}"`, 'info', 8000);
                }, 2000);
            }
            
            updateQuestDisplay();
        }

        // === PRESTIGE SYSTEM ===
        function canPrestige() {
            return gameState.player.lifetimeSpice >= CONFIG.PRESTIGE_COST_BASE * Math.pow(2, gameState.player.prestigeLevel) &&
                   gameState.buildings.sietchTabr >= 1 &&
                   gameState.player.level >= 25;
        }

        function performPrestige() {
            if (!canPrestige()) {
                showNotification('Prestige requirements not met!', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to prestige? This will reset your progress but grant permanent bonuses.\n\nCurrent Prestige Level: ${gameState.player.prestigeLevel}\nNext Level Bonus: +${(CONFIG.PRESTIGE_BONUS_PER_LEVEL * 100).toFixed(1)}%`)) {
                return;
            }
            
            // Store lifetime stats
            const lifetimeStats = {
                spice: gameState.player.lifetimeSpice,
                solari: gameState.player.lifetimeSolari,
                xp: gameState.player.lifetimeXP,
                prestigeLevel: gameState.player.prestigeLevel + 1
            };
            
            // Reset player progress
            gameState.player = {
                ...gameState.player,
                level: 1,
                experience: 0,
                experienceToNext: 100,
                health: 120,
                maxHealth: 120,
                energy: 150,
                maxEnergy: 150,
                attack: 12,
                defense: 8,
                position: { x: 100, y: 100 },
                abilities: [],
                selectedAbilities: [null, null, null],
                spiceConsumed: 0,
                movementCount: 0,
                totalSpiceCollected: 0,
                totalEnemiesDefeated: 0,
                prestigeLevel: lifetimeStats.prestigeLevel,
                lifetimeSpice: lifetimeStats.spice,
                lifetimeSolari: lifetimeStats.solari,
                lifetimeXP: lifetimeStats.xp
            };
            
            // Reset resources with some carry-over
            const carryOverPercent = Math.min(0.5, gameState.player.prestigeLevel * 0.05);
            gameState.resources = {
                spice: Math.floor(gameState.resources.spice * carryOverPercent),
                water: CONFIG.INITIAL_RESOURCES.water + gameState.player.prestigeLevel * 50,
                solari: Math.floor(gameState.resources.solari * carryOverPercent) + gameState.player.prestigeLevel * 1000,
                plasteel: Math.floor(gameState.resources.plasteel * carryOverPercent),
                rareMaterials: Math.floor(gameState.resources.rareMaterials * carryOverPercent),
                melange: Math.floor(gameState.resources.melange * carryOverPercent)
            };
            
            // Reset buildings but keep some levels
            Object.keys(gameState.buildings).forEach(building => {
                gameState.buildings[building] = Math.floor(gameState.buildings[building] * 0.2);
            });
            
            // Reset equipment and inventory
            gameState.equipment = { weapon: null, armor: null, accessory: null };
            gameState.inventory = new Array(CONFIG.MAX_INVENTORY).fill(null);
            
            // Reset quests
            gameState.quests = {
                active: [],
                completed: [],
                available: [...STATIC_DATA.QUESTS]
            };
            
            showNotification(`🌟 PRESTIGE ${gameState.player.prestigeLevel}! ✨ Transcendence achieved! +${(CONFIG.PRESTIGE_BONUS_PER_LEVEL * 100).toFixed(1)}% to all gains!`, 'legendary', 10000);
            logEvent(`🌟 PRESTIGIOUS TRANSCENDENCE - Level ${gameState.player.prestigeLevel}!`);
            
            updatePlayerRank();
            updateUI();
            renderMap();
            saveGame();
        }

        // === MAP SYSTEM ===
        function initializeMap() {
            // Generate enemies
            for (let i = 0; i < 200; i++) {
                const pos = getRandomPosition();
                const key = `${pos.x},${pos.y}`;
                
                if (Math.random() < 0.4) { // 40% chance for enemy
                    const enemyTypes = Object.keys(STATIC_DATA.ENEMIES);
                    let enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                    
                    // Reduce boss spawn rate
                    const enemy = STATIC_DATA.ENEMIES[enemyType];
                    if (enemy.boss && Math.random() > 0.05) {
                        enemyType = 'sandRaider'; // Default to common enemy
                    }
                    
                    gameState.map.enemies[key] = {
                        id: generateId(),
                        type: enemyType,
                        position: pos,
                        ...STATIC_DATA.ENEMIES[enemyType],
                        currentHealth: STATIC_DATA.ENEMIES[enemyType].health
                    };
                }
            }
            
            // Generate resources
            for (let i = 0; i < 150; i++) {
                const pos = getRandomPosition();
                const key = `${pos.x},${pos.y}`;
                
                if (!gameState.map.enemies[key]) {
                    const resourceTypes = ['spice', 'water', 'plasteel', 'rareMaterials'];
                    const weights = [60, 25, 12, 3]; // Spice is most common
                    let resourceType = weightedRandom(resourceTypes, weights);
                    
                    gameState.map.resources[key] = {
                        id: generateId(),
                        type: resourceType,
                        position: pos,
                        amount: 20 + Math.floor(Math.random() * 50),
                        maxAmount: 70
                    };
                }
            }
            
            // Generate special locations
            for (let i = 0; i < 20; i++) {
                const pos = getRandomPosition();
                const key = `${pos.x},${pos.y}`;
                
                if (!gameState.map.enemies[key] && !gameState.map.resources[key]) {
                    const locationTypes = ['sietch', 'ruins', 'settlement'];
                    const locationType = locationTypes[Math.floor(Math.random() * locationTypes.length)];
                    
                    gameState.map[locationType + 's'] = gameState.map[locationType + 's'] || {};
                    gameState.map[locationType + 's'][key] = {
                        id: generateId(),
                        type: locationType,
                        position: pos
                    };
                }
            }
        }

        function weightedRandom(items, weights) {
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < items.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return items[i];
                }
            }
            return items[items.length - 1];
        }

        function renderMap() {
            const mapGrid = document.getElementById('uiMapGrid');
            if (!mapGrid) return;
            
            mapGrid.innerHTML = '';
            
            const playerX = gameState.player.position.x;
            const playerY = gameState.player.position.y;
            const radius = gameState.map.viewRadius;
            
            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    const x = playerX + dx;
                    const y = playerY + dy;
                    const key = `${x},${y}`;
                    
                    const cell = document.createElement('div');
                    cell.className = 'map-cell map-cell-explored';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // Mark as explored
                    gameState.map.explored[key] = true;
                    
                    // Player position
                    if (x === playerX && y === playerY) {
                        cell.className += ' map-cell-player';
                        cell.textContent = '👤';
                        cell.title = `${gameState.player.name} (P${gameState.player.prestigeLevel})`;
                    }
                    // Sandworm
                    else if (gameState.map.sandworms[key]) {
                        cell.className += ' map-cell-sandworm';
                        cell.textContent = '🐛';
                        cell.title = 'Shai-Hulud - The Great Sandworm!';
                    }
                    // Enemy
                    else if (gameState.map.enemies[key]) {
                        const enemy = gameState.map.enemies[key];
                        cell.className += enemy.boss ? ' map-cell-boss' : ' map-cell-enemy';
                        cell.textContent = enemy.icon;
                        cell.title = `${enemy.name} (Lv.${enemy.level}) - ${enemy.description}`;
                    }
                    // Resource
                    else if (gameState.map.resources[key]) {
                        const resource = gameState.map.resources[key];
                        cell.className += ` map-cell-resource-${resource.type}`;
                        const icons = { spice: '✨', water: '💧', plasteel: '🔧', rareMaterials: '💎' };
                        cell.textContent = icons[resource.type] || '📦';
                        cell.title = `${resource.type.charAt(0).toUpperCase() + resource.type.slice(1)} Deposit (${resource.amount}/${resource.maxAmount})`;
                    }
                    // Special locations
                    else if (gameState.map.sietches && gameState.map.sietches[key]) {
                        cell.className += ' map-cell-sietch';
                        cell.textContent = '🏔️';
                        cell.title = 'Fremen Sietch - Hidden desert stronghold';
                    }
                    else if (gameState.map.ruins && gameState.map.ruins[key]) {
                        cell.className += ' map-cell-ruins';
                        cell.textContent = '🏛️';
                        cell.title = 'Ancient Ruins - Echoes of lost civilizations';
                    }
                    else if (gameState.map.settlements && gameState.map.settlements[key]) {
                        cell.className += ' map-cell-settlement';
                        cell.textContent = '🏘️';
                        cell.title = 'Desert Settlement - Trade and rest';
                    }
                    // Player base
                    else if (x === gameState.player.basePosition.x && y === gameState.player.basePosition.y) {
                        cell.className += ' map-cell-player-base';
                        cell.textContent = '🏠';
                        cell.title = 'Your Base';
                    }
                    // Empty desert
                    else {
                        const terrains = ['🏜️', '🌵', '🪨'];
                        cell.textContent = terrains[Math.floor(Math.random() * terrains.length)];
                        cell.title = 'Empty desert';
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(parseInt(x), parseInt(y)));
                    mapGrid.appendChild(cell);
                }
            }
            
            // Update coordinates display
            const coordsDisplay = document.getElementById('mapPlayerCoords');
            if (coordsDisplay) {
                coordsDisplay.textContent = `${playerX},${playerY}`;
            }
        }

        function handleCellClick(x, y) {
            const key = `${x},${y}`;
            const dx = x - gameState.player.position.x;
            const dy = y - gameState.player.position.y;
            
            // Only allow movement to adjacent cells
            if (Math.abs(dx) <= 1 && Math.abs(dy) <= 1 && (dx !== 0 || dy !== 0)) {
                movePlayer(dx, dy);
            }
            // Interact with objects on current position
            else if (dx === 0 && dy === 0) {
                if (gameState.map.enemies[key]) {
                    startCombat(gameState.map.enemies[key]);
                } else if (gameState.map.resources[key]) {
                    harvestResourceNode(gameState.map.resources[key]);
                } else if (gameState.map.sietches && gameState.map.sietches[key]) {
                    visitSietch();
                } else if (gameState.map.settlements && gameState.map.settlements[key]) {
                    visitSettlement();
                } else if (gameState.map.ruins && gameState.map.ruins[key]) {
                    exploreRuins();
                }
            }
        }

        function movePlayer(dx, dy) {
            if (gameState.combat.active) {
                showNotification('Cannot move during combat!', 'error');
                return;
            }
            
            const waterCost = gameState.player.house === 'fremen' ? Math.floor(CONFIG.WATER_CONSUMPTION_MOVE * 0.5) : CONFIG.WATER_CONSUMPTION_MOVE;
            
            if (gameState.resources.water < waterCost) {
                showNotification('Not enough water to travel the desert!', 'error');
                return;
            }
            
            const newX = Math.max(0, Math.min(CONFIG.MAP_SIZE - 1, gameState.player.position.x + dx));
            const newY = Math.max(0, Math.min(CONFIG.MAP_SIZE - 1, gameState.player.position.y + dy));
            
            gameState.player.position.x = newX;
            gameState.player.position.y = newY;
            gameState.player.movementCount++;
            updateResources({ water: -waterCost });
            
            // Random encounters
            const key = `${newX},${newY}`;
            
            // Sandworm encounter (very rare)
            if (Math.random() < CONFIG.SANDWORM_ENCOUNTER_CHANCE && gameState.player.house !== 'fremen') {
                encounterSandworm();
                return;
            }
            
            // Enemy encounter
            if (gameState.map.enemies[key] && Math.random() < 0.25) {
                startCombat(gameState.map.enemies[key]);
                return;
            }
            
            renderMap();
            logEvent(`Moved to ${newX},${newY}`);
            checkQuestProgress();
        }

        function encounterSandworm() {
            showNotification('🐛 THE GROUND TREMBLES... SHAI-HULUD APPROACHES!', 'sandworm', 8000);
            logEvent('🐛 SANDWORM ENCOUNTER! The Maker of Spice has found you!');
            
            // Chance to survive based on level and equipment
            let survivalChance = 0.1 + (gameState.player.level * 0.02);
            
            if (gameState.equipment.accessory && gameState.equipment.accessory.special === 'desert') {
                survivalChance += 0.3;
            }
            
            if (gameState.player.abilities.includes('prescience')) {
                survivalChance += 0.2;
            }
            
            if (Math.random() < survivalChance) {
                gameState.player.sandwormsSurvived++;
                showNotification('You survive the encounter with Shai-Hulud! The Maker deems you worthy!', 'legendary', 10000);
                logEvent('🎉 SURVIVED SANDWORM ENCOUNTER! Bless the Maker and His water!');
                
                // Massive rewards
                updateResources({ 
                    spice: 200, 
                    melange: 20, 
                    rareMaterials: 10 
                });
                addExperience(500);
                
                checkQuestProgress();
            } else {
                showNotification('The sandworm consumes you... but in death, you are reborn.', 'error', 8000);
                logEvent('💀 Consumed by Shai-Hulud. The desert reclaims all...');
                
                // Death penalty
                gameState.player.health = 1;
                updateResources({ 
                    spice: -Math.floor(gameState.resources.spice * 0.5),
                    water: -Math.floor(gameState.resources.water * 0.3),
                    solari: -Math.floor(gameState.resources.solari * 0.2)
                });
                
                // Teleport to safe location
                gameState.player.position = { ...gameState.player.basePosition };
            }
        }

        function harvestResourceNode(resource) {
            if (gameState.player.energy < 15) {
                showNotification('Not enough energy!', 'error');
                return;
            }
            
            gameState.player.energy -= 15;
            const amount = Math.min(10, resource.amount);
            resource.amount -= amount;
            
            const bonusAmount = applyPrestigeBonus(amount, 'extraction');
            updateResources({ [resource.type]: bonusAmount });
            logEvent(`Harvested ${bonusAmount} ${resource.type} from deposit`);
            
            if (resource.amount <= 0) {
                const key = `${resource.position.x},${resource.position.y}`;
                delete gameState.map.resources[key];
                logEvent('Resource deposit depleted');
            }
            
            renderMap();
        }

        function visitSietch() {
            showNotification('You enter the hidden Fremen stronghold...', 'info', 5000);
            logEvent('Visited Fremen Sietch - Desert sanctuary found');
            
            // Chance for special rewards or traders
            if (Math.random() < 0.3) {
                const rewards = [
                    { water: 50, description: 'The Fremen share their water with you' },
                    { spice: 30, description: 'You learn of hidden spice deposits' },
                    { item: 'fremkit', description: 'A Fremen gives you survival gear' }
                ];
                
                const reward = rewards[Math.floor(Math.random() * rewards.length)];
                
                if (reward.item) {
                    addToInventory(STATIC_DATA.ITEMS[reward.item]);
                } else {
                    updateResources(reward);
                }
                
                showNotification(reward.description, 'success', 6000);
            }
        }

        function visitSettlement() {
            showNotification('A small desert outpost offers trade and rest...', 'info', 5000);
            logEvent('Visited desert settlement');
            
            // Rest and recovery
            gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + 20);
            gameState.player.energy = Math.min(gameState.player.maxEnergy, gameState.player.energy + 30);
            
            showNotification('You rest and recover at the settlement', 'success');
        }

        function exploreRuins() {
            showNotification('Ancient ruins hold secrets of the past...', 'info', 5000);
            logEvent('Explored ancient ruins');
            
            // Chance for rare items or resources
            if (Math.random() < 0.2) {
                const rareLoot = [
                    { rareMaterials: 5, description: 'You discover rare archeotech' },
                    { melange: 3, description: 'Ancient spice cache found' },
                    { item: 'spiceLens', description: 'A mysterious device among the ruins' }
                ];
                
                const loot = rareLoot[Math.floor(Math.random() * rareLoot.length)];
                
                if (loot.item) {
                    addToInventory(STATIC_DATA.ITEMS[loot.item]);
                } else {
                    updateResources(loot);
                }
                
                showNotification(loot.description, 'legendary', 6000);
            }
        }

        // === COMBAT SYSTEM ===
        function startCombat(enemy) {
            gameState.combat = {
                active: true,
                enemy: { ...enemy, currentHealth: enemy.currentHealth || enemy.health },
                turn: 'player',
                log: []
            };
            
            addCombatLog(`⚔️ Combat begins with ${enemy.name}!`);
            
            if (enemy.description) {
                addCombatLog(`"${enemy.description}"`);
            }
            
            showCombatModal();
        }

        function showCombatModal() {
            const modal = document.getElementById('modalCombat');
            if (!modal) return;
            
            modal.classList.remove('hidden');
            updateCombatDisplay();
        }

        function updateCombatDisplay() {
            // Update player stats
            document.getElementById('modalCombatPlayerName').textContent = `${gameState.player.name} (P${gameState.player.prestigeLevel})`;
            document.getElementById('modalCombatPlayerLevel').textContent = `Lv.${gameState.player.level}`;
            document.getElementById('modalCombatPlayerHealth').textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('modalCombatPlayerEnergy').textContent = `${gameState.player.energy}/${gameState.player.maxEnergy}`;
            
            // Update enemy stats
            const enemy = gameState.combat.enemy;
            document.getElementById('modalCombatEnemyName').textContent = enemy.name;
            document.getElementById('modalCombatEnemyLevel').textContent = `Lv.${enemy.level || 1}`;
            document.getElementById('modalCombatEnemyHealth').textContent = `${enemy.currentHealth}/${enemy.health}`;
            
            // Update health bars
            const playerHealthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const enemyHealthPercent = (enemy.currentHealth / enemy.health) * 100;
            
            document.getElementById('modalCombatPlayerHealthBar').style.width = `${playerHealthPercent}%`;
            document.getElementById('modalCombatEnemyHealthBar').style.width = `${enemyHealthPercent}%`;
            
            // Update energy bar
            const energyPercent = (gameState.player.energy / gameState.player.maxEnergy) * 100;
            document.getElementById('modalCombatPlayerEnergyBar').style.width = `${energyPercent}%`;
            
            // Update combat log
            const logElement = document.getElementById('modalCombatLog');
            if (logElement) {
                logElement.innerHTML = gameState.combat.log.join('<br>');
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            // Update turn indicator
            const turnIndicator = document.getElementById('modalCombatTurnIndicator');
            if (turnIndicator) {
                turnIndicator.textContent = gameState.combat.turn === 'player' ? "Your Turn" : `${enemy.name}'s Turn`;
                turnIndicator.className = gameState.combat.turn === 'player' ? 'text-center text-xs text-green-400' : 'text-center text-xs text-red-400';
            }
            
            // Enable/disable action buttons
            const isPlayerTurn = gameState.combat.turn === 'player';
            document.getElementById('combatActionAttack').disabled = !isPlayerTurn;
            document.getElementById('combatActionDefend').disabled = !isPlayerTurn;
            document.getElementById('combatActionFlee').disabled = !isPlayerTurn;
            
            // Update ability buttons
            updateCombatAbilities();
        }

        function updateCombatAbilities() {
            const abilitiesContainer = document.getElementById('modalCombatPlayerAbilities');
            if (!abilitiesContainer) return;
            
            abilitiesContainer.innerHTML = '';
            
            gameState.player.selectedAbilities.forEach((abilityId, index) => {
                if (!abilityId) return;
                
                const ability = STATIC_DATA.ABILITIES[abilityId];
                if (!ability) return;
                
                const button = document.createElement('button');
                button.className = 'py-2 px-3 rounded text-sm';
                
                const isOnCooldown = gameState.abilityCooldowns[abilityId] && gameState.abilityCooldowns[abilityId] > Date.now();
                const hasEnergy = gameState.player.energy >= ability.energyCost;
                const canUse = hasEnergy && !isOnCooldown && gameState.combat.turn === 'player';
                
                if (canUse) {
                    button.className += ' bg-purple-600 hover:bg-purple-700';
                } else {
                    button.className += ' bg-stone-600 cursor-not-allowed';
                    button.disabled = true;
                }
                
                button.textContent = `${ability.icon} ${ability.name}`;
                
                if (isOnCooldown) {
                    const remaining = Math.ceil((gameState.abilityCooldowns[abilityId] - Date.now()) / 1000);
                    button.textContent += ` (${remaining}s)`;
                } else if (!hasEnergy) {
                    button.textContent += ` (${ability.energyCost} energy)`;
                }
                
                button.addEventListener('click', () => {
                    if (canUse) {
                        useCombatAbility(abilityId);
                    }
                });
                
                abilitiesContainer.appendChild(button);
            });
        }

        function addCombatLog(message) {
            gameState.combat.log.push(message);
            if (gameState.combat.log.length > 30) gameState.combat.log.shift();
        }

        function combatAction(action) {
            if (gameState.combat.turn !== 'player') return;
            
            const enemy = gameState.combat.enemy;
            let damage = 0;
            
            switch (action) {
                case 'attack':
                    let baseAttack = gameState.player.attack;
                    
                    // Equipment bonuses
                    if (gameState.equipment.weapon) {
                        baseAttack += gameState.equipment.weapon.attack || 0;
                    }
                    
                    damage = baseAttack + Math.floor(Math.random() * 15);
                    
                    // Critical hit
                    if (Math.random() * 100 < gameState.player.critChance) {
                        damage *= 2;
                        addCombatLog(`💥 CRITICAL HIT! You deal ${damage} damage!`);
                    } else {
                        addCombatLog(`⚔️ You attack for ${damage} damage!`);
                    }
                    
                    enemy.currentHealth -= damage;
                    break;
                    
                case 'defend':
                    const healing = Math.floor(gameState.player.maxHealth * 0.15);
                    gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healing);
                    addCombatLog(`🛡️ You defend and recover ${healing} health!`);
                    break;
                    
                case 'flee':
                    let fleeChance = 0.6;
                    if (enemy.boss) fleeChance = 0.3;
                    if (gameState.player.level > enemy.level) fleeChance += 0.2;
                    
                    if (Math.random() < fleeChance) {
                        addCombatLog(`💨 You successfully flee from combat!`);
                        endCombat(false, true);
                        return;
                    } else {
                        addCombatLog(`❌ Failed to flee! ${enemy.name} blocks your escape!`);
                    }
                    break;
            }
            
            // Check if enemy is defeated
            if (enemy.currentHealth <= 0) {
                endCombat(true);
                return;
            }
            
            // Enemy turn
            gameState.combat.turn = 'enemy';
            updateCombatDisplay();
            
            setTimeout(() => {
                enemyTurn();
            }, 1500);
        }

        function useCombatAbility(abilityId) {
            const ability = STATIC_DATA.ABILITIES[abilityId];
            if (!ability) return;
            
            if (gameState.abilityCooldowns[abilityId] && gameState.abilityCooldowns[abilityId] > Date.now()) {
                addCombatLog(`${ability.name} is on cooldown!`);
                return;
            }
            
            if (gameState.player.energy < ability.energyCost) {
                addCombatLog(`Not enough energy for ${ability.name}!`);
                return;
            }
            
            gameState.player.energy -= ability.energyCost;
            gameState.abilityCooldowns[abilityId] = Date.now() + ability.cooldown;
            
            const enemy = gameState.combat.enemy;
            
            switch (ability.type) {
                case 'aoe':
                case 'single':
                    let damage = ability.damage || 0;
                    if (ability.critBonus && Math.random() < 0.4) {
                        damage += ability.critBonus;
                        addCombatLog(`🌟 ${ability.name} delivers a devastating blow for ${damage} damage!`);
                    } else {
                        addCombatLog(`🌟 ${ability.name} deals ${damage} damage!`);
                    }
                    enemy.currentHealth -= damage;
                    break;
                    
                case 'heal':
                    const healing = ability.heal || 0;
                    gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healing);
                    addCombatLog(`💧 ${ability.name} heals you for ${healing} health!`);
                    break;
                    
                case 'defense':
                    addCombatLog(`🛡️ ${ability.name} strengthens your defenses!`);
                    // Could add temporary defense bonus here
                    break;
                    
                case 'utility':
                    if (ability.effect === 'foresight') {
                        addCombatLog(`👁️ ${ability.name} reveals your enemy's next move!`);
                        gameState.combat.foresight = 2; // Dodge next 2 attacks
                    } else if (ability.effect === 'control') {
                        if (Math.random() < 0.7) {
                            addCombatLog(`🗣️ ${ability.name} compels your enemy to hesitate!`);
                            gameState.combat.enemyStunned = 1;
                        } else {
                            addCombatLog(`🗣️ ${ability.name} fails - your enemy resists!`);
                        }
                    }
                    break;
            }
            
            // Check if enemy is defeated
            if (enemy.currentHealth <= 0) {
                endCombat(true);
                return;
            }
            
            // Enemy turn (unless stunned)
            if (!gameState.combat.enemyStunned) {
                gameState.combat.turn = 'enemy';
                updateCombatDisplay();
                
                setTimeout(() => {
                    enemyTurn();
                }, 1500);
            } else {
                gameState.combat.enemyStunned--;
                addCombatLog(`${enemy.name} is stunned and loses their turn!`);
                updateCombatDisplay();
            }
        }

        function enemyTurn() {
            const enemy = gameState.combat.enemy;
            let damage = enemy.attack + Math.floor(Math.random() * 10);
            
            // Apply defense
            let defense = gameState.player.defense;
            if (gameState.equipment.armor) {
                defense += gameState.equipment.armor.defense || 0;
            }
            if (gameState.equipment.accessory && gameState.equipment.accessory.defense) {
                defense += gameState.equipment.accessory.defense;
            }
            
            // Foresight/dodge check
            let dodged = false;
            if (gameState.combat.foresight > 0) {
                dodged = true;
                gameState.combat.foresight--;
                addCombatLog(`👁️ Your prescience allows you to dodge ${enemy.name}'s attack!`);
            } else if (Math.random() * 100 < gameState.player.dodgeChance) {
                dodged = true;
                addCombatLog(`💨 You dodge ${enemy.name}'s attack!`);
            }
            
            if (!dodged) {
                const actualDamage = Math.max(1, damage - defense);
                gameState.player.health -= actualDamage;
                
                if (enemy.boss) {
                    addCombatLog(`💀 ${enemy.name} unleashes a devastating attack for ${actualDamage} damage!`);
                } else {
                    addCombatLog(`💀 ${enemy.name} attacks you for ${actualDamage} damage!`);
                }
                
                if (gameState.player.health <= 0) {
                    endCombat(false);
                    return;
                }
            }
            
            gameState.combat.turn = 'player';
            updateCombatDisplay();
        }

        function endCombat(victory, fled = false) {
            const enemy = gameState.combat.enemy;
            
            if (victory) {
                addCombatLog(`🎉 Victory! ${enemy.name} has been defeated!`);
                
                // Calculate rewards with prestige bonuses
                const baseXP = enemy.xp || 30;
                const bonusXP = applyPrestigeBonus(baseXP, 'xp');
                addExperience(bonusXP);
                
                if (enemy.loot) {
                    const bonusLoot = {};
                    Object.entries(enemy.loot).forEach(([resource, amount]) => {
                        bonusLoot[resource] = applyPrestigeBonus(amount, 'extraction');
                    });
                    updateResources(bonusLoot);
                }
                
                // Track defeated enemies
                gameState.player.totalEnemiesDefeated++;
                
                // Remove enemy from map
                const key = `${enemy.position.x},${enemy.position.y}`;
                delete gameState.map.enemies[key];
                
                // Boss rewards
                if (enemy.boss) {
                    showNotification(`🏆 BOSS DEFEATED: ${enemy.name}!`, 'legendary', 8000);
                    logEvent(`🏆 BOSS VICTORY: Defeated ${enemy.name}!`);
                    
                    // Extra boss rewards
                    if (enemy.legendary) {
                        updateResources({ melange: 25, rareMaterials: 20 });
                        showNotification('The Maker grants you its blessing...', 'legendary', 6000);
                    }
                } else {
                    showNotification(`Defeated ${enemy.name}!`, 'success');
                    logEvent(`Defeated ${enemy.name} and gained ${bonusXP} XP`);
                }
                
            } else if (fled) {
                addCombatLog(`💨 You escape from ${enemy.name}!`);
                logEvent(`Fled from ${enemy.name}`);
            } else {
                addCombatLog(`💀 Defeat! You have been defeated by ${enemy.name}!`);
                
                // Death penalties
                gameState.player.health = Math.floor(gameState.player.maxHealth * 0.1);
                const lostSolari = Math.floor(gameState.resources.solari * 0.1);
                const lostSpice = Math.floor(gameState.resources.spice * 0.05);
                
                updateResources({ 
                    solari: -lostSolari,
                    spice: -lostSpice 
                });
                
                showNotification(`Defeated by ${enemy.name}! Lost ${lostSolari} Solari and ${lostSpice} Spice`, 'error', 6000);
                logEvent(`💀 Defeated by ${enemy.name} - Lost resources`);
                
                // Teleport to base
                gameState.player.position = { ...gameState.player.basePosition };
            }
            
            gameState.combat.active = false;
            gameState.combat.foresight = 0;
            gameState.combat.enemyStunned = 0;
            
            setTimeout(() => {
                document.getElementById('modalCombat').classList.add('hidden');
                renderMap();
                checkQuestProgress();
            }, 3000);
        }

        // === BUILDING SYSTEM ===
        function buyBuilding(buildingType) {
            const building = STATIC_DATA.BUILDINGS[buildingType];
            if (!building) return;
            
            const currentLevel = gameState.buildings[buildingType] || 0;
            if (currentLevel >= building.maxLevel) {
                showNotification('Building at maximum level!', 'warning');
                return;
            }
            
            const cost = {};
            Object.entries(building.baseCost).forEach(([resource, amount]) => {
                cost[resource] = Math.floor(amount * Math.pow(building.costFactor, currentLevel));
            });
            
            if (!canAfford(cost)) {
                const costText = Object.entries(cost).map(([resource, amount]) => 
                    `${amount} ${resource}`
                ).join(', ');
                showNotification(`Cannot afford: ${costText}`, 'error');
                return;
            }
            
            spendResources(cost);
            gameState.buildings[buildingType] = currentLevel + 1;
            
            logEvent(`Upgraded ${building.name} to level ${gameState.buildings[buildingType]}`);
            showNotification(`${building.name} upgraded!`, 'success');
            
            // Special building effects
            if (buildingType === 'sietchTabr' && gameState.buildings[buildingType] === 1) {
                showNotification('🏔️ Sietch Tabr constructed! You may now prestige when ready.', 'legendary', 8000);
            }
            
            updateBuildingsDisplay();
            checkQuestProgress();
        }

        // === INVENTORY SYSTEM ===
        function addToInventory(item) {
            const emptySlot = gameState.inventory.findIndex(slot => slot === null);
            if (emptySlot === -1) {
                showNotification('Inventory full!', 'warning');
                return false;
            }
            
            gameState.inventory[emptySlot] = { ...item, id: generateId() };
            updateInventoryDisplay();
            showNotification(`Acquired: ${item.name}`, item.rarity === 'legendary' ? 'legendary' : 'success');
            return true;
        }

        function equipItem(item, inventoryIndex) {
            if (!item || !item.type) return;
            
            const equipSlot = item.type;
            const currentEquipped = gameState.equipment[equipSlot];
            
            // Unequip current item
            if (currentEquipped) {
                gameState.inventory[inventoryIndex] = currentEquipped;
            } else {
                gameState.inventory[inventoryIndex] = null;
            }
            
            // Equip new item
            gameState.equipment[equipSlot] = item;
            
            logEvent(`Equipped ${item.name}`);
            showNotification(`Equipped ${item.name}`, 'success');
            updateInventoryDisplay();
            updateEquipmentDisplay();
            updatePlayerRank(); // Equipment affects power
        }

        // === HOUSE SELECTION ===
        function selectHouse(houseId) {
            if (gameState.player.house) {
                showNotification('You have already chosen your allegiance!', 'warning');
                return;
            }
            
            const house = STATIC_DATA.HOUSES[houseId];
            if (!house) return;
            
            gameState.player.house = houseId;
            
            logEvent(`🏛️ Joined ${house.name}! ${house.description}`);
            showNotification(`Welcome to ${house.name}!`, 'legendary', 8000);
            
            // House starting bonuses
            switch (houseId) {
                case 'atreides':
                    addExperience(200);
                    updateResources({ solari: 500 });
                    break;
                case 'harkonnen':
                    gameState.player.attack += 5;
                    updateResources({ plasteel: 100 });
                    break;
                case 'fremen':
                    updateResources({ water: 200, spice: 50 });
                    if (!gameState.player.abilities.includes('crysknife')) {
                        gameState.player.abilities.push('crysknife');
                    }
                    break;
            }
            
            updateUI();
            checkQuestProgress();
        }

        // === UI UPDATE FUNCTIONS ===
        function updateResourceDisplay() {
            Object.entries(gameState.resources).forEach(([resource, amount]) => {
                const element = document.getElementById(`resource${resource.charAt(0).toUpperCase() + resource.slice(1)}`);
                if (element) {
                    element.textContent = amount.toLocaleString();
                }
            });
        }

        function updatePlayerStats() {
            document.getElementById('statHealth').textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('statEnergy').textContent = `${gameState.player.energy}/${gameState.player.maxEnergy}`;
            document.getElementById('statLevel').textContent = gameState.player.level;
            document.getElementById('statExp').textContent = `${gameState.player.experience}/${gameState.player.experienceToNext}`;
            
            // Update progress bars
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const energyPercent = (gameState.player.energy / gameState.player.maxEnergy) * 100;
            const expPercent = (gameState.player.experience / gameState.player.experienceToNext) * 100;
            
            document.getElementById('barHealth').style.width = `${healthPercent}%`;
            document.getElementById('barEnergy').style.width = `${energyPercent}%`;
            document.getElementById('barExp').style.width = `${expPercent}%`;
            
            // Character tab
            document.getElementById('charName').textContent = `${gameState.player.name} (P${gameState.player.prestigeLevel})`;
            document.getElementById('charLevel').textContent = gameState.player.level;
            document.getElementById('charAttack').textContent = gameState.player.attack;
            document.getElementById('charDefense').textContent = gameState.player.defense;
            document.getElementById('charCrit').textContent = gameState.player.critChance;
            document.getElementById('charDodge').textContent = gameState.player.dodgeChance;
            document.getElementById('charPower').textContent = gameState.player.power.toLocaleString();
            
            // Prestige display
            const prestigeDisplay = document.getElementById('playerPrestigeDisplay');
            if (prestigeDisplay) {
                prestigeDisplay.textContent = gameState.player.prestigeLevel;
            }
            
            // Rank display
            const rankElement = document.getElementById('playerRankDisplay');
            if (rankElement) {
                rankElement.textContent = gameState.player.rank;
                const rankData = STATIC_DATA.RANKS.find(r => r.name === gameState.player.rank);
                if (rankData) {
                    rankElement.className = rankData.color;
                }
            }
            
            // House display
            const houseElement = document.getElementById('playerHouseDisplay');
            if (houseElement && gameState.player.house) {
                const house = STATIC_DATA.HOUSES[gameState.player.house];
                houseElement.textContent = house.name;
                houseElement.className = house.color;
            }
        }

        function updateInventoryDisplay() {
            const inventoryGrid = document.getElementById('uiInventoryGrid');
            if (!inventoryGrid) return;
            
            inventoryGrid.innerHTML = '';
            
            for (let i = 0; i < CONFIG.MAX_INVENTORY; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.dataset.index = i;
                
                const item = gameState.inventory[i];
                if (item) {
                    slot.textContent = item.icon || '📦';
                    slot.title = `${item.name}\n${item.description || ''}`;
                    
                    // Rarity styling
                    if (item.rarity) {
                        slot.classList.add(`item-rarity-${item.rarity}`);
                    }
                    
                    slot.addEventListener('click', () => {
                        if (item.type && ['weapon', 'armor', 'accessory'].includes(item.type)) {
                            equipItem(item, i);
                        }
                    });
                }
                
                inventoryGrid.appendChild(slot);
            }
            
            // Update inventory usage
            const usedSlots = gameState.inventory.filter(slot => slot !== null).length;
            const usageElement = document.getElementById('inventoryUsage');
            if (usageElement) {
                usageElement.textContent = `${usedSlots}/${CONFIG.MAX_INVENTORY}`;
            }
        }

        function updateEquipmentDisplay() {
            ['weapon', 'armor', 'accessory'].forEach(type => {
                const element = document.getElementById(`equip${type.charAt(0).toUpperCase() + type.slice(1)}`);
                if (element) {
                    const item = gameState.equipment[type];
                    if (item) {
                        element.textContent = item.icon || '📦';
                        element.title = `${item.name}\n${item.description || ''}`;
                        
                        // Rarity styling
                        if (item.rarity) {
                            element.className = `inventory-slot item-rarity-${item.rarity}`;
                        }
                    } else {
                        element.textContent = '';
                        element.title = 'Empty';
                        element.className = 'inventory-slot';
                    }
                }
            });
        }

        function updateBuildingsDisplay() {
            const buildingsList = document.getElementById('uiBuildingsList');
            if (!buildingsList) return;
            
            buildingsList.innerHTML = '';
            
            Object.entries(STATIC_DATA.BUILDINGS).forEach(([buildingType, building]) => {
                const currentLevel = gameState.buildings[buildingType] || 0;
                
                const buildingCard = document.createElement('div');
                buildingCard.className = 'production-building p-3 rounded';
                buildingCard.dataset.building = buildingType;
                
                const cost = {};
                Object.entries(building.baseCost).forEach(([resource, amount]) => {
                    cost[resource] = Math.floor(amount * Math.pow(building.costFactor, currentLevel));
                });
                
                const costText = Object.entries(cost).map(([resource, amount]) => 
                    `${amount} ${resource.charAt(0).toUpperCase() + resource.slice(1)}`
                ).join(', ');
                
                const canAffordBuilding = canAfford(cost);
                const isMaxLevel = currentLevel >= building.maxLevel;
                
                let description = building.description;
                if (typeof description === 'function') {
                    description = description(currentLevel);
                }
                
                buildingCard.innerHTML = `
                    <h4 class="font-semibold mb-1">${building.icon} ${building.name}</h4>
                    <p class="text-xs text-stone-400 mb-1">Level ${currentLevel}/${building.maxLevel}</p>
                    <p class="text-xs text-amber-200 mb-2">${description}</p>
                    <button 
                        class="w-full text-xs py-1 rounded ${isMaxLevel ? 'bg-stone-600 cursor-not-allowed' : 
                        canAffordBuilding ? 'bg-amber-600 hover:bg-amber-700' : 'bg-red-600 cursor-not-allowed'}"
                        ${isMaxLevel || !canAffordBuilding ? 'disabled' : ''}
                        onclick="buyBuilding('${buildingType}')"
                    >
                        ${isMaxLevel ? 'MAX LEVEL' : `Upgrade (${costText})`}
                    </button>
                `;
                
                buildingsList.appendChild(buildingCard);
            });
        }

        function updateAbilityDisplay() {
            for (let i = 0; i < 3; i++) {
                const slot = document.querySelector(`.ability-slot[data-slot="${i}"]`);
                if (!slot) continue;
                
                const abilityId = gameState.player.selectedAbilities[i];
                const ability = abilityId ? STATIC_DATA.ABILITIES[abilityId] : null;
                
                const icon = slot.querySelector('.ability-icon');
                const cooldownText = slot.querySelector('.ability-cooldown-text');
                
                if (ability) {
                    icon.textContent = ability.icon;
                    slot.title = `${ability.name}\n${ability.description}\nEnergy: ${ability.energyCost} | Cooldown: ${ability.cooldown/1000}s`;
                    
                    const cooldownEnd = gameState.abilityCooldowns[abilityId];
                    if (cooldownEnd && cooldownEnd > Date.now()) {
                        const remaining = Math.ceil((cooldownEnd - Date.now()) / 1000);
                        cooldownText.textContent = remaining + 's';
                        slot.classList.add('cooldown');
                    } else {
                        cooldownText.textContent = '';
                        slot.classList.remove('cooldown');
                    }
                    
                    slot.onclick = () => {
                        if (gameState.combat.active) {
                            useCombatAbility(abilityId);
                        } else {
                            useAbility(abilityId);
                        }
                    };
                } else {
                    icon.textContent = '❔';
                    cooldownText.textContent = '';
                    slot.title = 'No ability assigned - Learn abilities by leveling up';
                    slot.onclick = () => showAbilitySelection(i);
                }
            }
        }

        function showAbilitySelection(slotIndex) {
            const availableAbilities = gameState.player.abilities.filter(abilityId => 
                !gameState.player.selectedAbilities.includes(abilityId)
            );
            
            if (availableAbilities.length === 0) {
                showNotification('No available abilities to assign!', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-orbitron text-purple-400 mb-3">Select Ability for Slot ${slotIndex + 1}</h3>
                    <div class="space-y-2 mb-4">
                        ${availableAbilities.map(abilityId => {
                            const ability = STATIC_DATA.ABILITIES[abilityId];
                            return `
                                <button class="w-full text-left p-3 bg-stone-700 hover:bg-stone-600 rounded" onclick="assignAbility('${abilityId}', ${slotIndex})">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">${ability.icon}</span>
                                        <div>
                                            <div class="font-semibold">${ability.name}</div>
                                            <div class="text-xs text-stone-400">${ability.description}</div>
                                            <div class="text-xs text-amber-400">Energy: ${ability.energyCost} | Cooldown: ${ability.cooldown/1000}s</div>
                                        </div>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <button class="w-full py-2 bg-stone-600 hover:bg-stone-700 rounded" onclick="closeAbilityModal()">Cancel</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.assignAbility = (abilityId, slotIndex) => {
                gameState.player.selectedAbilities[slotIndex] = abilityId;
                updateAbilityDisplay();
                closeAbilityModal();
                showNotification(`Assigned ${STATIC_DATA.ABILITIES[abilityId].name} to slot ${slotIndex + 1}`, 'success');
            };
            
            window.closeAbilityModal = () => {
                document.body.removeChild(modal);
                delete window.assignAbility;
                delete window.closeAbilityModal;
            };
        }

        function useAbility(abilityId) {
            const ability = STATIC_DATA.ABILITIES[abilityId];
            if (!ability) return;
            
            if (gameState.abilityCooldowns[abilityId] && gameState.abilityCooldowns[abilityId] > Date.now()) {
                showNotification(`${ability.name} is on cooldown!`, 'warning');
                return;
            }
            
            if (gameState.player.energy < ability.energyCost) {
                showNotification('Not enough energy!', 'error');
                return;
            }
            
            gameState.player.energy -= ability.energyCost;
            gameState.abilityCooldowns[abilityId] = Date.now() + ability.cooldown;
            
            // Non-combat ability effects
            switch (ability.type) {
                case 'heal':
                    const healing = ability.heal || 0;
                    gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healing);
                    showNotification(`${ability.name} heals you for ${healing} health!`, 'success');
                    break;
                    
                case 'utility':
                    if (ability.effect === 'foresight') {
                        // Reveal nearby enemies and resources
                        showNotification('Your prescience reveals hidden secrets...', 'info', 6000);
                        // Implementation could reveal map objects
                    }
                    break;
                    
                default:
                    showNotification(`Used ${ability.name}!`, 'info');
            }
            
            updateAbilityDisplay();
        }

        function updateQuestDisplay() {
            const questsList = document.getElementById('uiQuestsList');
            if (!questsList) return;
            
            questsList.innerHTML = '';
            
            gameState.quests.active.forEach(quest => {
                const questItem = document.createElement('div');
                questItem.className = `quest-item p-3 rounded mb-2 ${quest.completed ? 'quest-completed' : ''}`;
                
                let progressText = '';
                if (quest.type === 'collection' && quest.target.spice) {
                    const progress = Math.min(gameState.player.totalSpiceCollected, quest.target.spice);
                    progressText = `Progress: ${progress}/${quest.target.spice}`;
                } else if (quest.type === 'building') {
                    const building = Object.keys(quest.target)[0];
                    const current = gameState.buildings[building] || 0;
                    const required = quest.target[building];
                    progressText = `Progress: ${current}/${required}`;
                } else if (quest.type === 'combat') {
                    const enemy = Object.keys(quest.target)[0];
                    const progress = gameState.player.totalEnemiesDefeated;
                    const required = quest.target[enemy];
                    progressText = `Progress: ${progress}/${required}`;
                }
                
                questItem.innerHTML = `
                    <h4 class="font-semibold text-amber-400">${quest.name}</h4>
                    <p class="text-sm text-stone-300 mb-1">${quest.description}</p>
                    ${progressText ? `<p class="text-xs text-stone-400">${progressText}</p>` : ''}
                    ${quest.completed ? '<p class="text-xs text-green-400 mt-1">✅ Completed!</p>' : ''}
                `;
                
                questsList.appendChild(questItem);
            });
            
            if (gameState.quests.active.length === 0) {
                questsList.innerHTML = '<p class="text-stone-400 text-center">No active quests</p>';
            }
        }

        function updateGameLog() {
            const logElement = document.getElementById('uiGameLog');
            if (!logElement) return;
            
            logElement.innerHTML = gameState.gameLog.slice(0, 30).join('<br>');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateUI() {
            updateResourceDisplay();
            updatePlayerStats();
            updateInventoryDisplay();
            updateEquipmentDisplay();
            updateBuildingsDisplay();
            updateAbilityDisplay();
            updateQuestDisplay();
            updateGameLog();
        }

        // === GAME INITIALIZATION ===
        function initializeGameAfterLoad() {
            // Initialize default values
            if (!gameState.buildings) gameState.buildings = {};
            if (!gameState.player.abilities) gameState.player.abilities = [];
            if (!gameState.player.selectedAbilities) gameState.player.selectedAbilities = [null, null, null];
            if (!gameState.player.prestigeLevel) gameState.player.prestigeLevel = 0;
            if (!gameState.player.lifetimeSpice) gameState.player.lifetimeSpice = 0;
            
            // Initialize map if needed
            if (Object.keys(gameState.map.enemies).length === 0) {
                initializeMap();
            }
            
            // Check for initial quests
            checkQuestProgress();
            
            // Update power and rank
            updatePlayerRank();
            
            // Mark as initialized
            gameState.gameInitialized = true;
            gameState.isLoading = false;
            
            // Hide loading screen
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            // Initial UI update
            updateUI();
            renderMap();
            
            // Start game loop
            startGameLoop();
            
            const welcomeMessage = gameState.player.prestigeLevel > 0 
                ? `Welcome back, Prestige ${gameState.player.prestigeLevel} ${gameState.player.rank}!`
                : 'Welcome to Arrakis! The spice must flow...';
            
            logEvent(welcomeMessage);
            showNotification(welcomeMessage, gameState.player.prestigeLevel > 0 ? 'legendary' : 'success', 6000);
            
            // Show house selection if not chosen
            if (!gameState.player.house && gameState.player.level >= 3) {
                setTimeout(() => showHouseSelection(), 2000);
            }
            
            // Show prestige notification if available
            if (canPrestige()) {
                setTimeout(() => {
                    showNotification('🌟 You are ready to Prestige! Visit the Base tab.', 'legendary', 8000);
                }, 5000);
            }
        }

        function showHouseSelection() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content max-w-2xl">
                    <h3 class="text-2xl font-orbitron text-amber-400 mb-4 text-center">Choose Your Allegiance</h3>
                    <p class="text-center text-stone-300 mb-6">The great houses of the Imperium await your decision. Choose wisely...</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${Object.entries(STATIC_DATA.HOUSES).map(([houseId, house]) => `
                            <button class="house-selection-btn p-4 border-2 rounded ${house.color} hover:bg-stone-700 transition-all" onclick="selectHouse('${houseId}')">
                                <h4 class="font-bold text-lg mb-2">${house.name}</h4>
                                <p class="text-sm text-stone-300">${house.description}</p>
                            </button>
                        `).join('')}
                    </div>
                    
                    <p class="text-center text-xs text-stone-400 mt-4">This choice is permanent and affects your entire journey on Arrakis.</p>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.selectHouse = (houseId) => {
                selectHouse(houseId);
                document.body.removeChild(modal);
                delete window.selectHouse;
            };
        }

        // === GAME LOOP ===
        function startGameLoop() {
            setInterval(() => {
                // Energy regeneration
                if (Date.now() - gameState.lastEnergyRegen >= CONFIG.ENERGY_REGEN_INTERVAL) {
                    const regenAmount = gameState.player.house === 'fremen' ? CONFIG.ENERGY_REGEN_RATE + 1 : CONFIG.ENERGY_REGEN_RATE;
                    gameState.player.energy = Math.min(gameState.player.maxEnergy, gameState.player.energy + regenAmount);
                    gameState.lastEnergyRegen = Date.now();
                }
                
                // Resource production
                processProduction();
                
                // Update ability cooldowns display
                updateAbilityDisplay();
                
                // Update player stats display
                updatePlayerStats();
                
                // Auto-save
                if (gameState.settings.autoSave && Date.now() - gameState.lastSaveTime >= CONFIG.SAVE_INTERVAL) {
                    saveGame();
                    gameState.lastSaveTime = Date.now();
                }
                
            }, 1000);
            
            // Longer interval updates
            setInterval(() => {
                // Spawn new enemies and resources occasionally
                if (Math.random() < 0.1) {
                    const pos = getRandomPosition();
                    const key = `${pos.x},${pos.y}`;
                    
                    if (!gameState.map.enemies[key] && !gameState.map.resources[key]) {
                        if (Math.random() < 0.7) {
                            // Spawn enemy
                            const enemyTypes = Object.keys(STATIC_DATA.ENEMIES).filter(type => !STATIC_DATA.ENEMIES[type].boss);
                            const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                            
                            gameState.map.enemies[key] = {
                                id: generateId(),
                                type: enemyType,
                                position: pos,
                                ...STATIC_DATA.ENEMIES[enemyType],
                                currentHealth: STATIC_DATA.ENEMIES[enemyType].health
                            };
                        } else {
                            // Spawn resource
                            const resourceTypes = ['spice', 'water', 'plasteel'];
                            const resourceType = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
                            
                            gameState.map.resources[key] = {
                                id: generateId(),
                                type: resourceType,
                                position: pos,
                                amount: 15 + Math.floor(Math.random() * 30),
                                maxAmount: 45
                            };
                        }
                    }
                }
            }, 30000); // Every 30 seconds
        }

        function saveGame() {
            if (USE_FIREBASE) {
                saveGameToFirebase();
            } else {
                saveGameToStorage();
            }
        }

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase/Storage
            await initializeFirebase();
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Update active tab button
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Show corresponding tab content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    const tabId = button.dataset.tab + 'Tab';
                    const activeTab = document.getElementById(tabId);
                    if (activeTab) {
                        activeTab.classList.remove('hidden');
                        gameState.currentTab = button.dataset.tab;
                        
                        // Special handling for certain tabs
                        if (button.dataset.tab === 'game') {
                            renderMap();
                        } else if (button.dataset.tab === 'quests') {
                            updateQuestDisplay();
                        }
                    }
                });
            });
            
            // Combat action buttons
            document.getElementById('combatActionAttack')?.addEventListener('click', () => combatAction('attack'));
            document.getElementById('combatActionDefend')?.addEventListener('click', () => combatAction('defend'));
            document.getElementById('combatActionFlee')?.addEventListener('click', () => combatAction('flee'));
            
            // Movement keys
            document.addEventListener('keydown', (e) => {
                if (gameState.combat.active) return;
                
                switch (e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        movePlayer(0, 1);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        movePlayer(1, 0);
                        break;
                    case ' ':
                        e.preventDefault();
                        harvestResource('spice');
                        break;
                    case 'p':
                    case 'P':
                        if (canPrestige()) {
                            performPrestige();
                        }
                        break;
                }
            });
            
            // Manual save button
            document.getElementById('saveGameButton')?.addEventListener('click', () => {
                saveGame();
                showNotification('Game saved!', 'success');
            });
        });

        // === GLOBAL FUNCTIONS (for onclick handlers) ===
        window.buyBuilding = buyBuilding;
        window.harvestResource = harvestResource;
        window.combatAction = combatAction;
        window.movePlayer = movePlayer;
        window.useAbility = useAbility;
        window.performPrestige = performPrestige;
        window.selectHouse = selectHouse;

    </script>

    <div id="loadingScreen" class="fixed inset-0 bg-stone-950 text-white flex items-center justify-center z-[10000]">
        <div class="text-center">
            <div class="text-6xl font-orbitron text-amber-400 mb-6 prestige-glow">🏜️ ARRAKIS</div>
            <div class="text-2xl mb-4">Spice Empire MMO</div>
            <div class="text-lg text-amber-300 mb-6">Loading the desert world...</div>
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 bg-amber-400 rounded-full animate-bounce"></div>
                <div class="w-3 h-3 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-amber-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <div class="mt-6 text-stone-400 italic">"The spice must flow..."</div>
        </div>
    </div>

    <header class="bg-stone-800 border-b border-stone-700 px-4 py-3 fixed top-0 left-0 right-0 z-100">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-3xl font-orbitron font-bold text-amber-400 prestige-glow">Arrakis: Spice Empire</h1>
                <span class="text-sm text-amber-200 italic">"He who controls the spice, controls the universe"</span>
            </div>
            <div class="flex items-center space-x-6">
                <div class="text-sm">
                    <span class="text-stone-400">House:</span>
                    <span id="playerHouseDisplay" class="font-semibold">None</span>
                </div>
                <div class="text-sm">
                    <span class="text-stone-400">Rank:</span>
                    <span id="playerRankDisplay" class="font-semibold text-stone-400">Desert Rat</span>
                </div>
                <div class="text-sm">
                    <span class="text-stone-400">Prestige:</span>
                    <span id="playerPrestigeDisplay" class="font-semibold text-purple-400 prestige-glow">0</span>
                </div>
                <button id="saveGameButton" class="px-4 py-2 bg-green-700 hover:bg-green-600 rounded text-sm font-semibold">💾 Save Game</button>
            </div>
        </div>
    </header>

    <nav class="bg-stone-800 border-b border-stone-700 px-4 fixed top-[72px] left-0 right-0 z-100">
        <div class="flex space-x-1">
            <button class="tab-button active px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="game">🏜️ Desert Map</button>
            <button class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="character">👤 Character</button>
            <button class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="base">🏗️ Base & Empire</button>
            <button class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-amber-400" data-tab="quests">📜 Quests & Lore</button>
        </div>
    </nav>

    <main class="flex pt-[124px] h-screen">
        <!-- Left Sidebar -->
        <aside class="w-72 bg-stone-800 border-r border-stone-700 flex flex-col p-4 space-y-4 overflow-y-auto">
            <div>
                <h3 class="text-lg font-semibold text-amber-400 mb-3">📦 Resources</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                        <span class="flex items-center"><span class="text-amber-400 mr-2">✨</span>Spice:</span>
                        <span id="resourceSpice" class="font-mono text-amber-300 font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                        <span class="flex items-center"><span class="text-orange-400 mr-2">🔥</span>Melange:</span>
                        <span id="resourceMelange" class="font-mono text-orange-300 font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                        <span class="flex items-center"><span class="text-blue-400 mr-2">💧</span>Water:</span>
                        <span id="resourceWater" class="font-mono text-blue-300 font-bold">150</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                        <span class="flex items-center"><span class="text-yellow-400 mr-2">💰</span>Solari:</span>
                        <span id="resourceSolari" class="font-mono text-yellow-300 font-bold">1000</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                        <span class="flex items-center"><span class="text-gray-400 mr-2">🔧</span>Plasteel:</span>
                        <span id="resourcePlasteel" class="font-mono text-gray-300 font-bold">100</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-stone-700 rounded">
                        <span class="flex items-center"><span class="text-purple-400 mr-2">💎</span>Rare Materials:</span>
                        <span id="resourceRareMaterials" class="font-mono text-purple-300 font-bold">0</span>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-amber-400 mb-3">⚡ Character Stats</h3>
                <div class="space-y-2 text-sm">
                    <div class="p-2 bg-stone-700 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Health:</span>
                            <span id="statHealth" class="font-mono">120/120</span>
                        </div>
                        <div class="progress-bar-bg rounded h-2">
                            <div id="barHealth" class="progress-bar-fill h-full rounded" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="p-2 bg-stone-700 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Energy:</span>
                            <span id="statEnergy" class="font-mono">150/150</span>
                        </div>
                        <div class="progress-bar-bg rounded h-2">
                            <div id="barEnergy" class="bg-blue-500 h-full rounded" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="p-2 bg-stone-700 rounded">
                        <div class="flex justify-between mb-1">
                            <span>Level <span id="statLevel" class="font-bold">1</span>:</span>
                            <span id="statExp" class="font-mono text-xs">0/100</span>
                        </div>
                        <div class="progress-bar-bg rounded h-2">
                            <div id="barExp" class="bg-purple-500 h-full rounded" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-amber-400 mb-3">🌟 Combat Abilities</h3>
                <div id="uiAbilitySlots" class="flex gap-3 justify-center">
                    <div class="ability-slot" data-slot="0">
                        <span class="ability-icon">❔</span>
                        <span class="ability-cooldown-text"></span>
                    </div>
                    <div class="ability-slot" data-slot="1">
                        <span class="ability-icon">❔</span>
                        <span class="ability-cooldown-text"></span>
                    </div>
                    <div class="ability-slot" data-slot="2">
                        <span class="ability-icon">❔</span>
                        <span class="ability-cooldown-text"></span>
                    </div>
                </div>
                <p class="text-xs text-stone-400 text-center mt-2">Click empty slots to assign abilities</p>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-amber-400 mb-3">⚡ Desert Actions</h3>
                <div class="space-y-2">
                    <button onclick="harvestResource('spice')" class="w-full text-sm py-2 bg-amber-600 hover:bg-amber-700 rounded font-semibold">
                        ✨ Harvest Spice <span class="text-xs">(8 energy)</span>
                    </button>
                    <button onclick="harvestResource('water')" class="w-full text-sm py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                        💧 Extract Water <span class="text-xs">(12 energy)</span>
                    </button>
                    <button onclick="harvestResource('plasteel')" class="w-full text-sm py-2 bg-gray-600 hover:bg-gray-700 rounded font-semibold">
                        🔧 Mine Plasteel <span class="text-xs">(15 energy)</span>
                    </button>
                </div>
            </div>
            
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-amber-400 mb-3">📜 Event Chronicle</h3>
                <div id="uiGameLog" class="h-64 bg-stone-900 rounded p-3 text-xs overflow-y-auto border border-stone-600"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Game Tab -->
            <div id="gameTab" class="tab-content flex-1 p-6 overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-orbitron text-amber-400">🏜️ The Great Desert of Arrakis</h2>
                    <div class="text-lg text-stone-300">
                        Position: <span id="mapPlayerCoords" class="text-amber-300 font-bold">100,100</span>
                    </div>
                </div>
                
                <div class="mb-6 text-center">
                    <div class="text-sm text-stone-400 mb-3">
                        <span class="font-semibold">Controls:</span> WASD/Arrow Keys to move • Space to harvest • P to prestige • Click cells to interact
                    </div>
                    <div id="uiMapGrid" class="map-grid"></div>
                    <div class="mt-3 text-xs text-stone-400">
                        <span class="text-amber-400">👤 You</span> • 
                        <span class="text-red-400">👹 Enemies</span> • 
                        <span class="text-orange-400">✨ Spice</span> • 
                        <span class="text-blue-400">💧 Water</span> • 
                        <span class="text-gray-400">🔧 Plasteel</span> • 
                        <span class="text-green-400">🏔️ Sietch</span>
                    </div>
                </div>
            </div>
            
            <!-- Character Tab -->
            <div id="characterTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-2xl font-orbitron text-amber-400 mb-4">👤 Character Profile</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-stone-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 text-amber-300">Character Statistics</h3>
                        <div class="space-y-2 text-sm">
                            <p class="flex justify-between">
                                <span>Name:</span>
                                <span id="charName" class="text-amber-300 font-semibold">Desert Walker (P0)</span>
                            </p>
                            <p class="flex justify-between">
                                <span>Level:</span>
                                <span id="charLevel" class="text-green-400 font-bold">1</span>
                            </p>
                            <p class="flex justify-between">
                                <span>Attack Power:</span>
                                <span id="charAttack" class="text-red-400 font-bold">12</span>
                            </p>
                            <p class="flex justify-between">
                                <span>Defense Rating:</span>
                                <span id="charDefense" class="text-blue-400 font-bold">8</span>
                            </p>
                            <p class="flex justify-between">
                                <span>Critical Hit Chance:</span>
                                <span id="charCrit" class="text-yellow-400 font-bold">5%</span>
                            </p>
                            <p class="flex justify-between">
                                <span>Dodge Chance:</span>
                                <span id="charDodge" class="text-green-400 font-bold">12%</span>
                            </p>
                            <p class="flex justify-between">
                                <span>Power Rating:</span>
                                <span id="charPower" class="text-purple-400 font-bold">0</span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-stone-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 text-amber-300">Equipment</h3>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div id="equipWeapon" class="inventory-slot mx-auto mb-2"></div>
                                <span class="text-sm font-semibold">Weapon</span>
                            </div>
                            <div>
                                <div id="equipArmor" class="inventory-slot mx-auto mb-2"></div>
                                <span class="text-sm font-semibold">Armor</span>
                            </div>
                            <div>
                                <div id="equipAccessory" class="inventory-slot mx-auto mb-2"></div>
                                <span class="text-sm font-semibold">Accessory</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-stone-800 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-amber-300">
                        Inventory (<span id="inventoryUsage">0/30</span>)
                    </h3>
                    <div id="uiInventoryGrid" class="grid grid-cols-6 sm:grid-cols-10 gap-2"></div>
                    <p class="text-xs text-stone-400 mt-3">Click equipment items to equip them</p>
                </div>
            </div>
            
            <!-- Base Tab -->
            <div id="baseTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-orbitron text-amber-400">🏗️ Spice Empire Management</h2>
                    <button onclick="performPrestige()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold text-lg prestige-glow" 
                            style="display: none;" id="prestigeButton">
                        ✨ PRESTIGE ✨
                    </button>
                </div>
                
                <div id="uiBuildingsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                
                <div class="mt-6 bg-stone-800 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-purple-400">🌟 Prestige System</h3>
                    <p class="text-sm text-stone-300 mb-3">
                        Prestige allows you to transcend your current existence and begin anew with permanent bonuses.
                        Each prestige level grants +10% to all resource gains and XP.
                    </p>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><span class="text-stone-400">Current Prestige:</span> <span class="text-purple-400 font-bold">P0</span></p>
                            <p><span class="text-stone-400">Lifetime Spice:</span> <span class="text-amber-400">0</span></p>
                        </div>
                        <div>
                            <p><span class="text-stone-400">Requirements:</span></p>
                            <p class="text-xs">• Level 25+</p>
                            <p class="text-xs">• 1,000,000 Lifetime Spice</p>
                            <p class="text-xs">• Sietch Tabr built</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quests Tab -->
            <div id="questsTab" class="tab-content hidden flex-1 p-6 overflow-y-auto">
                <h2 class="text-2xl font-orbitron text-amber-400 mb-4">📜 Quests & Lore of Arrakis</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-amber-300">Active Quests</h3>
                        <div id="uiQuestsList" class="space-y-3"></div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-amber-300">Arrakis Chronicles</h3>
                        <div class="bg-stone-800 p-4 rounded-lg text-sm text-stone-300 space-y-3">
                            <p class="italic">"Arrakis. Dune. Desert planet. The whole universe depends on it."</p>
                            
                            <p>The desert planet Arrakis is the sole source of melange, the "spice" that extends life, expands consciousness, and makes space travel possible. The great houses of the Imperium vie for control of this precious resource.</p>
                            
                            <p>You have arrived on Arrakis with nothing but determination. Will you align with the noble House Atreides, the brutal Harkonnens, or learn the ways of the desert from the Fremen?</p>
                            
                            <p class="text-amber-400 font-semibold">"He who controls the spice, controls the universe."</p>
                            
                            <div class="mt-4 p-3 bg-stone-700 rounded">
                                <p class="text-xs text-stone-400 mb-1">Pro Tip:</p>
                                <p class="text-xs">Beware of sandworms! These massive creatures are attracted to rhythmic movement across the desert. The Fremen know how to avoid them...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Combat Modal -->
    <div id="modalCombat" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-2xl">
            <h3 class="text-2xl font-orbitron text-red-500 mb-4 text-center">⚔️ DESERT COMBAT ⚔️</h3>
            
            <div class="grid grid-cols-2 gap-6 mb-4">
                <div class="bg-stone-700 p-3 rounded">
                    <div class="flex justify-between items-baseline mb-2">
                        <span id="modalCombatPlayerName" class="font-semibold text-green-400">Player</span>
                        <span id="modalCombatPlayerLevel" class="text-sm text-stone-400">Lv.1</span>
                    </div>
                    <div class="text-sm mb-1">Health: <span id="modalCombatPlayerHealth">120/120</span></div>
                    <div class="progress-bar-bg rounded h-3 mb-2">
                        <div id="modalCombatPlayerHealthBar" class="progress-bar-fill h-full rounded" style="width: 100%"></div>
                    </div>
                    <div class="text-sm mb-1">Energy: <span id="modalCombatPlayerEnergy">150/150</span></div>
                    <div class="progress-bar-bg rounded h-3">
                        <div id="modalCombatPlayerEnergyBar" class="bg-blue-500 h-full rounded" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="bg-stone-700 p-3 rounded">
                    <div class="flex justify-between items-baseline mb-2">
                        <span id="modalCombatEnemyName" class="font-semibold text-red-400">Enemy</span>
                        <span id="modalCombatEnemyLevel" class="text-sm text-stone-400">Lv.1</span>
                    </div>
                    <div class="text-sm mb-1">Health: <span id="modalCombatEnemyHealth">50/50</span></div>
                    <div class="progress-bar-bg rounded h-3">
                        <div id="modalCombatEnemyHealthBar" class="bg-red-600 h-full rounded" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            
            <div id="modalCombatLog" class="bg-stone-900 rounded p-3 h-40 overflow-y-auto text-sm mb-4 border border-stone-600"></div>
            
            <div class="grid grid-cols-3 gap-3 mb-3">
                <button id="combatActionAttack" class="py-3 bg-red-600 hover:bg-red-700 rounded font-semibold">⚔️ Attack</button>
                <button id="combatActionDefend" class="py-3 bg-blue-600 hover:bg-blue-700 rounded font-semibold">🛡️ Defend</button>
                <button id="combatActionFlee" class="py-3 bg-stone-600 hover:bg-stone-700 rounded font-semibold">💨 Flee</button>
            </div>
            
            <div id="modalCombatPlayerAbilities" class="grid grid-cols-3 gap-2 mb-3"></div>
            
            <div id="modalCombatTurnIndicator" class="text-center text-lg font-bold text-green-400">Your Turn</div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-20 right-4 space-y-2 z-[9999]"></div>

</body>
</html>
